## Vue3æºç å‰–æï¼ˆäº”ï¼‰â€” Vue3æ¸²æŸ“åŸç†

### ä¸€ã€å‰è¨€

Vue3ä¸­è¿è¡Œæ—¶çš„==æ ¸å¿ƒæ¨¡å—æœ‰ä¸¤ä¸ª==**runtime-dom** å’Œ**runtime-core** 

- **runtime-domï¼š**==æä¾›**DOM API**==
- **runtime-coreï¼š**è°ƒç”¨**runtime-dom**æä¾›çš„**DOM API**==å°†è™šæ‹ŸDOMå˜æˆçœŸå®DOM==

æ¥ä¸‹æ¥å®ç°çš„å°±æ˜¯`runtime-dom` å’Œ`runtime-core`è¿™ä¸¤ä¸ªæ¨¡å—

#### 1.1ã€æ¸²æŸ“è¿‡ç¨‹ä¸­çš„å‡ ä¸ªå…³é”®æ–¹æ³•

##### 1.1.1ã€`createApp`

==`createApp` æ˜¯ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ª **Vueåº”ç”¨ç¨‹åºå®ä¾‹**==

å®ƒæ¥å—ä¸€ä¸ªæ ¹ç»„ä»¶ä½œä¸ºå‚æ•°ï¼Œ==è¿”å›ä¸€ä¸ªæä¾›åº”ç”¨ä¸Šä¸‹æ–‡çš„**åº”ç”¨å®ä¾‹**å¯¹è±¡== 

è¯¥å¯¹è±¡åŒ…å«äº†ä¸€äº›å¸¸ç”¨çš„æ–¹æ³•å’Œå±æ€§ï¼Œæ¯”å¦‚ `mount`ã€`unmount`ã€`provide`ã€`inject` ç­‰ã€‚é€šè¿‡ `createApp` æ–¹æ³•å¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºä¸€ä¸ª Vue åº”ç”¨ç¨‹åºï¼Œå¹¶å°†å…¶æŒ‚è½½åˆ°é¡µé¢ä¸Š

<!--åº”ç”¨å®ä¾‹æŒ‚è½½çš„æ•´ä¸ªç»„ä»¶æ ‘å…±äº«åŒä¸€ä¸ªä¸Šä¸‹æ–‡-->

ç¤ºä¾‹ï¼š

```js
import { createApp } from 'vue'
import App from './App.vue'

const app = createApp(App)

app.mount('#app')
```

> CreateApp ä½œä¸º vue çš„==å¯åŠ¨å‡½æ•°==ï¼Œè¿”å›ä¸€ä¸ªåº”ç”¨å®ä¾‹ï¼Œæ¯ä¸ª Vue åº”ç”¨ç¨‹åºéƒ½é¦–å…ˆä½¿ç”¨ä»¥ä¸‹å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„**åº”ç”¨ç¨‹åºå®ä¾‹**ï¼Œåº”ç”¨ç¨‹åºå®ä¾‹å…¬å¼€çš„å¤§å¤šæ•°æ–¹æ³•éƒ½è¿”å›ç›¸åŒçš„å®ä¾‹ï¼Œå¯ä»¥é“¾å¼è°ƒç”¨

##### 1.1.2ã€`h`

==`h` æ–¹æ³•æ˜¯ç”¨äºåˆ›å»º**è™šæ‹ŸèŠ‚ç‚¹(VNode)**çš„å‡½æ•°==ï¼Œå®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼š**æ ‡ç­¾å**ã€**å±æ€§å¯¹è±¡**å’Œ**å­èŠ‚ç‚¹æ•°ç»„**

**VNode**æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå®ƒæè¿°äº†ä¸€ä¸ª DOM å…ƒç´ çš„ç»“æ„å’Œå±æ€§ï¼Œå¯ä»¥ç”¨äºæ„å»º Vue ç»„ä»¶çš„æ¨¡æ¿

ä½¿ç”¨ `h` æ–¹æ³•å¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºä¸­åŠ¨æ€ç”Ÿæˆç»„ä»¶

ç¤ºä¾‹ï¼š

```js
import { createApp, h } from 'vue'
import App from './App.vue'

const app = createApp({
  render() {
    return h('div', {
      class: 'container'
    }, [
      h('h1', {}, 'Hello Vue 3.0'),
      h(App)
    ])
  }
})

app.mount('#app')
```

##### 1.1.3ã€Custom Renderer API  â€” `createRenderer` 

==`createRenderer` æ˜¯ç”¨äºåˆ›å»ºè‡ªå®šä¹‰æ¸²æŸ“å™¨çš„å‡½æ•°==

Vue3é€šè¿‡å‘å¤–æš´éœ²å‡º`runtime-dom` æ¨¡å—çš„`createRenderer`æ–¹æ³•ï¼Œ==æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ¸²æŸ“å™¨==ï¼Œå»é€‚é…ä¸åŒçš„å¹³å°ï¼Œä¾‹å¦‚ Canvas æˆ– WebGPU

> ==æ¸²æŸ“å™¨çš„ä½œç”¨æ˜¯æŠŠè™šæ‹ŸDOMæ¸²æŸ“ä¸ºç‰¹å®šå¹³å°ä¸Šçš„çœŸå®å…ƒç´ ==
>
> åœ¨æµè§ˆå™¨ä¸­ï¼Œæ¸²æŸ“å™¨ä¼šæŠŠè™šæ‹ŸDOMæ¸²æŸ“æˆçœŸå®DOMå…ƒç´ 
>
> ==`createRenderer`æ–¹æ³•æ˜¯æ•´ä¸ªVueæ¸²æŸ“åŸç†çš„æ ¸å¿ƒæ–¹æ³•==ï¼ŒDOM çš„åˆå§‹åŒ–æŒ‚è½½ã€`diff`æ›´æ–°ã€å¸è½½éƒ½åœ¨`createRenderer`ä¸­å®ç°

`createRenderer`è¯­æ³•å¦‚ä¸‹ğŸ‘‡

```js
import { createRenderer } from 'vue'
const { render, createApp } = createRenderer({
  patchProp,
  ...nodeOps
})
```

**==å…¥å‚ï¼š==**

`createRenderer` å‡½æ•°çš„æ¥å—ä¸€ä¸ª`rendererOptions`å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œåœ¨`rendererOptions`ä¸­å¯ä»¥å®šä¹‰å¾ˆå¤š==æ“ä½œçœŸå®DOMçš„æ–¹æ³•==ç”¨äº==æ„å»ºæ•´ä¸ªæ¸²æŸ“å™¨==

é€šè¿‡è‡ªå®šä¹‰`rendererOptions`å¯ä»¥ç”Ÿæˆé€‚é…ä¸åŒå¹³å°çš„æ¸²æŸ“å™¨

> åœ¨ [runtime-dom/src/nodeOps.ts](https://github.com/vuejs/vue-next/blob/master/packages/runtime-dom/src/nodeOps.ts) ä¸­æœ‰å®˜æ–¹çš„å®ç°å¯ä»¥ä½œä¸ºå‚è€ƒ
>
> Vue3ä¸­å†…ç½®äº†æµè§ˆå™¨å¹³å°çš„`rendererOptions`ä½œä¸ºé»˜è®¤å€¼

`rendererOptions`ä¸­çš„å†…å®¹ï¼š <!--Vue3ä¸­å†…ç½®çš„rendererOptionsæ˜¯æµè§ˆå™¨å¹³å°çš„æ“ä½œçœŸå®DOMçš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åœ¨runtime-domè¿™ä¸ªåŒ…ä¸­-->

- `patchProp (el, key, prevValue, nextValue)`ï¼š**==æ“ä½œDOMå…ƒç´ å±æ€§çš„API==**

  -  åœ¨ç»„ä»¶==å±æ€§è¢«ä¿®æ”¹æ—¶è°ƒç”¨==ï¼Œé’ˆå¯¹ä¸åŒå±æ€§ï¼Œå¯¹ `el` è¿›è¡Œä¸åŒçš„æ“ä½œ

- `nodeOps`ï¼š==**æ“ä½œDOMå…ƒç´ çš„API**==

  - `createElement(tag)` ï¼šåˆ›å»ºå…ƒç´ 

  - `createText(text)`ï¼šåˆ›å»ºæ–‡æœ¬

  - `setElementText(node, text)`ï¼šè®¾ç½®æ–‡æœ¬

  - `insert(el, parent)`ï¼šå°†å…ƒç´ æ’å…¥çˆ¶èŠ‚ç‚¹çš„å…ƒç´ ï¼Œ`el` è¦æ’å…¥çš„å…ƒç´ å¯¹è±¡ï¼Œ`parent` çˆ¶å…ƒç´ å¯¹è±¡

    <!--...è¿˜æœ‰å¾ˆå¤šï¼Œå¾…è¡¥å……-->

**==è¿”å›å€¼ï¼š==**

`createRenderer`çš„è¿”å›å€¼æ˜¯ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•`render`å’Œ`createApp`

- `render(VNode, el)`  <!--è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦â€¼ï¸-->

  ==ç”¨æ¥å°†`VNode`è½¬åŒ–æˆçœŸå®`DOM`å¹¶æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ä¸Šï¼Œ`VNode`çš„`diff`æ›´æ–°ï¼Œä»¥åŠ`VNode`çš„å¸è½½==

  - `VNode`ï¼šè™šæ‹Ÿ**DOM**èŠ‚ç‚¹
  - `el`ï¼šå®¹å™¨ï¼Œæ˜¯ä¸ªçœŸå®**DOM**èŠ‚ç‚¹

- `createApp` 

  - æ˜¯ç”¨æ¥åˆ›å»ºæ•´ä¸ªåº”ç”¨çš„å·¥å…·ï¼Œè¿è¡Œå®ƒä¼šè¿”å›==ä¸€ä¸ªæä¾›åº”ç”¨ä¸Šä¸‹æ–‡çš„åº”ç”¨å®ä¾‹==ï¼Œåº”ç”¨å®ä¾‹æŒ‚è½½çš„æ•´ä¸ªç»„ä»¶æ ‘å…±äº«åŒä¸€ä¸ªä¸Šä¸‹æ–‡ï¼›
  - å¯ä»¥åœ¨ `createApp` ä¹‹åé“¾å¼è°ƒç”¨å…¶å®ƒæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥åœ¨ [åº”ç”¨ API](https://vue3js.cn/docs/zh/api/application-api.html) ä¸­æ‰¾åˆ°

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ğŸ‘‡

```js
const {createRenderer,h} = Vue
const renderer = createRenderer({
    createElement(element){
        return document.createElement(element);
    },
    setElementText(el,text){
        el.innerHTML = text
    },
    insert(el,container){
        container.appendChild(el)
    }
});
renderer.render(h('h1','hello world'),document.getElementById('app')) 
```

#### 1.2ã€Vue3ä¸­çš„diffç®—æ³•

**Vue3**çš„**diff**ç®—æ³•ä¸**Vue2**çš„**diff**ç®—æ³•ç›¸æ¯”ï¼Œæœ‰ä»¥ä¸‹ä¸€äº›é‡è¦çš„æ”¹è¿›ï¼š

1. ==**é™æ€æ ‡è®°ï¼š**== **Vue3** ä¸­å¼•å…¥äº†==é™æ€æ ‡è®°==ï¼Œå¯==ä»¥å°†ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„èŠ‚ç‚¹æ ‡è®°ä¸ºé™æ€èŠ‚ç‚¹ï¼Œä»è€Œåœ¨ diff ç®—æ³•ä¸­è·³è¿‡è¿™äº›èŠ‚ç‚¹çš„æ¯”è¾ƒã€‚==è¿™æ ·å¯ä»¥å¤§å¹…å‡å°‘ diff çš„æ—¶é—´å¤æ‚åº¦ï¼Œæé«˜æ¸²æŸ“æ€§èƒ½ã€‚
2. **PatchFlagï¼š**Vue 3 ä¸­çš„è™šæ‹ŸèŠ‚ç‚¹å¼•å…¥äº† PatchFlag æ ‡è®°ï¼Œå¯ä»¥ç”¨äºæ ‡è®°èŠ‚ç‚¹çš„ç±»å‹ã€å±æ€§ã€å­èŠ‚ç‚¹ç­‰ä¿¡æ¯ã€‚åœ¨ diff ç®—æ³•ä¸­ï¼Œå¯ä»¥æ ¹æ® PatchFlag å¿«é€Ÿæ¯”è¾ƒèŠ‚ç‚¹çš„å·®å¼‚ï¼Œä»è€Œé¿å…ä¸å¿…è¦çš„æ¯”è¾ƒã€‚
3. **åŠ¨æ€èŠ‚ç‚¹çš„ç¼“å­˜ï¼š**Vue 3 ä¸­é€šè¿‡ç¼“å­˜åŠ¨æ€èŠ‚ç‚¹çš„æ–¹å¼ï¼Œå¯ä»¥é¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½é‡æ–°åˆ›å»ºèŠ‚ç‚¹ã€‚åœ¨ diff ç®—æ³•ä¸­ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ä¹‹å‰çš„èŠ‚ç‚¹ï¼Œä»è€Œå‡å°‘äº†èŠ‚ç‚¹çš„åˆ›å»ºå’Œé”€æ¯ã€‚

æ€»ä¹‹ï¼ŒVue 3 çš„ diff ç®—æ³•åœ¨æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§æ–¹é¢éƒ½æœ‰äº†å¾ˆå¤§çš„æå‡ï¼Œä½¿å¾— Vue 3 åœ¨å¤„ç†å¤§å‹åº”ç”¨å’Œé«˜æ€§èƒ½åœºæ™¯æ—¶æ›´åŠ ä¼˜ç§€

### äºŒã€`runtime-dom` 

åˆ›å»º`runtime-dom`åŒ…

`runtime-dom` åŒ…æ˜¯æä¾›è¿è¡Œæ—¶å¤„ç†çœŸå®DOMçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬DOM API ã€å±æ€§ã€äº‹ä»¶å¤„ç†ç­‰

```json
// runtime-dom/package.json
{
    "name": "@vue/runtime-dom",
    "main": "index.js",
    "module": "dist/runtime-dom.esm-bundler.js",
    "unpkg": "dist/runtime-dom.global.js",
    "buildOptions": {
        "name": "VueRuntimeDOM",
        "formats": [
        "esm-bundler",
        "cjs",
        "global"
        ]
    }
}
```

```shell
pnpm install @vue/shared@workspace --filter @vue/runtime-dom
```

#### 2.1ã€å†…ç½®çš„`rendererOptions`

##### 2.1.1ã€`pachProp`

```typescript
// packages/runtime-dom/src/patchProp.ts

import { patchAttr } from './patch-prop/patchAttr';
import { patchClass } from './patch-prop/patchClass';
import { patchEvent } from './patch-prop/patchEvent';
import { patchStyle } from './patch-prop/patchStyle';

/**
 * å¯¹èŠ‚ç‚¹å±æ€§çš„æ“ä½œ
 * ç»™å±æ€§æ‰“è¡¥ä¸ {style:{color:'red'}}   {style:{}}
 */
export const patchProp = (el, key, preValue, nextValue) => {
  if (key === 'class') {
    // ç±»å
    patchClass(el, nextValue);
  } else if (key === 'style') {
    // è¡Œå†…æ ·å¼
    patchStyle(el, preValue, nextValue);
  } else if (/on[^a-z]/.test(key)) {
    // äº‹ä»¶ onClick onMousedown
    patchEvent(el, key, nextValue);
  } else {
    // å…¶ä»–å±æ€§
    patchAttr(el, key, nextValue);
  }
};
```

```typescript
//packages/runtime-dom/src/patch-prop/patchClass.ts

/**
 * æ“ä½œå…ƒç´ çš„ç±»å
 */
export function patchClass(el, nextValue) {
  if (nextValue == null) {
    el.removeAttribute('class');
  } else {
    el.className = nextValue;
  }
}
```

```typescript
//packages/runtime-dom/src/patch-prop/patchStyle.ts

/**
 * æ“ä½œå…ƒç´ çš„è¡Œå†…æ ·å¼
 */
export function patchStyle(el, preValue, nextValue) {
  const style = el.style;
  for (let key in nextValue) {
    style[key] = nextValue[key];
  }
  if (preValue) {
    for (let key in preValue) {
      if (nextValue[key] == null) {
        // è€çš„æœ‰ æ–°çš„æ²¡æœ‰ éœ€è¦åˆ é™¤è€çš„
        style[key] = null;
      }
    }
  }
}

```

```typescript
//packages/runtime-dom/src/patch-prop/patchEvent.ts

/**
 * åˆ›å»ºä¸€ä¸ªåŒ…è£…äº‹ä»¶å›è°ƒçš„å‡½æ•°
 * è¿™ä¹ˆåšæ˜¯ä¸ºäº†æå‡æ€§èƒ½
 * åªéœ€è¦ä¿®æ”¹valueçš„å¼•ç”¨å°±å¯ä»¥è°ƒç”¨ä¸åŒçš„é€»è¾‘
 * é¿å…äº†ç»‘å®šäº‹ä»¶æ—¶æ–°å»ºå‡½æ•°çš„å¼€é”€
 */
function createInvoker(initialValue) {
  const invoker = e => {
    invoker.value(e);
  };

  // åç»­åªéœ€è¦ä¿®æ”¹valueçš„å¼•ç”¨å°±å¯ä»¥ è¾¾åˆ°è°ƒç”¨ä¸åŒçš„é€»è¾‘
  invoker.value = initialValue;
  return invoker;
}

/**
 * æ“ä½œå…ƒç´ çš„äº‹ä»¶
 */
export function patchEvent(el, eventName, nextValue) {
  // ç»™å…ƒç´ elæ·»åŠ _veiå±æ€§ç”¨äºå­˜å‚¨äº‹ä»¶
  const invokers = el._vei || (el._vei = {});
  const exitingInvoker = invokers[eventName];

  if (exitingInvoker && nextValue) {
    // å­˜åœ¨ç¼“å­˜çš„æƒ…å†µï¼Œç›´æ¥è¿›è¡Œæ¢ç»‘
    exitingInvoker.value = nextValue;
  } else {
    // ä¸å­˜åœ¨ç¼“å­˜çš„æƒ…å†µ éœ€è¦æ·»åŠ äº‹ä»¶ï¼Œäº‹ä»¶åä¸€èˆ¬æ˜¯è¿™ç§å½¢å¼çš„ onClick onMousedown
    const eName = eventName.slice(2).toLowerCase();
    if (nextValue) {
      // el._vei = {onClick: invoker}
      const invoker = createInvoker(nextValue);
      // ç¼“å­˜invoker
      invokers[eventName] = invoker;
      el.addEventListener(eName, invoker);
    } else if (exitingInvoker) {
      // æ²¡æœ‰æ–°çš„å€¼ï¼Œä½†æ˜¯ä¹‹å‰ç»‘å®šè¿‡ éœ€è¦åˆ é™¤ä¹‹å‰çš„
      el.removeEventListener(eName, exitingInvoker);
      // æ¸…é™¤ç¼“å­˜invoker
      invokers[eventName] = null;
    }
  }
}

```

```typescript
//packages/runtime-dom/src/patch-prop/patchAttr.ts

/**
 * æ“ä½œå…ƒç´ çš„å…¶ä»–å±æ€§
 */
export function patchAttr(el,key,nextValue){
    if(nextValue == null){
        el.removeAttribute(key);
    }else{
        el.setAttribute(key,nextValue)
    }
}
```

##### 2.1.2ã€`nodeOps`

```typescript
// packages/runtime-dom/src/nodeOps.ts

/**
 * å¯¹èŠ‚ç‚¹çš„æ“ä½œ
 * åˆ›å»ºå…ƒç´ èŠ‚ç‚¹ åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹  èŠ‚ç‚¹çš„å¢åˆ æŸ¥ï¼Œ è·å–çˆ¶å­å…³ç³»
 */
export const nodeOps = {
  createElement(tagName) {
    return document.createElement(tagName);
  },
  createTextNode(text) {
    return document.createTextNode(text);
  },
  insert(element, container, anchor = null) {
    container.insertBefore(element, anchor); // ==appendChild
  },
  remove(child) {
    const parent = child.parentNode;
    if (parent) {
      parent.removeChild(child);
    }
  },
  querySelector(selectors) {
    return document.querySelector(selectors);
  },
  parentNode(child) {
    // çˆ¶èŠ‚ç‚¹
    return child.parentNode;
  },
  nextSibling(child) {
    // è·å–å…„å¼Ÿå…ƒç´ 
    return child.nextSibling;
  },
  setText(element, text) {
    // ç»™æ–‡æœ¬èŠ‚ç‚¹è®¾ç½®å†…å®¹
    element.nodeValue = text;
  },
  setElementText(element, text) {
    // ç»™å…ƒç´ èŠ‚ç‚¹è®¾ç½®å†…å®¹ innerHTML
    element.textContent = text;
  }
};
```

 `runtime-dom/src/nodeOps` è¿™é‡Œ**==å­˜æ”¾å¸¸è§DOMæ“ä½œAPI==**

ä¸åŒè¿è¡Œæ—¶æä¾›çš„å…·ä½“å®ç°ä¸ä¸€æ ·ï¼Œæœ€ç»ˆå°†æ“ä½œæ–¹æ³•ä¼ é€’åˆ°`runtime-core`ä¸­ï¼Œæ‰€ä»¥==`runtime-core`ä¸éœ€è¦å…³å¿ƒå¹³å°ç›¸å…³ä»£ç ==

#### 2.3ã€`runtime-core`

åˆ›å»º`runtime-core`åŒ…

`runtime-core` ==ä¸å…³å¿ƒè¿è¡Œå¹³å°==

```json
// runtime-core/package.json

{
  "name": "@vue/runtime-core",
  "module": "dist/runtime-core.esm-bundler.js",
  "types": "dist/runtime-core.d.ts",
  "files": [
    "index.js",
    "dist"
  ],
  "buildOptions": {
    "name": "VueRuntimeCore",
    "formats": [
      "esm-bundler",
      "cjs"
    ]
}
```

`runtime-core`ä¸­éœ€è¦ä¾èµ– `@vue/shared` åŠ `@vue/reactivity`

```shell
pnpm install @vue/shared@workspace @vue/reactivity@workspace --filter @vue/runtime-core
```

##### 2.3.1ã€`createVNode`å®ç°

```typescript
// packages/runtime-core/src/createVNode.ts
/**
 * vue3ä¸­çš„å½¢çŠ¶æ ‡è¯†
 * é€šè¿‡ç»„åˆå¯ä»¥æè¿°è™šæ‹ŸèŠ‚ç‚¹çš„ç±»å‹
 */
export const enum ShapeFlags {
  ELEMENT = 1, // 1
  FUNCTIONAL_COMPONENT = 1 << 1, // 2
  STATEFUL_COMPONENT = 1 << 2, // 4
  TEXT_CHILDREN = 1 << 3, // 8
  ARRAY_CHILDREN = 1 << 4, // 16
  SLOTS_CHILDREN = 1 << 5, // 32
  TELEPORT = 1 << 6, // 64
  SUSPENSE = 1 << 7, // 128
  COMPONENT_SHOULD_KEEP_ALIVE = 1 << 8,
  COMPONENT_KEPT_ALIVE = 1 << 9,
  COMPONENT = ShapeFlags.STATEFUL_COMPONENT |
    ShapeFlags.FUNCTIONAL_COMPONENT
}
```

```typescript
// packages/runtime-core/src/createVNode.ts
import { isArray, isString } from '@vue/shared';

/**
 * åˆ›å»ºVirtualNode
 */
export function createVNode(type, props = null, children = null) {
  // æ ‡è®°åˆ›å»ºçš„æ˜¯ä»€ä¹ˆç±»å‹çš„VNode
  let shapeFlag = isString(type) ? ShapeFlags.ELEMENT : 0;

 const vnode = {
  __v_isVNode:true, // vnodeæ ‡è¯†
  type, // çœŸå®èŠ‚ç‚¹çš„ç±»å‹
  props,
  children,
  key: props && props.key,
  el: null,
  shapeFlag // æ ‡è®°è‡ªå·±çš„ç±»å‹åŠchildren VNodeçš„ç±»å‹
};

  /**
   * é€šè¿‡ä½è¿ç®—
   * å°†å½“å‰çš„VNode å’Œ children VNodeæ˜ å°„èµ·æ¥
   * é€šè¿‡shapeFlags å°±å¯ä»¥çŸ¥é“children VNodeçš„ç±»å‹äº† æ˜¯æ•°ç»„ è¿˜æ˜¯å…ƒç´  è¿˜æ˜¯æ–‡æœ¬
   * åˆ©ç”¨çš„æ˜¯ä½è¿ç®—åœ¨æƒé™æ§åˆ¶ä¸­çš„åº”ç”¨
   */
  if (children) {
    let temp = 0;
    // å­èŠ‚ç‚¹çš„æ•°æ®æ ¼å¼ï¼Œæš‚æ—¶åªè€ƒè™‘æ•°ç»„å’Œå­—ç¬¦ä¸²
    if (isArray(children)) {
      temp = ShapeFlags.ARRAY_CHILDREN;
    } else {
      children = String(children);
      temp = ShapeFlags.TEXT_CHILDREN;
    }
    vnode.shapeFlag = vnode.shapeFlag | temp;
  }

  return vnode;
}
```

**è™šæ‹ŸDOMèŠ‚ç‚¹ä¸Šé‡è¦çš„å±æ€§**ï¼š

- `type`ï¼š==çœŸå®èŠ‚ç‚¹çš„ç±»å‹==
- `el`ï¼š==çœŸå®DOMèŠ‚ç‚¹==

`createVNode`çš„å®ç°ä¸­åº”ç”¨åˆ°äº†ä½è¿ç®—æ¥==æ ‡è¯†`children VNode`çš„ç±»å‹==

`VNode`ä¸Šçš„`shapeFlag`å±æ€§ç”¨æ¥å­˜å‚¨ä½è¿ç®—çš„ç»“æœï¼Œ==æ ‡è®°è‡ªå·±çš„ç±»å‹åŠchildrenèŠ‚ç‚¹çš„ç±»å‹==

<!--å…³äºä½è¿ç®—åœ¨æƒé™æ§åˆ¶ä¸­çš„åº”ç”¨ï¼Œå•ç‹¬å†™äº†ç¯‡ç¬”è®°è®°å½•-->

##### 2.3.2ã€`h`å®ç°

`h`æ–¹æ³•æ˜¯`createVNode`çš„é‡è½½æ–¹æ³•ï¼Œå¤„ç†ä¸åŒçš„å…¥å‚æƒ…å†µæ—¶å¦‚ä½•è°ƒç”¨`createVNode`

> `createVNode`å…¥å‚å¯èƒ½çš„æƒ…å†µ
>
> - å…ƒç´  å†…å®¹
> -  å…ƒç´  å±æ€§ å†…å®¹
> - å…ƒç´  å±æ€§ å¤šä¸ªå„¿å­
> - å…ƒç´  å„¿å­ / å…ƒç´     (åªè¦ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œéƒ½ä¼šæŠŠå„¿å­è½¬æˆæ•°ç»„)
> - å…ƒç´  ç©ºå±æ€§ å¤šä¸ªå„¿å­
> - ...

```typescript
// packages/runtime-core/src/h.ts
import { isArray, isObject } from '@vue/shared';
import { isVnode, createVNode } from './createVNode';

/**
 * hæ–¹æ³•æ˜¯createVNodeçš„é‡è½½æ–¹æ³•
 * å¤„ç†ä¸åŒçš„å…¥å‚æƒ…å†µæ—¶å¦‚ä½•è°ƒç”¨createVNode`
 * createVNodeå…¥å‚å¯èƒ½çš„æƒ…å†µ
 * 1) å…ƒç´  å†…å®¹
 * 2) å…ƒç´  å±æ€§ å†…å®¹
 * 3) å…ƒç´  å±æ€§ å¤šä¸ªå„¿å­
 * 4) å…ƒç´  å„¿å­ / å…ƒç´  (åªè¦ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œéƒ½ä¼šæŠŠå„¿å­è½¬æˆæ•°ç»„)
 * 5) å…ƒç´  ç©ºå±æ€§ å¤šä¸ªå„¿å­
 * æ³¨æ„å­èŠ‚ç‚¹æ˜¯ï¼šæ•°ç»„ã€æ–‡æœ¬ã€null
 */
export function h(type, propsOrChildren, children) {
  const l = arguments.length;
  if (l === 2) {
    // å‚æ•°ä¸ºä¸¤ä¸ªçš„æƒ…å†µ 1ï¼‰ å…ƒç´  + å±æ€§ 2ï¼‰ å…ƒç´  + children
    if (isObject(propsOrChildren) && !isArray(propsOrChildren)) {
      // è‹¥propsOrChildrenæ˜¯å¯¹è±¡çš„è¯ åˆ™å…¶å¯èƒ½æ˜¯å±æ€§ä¹Ÿæœ‰å¯èƒ½æ˜¯children VNode
      if (isVnode(propsOrChildren)) {
        // children VNode å°†å…¶ç”¨æ•°ç»„åŒ…èµ·æ¥ h(type,å…ƒç´ å¯¹è±¡)
        return createVNode(type, null, [propsOrChildren]);
      }
      // å±æ€§ h(type,å±æ€§)
      return createVNode(type, propsOrChildren);
    } else {
      // è‹¥propsOrChildrenä¸æ˜¯å¯¹è±¡çš„è¯ï¼Œé‚£å…¶ä¸€å®šæ˜¯children VNode
      // children VNodeæ˜¯ æ•°ç»„ æˆ–è€… å­—ç¬¦ h(type,[] ) h(type,'æ–‡æœ¬â€˜)
      return createVNode(type, null, propsOrChildren);
    }
  } else {
    // å‚æ•°å¤§äºä¸¤ä¸ªçš„æƒ…å†µ,åˆ™ä¸€å®šæ˜¯ å…ƒç´  + å±æ€§ + children
    if (l === 3 && isVnode(children)) {
      // åªæœ‰ä¸‰ä¸ªå‚æ•° h(type,å±æ€§ï¼Œchildren) å°†childrenç”¨æ•°ç»„åŒ…èµ·æ¥
      children = [children];
    } else if (l > 3) {
      // å¤§äºä¸‰ä¸ªå‚æ•° h(type,å±æ€§ï¼Œchildren1ï¼Œchildren2ï¼Œ...) å°†childrenå¤„ç†æˆæ•°ç»„
      children = Array.from(arguments).slice(2);
    }
    return createVNode(type, propsOrChildren, children);
  }
}
```

```typescript
// packages/runtime-core/src/createVNode.ts

/**
 * åˆ¤æ–­æ˜¯å¦æ˜¯VNode
 */
export function isVnode(val) {
  return !!val.__v_isVNode;
}
```

##### 2.3.3ã€`createRenderer` å®ç° â€¼ï¸

==åœ¨`createRenderer` ä¸­éœ€è¦å®ç°`VNode`çš„åˆå§‹åŒ–æŒ‚è½½ã€`diff`æ›´æ–°ã€å¸è½½==

 <!--æ ¸å¿ƒæ–¹æ³•ï¼Œå¾ˆé‡è¦-->

###### 2.3.3.1ã€`createRenderer`æ•´ä½“ç»“æ„

```typescript
// packages/runtime-core/src/renderer.ts

export function createRenderer(options){
  // ä¼ å…¥è¿›æ¥çš„renderOptions
  let {
    patchProp: hostPatchProp, // å¯¹èŠ‚ç‚¹å±æ€§çš„æ“ä½œ
    createElement: hostCreateElement, // åˆ›å»ºå…ƒç´ 
    createTextNode: hostCreateTextNode, // åˆ›å»ºæ–‡æœ¬
    createText: hostCreateText,
    querySelector: hostQuerySelector,
    insert: hostInsert,
    remove: hostRemove,
    setText: hostSetText,
    setElementText: hostSetElementText,
    parentNode: hostParentNode,
    nextSibling: hostNextSibling
  } = options;
    
  const unmount = (n1) => {
    // å¸è½½é€»è¾‘åœ¨è¿™é‡Œå®ç°
  }
  
  const patch = (n1,n2,container) => {
    // åˆå§‹åŒ–å’Œdiffç®—æ³•éƒ½åœ¨è¿™é‡Œå®ç°
  }
    
/**
   * DOMçš„æ¸²æŸ“æ–¹æ³•
   * è´Ÿè´£DOMçš„åˆå§‹åŒ–æŒ‚è½½ã€æ›´æ–°ã€å¸è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container å®¹å™¨ï¼ŒçœŸå®çš„DOMèŠ‚ç‚¹
   */
  function render(vnode, container) {
    // æˆ‘ä»¬éœ€è¦å°†vnodeæ¸²æŸ“åˆ°containerä¸­ï¼Œå¹¶ä¸”è°ƒç”¨optionsä¸­çš„api
    if (vnode == null) {
      // å¸è½½
      if (container._vnode) {
        unmount(container._vnode);
      }
    } else {
      // åˆå§‹åŒ–æŒ‚è½½å’Œæ›´æ–°
      patch(container._vnode || null, vnode, container);
    }
    // ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™å°±å°†vnodeä¿ç•™åˆ°äº†å®¹å™¨ä¸Šï¼Œç”¨äºåç»­åŒºåˆ†æ˜¯åˆå§‹åŒ–æŒ‚è½½è¿˜æ˜¯æ›´æ–°
    container._vnode = vnode; 
  }
  
  return {
    render
  };
}
```

å¯ä»¥å…ˆçœ‹ä¸‹`createRenderer`æ•´ä½“ç»“æ„ï¼Œåé¢ä¼šåœ¨`createRenderer`ä¸­å®ç°==**æŒ‚è½½**==ã€==**å¸è½½**==ã€==**æ›´æ–°**==çš„é€»è¾‘

------

`createRenderer`æ–¹æ³•éœ€è¦é€šè¿‡`runtime-dom`æ¨¡å—æš´éœ²å‡ºå»ï¼Œå¦å¤–è¿˜è¦æš´éœ²å‡ºä½¿ç”¨å†…ç½®`rendererOptions`ç”Ÿæˆçš„`render`

```typescript
// packages/runtime-dom/src/index.ts

import { createRenderer } from '@vue/runtime-core';
import { nodeOps } from './nodeOps';
import { patchProp } from './patchProp';

export * from '@vue/runtime-core';

const renderOptions = { patchProp, ...nodeOps };
/**
 * vueå†…ç½®çš„æ¸²æŸ“å™¨
 * ä½¿ç”¨createRendereræ­é…å†…ç½®çš„renderOptionsï¼ˆæµè§ˆå™¨å¹³å°çš„æ¸²æŸ“é…ç½®é¡¹ï¼‰
 * åˆ›å»ºçš„æ¸²æŸ“å™¨
 */
export function render(vnode, container) {
  let { render } = createRenderer(renderOptions);
  return render(vnode, container);
}

```

###### 2.3.3.2ã€åˆå§‹åŒ–æŒ‚è½½

```typescript
// packages/runtime-core/src/renderer.ts

import { isNumber, isString } from '@vue/shared';
import {
  ShapeFlags,
  Text,
  createVNode,
  isSameVNode,
  Fragment
} from './createVNode';

export function createRenderer(options) {
  // ä¼ å…¥è¿›æ¥çš„renderOptionsï¼Œï¼Œå†…éƒ¨å±æ€§éƒ½æ˜¯DOM Api
  let {
    patchProp: hostPatchProp, // å¯¹èŠ‚ç‚¹å±æ€§çš„æ“ä½œ
    createElement: hostCreateElement, // åˆ›å»ºå…ƒç´ 
    createTextNode: hostCreateTextNode, // åˆ›å»ºæ–‡æœ¬
    createText: hostCreateText,
    querySelector: hostQuerySelector,
    insert: hostInsert,
    remove: hostRemove,
    setText: hostSetText,
    setElementText: hostSetElementText,
    parentNode: hostParentNode,
    nextSibling: hostNextSibling
  } = options;

  /**
   * æ ¼å¼åŒ–children
   * childrenæœ‰å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œéœ€è¦å°†å…¶å¤„ç†æˆVNode
   */
  function normalize(children, i) {
    if (isString(children[i]) || isNumber(children[i])) {
      children[i] = createVNode(Text, null, children[i]);
    }
    return children[i];
  }

  /**
   * æŒ‚è½½childrençš„æ–¹æ³•
   */
  function mountChildren(children, container) {
    for (let i = 0; i < children.length; i++) {
      // æ ¼å¼åŒ–children child å¯èƒ½æ˜¯æ–‡æœ¬ éœ€è¦æŠŠæ–‡æœ¬ä¹Ÿå˜æˆè™šæ‹ŸèŠ‚ç‚¹
      let child = normalize(children, i);
      // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
      patch(null, child, container);
    }
  }

  /**
   * å…ƒç´ ç±»å‹çš„VNodeçš„æŒ‚è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container çˆ¶å®¹å™¨
   * @param anchor é”šç‚¹ ç”¨äºçœŸå®èŠ‚ç‚¹çš„insertæ“ä½œ
   * mountElementè¢«é€’å½’è°ƒç”¨ï¼Œä¸æ–­çš„å°†æ ¹æ®VNodeç”Ÿæˆçš„çœŸå®èŠ‚ç‚¹insertåˆ°çˆ¶å®¹å™¨ä¸­
   * æœ€ç»ˆç”Ÿæˆå®Œæ•´çš„DOMï¼Œ
   * æœ€åå†å°†DOM insertåˆ°æ ¹èŠ‚ç‚¹ï¼ˆç”¨æˆ·æŒ‡å®šçš„çœŸå®èŠ‚ç‚¹ï¼‰ä¸Š
   * ä¾¿å®ŒæˆæŒ‚è½½
   */
  function mountElement(vnode, container, anchor) {
    let { type, children, shapeFlag } = vnode;

    /**
     * åˆ›å»ºçœŸå®èŠ‚ç‚¹
     * å¹¶ä¿å­˜åœ¨VNodeçš„elå±æ€§ä¸Šä¿å­˜ä¸‹æ¥
     * åç»­éœ€è¦æ¯”å¯¹è™šæ‹ŸèŠ‚ç‚¹çš„å·®å¼‚ï¼Œæ›´æ–°é¡µé¢
     * æ‰€ä»¥éœ€è¦ä¿ç•™å¯¹åº”çš„çœŸå®èŠ‚ç‚¹
     */
    let el = (vnode.el = hostCreateElement(type));

    if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
      // childrenæ˜¯æ–‡æœ¬ï¼Œç›´æ¥è®¾ç½®çœŸå®èŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹å³å¯
      hostSetElementText(el, children);
    }
    if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      // childrenæ˜¯æ•°ç»„ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥å¤„ç†
      mountChildren(children, el);
    }

    /**
     * æŒ‚è½½æ“ä½œ
     * å°†æ ¹æ®VNodeç”Ÿæˆçš„çœŸå®èŠ‚ç‚¹elæŒ‚è½½åˆ°çˆ¶å®¹å™¨ä¸­
     */
    hostInsert(el, container, anchor);
  }

  /**
   * æ–‡æœ¬ç±»å‹çš„VNodeçš„æŒ‚è½½å’Œæ›´æ–°å¤„ç†
   */
  function processText(n1, n2, container) {
    if (n1 == null) {
      hostInsert(
        (n2.el = hostCreateTextNode(n2.children)),
        container
      );
    } else {
     // åç»­æ›´æ–°å¤„ç†é€»è¾‘
    }
  }

  /**
   * å…ƒç´ ç±»å‹çš„VNodeçš„æŒ‚è½½å’Œæ›´æ–°å¤„ç†
   */
  function processElement(n1, n2, container, anchor) {
    if (n1 == null) {
      mountElement(n2, container, anchor);
    } else {
      // åç»­æ›´æ–°å¤„ç†é€»è¾‘
    }
  }

  /**
   * VNodeçš„åˆå§‹åŒ–æŒ‚è½½å’Œdiffæ›´æ–°
   * @param n1 å®¹å™¨ä¸Šä¿å­˜çš„ä¸Šä¸€æ¬¡çš„VNode
   * @param n2 æ–°çš„VNode
   * @param container å®¹å™¨ çœŸå®çš„DOMèŠ‚ç‚¹
   */
  const patch = (n1, n2, container, anchor = null) => {
    /**
     * n1 å¦‚æœæ˜¯null è¯´æ˜æ˜¯åˆå§‹åŒ–æŒ‚è½½
     * n1 å¦‚æœæœ‰å€¼ è¯´æ˜æ˜¯æ›´æ–° è¦èµ°diffç®—æ³•
     */
    const { type, shapeFlag } = n2;
    switch (type) {
      case Text:
        processText(n1, n2, container);
        break;
      default:
        if (shapeFlag & ShapeFlags.ELEMENT) {
          // é€šè¿‡ä½è¿ç®—åˆ¤æ–­å½“å‰VNodeæ˜¯å…ƒç´ ç±»å‹
          processElement(n1, n2, container, anchor);
        }
    }
  };

  /**
   * DOMçš„æ¸²æŸ“æ–¹æ³•
   * è´Ÿè´£DOMçš„åˆå§‹åŒ–æŒ‚è½½ã€æ›´æ–°ã€å¸è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container å®¹å™¨ï¼ŒçœŸå®çš„DOMèŠ‚ç‚¹
   */
  function render(vnode, container) {
    if (vnode == null) {
      // å¸è½½é€»è¾‘
    } else {
      // åˆå§‹åŒ–æŒ‚è½½å’Œæ›´æ–°
      patch(container._vnode || null, vnode, container);
    }
    // ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™å°±å°†vnodeä¿ç•™åˆ°äº†å®¹å™¨ä¸Šï¼Œç”¨äºåç»­åŒºåˆ†æ˜¯åˆå§‹åŒ–æŒ‚è½½è¿˜æ˜¯æ›´æ–°
    container._vnode = vnode;
  }

  return {
    render
  };
}
```

å…ˆçœ‹ä½¿ç”¨æ•ˆæœğŸ‘‡

```html
<!-- packages/runtime-dom/dist/index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <!-- <script src="../../../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js"></script> -->
  <script src="./runtime-dom.global.js"></script>
  <div id="app"></div>

  <script>
    const { h, createVNode, render } = VueRuntimeDOM

    const vnode1 = createVNode('p', {}, 'hello world')
    const vnode2 = h('h1', [vnode1, 'Vue3.0'])

    // æ¸²æŸ“å™¨å°±æ˜¯ä¸ºäº†ç”¨æˆ·æ–¹ä¾¿æ‰©å±•ï¼Œvueä¸­å†…ç½®äº† èŠ‚ç‚¹æ“ä½œå¯ä»¥ç›´æ¥ä½¿ç”¨
    render(vnode2,app)
  </script>
</body>

</html>
```

![image-20220614085300891](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220614085300891.png)

ä¸Šé¢ğŸ‘†åˆå§‹åŒ–æŒ‚è½½çš„å®ç°ä¸­ï¼Œ==æ ¸å¿ƒåœ¨äºæŒ‚è½½`children`ä¸­çš„**é€’å½’è°ƒç”¨`patch`**==

```typescript
  function mountChildren(children, container) {
    for (let i = 0; i < children.length; i++) {
      // æ ¼å¼åŒ–children child å¯èƒ½æ˜¯æ–‡æœ¬ éœ€è¦æŠŠæ–‡æœ¬ä¹Ÿå˜æˆè™šæ‹ŸèŠ‚ç‚¹
      let child = normalize(children, i);
      // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
      patch(null, child, container);
    }
  }
```

æ•´ä¸ªåˆå§‹åŒ–æŒ‚è½½çš„æµç¨‹å¦‚ä¸‹ğŸ‘‡

1. æ ¹æ®æ ¹`VNode`çš„`type`å±æ€§ï¼Œç”Ÿæˆæ ¹`VNode`å¯¹åº”çš„==çœŸå®DOMèŠ‚ç‚¹==(`n0`)  â¬‡ï¸
2. éå†`VNode`çš„`children`==**é€’å½’è°ƒç”¨**`patch`==å¹¶ç”Ÿæˆå¯¹åº”çš„==å­èŠ‚ç‚¹çš„çœŸå®DOMèŠ‚ç‚¹==(`nx`) â¬‡ï¸
3. æ¯ç”Ÿæˆä¸€ä¸ª`nx`ï¼Œ==å°±å°†å…¶`insert`åˆ°çˆ¶èŠ‚ç‚¹çš„çœŸå®DOMèŠ‚ç‚¹ä¸Š==ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„DOM â¬‡ï¸
4. æœ€åå†å°†æ ¹`VNode`çš„çœŸå®DOMèŠ‚ç‚¹ <!--ä¸€æ£µå®Œæ•´çš„DOMæ ‘--> `insert`åˆ°æŒ‡å®šå¥½çš„æ ¹èŠ‚ç‚¹ï¼ˆ`#app`ï¼‰ä¸Šä¾¿å®Œæˆäº†==åˆå§‹åŒ–æŒ‚è½½==

==æ•´ä¸ªåˆå§‹åŒ–æŒ‚è½½çš„æµç¨‹å¹¶ä¸å¤æ‚ï¼Œå°±æ˜¯æ ¹æ®`VNode`åˆ›å»ºçœŸå®DOMèŠ‚ç‚¹ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€æ£µå®Œæ•´çš„DOMæ ‘æŒ‚è½½åˆ°å®¹å™¨ä¸Š==

###### 2.3.3.3ã€å¸è½½

å¸è½½é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œç›´æ¥`remove`æ‰å°±å¯ä»¥äº†ï¼Œç›´æ¥å°†çœŸå®DOMèŠ‚ç‚¹ç§»é™¤

<!--VNodeä¸Šçš„elå±æ€§å­˜æ”¾çš„æ˜¯å½“å‰è™šæ‹ŸDOMèŠ‚ç‚¹å¯¹åº”çš„çœŸå®DOMèŠ‚ç‚¹-->

```typescript
// packages/runtime-core/src/renderer.ts

export function createRenderer(options) {
  // ...

  /**
   * VNodeçš„å¸è½½
   */
  const unmount = n1 => {
    hostRemove(n1.el);
  };

  function render(vnode, container) {
    if (vnode == null) {
      // å¸è½½é€»è¾‘
      unmount(container._vnode);
    } else {
      // åˆå§‹åŒ–æŒ‚è½½å’Œæ›´æ–°
      patch(container._vnode || null, vnode, container);
    }
    // ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™å°±å°†vnodeä¿ç•™åˆ°äº†å®¹å™¨ä¸Šï¼Œç”¨äºåç»­åŒºåˆ†æ˜¯åˆå§‹åŒ–æŒ‚è½½è¿˜æ˜¯æ›´æ–°
    container._vnode = vnode;
  }

  return {
    render
  };
}
```

###### 2.3.3.4ã€diffæ›´æ–°

==Vueçš„`diff`é‡‡ç”¨çš„æ˜¯åŒçº§èŠ‚ç‚¹æ¯”å¯¹ï¼Œçˆ¶èŠ‚ç‚¹æ¯”å¯¹å®Œæˆä¹‹åä¼šé€’å½’æ¯”å¯¹å­èŠ‚ç‚¹==

åŒä¸€èŠ‚ç‚¹æœ‰ä¸¤ç§å˜åŒ–æƒ…å†µï¼š

- **å‰åå…ƒç´ ä¸ä¸€è‡´**
- **å‰åå…ƒç´ ä¸€è‡´**

ä¸‹é¢ğŸ‘‡å°†è¿™ä¸¤ç§æƒ…å†µè¿›è¡Œå®ç°

------

==**å‰åå…ƒç´ ä¸ä¸€è‡´**==

==ä¸¤ä¸ªä¸åŒè™šæ‹ŸèŠ‚ç‚¹ä¸éœ€è¦è¿›è¡Œæ¯”è¾ƒï¼Œç›´æ¥ç§»é™¤è€èŠ‚ç‚¹ï¼Œå°†æ–°çš„è™šæ‹ŸèŠ‚ç‚¹æ¸²æŸ“æˆçœŸå®DOMè¿›è¡ŒæŒ‚è½½å³å¯==

å®ç°å¦‚ä¸‹ğŸ‘‡

```typescript
// packages/runtime-core/src/renderer.ts
  const patch = (n1, n2, container, anchor = null) => {
    // è‹¥n1æœ‰å€¼ä¸”n2ã€n1ä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜æ˜¯è¦å°†n1æ›¿æ¢æˆn2
    if (n1 && !isSameVNode(n1, n2)) {
      // å¸è½½n1å¹¶é‡åˆ¶ä¸ºnullï¼Œåç»­èµ°n2çš„åˆå§‹åŒ–
      unmount(n1);
      n1 = null;
    }

  /**
   * æ­¤æ—¶n1è¢«ç½®ä¸ºnullï¼Œæ¥ä¸‹æ¥èµ°æŒ‚è½½é€»è¾‘
   * åŒåˆå§‹åŒ–æŒ‚è½½ä¸€è‡´
   */
    const { type, shapeFlag } = n2;
    switch (type) {
      case Text:
        processText(n1, n2, container);
        break;
      case Fragment:
        processFragment(n1, n2, container);
        break;
      default:
        if (shapeFlag & ShapeFlags.ELEMENT) {
          // é€šè¿‡ä½è¿ç®—åˆ¤æ–­å½“å‰VNodeæ˜¯å…ƒç´ ç±»å‹
          processElement(n1, n2, container, anchor);
        }
    }
  };

```

```typescript
// packages/runtime-core/src/createVNode.ts
/**
 * åˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒVNode
 */
export function isSameVNode(v1, v2) {
  return v1.type === v2.type && v1.key == v2.key;
}
```

==å‰åå…ƒç´ ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå°±ç›´æ¥ä½¿ç”¨æ–°å…ƒç´ æ›¿æ¢è€å…ƒç´ ï¼Œç›¸å½“äºç›´æ¥å¸è½½è€å…ƒç´ ï¼Œä¸ç”¨è€ƒè™‘å­èŠ‚ç‚¹æœ‰æ²¡æœ‰å¤ç”¨==

------

==**å‰åå…ƒç´ ä¸€è‡´**==

==å‰åå…ƒç´ ä¸€è‡´åˆ™æ¯”è¾ƒä¸¤ä¸ªå…ƒç´ çš„å±æ€§å’Œå­èŠ‚ç‚¹==

å®ç°å¦‚ä¸‹ğŸ‘‡

```typescript
const patch = (n1, n2, container, anchor = null) => {
    // ... 

    /**
     * ç”±äºisSameVNode(n1, n2ï¼‰ä¸ºtrueï¼Œn1æ²¡æœ‰è¢«ç½®ä¸ºnull
     * n1æœ‰å€¼ è¯´æ˜æ˜¯æ›´æ–° è¦èµ°diffç®—æ³•
     */
    const { type, shapeFlag } = n2;
    switch (type) {
      case Text:
        processText(n1, n2, container);
        break;
      case Fragment:
        processFragment(n1, n2, container);
        break;
      default:
        if (shapeFlag & ShapeFlags.ELEMENT) {
          // é€šè¿‡ä½è¿ç®—åˆ¤æ–­å½“å‰VNodeæ˜¯å…ƒç´ ç±»å‹
          processElement(n1, n2, container, anchor);
        }
    }
  };
```

```typescript
function processElement(n1, n2, container, anchor) {
    if (n1 == null) {
      // ...
    } else {
      patchElement(n1, n2);
    }
}
```

```typescript

/**
 * VNodeçš„diffæ›´æ–°å¤„ç†
 */
function patchElement(n1, n2) {
  // n1 å’Œ n2 èƒ½å¤ç”¨è¯´æ˜domèŠ‚ç‚¹å°±ä¸ç”¨åˆ é™¤äº†

  // å¤ç”¨çœŸå®DOMèŠ‚ç‚¹,ä¸ç”¨åˆ é™¤
  let el = (n2.el = n1.el);

  let oldProps = n1.props;
  let newProps = n2.props;
  // æ¯”è¾ƒå±æ€§
  patchProps(oldProps, newProps, el);

  // æ¯”è¾ƒchildren
  patchChildren(n1, n2, el);
}
```

æ¯”è¾ƒå±æ€§å¹¶æ›´æ–°`patchProps(oldProps, newProps, el)`å®ç°å¦‚ä¸‹ğŸ‘‡

```typescript
/**
 * æ›´æ–°å±æ€§çš„æ–¹æ³•
 */
function patchProps(oldProps, newProps, el) {
  if (oldProps == null) oldProps = {};
  if (newProps == null) newProps = {};

  // å¾ªç¯newPropsè¦†ç›–oldProps
  for (let key in newProps) {
    hostPatchProp(el, key, oldProps[key], newProps[key]);
  }
  // oldPropsä¸­æœ‰çš„ï¼Œä½†newPropsæ²¡æœ‰çš„ï¼Œè¦åˆ é™¤
  for (let key in oldProps) {
    if (newProps[key] == null) {
      hostPatchProp(el, key, oldProps[key], null);
    }
  }
}
```

==å­èŠ‚ç‚¹çš„æ¯”å¯¹ `patchChildren(n1, n2, el)` æ¯”è¾ƒå¤æ‚ï¼Œåˆ†ä¸ºä»¥ä¸‹çš„æƒ…å†µ==â€¼ï¸ 

<!--è¿™é‡Œä¹Ÿæ˜¯diffå¤§é‡è®¡ç®—çš„åœ°æ–¹-->

| æ–°å­èŠ‚ç‚¹ | æ—§å­èŠ‚ç‚¹ | æ“ä½œæ–¹å¼                   |
| :------- | :------- | :------------------------- |
| æ–‡æœ¬     | æ•°ç»„     | åˆ é™¤æ—§å­èŠ‚ç‚¹ï¼Œè®¾ç½®æ–‡æœ¬å†…å®¹ |
| æ–‡æœ¬     | æ–‡æœ¬     | æ›´æ–°æ–‡æœ¬å³å¯               |
| æ–‡æœ¬     | ç©º       | æ›´æ–°æ–‡æœ¬å³å¯ ä¸ä¸Šé¢çš„ç±»ä¼¼  |
| æ•°ç»„     | æ•°ç»„     | diffç®—æ³•                   |
| æ•°ç»„     | æ–‡æœ¬     | æ¸…ç©ºæ–‡æœ¬ï¼Œè¿›è¡ŒæŒ‚è½½         |
| æ•°ç»„     | ç©º       | è¿›è¡ŒæŒ‚è½½ ä¸ä¸Šé¢çš„ç±»ä¼¼      |
| ç©º       | æ•°ç»„     | åˆ é™¤æ‰€æœ‰æ—§å­èŠ‚ç‚¹           |
| ç©º       | æ–‡æœ¬     | æ¸…ç©ºæ–‡æœ¬                   |
| ç©º       | ç©º       | æ— éœ€å¤„ç†                   |

æ¯”è¾ƒå­èŠ‚ç‚¹å¹¶æ›´æ–° `patchChildren(n1, n2, el)`å®ç°å¦‚ä¸‹ğŸ‘‡

```typescript
/**
   * æ›´æ–°å­èŠ‚ç‚¹çš„æ–¹æ³•
   * @param n1 æ—§èŠ‚ç‚¹
   * @param n2 æ–°èŠ‚ç‚¹
   * @param el çœŸå®çš„DOMèŠ‚ç‚¹
   */
  function patchChildren(n1, n2, el) {
    let c1 = n1.children;
    let c2 = n2.children;

    const prevShapeFlag = n1.shapeFlag;
    const shapeFlag = n2.shapeFlag;

    if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
      /**
       * æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬
       * æ•°ç»„ â€”â€”> æ–‡æœ¬
       * æ–‡æœ¬ â€”â€”> æ–‡æœ¬
       * ç©º â€”â€”> æ–‡æœ¬
       * è‹¥æ—§å­èŠ‚ç‚¹æ˜¯æ•°ç»„ï¼Œåˆ™éœ€å…ˆåˆ é™¤æ—§å­èŠ‚ç‚¹ï¼Œå†è®¾ç½®æ–‡æœ¬å†…å®¹
       * ä¸æ˜¯çš„è¯ï¼Œç›´æ¥è®¾ç½®æ–‡æœ¬å†…å®¹
       */
      if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
        unmountChildren(c1);
      }
      if (c1 !== c2) {
        hostSetElementText(el, c2);
      }
    } else {
      // æ–°å­èŠ‚ç‚¹æ˜¯æ•°ç»„å’Œç©ºçš„æƒ…å†µ
      if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
        // æ—§å­èŠ‚ç‚¹æ˜¯æ•°ç»„
        if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
          /**
           * æ–°å­èŠ‚ç‚¹ä¹Ÿæ˜¯æ•°ç»„
           * æ•°ç»„ â€”â€”> æ•°ç»„
           * diffç®—æ³•
           */
          patchKeyedChildren(c1, c2, el);
        } else {
          /**
           * æ–°å­èŠ‚ç‚¹æ˜¯ç©º
           * æ•°ç»„ â€”â€”> ç©º
           * åˆ é™¤æ‰€æœ‰æ—§å­èŠ‚ç‚¹
           */
          unmountChildren(c1);
        }
      } else {
        /**
         * æ—§å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬æˆ–ç©º
         * æ–‡æœ¬ â€”â€”> æ•°ç»„
         * æ–‡æœ¬ â€”â€”> ç©º
         * ç©º â€”â€”> æ•°ç»„
         * ç©º â€”â€”> ç©º
         * æ—§å­èŠ‚ç‚¹è‹¥æ˜¯æ–‡æœ¬ï¼Œåˆ™æ¸…ç©ºå†æŒ‚è½½æ–°å­èŠ‚ç‚¹
         * ä¸æ˜¯åˆ™ç›´æ¥æŒ‚è½½æ–°å­èŠ‚ç‚¹
         */
        if (prevShapeFlag & ShapeFlags.TEXT_CHILDREN) {
          hostSetElementText(el, '');
        }
        if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
          mountChildren(c2, el);
        }
      }
    }
  }
```

å…¶ä¸­==åªæœ‰å½“æ–°æ—§å­èŠ‚ç‚¹éƒ½æ˜¯æ•°ç»„çš„æƒ…å†µå¤æ‚äº›==ï¼Œè¦ä½¿ç”¨`diff`ï¼Œè¿™ä¸ªä¸‹é¢å•ç‹¬æ‹å‡ºæ¥å®ç°ï¼›

`unmountChildren`çš„å®ç°

```typescript
  /**
   * å¸è½½å­èŠ‚ç‚¹çš„æ–¹æ³•
   */
  function unmountChildren(children) {
    children.forEach(child => {
      unmount(child);
    });
  }
```

###### 2.3.3.5ã€æ ¸å¿ƒdiffç®—æ³•

Vue `diff`çš„**åŸåˆ™**æ˜¯==å°½å¯èƒ½**å¤ç”¨**èŠ‚ç‚¹==ï¼Œè€Œä¸”æ‰¾åˆ°å˜åŒ–çš„ä½ç½®ï¼›

Vueçš„`diff`å¯ä»¥åˆ†ä¸ºä¸¤ç§

- `patchKeyedChildren`ï¼šå¯¹æœ‰`key`å€¼çš„`children` è¿›è¡Œ`diff`
- `patchUnkeyedChildren`ï¼šå¯¹æ— `key`å€¼çš„`children`è¿›è¡Œ `diff` 

<!--ä¸‹é¢å®ç°çš„æ˜¯`patchKeyedChildren`ï¼Œ`patchUnkeyedChildren`åç»­å†è¡¥å……-->

`patchKeyedChildren`ä¸»è¦==å°±æ˜¯å°†æ–°æ—§ä¸¤ä¸ª`children`æ•°ç»„çš„æ¯ä¸€é¡¹è¿›è¡Œæ¯”å¯¹==

- é¦–å…ˆæ˜¯å¯¹äºé‚£äº›æœ‰è§„å¾‹çš„ï¼ˆ`common sequence`ï¼‰éƒ¨åˆ†å…ˆæ‰¾åˆ°`key`å’Œ`type`ç›¸åŒçš„ä¸¤é¡¹è¿›è¡Œå¤ç”¨
- ç„¶åæ˜¯`mount`æ–°å¢çš„å’Œ`unmount`åˆ é™¤çš„
- æœ€åæ˜¯å¯¹äºé‚£äº›ä¹±åºçš„ï¼ˆ`unknown sequence`ï¼‰éƒ¨åˆ†è¿›è¡Œæ¯”å¯¹æ‰¾åˆ°å¯ä»¥å¤ç”¨çš„

------

`common sequence`çš„å¤„ç†ï¼š

**sync from startï¼š**==ä»å¤´éƒ¨å¼€å§‹è¿›è¡Œå¯¹æ¯”ï¼Œ**é‡åˆ°ä¸åŒçš„å°±ç»“æŸ**==

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/diff-1.633a1a31.png)

ä¸¤ç§æƒ…å†µï¼š

1. æ—§çš„æ¯”è¾ƒå¤š

   æ–°çš„å­èŠ‚ç‚¹ï¼š(a b) c

   æ—§çš„å­èŠ‚ç‚¹ï¼š(a b)

   å½“ i > e2 è¯´æ˜æ–°çš„æ¯”å¯¹å®Œæˆäº†ï¼Œä½†æ˜¯æ—§çš„è¿˜æœ‰å‰©ä½™ï¼Œä¹Ÿå°±æ˜¯è¯´i åˆ° e1ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦åˆ é™¤çš„

2. æ–°çš„æ¯”è¾ƒå¤š

   æ–°çš„å­èŠ‚ç‚¹ï¼š(a b)

   æ—§çš„å­èŠ‚ç‚¹ï¼š(a b) c

   å½“i > e1 è¯´æ˜æ—§çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ–°çš„è¿˜æœ‰å‰©ä½™ï¼Œä¹Ÿå°±æ˜¯è¯´i åˆ° e2ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦æ–°å¢çš„

```js
 h('div',[
     h('li', { key: 'a' }, 'a'),
     h('li', { key: 'b' }, 'b'),
     h('li', { key: 'c' }, 'c')
 ]) : 
 h('div',[
     h('li', { key: 'a' }, 'a'),
     h('li', { key: 'b' }, 'b'),
     h('li', { key: 'd' }, 'd'),
     h('li', { key: 'e' }, 'e')
 ])
```

```typescript
  /**
   * children diff æ–¹æ³•
   * @param {Array} c1 æ—§çš„children
   * @param {Array} c2 æ–°çš„çš„children
   * @param el çœŸå®çš„DOMèŠ‚ç‚¹ï¼ˆå¯¹äºc1ã€c2æ¥è¯´æ˜¯çˆ¶èŠ‚ç‚¹ï¼‰
   * diff c1 å’Œ c2 ä¸¤ä¸ªæ•°ç»„ä¹‹é—´çš„å·®å¼‚å¹¶è¿›è¡Œæ›´æ–°
   * åŸåˆ™ï¼šå°½å¯èƒ½å¤ç”¨èŠ‚ç‚¹ï¼Œè€Œä¸”æ‰¾åˆ°å˜åŒ–çš„ä½ç½®
   */
  function patchKeyedChildren(c1, c2, el, parentComponent) {
    /**
     * iã€e1ã€e2å¯ä»¥ç†è§£ä¸ºæŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ˜¯childrenä¸­æŸä¸€ä¸ªchild
     * iæŒ‡å‘çš„æ˜¯sync from startæ–¹å‘çš„æŒ‡é’ˆ
     * e1ã€e2æŒ‡å‘çš„æ˜¯sync from endæ–¹å‘çš„æŒ‡é’ˆ
     */
    let i = 0;
    let e1 = c1.length - 1;
    let e2 = c2.length - 1;

    /**
     * 1. sync from start ä»å¤´å¼€å§‹æ¯”å¯¹
     * é‡åˆ°ä¸åŒçš„å°±ç»“æŸ
     * (a b) c
     * (a b)
     * å½“ i > e2 è¯´æ˜æ–°çš„æ¯”å¯¹å®Œæˆäº†ï¼Œä½†æ˜¯æ—§çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e1ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦åˆ é™¤çš„
     * (a b)
     * (a b) c
     * å½“i > e1 è¯´æ˜æ—§çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ–°çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e2ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦æ–°å¢çš„
     */
    while (i <= e1 && i <= e2) {
      const n1 = c1[i];
      const n2 = normalizeVNode(c2, i);
      if (isSameVNode(n1, n2)) {
        patch(n1, n2, el);
      } else {
        break;
      }
      i++;
    }
    
    // ...
  }
```

------

**sync from endï¼š**==ä»å°¾éƒ¨å¼€å§‹è¿›è¡Œå¯¹æ¯”ï¼Œ**é‡åˆ°ä¸åŒçš„å°±ç»“æŸ**==

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/diff-2.d3e4a7df.png)

ä¸¤ç§æƒ…å†µï¼š

1. æ—§çš„æ¯”è¾ƒå¤š

   æ—§çš„å­èŠ‚ç‚¹ï¼šd e (a b c)

   æ–°çš„å­èŠ‚ç‚¹ï¼š       (a b c)

   å½“i > e2 è¯´æ˜æ–°çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ—§çš„è¿˜æœ‰å‰©ä½™

   ä¹Ÿå°±æ˜¯è¯´i åˆ° e1ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦åˆ é™¤çš„

2. æ–°çš„æ¯”è¾ƒå¤š

   æ—§çš„å­èŠ‚ç‚¹ï¼š   (a b)

   æ–°çš„å­èŠ‚ç‚¹ï¼šc (a b)

   å½“ i > e1ï¼Œè¯´æ˜æ—§çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ–°çš„è¿˜æœ‰å‰©ä½™

   ä¹Ÿå°±æ˜¯è¯´i åˆ° e2ä¹‹é—´çš„å†…å®¹æ˜¯è¦æ–°å¢çš„

```js
 h('div',[
     h('li', { key: 'a' }, 'a'),
     h('li', { key: 'b' }, 'b'),
     h('li', { key: 'c' }, 'c')
 ]) : 
 h('div',[
     h('li', { key: 'd' }, 'd'),
     h('li', { key: 'e' }, 'e')
     h('li', { key: 'b' }, 'b'),
     h('li', { key: 'c' }, 'c'),

 ])
```

```typescript
  function patchKeyedChildren(c1, c2, el, parentComponent) {
    let i = 0;
    let e1 = c1.length - 1;
    let e2 = c2.length - 1;
    
    // ...

    /**
     * 2. sync from end ä»å°¾éƒ¨å¼€å§‹æ¯”å¯¹
     * é‡åˆ°ä¸åŒçš„å°±ç»“æŸ
     * d e (a b c)
     *     (a b c)
     * å½“i > e2 è¯´æ˜æ–°çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ—§çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e1ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦åˆ é™¤çš„
     *   (a b)
     * c (a b)
     * å½“ i > e1ï¼Œè¯´æ˜æ—§çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ–°çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e2ä¹‹é—´çš„å†…å®¹æ˜¯è¦æ–°å¢çš„
     */
    while (i <= e1 && i <= e2) {
      const n1 = c1[e1];
      const n2 = c2[e2];
      if (isSameVNode(n1, n2)) {
        patch(n1, n2, el);
      } else {
        break;
      }
      e1--;
      e2--;
    }

    
    // ...
  }
```

**common sequence + mount**

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/diff-3.747209db.png)

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/diff-4.07076735.png)

```typescript
  function patchKeyedChildren(c1, c2, el, parentComponent) {
    let i = 0;
    let e1 = c1.length - 1;
    let e2 = c2.length - 1;
    
    // ...

     if (i > e1) {
      /**
       * 3. common sequence + mount
       * (a b)
       * (a b) c
       * i = 2, e1 = 1, e2 = 2
       *   (a b)
       * c (a b)
       * i = 0, e1 = -1, e2 = 0
       */
      if (i <= e2) {
        /**
         * ç¡®å®šé”šç‚¹anchorï¼Œe2è‹¥æ˜¯c2çš„æœ€åä¸€é¡¹ï¼Œåˆ™é”šç‚¹ä¸ºnull
         * å°†æ–°å­èŠ‚ç‚¹c2[i]ç›´æ¥appendChildåˆ°çˆ¶èŠ‚ç‚¹ä¸Š
         * å¦åˆ™å°†æ–°å­èŠ‚ç‚¹c2[i] insertBefore åˆ°é”šç‚¹å‰
         */
        const nextPos = e2 + 1;
        let anchor = c2.length <= nextPos ? null : c2[nextPos].el;

        while (i <= e2) {
          patch(null, c2[i], el, anchor);
          i++;
        }
      }
    }

    // ...
  }
```

**common sequence + unmount**

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/diff-5.92c37bd1.png)

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/diff-6.58f193d3.png)

```typescript
  function patchKeyedChildren(c1, c2, el, parentComponent) {
    let i = 0;
    let e1 = c1.length - 1;
    let e2 = c2.length - 1;
    
    // ...

      else if (i > e2) {
      /**
       * 4. common sequence + unmount
       * (a b) c
       * (a b)
       * i = 2, e1 = 2, e2 = 1
       * a (b c)
       *   (b c)
       * i = 0, e1 = 0, e2 = -1
       */
      while (i <= e1) {
        unmount(c1[i], parentComponent);
        i++;
      }
    }

    // ...
  }
```

`common sequence`çš„å¤„ç†å®Œä¹‹åï¼Œä¾¿å¯ä»¥å¤„ç†`unknown sequence`çš„éƒ¨åˆ†

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/diff-7.566dc6f6.png)

```typescript
 else {
      /**
       * 5. unknown sequence
       * [i ... e1]: a b [c d e] f g
       * [i ... e2]: a b [e d c h] f g
       * i = 2
       * e1 = 4, e2 = 5
       * s1 = 2, s2 = 2
       */
      const s1 = i;
      const s2 = i;

      /**
       * ä½¿ç”¨Mapå­˜å‚¨childçš„ç´¢å¼•å€¼ï¼Œkeyæ˜¯å­èŠ‚ç‚¹çš„å±æ€§key
       */
      const keyToNewIndexMap = new Map();
      for (let i = s2; i <= e2; i++) {
        keyToNewIndexMap.set(c2[i].key, i);
      }
   // loop through old children left to be patched and try to patch
   // ...
   
   // move and mount
   // ...
  }
```

**loop through old children left to be patched and try to patch**

```typescript
/**
 * å¾ªç¯éå†æ—§çš„childrenå‰©ä¸‹çš„éƒ¨åˆ†è¿›è¡Œæ¯”å¯¹
 * è‹¥éå†åˆ°çš„childåœ¨æ–°çš„childrenä¸­æ‰¾ä¸åˆ°ç›¸åŒkeyçš„childï¼Œåˆ™ç›´æ¥unmount
 * è‹¥æ˜¯èƒ½æ‰¾åˆ°åˆ™è¿›è¡Œpatch
 * [i ... e1]: a b [c d e] f g
 * [i ... e2]: a b [e d c h] f g
 * éå† [c d e]
 * s1 = 2 e1 = 4
 */
const toBePatched = e2 - s2 + 1;// æ–°çš„children å‰©ä¸‹ä¹±åºéƒ¨åˆ† çš„é•¿åº¦
const newIndexToOldMapIndex = new Array(toBePatched).fill(0);
for (let i = s1; i <= e1; i++) {
  const oldVNode = c1[i];
  let newIndex = keyToNewIndexMap.get(oldVNode.key);
  if (newIndex == null) {
    // æ–°çš„é‡Œé¢æ‰¾ä¸åˆ°äº†ï¼Œè¯´æ˜è¦ç§»é™¤æ‰
    unmount(oldVNode, parentComponent);
  } else {
    // å¦‚æœèƒ½æ‰¾åˆ°ï¼Œåˆ™éœ€è¦æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹çš„å·®å¼‚ï¼Œå†å»æ¯”è¾ƒå®ƒä»¬è‡ªå·±çš„children
    patch(oldVNode, c2[newIndex], el);
  }
}
```

**move and mount**

![img](http://www.zhufengpeixun.com/jg-vue/assets/img/diff-8.03470ece.png)

```typescript
/**
 * éå†æ–°çš„childrenä¹±åºéƒ¨åˆ†
 * å°†èƒ½æ—§çš„children èƒ½å¤ç”¨çš„éƒ¨åˆ† æŒ‰ç…§æ–°çš„childrenä½ç½®é‡æ–°â€œæ’åˆ—â€å¹¶æ’å…¥
 * å¹¶ä¸”è¿˜éœ€è¦å°†æ–°çš„childrenä¸­â€œæ–°å¢â€childæ·»åŠ ä¸Š
 * æ³¨æ„ï¼šæ˜¯ä»å°¾éƒ¨å¼€å§‹éå†
 * [i ... e1]: a b [c d e] f g
 * [i ... e2]: a b [e d c h] f g
 * toBePatched = 4
 * currentIndex ä¸€å¼€å§‹æŒ‡å‘ h
 * anchor ä¸€å¼€å§‹æŒ‡å‘ f
 */
  for (let i = toBePatched - 1; i >= 0; i--) {
    // å½“å‰è¦æ“ä½œçš„child
    const currentIndex = s2 + i;
    const child = c2[currentIndex];
    // è®¾ç½®é”šç‚¹
    const anchor =
      currentIndex + 1 < c2.length
        ? c2[currentIndex + 1].el
        : null;
    /**
     * åˆ¤æ–­childæ˜¯è¦ç§»åŠ¨è¿˜æ˜¯æ–°å¢
     */
    if (!child.el) {
      patch(null, child, el, anchor);   // å¦‚æœ æ²¡æœ‰el è¯´æ˜æ˜¯æ–°å¢çš„
    } else {
      hostInsert(child.el, el, anchor); // å¦‚æœæœ‰el è¯´æ˜ä»¥å‰æ¸²æŸ“è¿‡äº†ï¼Œæ˜¯å¤ç”¨çš„domèŠ‚ç‚¹
    }
  }
}
```

å…¶å®åˆ°è¿™é‡Œ`diff`æ•°ç»„å½¢å¼çš„`children`å·²ç»å®Œæˆäº†ï¼Œä½†æ˜¯ä¸Šé¢ğŸ‘†å¤„ç†`unknown sequence`çš„éƒ¨åˆ†ï¼Œå…¶å®æ˜¯æœ‰ä¼˜åŒ–çš„éƒ¨åˆ†ï¼›

ç°åœ¨å¤„ç†æ—§çš„`children`çš„æ–¹å¼æ˜¯è‹¥`child`å¯ä»¥å¤ç”¨åˆ™æ‰¾åˆ°é”šç‚¹è¿›è¡Œæ’å…¥ï¼Œä½†æ˜¯è¿™ç§æ“ä½œæ˜¯ä¸€ä¸ªä¸€ä¸ª`child`çš„è¿›è¡Œæ’å…¥çš„ï¼Œé‚£è¿™ç§æƒ…å†µï¼š

- a b [c d e] f g
-  a b [e c d h] f g

`c`å’Œ`d`çš„ç›¸å¯¹é¡ºåºæ²¡æœ‰æ”¹å˜ï¼Œå…¶å®å¯ä»¥ç›´æ¥å°†`c`å’Œ`d`è§†ä¸ºä¸€ä¸ªæ•´ä½“ä¸ç”¨ç§»åŠ¨çš„ï¼Œç›´æ¥ç§»åŠ¨`e`å°±å¥½äº†ï¼Œè‹¥æ˜¯åˆ†å¼€ä¾æ¬¡è¿›è¡Œæ’å…¥çš„è¯æœªå…æœ‰äº›æµªè´¹æ€§èƒ½ï¼›æ‰€ä»¥Vue3å¯¹äºè¿™ç§æƒ…å†µè¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¼˜åŒ–çš„æ–¹æ³•å°±æ˜¯**==æœ€é•¿é€’å¢å­åºåˆ—==**

==**æœ€é•¿é€’å¢å­åºåˆ—**==

> ==Vue3 é‡‡ç”¨æœ€é•¿é€’å¢å­åºåˆ—ï¼Œæ±‚è§£ä¸éœ€è¦ç§»åŠ¨çš„å…ƒç´ æœ‰å“ªäº›==

ä»€ä¹ˆæ˜¯æœ€é•¿é€’å¢å­åºåˆ—ï¼Ÿå°±æ˜¯æ±‚ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæœ€é•¿è¿ç»­ä¸Šå‡çš„éƒ¨åˆ†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/68747470733a2f2f696d672e616c6963646e2e636f6d2f696d6765787472612f69342f4f31434e30315641454563673235776a43736a7351416a5f2121363030303030303030373539312d322d7470732d3930302d3331302e706e67.png)

å¦‚æœåºåˆ—æœ¬èº«å°±æ˜¯ä¸Šå‡çš„ï¼Œé‚£å°±ç›´æ¥è¿”å›å…¶æœ¬èº«ï¼›å¦‚æœåºåˆ—æ²¡æœ‰ä»»ä½•ä¸€æ®µæ˜¯ä¸Šå‡çš„ï¼Œåˆ™è¿”å›ä»»ä½•ä¸€ä¸ªæ•°å­—éƒ½å¯ä»¥ã€‚å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ `3, 7, 22` ä¹Ÿæ˜¯ä¸Šå‡çš„ï¼Œä½†å› ä¸º `22` ä¹‹åæ¥ä¸ä¸‹å»äº†ï¼Œæ‰€ä»¥å…¶é•¿åº¦æ˜¯æœ‰ 3ï¼Œä¸ `3, 7, 8, 9, 11, 12` æ¯”èµ·æ¥ï¼Œè‚¯å®šä¸æ˜¯æœ€é•¿çš„ï¼Œå› æ­¤æ‰¾èµ·æ¥å¹¶ä¸å¤ªå®¹æ˜“ã€‚

==åœ¨å…·ä½“ DOM diff åœºæ™¯ä¸­ï¼Œä¸ºäº†ä¿è¯å°½å¯èƒ½ç§»åŠ¨è¾ƒå°‘çš„ DOMï¼Œæˆ‘ä»¬éœ€è¦ **ä¿æŒæœ€é•¿ä¸Šå‡å­åº** ä¸åŠ¨ï¼Œåªç§»åŠ¨å…¶ä»–å…ƒç´ ==ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæœ€é•¿ä¸Šå‡å­åºåˆ—æœ¬èº«å°±ç›¸å¯¹æœ‰åºï¼Œåªè¦å…¶ä»–å…ƒç´ ç§»åŠ¨å®Œäº†ï¼Œç­”æ¡ˆä¹Ÿå°±å‡ºæ¥äº†ã€‚è¿˜æ˜¯è¿™ä¸ªä¾‹å­ï¼Œå‡è®¾åŸæœ¬çš„ DOM å°±æ˜¯è¿™æ ·ä¸€ä¸ªé€’å¢é¡ºåºï¼ˆå½“ç„¶åº”è¯¥æ˜¯ 1 2 3 4 è¿ç»­çš„ä¸‹æ ‡ï¼Œä¸è¿‡å¯¹ç®—æ³•æ¥è¯´æ˜¯å¦è¿ç»­é—´éš”ä¸å½±å“ï¼Œåªè¦é€’å¢å³å¯ï¼‰ï¼š

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/68747470733a2f2f696d672e616c6963646e2e636f6d2f696d6765787472612f69322f4f31434e303151483546386a323368784356636e5967785f2121363030303030303030373238382d322d7470732d3931302d3134302e706e67.png)

å¦‚æœä¿æŒæœ€é•¿ä¸Šå‡å­åºä¸å˜ï¼Œåªéœ€è¦ç§»åŠ¨ä¸‰æ¬¡å³å¯è¿˜åŸï¼š

![img](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/68747470733a2f2f696d672e616c6963646e2e636f6d2f696d6765787472612f69322f4f31434e30316d39453937763146763169554a325a516d5f2121363030303030303030303534382d322d7470732d3933342d3134362e706e67.png)

å…¶ä»–ä»»ä½•ç§»åŠ¨æ–¹å¼éƒ½ä¸ä¼šå°äºä¸‰æ­¥ï¼Œ**å› ä¸ºæˆ‘ä»¬å·²ç»æœ€å¤§ç¨‹åº¦ä¿æŒå·²ç»æœ‰åºçš„éƒ¨åˆ†ä¸åŠ¨äº†**ã€‚

è·å–==**æœ€é•¿é€’å¢å­åºåˆ—**==çš„é‡‡ç”¨çš„ç®—æ³•æ˜¯==**è´ªå¿ƒç®—æ³•**== + ==**äºŒåˆ†æŸ¥æ‰¾æ³•**==

ç®—æ³•å¦‚ä¸‹ğŸ‘‡

```typescript
/**
 * è·å–æœ€é•¿é€’å¢å­åºåˆ—çš„æ–¹æ³•
 */
function getSequence(arr) { // æœ€ç»ˆçš„ç»“æœæ˜¯ç´¢å¼• 
  const len = arr.length;
  const result = [0]; // ç»“æœé›† å­˜æ”¾çš„æ˜¯ç´¢å¼•å€¼
  const p = new Array(len).fill(0); // é‡Œé¢å†…å®¹æ— æ‰€è°“ å’ŒåŸæœ¬çš„æ•°ç»„ç›¸åŒ ç”¨æ¥å­˜æ”¾ç´¢å¼•

  let lastIndex;
  let start;
  let end;
  let middle;

  for (let i = 0; i < len; i++) {
    const arrI = arr[i];
    if (arrI !== 0) {
      // 0 åœ¨vue3ä¸­æ„å‘³ç€æ–°å¢èŠ‚ç‚¹ï¼Œä¸è®¡å…¥æœ€é•¿é€’å¢å­åºåˆ—åˆ—è¡¨

      // å–åˆ°æ•°ç»„ä¸­çš„æœ€åä¸€é¡¹çš„ç´¢å¼•å€¼
      lastIndex = result[result.length - 1];

      if (arr[lastIndex] < arrI) {
        // è‹¥æ˜¯å½“å‰é¡¹æ¯” ç»“æœé›†result ä¸­æœ€åä¸€é¡¹å¤§

        // è®©å½“å‰çš„è¿™ä¸€é¡¹è®°å½•å…¶å‰ä¸€é¡¹çš„ç´¢å¼•
        p[i] = lastIndex;
        // ç›´æ¥å°†ç´¢å¼•æ”¾å…¥ç»“æœé›†result
        result.push(i);
        continue;
      }

      /**
       * å½“å‰é¡¹æ¯” ç»“æœé›†result ä¸­æœ€åä¸€é¡¹å°è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾
       * å½“ start === end
       * å°±æ‰¾åˆ°äº†ç»“æœé›†ä¸­æœ€æ¥è¿‘ä¸å½“å‰é¡¹çš„å€¼
       * è‹¥æ˜¯å½“å‰é¡¹å°äºè¯¥å€¼åˆ™è¿›è¡Œæ›¿æ¢
       */
      start = 0;
      end = result.length - 1;
      while (start < end) {
        middle = Math.floor((start + end) / 2);
        if (arr[result[middle]] < arrI) {
          start = middle + 1;
        } else {
          end = middle;
        }
      }
      if (arrI < arr[result[end]]) {
        p[i] = result[end - 1];
        result[end] = i;
      }
    }
  }
  // å€’å™è¿½æº¯ å…ˆå–åˆ°ç»“æœé›†ä¸­çš„æœ€åä¸€ä¸ª
  let i = result.length;
  let last = result[i - 1];

  while (i-- > 0) {
    // å½“æ£€ç´¢ååœæ­¢
    result[i] = last; // æœ€åä¸€é¡¹æ˜¯æ­£ç¡®çš„
    last = p[last]; // æ ¹æ®æœ€åä¸€é¡¹ å‘å‰è¿½æº¯
  }
  return result;
}
```

å…³äºè·å–==**æœ€é•¿é€’å¢å­åºåˆ—**==çš„ç®—æ³•å…¶å®å¾ˆéš¾ä»¥ç†è§£ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« [**ç²¾è¯»ã€ŠDOM diff æœ€é•¿ä¸Šå‡å­åºåˆ—ã€‹**](https://github.com/ascoders/weekly/blob/master/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/192.%E7%B2%BE%E8%AF%BB%E3%80%8ADOM%20diff%20%E6%9C%80%E9%95%BF%E4%B8%8A%E5%8D%87%E5%AD%90%E5%BA%8F%E5%88%97%E3%80%8B.md)ï¼Œè™½ç„¶æ²¡æœ‰ç®—æ³•çš„æ•°å­¦æ¨å¯¼è¿‡ç¨‹ï¼Œä½†ä¹Ÿæ˜¯æœ‰åŠ©äºç†è§£è¿™ä¸ªç®—æ³•çš„

<!--æ•´ä¸ªç®—æ³•çš„æ•°å­¦æ¨å¯¼è¿‡ç¨‹ï¼Œæ„Ÿè§‰éœ€è¦ä¸€å®šçš„ç®—æ³•çš„åŸºç¡€çŸ¥è¯†ï¼Œæ²¡æœ‰ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œçœ‹èµ·æ¥å¾ˆè´¹åŠ²ï¼Œè‹¥æ˜¯æœ‰ä¸€æ®µå¾ªåºæ¸è¿›çš„æ¨å¯¼è¿‡ç¨‹ä¼°è®¡ä¼šæ›´å®¹æ˜“ç†è§£-->

æ‰€ä»¥ä¼˜åŒ–è¿‡åå¤„ç†`unknown sequence`çš„å®ç°æ˜¯è¿™æ ·çš„

```typescript
 else {
   // ...
   
   // loop through old children left to be patched and try to patch
   // ...
   
   
   // move and mount
   
   // è®¡ç®—å‡ºäº†ä¸ç”¨åŠ¨åºåˆ— ï¼ˆç´¢å¼•ï¼‰
    let increasingNewIndexSequence = getSequence(
      newIndexToOldIndexMap
    );
    let j = increasingNewIndexSequence.length - 1;

    for (let i = toBePatched - 1; i >= 0; i--) {
      // å½“å‰è¦æ“ä½œçš„child
      const currentIndex = s2 + i;
      const child = c2[currentIndex];
      // è®¾ç½®é”šç‚¹
      const anchor =
        currentIndex + 1 < c2.length
          ? c2[currentIndex + 1].el
          : null;

      /**
       * åˆ¤æ–­childæ˜¯è¦ç§»åŠ¨è¿˜æ˜¯æ–°å¢
       */
      if (newIndexToOldIndexMap[i] === 0) {
        // newIndexToOldIndexMap[i]ä¸º0 è¯´æ˜æ˜¯æ–°å¢çš„
        patch(null, child, el, anchor);
      } else {
        if (i !== increasingNewIndexSequence[j]) {
          // é€šè¿‡åºåˆ—æ¥è¿›è¡Œæ¯”å¯¹ï¼Œæ‰¾åˆ°å“ªäº›éœ€è¦ç§»åŠ¨
          hostInsert(child.el, el, anchor);
        } else {
          j--; // ä¸åšä»»ä½•æ“ä½œ
        }
      }
    }
  }
}
```

###### 2.3.3.6ã€`createRenderer` å®Œæ•´ä»£ç 

```typescript
import {
  ShapeFlags,
  Text,
  isSameVNode,
  normalizeVNode,
  Fragment
} from './createVNode';

/**
 * è·å–æœ€é•¿é€’å¢å­åºåˆ—çš„æ–¹æ³•
 */
function getSequence(arr) {
  // æœ€ç»ˆçš„ç»“æœæ˜¯ç´¢å¼•
  const len = arr.length;
  const result = [0]; // ç»“æœé›† å­˜æ”¾çš„æ˜¯ç´¢å¼•å€¼
  const p = new Array(len).fill(0); // é‡Œé¢å†…å®¹æ— æ‰€è°“ å’ŒåŸæœ¬çš„æ•°ç»„ç›¸åŒ ç”¨æ¥å­˜æ”¾ç´¢å¼•

  let lastIndex;
  let start;
  let end;
  let middle;

  for (let i = 0; i < len; i++) {
    const arrI = arr[i];
    if (arrI !== 0) {
      // 0 åœ¨vue3ä¸­æ„å‘³ç€æ–°å¢èŠ‚ç‚¹ï¼Œä¸è®¡å…¥æœ€é•¿é€’å¢å­åºåˆ—åˆ—è¡¨

      // å–åˆ°æ•°ç»„ä¸­çš„æœ€åä¸€é¡¹çš„ç´¢å¼•å€¼
      lastIndex = result[result.length - 1];

      if (arr[lastIndex] < arrI) {
        // è‹¥æ˜¯å½“å‰é¡¹æ¯” ç»“æœé›†result ä¸­æœ€åä¸€é¡¹å¤§

        // è®©å½“å‰çš„è¿™ä¸€é¡¹è®°å½•å…¶å‰ä¸€é¡¹çš„ç´¢å¼•
        p[i] = lastIndex;
        // ç›´æ¥å°†ç´¢å¼•æ”¾å…¥ç»“æœé›†result
        result.push(i);
        continue;
      }

      /**
       * å½“å‰é¡¹æ¯” ç»“æœé›†result ä¸­æœ€åä¸€é¡¹å°è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾
       * å½“ start === end
       * å°±æ‰¾åˆ°äº†ç»“æœé›†ä¸­æœ€æ¥è¿‘ä¸å½“å‰é¡¹çš„å€¼
       * è‹¥æ˜¯å½“å‰é¡¹å°äºè¯¥å€¼åˆ™è¿›è¡Œæ›¿æ¢
       */
      start = 0;
      end = result.length - 1;
      while (start < end) {
        middle = Math.floor((start + end) / 2);
        if (arr[result[middle]] < arrI) {
          start = middle + 1;
        } else {
          end = middle;
        }
      }
      if (arrI < arr[result[end]]) {
        p[i] = result[end - 1];
        result[end] = i;
      }
    }
  }
  // å€’å™è¿½æº¯ å…ˆå–åˆ°ç»“æœé›†ä¸­çš„æœ€åä¸€ä¸ª
  let i = result.length;
  let last = result[i - 1];

  while (i-- > 0) {
    // å½“æ£€ç´¢ååœæ­¢
    result[i] = last; // æœ€åä¸€é¡¹æ˜¯æ­£ç¡®çš„
    last = p[last]; // æ ¹æ®æœ€åä¸€é¡¹ å‘å‰è¿½æº¯
  }
  return result;
}

export function createRenderer(options) {
  // ä¼ å…¥è¿›æ¥çš„renderOptionsï¼Œå†…éƒ¨å±æ€§éƒ½æ˜¯DOM Api
  let {
    patchProp: hostPatchProp, // å¯¹èŠ‚ç‚¹å±æ€§çš„æ“ä½œ
    createElement: hostCreateElement, // åˆ›å»ºå…ƒç´ 
    createTextNode: hostCreateTextNode, // åˆ›å»ºæ–‡æœ¬
    createText: hostCreateText,
    querySelector: hostQuerySelector,
    insert: hostInsert,
    remove: hostRemove,
    setText: hostSetText,
    setElementText: hostSetElementText,
    parentNode: hostParentNode,
    nextSibling: hostNextSibling
  } = options;

  /**
   * æŒ‚è½½childrençš„æ–¹æ³•
   */
  function mountChildren(
    children,
    container,
    anchor,
    parentComponent
  ) {
    for (let i = 0; i < children.length; i++) {
      // æ ¼å¼åŒ–children child å¯èƒ½æ˜¯æ–‡æœ¬ éœ€è¦æŠŠæ–‡æœ¬ä¹Ÿå˜æˆè™šæ‹ŸèŠ‚ç‚¹
      let child = normalizeVNode(children, i);
      // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
      patch(null, child, container, anchor, parentComponent);
    }
  }

  /**
   * å…ƒç´ ç±»å‹çš„VNodeçš„æŒ‚è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container çˆ¶å®¹å™¨
   * @param anchor é”šç‚¹ ç”¨äºçœŸå®èŠ‚ç‚¹çš„insertæ“ä½œ
   * mountElementè¢«é€’å½’è°ƒç”¨ï¼Œä¸æ–­çš„å°†æ ¹æ®VNodeç”Ÿæˆçš„çœŸå®èŠ‚ç‚¹insertåˆ°çˆ¶å®¹å™¨ä¸­
   * æœ€ç»ˆç”Ÿæˆå®Œæ•´çš„DOMï¼Œ
   * æœ€åå†å°†DOM insertåˆ°æ ¹èŠ‚ç‚¹ï¼ˆç”¨æˆ·æŒ‡å®šçš„çœŸå®èŠ‚ç‚¹ï¼‰ä¸Š
   * ä¾¿å®ŒæˆæŒ‚è½½
   */
  function mountElement(vnode, container, anchor, parentComponent) {
    let { type, props, children, shapeFlag } = vnode;

    /**
     * åˆ›å»ºçœŸå®èŠ‚ç‚¹
     * å¹¶ä¿å­˜åœ¨VNodeçš„elå±æ€§ä¸Šä¿å­˜ä¸‹æ¥
     * åç»­éœ€è¦æ¯”å¯¹è™šæ‹ŸèŠ‚ç‚¹çš„å·®å¼‚ï¼Œæ›´æ–°é¡µé¢
     * æ‰€ä»¥éœ€è¦ä¿ç•™å¯¹åº”çš„çœŸå®èŠ‚ç‚¹
     */
    let el = (vnode.el = hostCreateElement(type));

    if (props) {
      // æ›´æ–°å±æ€§
      patchProps(null, props, el);
    }

    if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
      // childrenæ˜¯æ–‡æœ¬ï¼Œç›´æ¥è®¾ç½®çœŸå®èŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹å³å¯
      hostSetElementText(el, children);
    }
    if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      // childrenæ˜¯æ•°ç»„ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥å¤„ç†
      mountChildren(children, el, anchor, parentComponent);
    }

    /**
     * æŒ‚è½½æ“ä½œ
     * å°†æ ¹æ®VNodeç”Ÿæˆçš„çœŸå®èŠ‚ç‚¹elæŒ‚è½½åˆ°çˆ¶å®¹å™¨ä¸­
     */
    hostInsert(el, container, anchor);
  }

  /**
   * æ›´æ–°å±æ€§çš„æ–¹æ³•
   */
  function patchProps(oldProps, newProps, el) {
    if (oldProps == null) oldProps = {};
    if (newProps == null) newProps = {};

    // å¾ªç¯newPropsè¦†ç›–oldProps
    for (let key in newProps) {
      hostPatchProp(el, key, oldProps[key], newProps[key]);
    }
    // oldPropsä¸­æœ‰çš„ï¼Œä½†newPropsæ²¡æœ‰çš„ï¼Œè¦åˆ é™¤
    for (let key in oldProps) {
      if (newProps[key] == null) {
        hostPatchProp(el, key, oldProps[key], null);
      }
    }
  }

  /**
   * children diff æ–¹æ³•
   * @param {Array} c1 æ—§çš„children
   * @param {Array} c2 æ–°çš„çš„children
   * @param el çœŸå®çš„DOMèŠ‚ç‚¹ï¼ˆå¯¹äºc1ã€c2æ¥è¯´æ˜¯çˆ¶èŠ‚ç‚¹ï¼‰
   * diff c1 å’Œ c2 ä¸¤ä¸ªæ•°ç»„ä¹‹é—´çš„å·®å¼‚å¹¶è¿›è¡Œæ›´æ–°
   * åŸåˆ™ï¼šå°½å¯èƒ½å¤ç”¨èŠ‚ç‚¹ï¼Œè€Œä¸”æ‰¾åˆ°å˜åŒ–çš„ä½ç½®
   */
  function patchKeyedChildren(c1, c2, el, parentComponent) {
    /**
     * iã€e1ã€e2å¯ä»¥ç†è§£ä¸ºæŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ˜¯childrenä¸­æŸä¸€ä¸ªchild
     * iæŒ‡å‘çš„æ˜¯sync from startæ–¹å‘çš„æŒ‡é’ˆ
     * e1ã€e2æŒ‡å‘çš„æ˜¯sync from endæ–¹å‘çš„æŒ‡é’ˆ
     */
    let i = 0;
    let e1 = c1.length - 1;
    let e2 = c2.length - 1;

    /**
     * 1. sync from start ä»å¤´å¼€å§‹æ¯”å¯¹
     * é‡åˆ°ä¸åŒçš„å°±ç»“æŸ
     * (a b) c
     * (a b)
     * å½“ i > e2 è¯´æ˜æ–°çš„æ¯”å¯¹å®Œæˆäº†ï¼Œä½†æ˜¯æ—§çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e1ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦åˆ é™¤çš„
     * (a b)
     * (a b) c
     * å½“i > e1 è¯´æ˜æ—§çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ–°çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e2ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦æ–°å¢çš„
     */
    while (i <= e1 && i <= e2) {
      const n1 = c1[i];
      const n2 = normalizeVNode(c2, i);
      if (isSameVNode(n1, n2)) {
        patch(n1, n2, el);
      } else {
        break;
      }
      i++;
    }

    /**
     * 2. sync from end ä»å°¾éƒ¨å¼€å§‹æ¯”å¯¹
     * é‡åˆ°ä¸åŒçš„å°±ç»“æŸ
     * d e (a b c)
     *     (a b c)
     * å½“i > e2 è¯´æ˜æ–°çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ—§çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e1ä¹‹é—´çš„å†…å®¹å°±æ˜¯è¦åˆ é™¤çš„
     *   (a b)
     * c (a b)
     * å½“ i > e1ï¼Œè¯´æ˜æ—§çš„å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼Œä½†æ˜¯æ–°çš„è¿˜æœ‰å‰©ä½™
     * ä¹Ÿå°±æ˜¯è¯´i åˆ° e2ä¹‹é—´çš„å†…å®¹æ˜¯è¦æ–°å¢çš„
     */
    while (i <= e1 && i <= e2) {
      const n1 = c1[e1];
      const n2 = c2[e2];
      if (isSameVNode(n1, n2)) {
        patch(n1, n2, el);
      } else {
        break;
      }
      e1--;
      e2--;
    }

    if (i > e1) {
      /**
       * 3. common sequence + mount
       * (a b)
       * (a b) c
       * i = 2, e1 = 1, e2 = 2
       *   (a b)
       * c (a b)
       * i = 0, e1 = -1, e2 = 0
       */
      if (i <= e2) {
        /**
         * ç¡®å®šé”šç‚¹anchorï¼Œe2è‹¥æ˜¯c2çš„æœ€åä¸€é¡¹ï¼Œåˆ™é”šç‚¹ä¸ºnull
         * å°†æ–°å­èŠ‚ç‚¹c2[i]ç›´æ¥appendChildåˆ°çˆ¶èŠ‚ç‚¹ä¸Š
         * å¦åˆ™å°†æ–°å­èŠ‚ç‚¹c2[i] insertBefore åˆ°é”šç‚¹å‰
         */
        const nextPos = e2 + 1;
        let anchor = c2.length <= nextPos ? null : c2[nextPos].el;

        while (i <= e2) {
          patch(null, c2[i], el, anchor);
          i++;
        }
      }
    } else if (i > e2) {
      /**
       * 4. common sequence + unmount
       * (a b) c
       * (a b)
       * i = 2, e1 = 2, e2 = 1
       * a (b c)
       *   (b c)
       * i = 0, e1 = 0, e2 = -1
       */
      while (i <= e1) {
        unmount(c1[i], parentComponent);
        i++;
      }
    } else {
      /**
       * 5. unknown sequence
       * [i ... e1]: a b [c d e] f g
       * [i ... e2]: a b [e d c h] f g
       * i = 2
       * e1 = 4, e2 = 5
       * s1 = 2, s2 = 2
       */
      const s1 = i;
      const s2 = i;

      /**
       * ä½¿ç”¨Mapå­˜å‚¨childçš„ç´¢å¼•å€¼ï¼Œkeyæ˜¯å­èŠ‚ç‚¹çš„å±æ€§key
       */
      const keyToNewIndexMap = new Map();
      for (let i = s2; i <= e2; i++) {
        keyToNewIndexMap.set(c2[i].key, i);
      }

      /**
       * å¾ªç¯éå†æ—§çš„childrenå‰©ä¸‹çš„éƒ¨åˆ†è¿›è¡Œæ¯”å¯¹
       * è‹¥éå†åˆ°çš„childåœ¨æ–°çš„childrenä¸­æ‰¾ä¸åˆ°ç›¸åŒkeyçš„childï¼Œåˆ™ç›´æ¥unmount
       * è‹¥æ˜¯èƒ½æ‰¾åˆ°åˆ™è¿›è¡Œpatch
       * [i ... e1]: a b [c d e] f g
       * [i ... e2]: a b [e c d h] f g
       * éå† [c d e]
       * s1 = 2 e1 = 4
       * s2 = 2 e2 = 5
       * newIndexToOldMapIndexé•¿åº¦ä¸º4 [e d c h]çš„é•¿åº¦
       */

      const toBePatched = e2 - s2 + 1; // æ–°çš„children å‰©ä¸‹ä¹±åºéƒ¨åˆ† çš„é•¿åº¦
      const newIndexToOldIndexMap = new Array(toBePatched).fill(0);
      for (let i = s1; i <= e1; i++) {
        const oldVNode = c1[i];
        let newIndex = keyToNewIndexMap.get(oldVNode.key);
        if (newIndex == null) {
          // æ–°çš„é‡Œé¢æ‰¾ä¸åˆ°äº†ï¼Œè¯´æ˜è¦ç§»é™¤æ‰
          unmount(oldVNode, parentComponent);
        } else {
          /**
           * è®°å½•ä¸‹æ¥å¯ä»¥æ—§çš„childrenä¸­å¯ä»¥å¤ç”¨çš„childçš„ç´¢å¼•
           * æ–°çš„ä½ç½®å’Œè€çš„ä½ç½®åšä¸€ä¸ªå…³è”
           * [c d e]
           * [e c d h]
           * newIndexToOldIndexMap = [4+1, 2+1, 3+1, 0+1] = [5, 3, 4, 1]
           * ä¸ºä»€ä¹ˆè¦+1
           * æ˜¯å› ä¸ºä¸ºäº†å°†newIndexToOldIndexMapé»˜è®¤å±æ€§å€¼0å’Œ
           * æ—§çš„childrenç¬¬ä¸€é¡¹çš„ç´¢å¼•0åŒºåˆ†å¼€
           */
          newIndexToOldIndexMap[newIndex - s2] = i + 1;

          // å¦‚æœèƒ½æ‰¾åˆ°ï¼Œåˆ™éœ€è¦æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹çš„å·®å¼‚ï¼Œå†å»æ¯”è¾ƒå®ƒä»¬è‡ªå·±çš„children
          patch(oldVNode, c2[newIndex], el);
        }
      }

      /**
       * éå†æ–°çš„childrenä¹±åºéƒ¨åˆ†
       * å°†èƒ½æ—§çš„children èƒ½å¤ç”¨çš„éƒ¨åˆ† æŒ‰ç…§æ–°çš„childrenä½ç½®é‡æ–°â€œæ’åˆ—â€å¹¶æ’å…¥
       * å¹¶ä¸”è¿˜éœ€è¦å°†æ–°çš„childrenä¸­â€œæ–°å¢â€childæ·»åŠ ä¸Š
       * æ³¨æ„ï¼šæ˜¯ä»å°¾éƒ¨å¼€å§‹éå†
       * [i ... e1]: a b [c d e] f g
       * [i ... e2]: a b [e d c h] f g
       * toBePatched = 4
       * currentIndex ä¸€å¼€å§‹æŒ‡å‘ h
       * anchor ä¸€å¼€å§‹æŒ‡å‘ f
       */

      // è®¡ç®—å‡ºäº†ä¸ç”¨åŠ¨åºåˆ— ï¼ˆç´¢å¼•ï¼‰
      let increasingNewIndexSequence = getSequence(
        newIndexToOldIndexMap
      );
      let j = increasingNewIndexSequence.length - 1;

      for (let i = toBePatched - 1; i >= 0; i--) {
        // å½“å‰è¦æ“ä½œçš„child
        const currentIndex = s2 + i;
        const child = c2[currentIndex];
        // è®¾ç½®é”šç‚¹
        const anchor =
          currentIndex + 1 < c2.length
            ? c2[currentIndex + 1].el
            : null;

        /**
         * åˆ¤æ–­childæ˜¯è¦ç§»åŠ¨è¿˜æ˜¯æ–°å¢
         */
        if (newIndexToOldIndexMap[i] === 0) {
          // newIndexToOldIndexMap[i]ä¸º0 è¯´æ˜æ˜¯æ–°å¢çš„
          patch(null, child, el, anchor);
        } else {
          if (i !== increasingNewIndexSequence[j]) {
            // é€šè¿‡åºåˆ—æ¥è¿›è¡Œæ¯”å¯¹ï¼Œæ‰¾åˆ°å“ªäº›éœ€è¦ç§»åŠ¨
            hostInsert(child.el, el, anchor);
          } else {
            j--; // ä¸åšä»»ä½•æ“ä½œ
          }
        }
      }
    }
  }

  /**
   * å¸è½½å­èŠ‚ç‚¹çš„æ–¹æ³•
   */
  function unmountChildren(children, parentComponent) {
    children.forEach(child => {
      unmount(child, parentComponent);
    });
  }

  /**
   * æ›´æ–°å­èŠ‚ç‚¹çš„æ–¹æ³•
   * @param n1 æ—§èŠ‚ç‚¹
   * @param n2 æ–°èŠ‚ç‚¹
   * @param el çœŸå®çš„DOMèŠ‚ç‚¹ï¼ˆn2å¤ç”¨n1çš„çœŸå®DOMèŠ‚ç‚¹ï¼‰
   * @param parentComponent çˆ¶ç»„ä»¶
   */
  function patchChildren(n1, n2, el, anchor, parentComponent) {
    let c1 = n1.children;
    let c2 = n2.children;

    const prevShapeFlag = n1.shapeFlag;
    const shapeFlag = n2.shapeFlag;

    if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
      /**
       * æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬
       * æ•°ç»„ â€”â€”> æ–‡æœ¬
       * æ–‡æœ¬ â€”â€”> æ–‡æœ¬
       * ç©º â€”â€”> æ–‡æœ¬
       * è‹¥æ—§å­èŠ‚ç‚¹æ˜¯æ•°ç»„ï¼Œåˆ™éœ€å…ˆåˆ é™¤æ—§å­èŠ‚ç‚¹ï¼Œå†è®¾ç½®æ–‡æœ¬å†…å®¹
       * ä¸æ˜¯çš„è¯ï¼Œç›´æ¥è®¾ç½®æ–‡æœ¬å†…å®¹
       */
      if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
        unmountChildren(c1, parentComponent);
      }
      if (c1 !== c2) {
        hostSetElementText(el, c2);
      }
    } else {
      // æ–°å­èŠ‚ç‚¹æ˜¯æ•°ç»„å’Œç©ºçš„æƒ…å†µ
      if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
        // æ—§å­èŠ‚ç‚¹æ˜¯æ•°ç»„
        if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
          /**
           * æ–°å­èŠ‚ç‚¹ä¹Ÿæ˜¯æ•°ç»„
           * æ•°ç»„ â€”â€”> æ•°ç»„
           * diffç®—æ³•
           */
          patchKeyedChildren(c1, c2, el, parentComponent);
        } else {
          /**
           * æ–°å­èŠ‚ç‚¹æ˜¯ç©º
           * æ•°ç»„ â€”â€”> ç©º
           * åˆ é™¤æ‰€æœ‰æ—§å­èŠ‚ç‚¹
           */
          unmountChildren(c1, parentComponent);
        }
      } else {
        /**
         * æ—§å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬æˆ–ç©º
         * æ–‡æœ¬ â€”â€”> æ•°ç»„
         * æ–‡æœ¬ â€”â€”> ç©º
         * ç©º â€”â€”> æ•°ç»„
         * ç©º â€”â€”> ç©º
         * æ—§å­èŠ‚ç‚¹è‹¥æ˜¯æ–‡æœ¬ï¼Œåˆ™æ¸…ç©ºå†æŒ‚è½½æ–°å­èŠ‚ç‚¹
         * ä¸æ˜¯åˆ™ç›´æ¥æŒ‚è½½æ–°å­èŠ‚ç‚¹
         */
        if (prevShapeFlag & ShapeFlags.TEXT_CHILDREN) {
          hostSetElementText(el, '');
        }
        if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
          mountChildren(c2, el, anchor, parentComponent);
        }
      }
    }
  }

  /**
   * VNodeçš„diffæ›´æ–°å¤„ç†
   */
  function patchElement(n1, n2, parentComponent) {
    // n1 å’Œ n2 èƒ½å¤ç”¨è¯´æ˜domèŠ‚ç‚¹å°±ä¸ç”¨åˆ é™¤äº†

    // å¤ç”¨çœŸå®DOMèŠ‚ç‚¹,ä¸ç”¨åˆ é™¤
    let el = (n2.el = n1.el);

    let oldProps = n1.props;
    let newProps = n2.props;
    // æ¯”è¾ƒå±æ€§
    patchProps(oldProps, newProps, el);

    // æ¯”è¾ƒchildren
    patchChildren(n1, n2, el, null, parentComponent);
  }

  /**
   * æ–‡æœ¬ç±»å‹çš„VNodeçš„æŒ‚è½½å’Œæ›´æ–°å¤„ç†
   */
  function processText(n1, n2, container) {
    if (n1 == null) {
      hostInsert(
        (n2.el = hostCreateTextNode(n2.children)),
        container
      );
    } else {
      // å¤ç”¨è€çš„èŠ‚ç‚¹
      const el = (n2.el = n1.el);
      let newText = n2.children;
      if (newText !== n1.children) {
        // ä¸ç›¸åŒæ‰æ›´æ–°
        hostSetText(el, newText);
      }
    }
  }

  function processFragment(n1, n2, container, parentComponent) {
    const fragmentEndAnchor = (n2.anchor = n1
      ? n1.anchor
      : hostCreateText(''))!;

    if (n1 == null) {
      mountChildren(
        n2.children,
        container,
        fragmentEndAnchor,
        parentComponent
      );
    } else {
      patchKeyedChildren(
        n1.children,
        n2.children,
        container,
        parentComponent
      );
    }
  }

  /**
   * å…ƒç´ ç±»å‹çš„VNodeçš„æŒ‚è½½å’Œæ›´æ–°å¤„ç†
   */
  function processElement(
    n1,
    n2,
    container,
    anchor,
    parentComponent
  ) {
    if (n1 == null) {
      mountElement(n2, container, anchor, parentComponent);
    } else {
      patchElement(n1, n2, parentComponent);
    }
  }

  /**
   * VNodeçš„åˆå§‹åŒ–æŒ‚è½½å’Œdiffæ›´æ–°
   * @param n1 å®¹å™¨ä¸Šä¿å­˜çš„ä¸Šä¸€æ¬¡çš„VNode
   * @param n2 æ–°çš„VNode
   * @param container å®¹å™¨ çœŸå®çš„DOMèŠ‚ç‚¹
   */
  const patch = (
    n1,
    n2,
    container,
    anchor = null,
    parentComponent = null
  ) => {
    // è‹¥n1æœ‰å€¼ä¸”n2ã€n1ä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜æ˜¯è¦å°†n1æ›¿æ¢æˆn2
    if (n1 && !isSameVNode(n1, n2)) {
      // å¸è½½n1å¹¶é‡åˆ¶ä¸ºnullï¼Œåç»­èµ°n2çš„åˆå§‹åŒ–
      unmount(n1, parentComponent);
      n1 = null;
    }

    /**
     * n1 å¦‚æœæ˜¯null è¯´æ˜æ˜¯åˆå§‹åŒ–æŒ‚è½½
     * n1 å¦‚æœæœ‰å€¼ è¯´æ˜æ˜¯æ›´æ–° è¦èµ°diffç®—æ³•
     */
    const { type, shapeFlag } = n2;
    switch (type) {
      case Text:
        processText(n1, n2, container);
        break;
      case Fragment:
        processFragment(n1, n2, container, parentComponent);
        break;
      default:
        if (shapeFlag & ShapeFlags.ELEMENT) {
          // é€šè¿‡ä½è¿ç®—åˆ¤æ–­å½“å‰VNodeæ˜¯å…ƒç´ ç±»å‹
          processElement(n1, n2, container, anchor, parentComponent);
        }
    }
  };

  /**
   * VNodeçš„å¸è½½
   */
  const unmount = (n1, parentComponent) => {
    let { shapeFlag, component } = n1;

    if (shapeFlag & ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE) {
      parentComponent.ctx.deactivate(n1);
    }

    if (n1.type == Fragment) {
      // fragment åˆ é™¤æ‰€æœ‰å­èŠ‚ç‚¹
      return unmountChildren(n1.children, parentComponent);
    } else if (shapeFlag & ShapeFlags.COMPONENT) {
      // _vnode ç»„ä»¶çš„è™šæ‹ŸèŠ‚ç‚¹  subTreeç»„ä»¶æ¸²æŸ“çš„å†…å®¹
      return unmount(component.subTree, parentComponent); // ç»„ä»¶è¦å¸è½½çš„æ˜¯subTree è€Œä¸æ˜¯è‡ªå·±
    }

    hostRemove(n1.el);
  };

  /**
   * DOMçš„æ¸²æŸ“æ–¹æ³•
   * è´Ÿè´£DOMçš„åˆå§‹åŒ–æŒ‚è½½ã€æ›´æ–°ã€å¸è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container å®¹å™¨ï¼ŒçœŸå®çš„DOMèŠ‚ç‚¹
   */
  function render(vnode, container) {
    if (vnode == null) {
      // å¸è½½
      if (container._vnode) {
        unmount(container._vnode, null);
      }
    } else {
      // åˆå§‹åŒ–æŒ‚è½½å’Œæ›´æ–°
      patch(container._vnode || null, vnode, container);
    }
    // ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™å°±å°†vnodeä¿ç•™åˆ°äº†å®¹å™¨ä¸Šï¼Œç”¨äºåç»­åŒºåˆ†æ˜¯åˆå§‹åŒ–æŒ‚è½½è¿˜æ˜¯æ›´æ–°
    container._vnode = vnode;
  }

  return {
    render
  };
}

```

### ä¸‰ã€æ€»ç»“

==å…¶å®æ•´ä¸ªVueæ¸²æŸ“åŸç†çš„æ ¸å¿ƒå°±æ˜¯ `createRenderer`æ–¹æ³•ï¼Œå…¶ä¸­åŒ…å«äº†DOM çš„åˆå§‹åŒ–æŒ‚è½½ã€`diff`æ›´æ–°ã€å¸è½½==ã€‚

è¿™é‡Œä¹Ÿæ˜¯Vueæœ€æ¶ˆè€—æ€§èƒ½çš„åœ°æ–¹ï¼Œè‹¥æ˜¯è™šæ‹ŸDOMçš„ç»“æ„å¤æ‚äº›ï¼Œ `createRenderer`ä¸­ä¾¿ä¼šæœ‰å¾ˆå¤šé€’å½’è¿ç®—ï¼›

äº†è§£æ¸²æŸ“åŸç†çš„æºç æœ‰åŠ©äºæ›´åŠ æ·±å…¥çš„ç†è§£Vueã€‚