## React18æºç è§£æï¼ˆå…­ï¼‰å®ç°æ›´æ–°é˜Ÿåˆ—

### ä¸€ã€å‰è¨€

#### 1.1ã€æ›´æ–°é˜Ÿåˆ—

reactçš„æ›´æ–°é˜Ÿåˆ—æ˜¯ç”¨äºå­˜å‚¨çŠ¶æ€å˜åŒ–çš„ä¸€ç§å¾ªç¯é“¾è¡¨ï¼Œæ¯ä¸ªfiberä¸Šéƒ½ä¼šæœ‰ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—ã€‚åœ¨å‰é¢çš„ç¬”è®°<!--React18æºç è§£æï¼ˆå››ï¼‰ç†è§£fiber-->ä¸­æœ‰ä¸€æ®µç®€å•çš„æ›´æ–°é˜Ÿåˆ—çš„å®ç°å¯ä»¥å…ˆçœ‹çœ‹å¸®åŠ©ç†è§£ã€‚

### äºŒã€åˆå§‹åŒ–æ›´æ–°é˜Ÿåˆ—

åœ¨`src\react-reconciler\src\ReactFiberRoot.js`æ–‡ä»¶ä¸­çš„`createFiberRoot`æ–¹æ³•ä¸­è¿›è¡Œ**==æ›´æ–°é˜Ÿåˆ—==**çš„åˆå§‹åŒ–

> `createFiberRoot`æ–¹æ³•åˆ›å»ºäº†FiberRootNodeå’ŒHostRootFiberï¼Œå¹¶å°†ä¸¤è€…åŒå‘ç»‘å®šï¼›
>
> å…·ä½“ç»†èŠ‚å¯ä»¥çœ‹ä¸Šä¸€ç¯‡ç¬”è®°ï¼šReact18æºç è§£æï¼ˆäº”ï¼‰å®ç°ReactDOMRoot

 `initializeUpdateQueue(uninitializedFiber)`ä¸­çš„`uninitializedFiber`ä¾¿æ˜¯åˆšåˆ›å»ºçš„`HostRootFiber`ï¼Œé€šè¿‡`uninitializedFiber`è¿™ä¸ªåå­—ä¹Ÿå¯ä»¥å‘ç°ï¼Œè¡¨ç¤ºçš„æ˜¯æœªåˆå§‹åŒ–çš„`fiber`ï¼›

```js
// ...
import { initializeUpdateQueue } from "./ReactFiberClassUpdateQueue";

export function createFiberRoot(containerInfo) {
  //...
  
   // åˆå§‹åŒ–æ›´æ–°é˜Ÿåˆ—
  initializeUpdateQueue(uninitializedFiber);
  
  // ...
  return root;
}

```

åœ¨`src\react-reconciler\src\ReactFiberClassUpdateQueue.js`æ–‡ä»¶ä¸­åˆ›å»ºåˆå§‹åŒ–æ›´æ–°é˜Ÿåˆ—çš„æ–¹æ³•`initialUpdateQueue`

```js
/**
 * @description åˆå§‹åŒ–æ›´æ–°é˜Ÿåˆ—çš„æ–¹æ³•
 * @param fiber ä¸€ä¸ªfiberå¯¹è±¡
 */
export function initialUpdateQueue(fiber) {
  // åˆ›å»ºä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—å¯¹è±¡
  const queue = {
    shared: {
      pending: null
    }
  };
  // ç»™fiberå¯¹è±¡ä¸Šæ·»åŠ å±æ€§updateQueueæŒ‡å‘æ›´æ–°é˜Ÿåˆ—
  fiber.updateQueue = queue;
}
```

å…¶å®å°±æ˜¯ç»™`HostRootFiber`ä¸Šæ·»åŠ äº†ä¸ª`updateQueue`å±æ€§ï¼Œè¯¥å±æ€§æ˜¯ä¸ªjså¯¹è±¡

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/initializeUpdateQueue_1664039386818.png" alt="img" style="zoom:50%;" />

æ›´æ–°é˜Ÿåˆ—åœ¨`fiber`å¯¹è±¡åˆ›å»ºæ—¶è¢«æ·»åŠ ä¸Šå»äº†ï¼Œä½†æ­¤æ—¶æ›´æ–°é˜Ÿåˆ—ä¸­æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰æ›´æ–°å†…å®¹ï¼Œé‚£ä¹ˆæ›´æ–°å†…å®¹æ˜¯åœ¨å“ªé‡Œæ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­çš„å‘¢ï¼Ÿæ¥ç€çœ‹ä¸‹é¢ğŸ‘‡

### ä¸‰ã€å°†æ›´æ–°åŠ å…¥æ›´æ–°é˜Ÿåˆ—

åœ¨`src\react-dom\src\client\ReactDOMRoot.js`ä¸­`ReactDOMRoot`çš„æ¸²æŸ“æ–¹æ³•`render`ä¸­è¿›è¡Œå®¹å™¨æ›´æ–°`updateContainer`ï¼Œ<!--åˆæ¸²æŸ“ä¹Ÿæ˜¯ä¸€ç§å®¹å™¨æ›´æ–°ï¼Œå› ä¸ºåˆšå¼€å§‹çš„å®¹å™¨ä¸­æ˜¯ç©ºçš„-->

```js
import {
  createContainer,
  updateContainer
} from 'react-reconciler/src/ReactFiberReconciler';

// ...

/**
 * @description ç»™ReactDOMRootæ„é€ å‡½æ•°æ·»åŠ renderæ–¹æ³•
 * @description æ›´æ–°å®¹å™¨
 * @param children è¦æ¸²æŸ“çš„è™šæ‹ŸDOM
 */
ReactDOMRoot.prototype.render = function (children) {
  // ...

  // æ›´æ–°å®¹å™¨ï¼Œå°†è™šæ‹ŸDOMå˜æˆçœŸå®DOMæ’å…¥åˆ°containerå®¹å™¨ä¸­
  updateContainer(children, root);
};

// ...
```

------

åœ¨`src\react-reconciler\src\ReactFiberReconciler.js`ä¸­å®ç°`updateContainer`æ–¹æ³•

```js
import {
  createUpdate,
  enqueueUpdate
} from './ReactFiberClassUpdateQueue';

// ... 

/**
 * @description æ›´æ–°å®¹å™¨ï¼ŒæŠŠè™šæ‹ŸDOMå˜æˆçœŸå®DOMæ’å…¥åˆ°containerå®¹å™¨ä¸­
 * @param {*} element è™šæ‹ŸDOM
 * @param {*} container DOMå®¹å™¨ ä¹Ÿå°±æ˜¯FiberRootNode
 * å…¶ä¸­container.containerInfo æŒ‡å‘ div#root
 * container.current æŒ‡å‘ HostRootFiber
 */
export function updateContainer(element, container) {
  //è·å–å½“å‰çš„æ ¹fiber HostRootFiber
  const current = container.current;

  //åˆ›å»ºæ›´æ–°å¯¹è±¡
  const update = createUpdate();

  //ç»™æ›´æ–°å¯¹è±¡ä¸Šæ·»åŠ è¦æ›´æ–°çš„è™šæ‹ŸDOM
  update.payload = { element };

  //æŠŠæ­¤æ›´æ–°å¯¹è±¡æ·»åŠ åˆ°currentè¿™ä¸ªæ ¹Fiberçš„æ›´æ–°é˜Ÿåˆ—ä¸Šï¼Œè¿”å›æ ¹èŠ‚ç‚¹
  const root = enqueueUpdate(current, update);
}

// ...
```

åœ¨`updateContainer`æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº†æ›´æ–°å¯¹è±¡ï¼Œå¹¶å°†è™šæ‹ŸDOMæ·»åŠ åˆ°æ›´æ–°å¯¹è±¡ä¸­ä½œä¸ºæ›´æ–°å†…å®¹ï¼Œè¿™é‡Œçš„`element`å°±æ˜¯è°ƒç”¨`render`æ–¹æ³•æ—¶ä¼ å…¥çš„è™šæ‹ŸDOM

------

åœ¨`src\react-reconciler\src\ReactFiberClassUpdateQueue.js`ä¸­å®ç°`createUpdate`å’Œ`enqueueUpdate`æ–¹æ³•

```js
import { markUpdateLaneFromFiberToRoot } from './ReactFiberConcurrentUpdates';

/**
 * @description åˆ›å»ºæ›´æ–°çš„æ–¹æ³•
 * @returns è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡
 */
export function createUpdate() {
  const update = { tag: UpdateState };
  return update;
}

/**
 * @description å°†æ›´æ–°å¯¹è±¡æ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­çš„æ–¹æ³•
 * @param fiber åˆå§‹çš„fiberå¯¹è±¡
 * @param update æ›´æ–°å¯¹è±¡
 */
export function enqueueUpdate(fiber, update) {
  // è·å–åˆå§‹fiberå¯¹è±¡ä¸Špendingå±æ€§
  const updateQueue = fiber.updateQueue;
  const sharedQueue = updateQueue.shared;
  const pending = sharedQueue.pending;

  if (pending === null) {
    // è‹¥pendingä¸ºnullï¼Œåˆ™è¯´æ˜é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ›´æ–°å¯¹è±¡ï¼Œåˆ™å°†æ›´æ–°å¯¹è±¡çš„nextæŒ‡å‘è‡ªå·±
    update.next = update;
  } else {
    /**
     * è‹¥pendingä¸ä¸ºnullï¼Œåˆ™è¯´æ˜é˜Ÿåˆ—ä¸­å·²ç»æœ‰æ›´æ–°å¯¹è±¡äº†
     * åˆ™å°†è¯¥æ›´æ–°å¯¹è±¡æ’å…¥åˆ°é˜Ÿåˆ—ä¸­
     * è¯¥æ›´æ–°å¯¹è±¡çš„nextæŒ‡å‘åŸæ¥pendingçš„next
     * åŸæ¥pendingçš„nextæŒ‡å‘è¯¥æ›´æ–°å¯¹è±¡
     */
    update.next = pending.next;
    pending.next = update;
  }

  // pending æ°¸è¿œæŒ‡å‘æœ€åé¢çš„æ›´æ–°å¯¹è±¡ï¼Œæœ€åé¢çš„æ›´æ–°å¯¹è±¡çš„nextæ°¸è¿œæŒ‡å‘ç¬¬ä¸€ä¸ªæ›´æ–°å¯¹è±¡
  updateQueue.shared.pending = update;

  // é€šè¿‡å½“å‰fiberæ‰¾åˆ°æ ¹èŠ‚ç‚¹FiberRootNodeå¹¶è¿”å›
  return markUpdateLaneFromFiberToRoot(fiber);
}
```

`createUpdate`ä»…ä»…åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ª`update`å¯¹è±¡

`enqueueUpdate`ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š

- å°†å¤šä¸ª`update`å¯¹è±¡è¿›è¡Œå…³è”ï¼Œæ•´ä¸ªæ›´æ–°é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå¾ªç¯åˆ—è¡¨<!--å…³äºå¾ªç¯åˆ—è¡¨çš„ç¬”è®°åœ¨04ã€ç†è§£fiberè¿™ç¯‡ç¬”è®°ä¸­æœ‰è®°å½•-->
- é€šè¿‡å½“å‰`fiber`æ‰¾åˆ°æ ¹èŠ‚ç‚¹FiberRootNodeå¹¶è¿”å›

------

åœ¨`src\react-reconciler\src\ReactFiberConcurrentUpdates.js`ä¸­å®ç°`markUpdateLaneFromFiberToRoot`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºå‘ä¸Šæ‰¾åˆ°æ ¹èŠ‚ç‚¹`FiberRootNode`

```js
import { HostRoot } from "./ReactWorkTags";

/**
 * æœ¬æ¥æ­¤æ–‡ä»¶è¦å¤„ç†æ›´æ–°ä¼˜å…ˆçº§çš„é—®é¢˜
 * ç›®å‰ç°åœ¨åªå®ç°å‘ä¸Šæ‰¾åˆ°æ ¹èŠ‚ç‚¹
 */
export function markUpdateLaneFromFiberToRoot(sourceFiber) {
  let node = sourceFiber;//å½“å‰fiber
  let parent = sourceFiber.return;//å½“å‰fiberçˆ¶fiber
  while (parent !== null) {
    node = parent;
    parent = parent.return;
  }
  //ä¸€ç›´æ‰¾åˆ°parentä¸ºnullï¼Œparentä¸ºnullåˆ™è¯´æ˜æ‰¾åˆ°äº†HostRootFiber
  if (node.tag === HostRoot) {
    // è¿”å›HostRootFiber.stateNodeï¼Œä¹Ÿå°±æ˜¯FiberRootNode
    return node.stateNode;
  }
  return null;
}
```

`markUpdateLaneFromFiberToRoot`å®ç°çš„é€»è¾‘æ˜¯ï¼Œé€šè¿‡å½“å‰`fiber`ä¸æ–­çš„å‘ä¸Šå¯»æ‰¾çˆ¶`fiber`ç›´åˆ°æ‰¾åˆ°æ²¡æœ‰çˆ¶`fiber`çš„é‚£ä¸ªï¼Œä¹Ÿå°±æ˜¯`HostRootFiber`ï¼Œç„¶åå†é€šè¿‡`HostRootFiber.stateNode`æ‰¾åˆ°`FiberRootNode`<!--å¯¹æ¯”ç€fiberæ ‘çš„ç¤ºæ„å›¾ä¸€çœ‹ä¾¿çŸ¥-->

------

æ›´æ–°é˜Ÿåˆ—çš„ç¤ºæ„å›¾å¦‚ä¸‹ğŸ‘‡ï¼š

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/queuepending_1644750048819.png" alt="img" style="zoom:50%;" />

æ­¤æ—¶å†æ‰“å°`HostRootFiber`å¯ä»¥å‘ç°`updateQueue`å±æ€§ä¸Šå·²ç»æœ‰äº†æ›´æ–°å†…å®¹äº†

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20230208162735984.png" alt="image-20230208162735984" style="zoom:50%;" />

`updateQueue.shared.pending.payload.element`ä¾¿æ˜¯ä¸‹é¢è¿™æ®µ`jsx`æ‰€ç”Ÿæˆçš„VirtualDOM

```jsx
let element = (
  <h1>
    hello<span style={{ color: "red" }}>world</span>
  </h1>
)
```


