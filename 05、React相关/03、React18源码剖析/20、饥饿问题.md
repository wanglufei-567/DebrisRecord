## React18æºç è§£æï¼ˆ20ï¼‰é¥¥é¥¿é—®é¢˜

### ä¸€ã€å‰è¨€

å›é¡¾ä¸‹ä¹‹å‰å®ç°çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­ä½ä¼˜å…ˆçº§ä»»åŠ¡

`main.jsx`

```jsx
import * as React from 'react';
import { createRoot } from 'react-dom/client';

function FunctionComponent() {
  const [numbers, setNumbers] = React.useState(
    new Array(10).fill('A')
  );
  React.useEffect(() => {
    setNumbers(numbers => numbers.map(number => number + 'B'));
  }, []);
  return (
    <button
      onClick={() =>
        setNumbers(numbers => numbers.map(number => number + 'C'))
      }
    >
      {numbers.map((number, index) => (
        <span key={index}>{number}</span>
      ))}
    </button>
  );
}
let element = <FunctionComponent />;
const root = createRoot(document.getElementById('root'));
root.render(element);

```

`onClick`äº‹ä»¶è§¦å‘çš„`setNumebers`ï¼ˆ`updateC`ï¼‰ä¼˜å…ˆçº§ä¸º`SyncLane`(1)ï¼Œ`useEffect`ä¸­è§¦å‘çš„`setNumebers`ï¼ˆ`updateB`ï¼‰ä¼˜å…ˆçº§ä¸º`DefaultLane`(16)ï¼Œ`updateC`çš„ä¼˜å…ˆçº§é«˜äº`updateB`ï¼›è‹¥æ˜¯å½“`updateB`è¿˜åœ¨è¿›è¡Œè®¡ç®—æ—¶ï¼Œ`onClick`äº‹ä»¶è§¦å‘äº†`updateC`ï¼Œé‚£ä¹ˆ`updateB`ä¾¿ä¼šè¢«**==ä¸­æ–­å¹¶å–æ¶ˆ==**ï¼Œä¼˜å…ˆå“åº”`updateC`

è¿™ä¸ªä¾¿æ˜¯==é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­ä½ä¼˜å…ˆçº§ä»»åŠ¡==ï¼Œéœ€è¦æ˜ç¡®ä¸€ç‚¹çš„æ˜¯ï¼Œ==ä½ä¼˜å…ˆçº§ä»»åŠ¡ä»€ä¹ˆæƒ…å†µèƒ½è¢«æ‰“æ–­==ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡åœ¨==å¹¶å‘æ›´æ–°æ—¶æ‰å¯ä»¥è¢«æ‰“æ–­==ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´åˆ‡ç‰‡ç»“æŸåï¼Œä¸‹ä¸€ä¸ªæ—¶é—´åˆ‡ç‰‡æ‰§è¡Œä»»åŠ¡ä¹‹å‰ä¼šæ£€æŸ¥`task.callback`ï¼Œè‹¥æ˜¯`callback`æ²¡æœ‰å€¼ä¾¿ä¼šå°†è¯¥ä»»åŠ¡å¼¹å‡ºï¼Œä»è€Œå®ç°==ä½ä¼˜å…ˆçº§ä»»åŠ¡è¢«ä¸­æ–­å–æ¶ˆ==ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»åŠ¡æ˜¯åœ¨ä¸¤ä¸ªæ—¶é—´åˆ‡ç‰‡ä¸­é—´è¢«æ‰“æ–­ï¼Œ<!--å•æ¬¡æ—¶é—´åˆ‡ç‰‡ä¸­æ˜¯åŒæ­¥é€»è¾‘æ— æ³•è¢«æ‰“æ–­-->

è¿˜æœ‰å¦å¤–ä¸€ç‚¹ä¸»è¦æ³¨æ„çš„ï¼š==åŒæ­¥æ›´æ–°æ—¶æ˜¯æ— æ³•è¢«æ‰“æ–­çš„==ï¼Œå½“ä½ä¼˜å…ˆçº§ä»»åŠ¡==**è¿‡æœŸå**å¹¶åˆ‡æ¢ä¸ºåŒæ­¥æ›´æ–°å®Œæˆå‰©ä¸‹çš„æ›´æ–°ä»»åŠ¡æ—¶ï¼Œä»»åŠ¡æ˜¯æ— æ³•è¢«æ‰“æ–­çš„==

```js
// src/react-reconciler/src/ReactFiberWorkLoop.js
/**
 * é«˜ä¼˜å…ˆçº§æ‰“æ–­ä½ä¼˜å…ˆçº§
 * existingCallbackNodeè¡¨ç¤ºå½“å‰å½“å‰æ ¹ä¸Šæ‰§è¡Œä»»åŠ¡
 * è°ƒç”¨Scheduler_cancelCallbackä¼šå°†å½“å‰ä»»åŠ¡çš„callbackç½®ç©º
 * schedulerä¸­workLoopæ—¶ä¼šå°†è¯¥ä»»åŠ¡å¼¹å‡º
 * åé¢é«˜ä¼˜å…ˆçº§ä»»åŠ¡å†æ‰§è¡Œ
 * ä»è€Œå®ç°é«˜ä¼˜å…ˆçº§æ‰“æ–­ä½ä¼˜å…ˆçº§
 */
if (existingCallbackNode !== null) {
Scheduler_cancelCallback(existingCallbackNode);
}
```

```js
//src/scheduler/src/forks/Scheduler.js

function workLoop(startTime) {
  //...
  const callback = currentTask.callback;
  if (typeof callback === 'function') {
  //...
  } else {
    pop(taskQueue);
  }
  //...
}

/**
* @description å–æ¶ˆå½“å‰ä»»åŠ¡
* å°†task.callbackç½®ä¸ºnullä¹‹åï¼Œåœ¨workLoopä¼šå°†è¯¥ä»»åŠ¡å¼¹å‡ºpop(taskQueue);
*/
function unstable_cancelCallback(task) {
task.callback = null;
}
```

åœ¨é«˜ä¼˜å…ˆçº§æ‰“æ–­ä½ä¼˜å…ˆçº§çš„å®ç°ä¸­ï¼Œæœ‰ä¸€ä¸ªé—ç•™é—®é¢˜ï¼šä½ä¼˜å…ˆçº§ä»»åŠ¡è¢«ä¸­æ–­å–æ¶ˆåï¼Œ==æ›´æ–°ä¸¢å¤±==äº†ï¼Œä¹Ÿå°±æ˜¯`updateB`ä¸ç”Ÿæ•ˆäº†ï¼Œè¿™å½“ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ä¾¿è¦è§£å†³è¿™ä¸ªé—®é¢˜

è§£å†³æ–¹æ³•ï¼šé«˜ä¼˜å…ˆçº§æ›´æ–°`commit`ä¹‹åå†è¿›è¡Œä¸€æ¬¡è°ƒåº¦æ›´æ–°ï¼ˆ`ensureRootIsScheduled`ï¼‰

éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼š

- å¦‚ä½•æ‰¾åˆ°è¢«ä¸¢å¤±çš„`updateB`?
- å¦‚ä½•å¤„ç†æ›´æ–°æ—¶çš„åˆå§‹çŠ¶æ€ï¼Ÿåˆå§‹çŠ¶æ€(A) =ã€‹ä¸­é—´çŠ¶æ€(AC) =ã€‹æœ€ç»ˆçŠ¶æ€(ABC)

é™¤äº†è¦è§£å†³ä½ä¼˜å…ˆçº§ä¸¢å¤±çš„é—®é¢˜ï¼Œå†æ€è€ƒä¸‹è¿™ä¹ˆä¸€ç§åœºæ™¯ï¼š

1. å½“é«˜ä¼˜å…ˆçº§ä»»åŠ¡`UpdateC`å¤„ç†å®Œä¹‹åï¼Œç»§ç»­å¤„ç†`UpdateB`æ—¶ï¼Œåˆæœ‰ä¸€ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡`UpdateC2`è¿›æ¥ï¼Œé‚£ä¹ˆ`UpdateB`å°†åˆè¢«ä¸­æ–­å–æ¶ˆï¼›
2. å½“`UpdateC2`å¤„ç†å®Œæˆä¹‹åç»§ç»­å¤„ç†`UpdateB`æ—¶ï¼Œåˆä¸€ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡`UpdateC3`è¿›æ¥ï¼Œé‚£ä¹ˆ`UpdateB`å°†åˆè¢«ä¸­æ–­å–æ¶ˆ
3. ã€‚ã€‚ã€‚

å¯ä»¥å‘ç°ï¼Œ==åªè¦åœ¨å¤„ç†ä½ä¼˜å…ˆçº§ä»»åŠ¡æ—¶ï¼Œä¸æ–­æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡è¿›æ¥çš„è¯ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡å°†æ°¸è¿œå¾—ä¸åˆ°å¤„ç†==ï¼Œä¹Ÿå°±æ˜¯ä½ä¼˜å…ˆçº§ä»»åŠ¡å°†è¢«é¥¿æ­»ï¼Œè¿™ä¸ªé—®é¢˜ä¾¿æ˜¯**==é¥¥é¥¿é—®é¢˜==**

é‚£ä¹ˆå¦‚ä½•è§£å†³**==é¥¥é¥¿é—®é¢˜==**å‘¢ï¼Ÿ

è§£å†³æ–¹æ³•ï¼šç»™æ¯ä¸ª`lane`éƒ½è®¾ç½®ä¸€ä¸ª**==è¿‡æœŸæ—¶é—´==**ï¼Œ==åªè¦ä»»åŠ¡ä¸€æ—¦è¿‡æœŸä¾¿ç«‹åˆ»åˆ‡æ¢ä¸ºåŒæ­¥æ›´æ–°ï¼Œä¸€æ°”å‘µæˆåœ°å®Œæˆæ›´æ–°ï¼Œä¸å†ç»™é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­æ‰§è¡Œçš„æœºä¼š== <!--schedulerä¸­ä¹Ÿä¼šç»™ä»»åŠ¡è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä½†å’Œlaneçš„è¿‡æœŸæ—¶é—´ä¸å†²çªï¼ŒäºŒè€…æ˜¯å…±åŒä½œç”¨çš„ï¼Œåªè¦æœ‰ä¸€ä¸ªè¿‡æœŸäº†å°±ä¼šåˆ‡æ¢ä¸ºåŒæ­¥æ›´æ–°-->

### äºŒã€è§£å†³é¥¥é¥¿é—®é¢˜

é¦–å…ˆæ”¹é€ ä¸‹`main.jsx`

```jsx
import * as React from 'react';
import { createRoot } from 'react-dom/client';

let counter = 0;
let timer;
let bCounter = 0;
let cCounter = 0;
function FunctionComponent() {
  const [text, setText] = React.useState('A');
  const divRef = React.useRef();
  const updateB = text => text + 'B';
  updateB.id = 'updateB' + bCounter++;

  const updateC = text => text + 'C';
  updateC.id = 'updateC' + cCounter++;

  React.useEffect(() => {
    timer = setInterval(() => {
      if (counter === 0) {
        console.log('updateB');
        setText(updateB); //16
      }
      divRef.current.click(); //1
      if (counter++ > 5) {
        clearInterval(timer);
      }
    });
  }, []);
  return (
    <div
      ref={divRef}
      onClick={() => {
        console.log('updateC');
        setText(updateC);
      }}
    >
      <span>{text}</span>
    </div>
  );
}
let element = <FunctionComponent />;
const root = createRoot(document.getElementById('root'));
root.render(element);
```

`updateB`æ˜¯ä½ä¼˜å…ˆçº§æ›´æ–°ï¼Œ`updateC`æ˜¯é«˜ä¼˜å…ˆçº§æ›´æ–°ï¼Œå¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ä¸­ä¸æ–­çš„æ·»åŠ `updateC`

------

æ¥ç€æ”¹é€ ä¸‹`src/react-reconciler/src/ReactFiberRoot.js`ä¸­`FiberRootNode`çš„æ„é€ å‡½æ•°ï¼Œç»™`root`ä¸Šæ·»åŠ ä¸¤ä¸ªå±æ€§

- `expirationTimes`ï¼š**è¿‡æœŸæ—¶é—´**ï¼Œå­˜æ”¾æ¯ä¸ª`lane`çš„è¿‡æœŸæ—¶é—´
- `expiredLanes`ï¼š**è¿‡æœŸçš„èµ›é“**ï¼Œå­˜æ”¾å·²ç»è¿‡æœŸçš„`lane`

```diff
+import { NoLanes, NoLane, createLaneMap, NoTimestamp } from './ReactFiberLane';

/**
 * @description FiberRootNodeçš„æ„é€ å‡½æ•°ï¼Œç”¨äºåˆ›å»ºfiberæ ¹èŠ‚ç‚¹
 * @param containerInfo å®¹å™¨ä¿¡æ¯ï¼Œæ ¹rootä¸Šçš„å°±æ˜¯çœŸå®DOMï¼Œdiv#root
 */
function FiberRootNode(containerInfo) {
  /*
  å°±æ˜¯åœ¨è¿™é‡Œç»™FiberRootNodeä¸ŠæŒ‚ä¸Šäº†containerInfoï¼Œ
  fiberæ ¹èŠ‚ç‚¹ä¸Šçš„containerInfoç›´æ¥å°±æ˜¯çœŸå®DOMï¼Œdiv#root
  */
  this.containerInfo = containerInfo;

  //è¡¨ç¤ºæ­¤æ ¹ä¸Šæœ‰å“ªäº›èµ›é“ç­‰å¾…è¢«å¤„ç†
  this.pendingLanes = NoLanes;

  // è¡¨ç¤ºæ­¤æ ¹ä¸Šçš„è°ƒåº¦ä¼˜å…ˆçº§
  this.callbackPriority = NoLane;

+  // è¡¨ç¤ºå½“å‰æ ¹ä¸Šæ‰§è¡Œä»»åŠ¡
+  this.callbackNode = null;

+   //è¿‡æœŸæ—¶é—´ å­˜æ”¾æ¯ä¸ªèµ›é“è¿‡æœŸæ—¶é—´
+   this.expirationTimes = createLaneMap(NoTimestamp);

   //è¿‡æœŸçš„èµ›é“
   this.expiredLanes = NoLanes;
}
```

```js
// src/react-reconciler/src/ReactFiberLane.js

//æ²¡æœ‰æ—¶é—´æˆ³
export const NoTimestamp = -1;

/**
 * @description åˆ›å»ºä¸€ä¸ªç”¨äºè®°å½•æ‰€æœ‰è½¦é“è¿‡æœŸæ—¶é—´çš„Map
 */
export function createLaneMap(initial) {
  const laneMap = [];
  for (let i = 0; i < TotalLanes; i++) {
    laneMap.push(initial);
  }
  return laneMap;
}
```

------

æ¥ç€æ”¹é€ `src/react-reconciler/src/ReactFiberReconciler.js`ä¸­çš„å®¹å™¨æ›´æ–°æ–¹æ³•

```diff
+import {
+  scheduleUpdateOnFiber,
+  requestUpdateLane,
+  requestEventTime
+} from './ReactFiberWorkLoop';

/**
 * @description æ›´æ–°å®¹å™¨ï¼ŒæŠŠè™šæ‹ŸDOMå˜æˆçœŸå®DOMæ’å…¥åˆ°containerå®¹å™¨ä¸­
 * @param {*} element è™šæ‹ŸDOM
 * @param {*} container DOMå®¹å™¨ ä¹Ÿå°±æ˜¯FiberRootNode
 * å…¶ä¸­container.containerInfo æŒ‡å‘ div#root
 * container.current æŒ‡å‘ HostRootFiber
 */
export function updateContainer(element, container) {
  //è·å–å½“å‰çš„æ ¹fiber HostRootFiber
  const current = container.current;

  //è¯·æ±‚ä¸€ä¸ªæ›´æ–°è½¦é“ åˆæ¬¡æ¸²æŸ“æ—¶æ˜¯é»˜è®¤äº‹ä»¶è½¦é“ DefaultLane 16
  const lane = requestUpdateLane(current);

+  //è¯·æ±‚å½“å‰äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ï¼Œç”¨äºåç»­ç»™lanesè®¡ç®—è¿‡æœŸæ—¶é—´
+  const eventTime = requestEventTime();

  //åˆ›å»ºæ›´æ–°å¯¹è±¡
  const update = createUpdate(lane);

  //ç»™æ›´æ–°å¯¹è±¡ä¸Šæ·»åŠ è¦æ›´æ–°çš„è™šæ‹ŸDOM
  update.payload = { element };

  //æŠŠæ­¤æ›´æ–°å¯¹è±¡æ·»åŠ åˆ°HostRootFiberçš„æ›´æ–°é˜Ÿåˆ—ä¸Šï¼Œè¿”å›æ ¹èŠ‚ç‚¹
  const root = enqueueUpdate(current, update, lane);

+  // åœ¨fiberä¸Šè°ƒåº¦æ›´æ–°
+  scheduleUpdateOnFiber(root, current, lane, eventTime);
}
```

```diff
// src/react-reconciler/src/ReactFiberWorkLoop.js

import {
  scheduleCallback as Scheduler_scheduleCallback,
  shouldYield,
  ImmediatePriority as ImmediateSchedulerPriority,
  UserBlockingPriority as UserBlockingSchedulerPriority,
  NormalPriority as NormalSchedulerPriority,
  IdlePriority as IdleSchedulerPriority,
  cancelCallback as Scheduler_cancelCallback,
+  now
} from './scheduler';

+//ä¿å­˜å½“å‰çš„äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´
+let currentEventTime = NoTimestamp;

+//è¯·æ±‚å½“å‰çš„æ—¶é—´
+export function requestEventTime() {
+  currentEventTime = now();
+  return currentEventTime; //performance.now()
+}
```

è¿™é‡Œçš„æ”¹é€ æ˜¯ä¸ºäº†åç»­ç»™`lane`è®¡ç®—è¿‡æœŸæ—¶é—´ï¼Œ`lane`çš„è¿‡æœŸæ—¶é—´ = äº‹ä»¶å‘ç”Ÿæ—¶çš„æ—¶é—´`currentEventTime` + `lane`ä»»åŠ¡æ—¶é—´

------

æ¥ç€æ”¹é€ `setState`çš„`dispatch`æ–¹æ³•

```diff
// src/react-reconciler/src/ReactFiberHooks.js
/**
 * @description useStateçš„æ›´æ–°æ–¹æ³•
 * @param {*} fiber functionå¯¹åº”çš„fiber
 * @param {*} queue hookå¯¹åº”çš„æ›´æ–°é˜Ÿåˆ—
 * @param {*} action æ´¾å‘çš„åŠ¨ä½œ
 */
function dispatchSetState(fiber, queue, action) {
  /**
   * â€¼ï¸é‡è¦
   * setStateè§¦å‘çš„æ›´æ–°çš„laneå°±æ˜¯è¿™é‡Œæ·»åŠ åˆ°æ›´æ–°å¯¹è±¡updateä¸Šçš„
   * é»˜è®¤setStateçš„laneä¸º16
   * å…¶ä»–äº‹ä»¶ä¸­çš„setStateçš„laneä¸ºå¯¹åº”äº‹ä»¶çš„lane
   * æ¯”å¦‚ç‚¹å‡»äº‹ä»¶ä¸­çš„setStateçš„laneä¸º1
   */
  // è·å–å½“å‰çš„æ›´æ–°èµ›é“
  const lane = requestUpdateLane();
  // åˆ›å»ºæ›´æ–°å¯¹è±¡
  const update = {
+    lane,
    action,
    hasEagerState: false, //æ˜¯å¦æœ‰æ€¥åˆ‡çš„æ›´æ–°
    eagerState: null, //æ€¥åˆ‡çš„æ›´æ–°çŠ¶æ€
    next: null
  };
  const alternate = fiber.alternate;
  
  // ...

+  /**
+   * æ¯æ¬¡dispatchçš„å½“å‰æ—¶é—´éƒ½è¦ç»™åˆ°scheduleUpdateOnFiber
+   * ç”¨äºåç»­è®¡ç®—å½“å‰laneçš„è¿‡æœŸæ—¶é—´
+   */
+  // å½“å‰æ›´æ–°å‘ç”Ÿçš„æ—¶é—´
+  const eventTime = requestEventTime();
-  scheduleUpdateOnFiber(root, fiber, lane);
+  scheduleUpdateOnFiber(root, fiber, lane, eventTime);
}
```

è¿™é‡Œçš„æ”¹é€ åŒæ ·æ˜¯ä¸ºäº†åç»­ç»™`lane`è®¡ç®—è¿‡æœŸæ—¶é—´

------

æ¥ç€ç»§ç»­æ”¹é€ `scheduleUpdateOnFiber`å’Œ`ensureRootIsScheduled`

```diff
// src/react-reconciler/src/ReactFiberWorkLoop.js

/**
 * @description åœ¨fiberä¸Šè°ƒåº¦æ›´æ–° ä¹Ÿå°±æ˜¯è®¡åˆ’æ›´æ–°root
 * æºç ä¸­æ­¤å¤„æœ‰ä¸€ä¸ªä»»åŠ¡çš„åŠŸèƒ½ï¼Œè¿™é‡Œåç»­å†å®ç°
 * @param root æ ¹ FiberRootNode
 * @param lane è½¦é“ åˆæ¬¡æ¸²æŸ“æ—¶æ˜¯é»˜è®¤äº‹ä»¶è½¦é“ DefaultLane 16
 * @param eventTime å½“å‰äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ï¼Œç”¨äºåç»­ç»™lanesè®¡ç®—è¿‡æœŸæ—¶é—´
 */
- export function scheduleUpdateOnFiber(root, fiber, lane) {
+ export function scheduleUpdateOnFiber(root, fiber, lane, eventTime) {
+    console.log('scheduleUpdateOnFiber', lane);
    // ç»™å½“æ ¹ root æ ‡è®°æ›´æ–°çš„è½¦é“
    markRootUpdated(root, lane);
    // ç¡®ä¿è°ƒåº¦æ‰§è¡Œrootä¸Šçš„æ›´æ–°
-    ensureRootIsScheduled(root);
+    ensureRootIsScheduled(root, eventTime);
  }
  
  /**
 * @description ç¡®ä¿æ‰§è¡Œrootä¸Šçš„æ›´æ–°
 */
function ensureRootIsScheduled(root, currentTime) {
//... 

+  /**
+   * @description æ ‡è®°æ‰€æœ‰é¥¥é¥¿èµ›é“ä¸ºè¿‡æœŸ
+   * rootä¸Šæœ‰ä¸ªå±æ€§expirationTimesç”¨äºè®°å½•31æ¡laneçš„è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤å€¼ä¸º-1ï¼‰
+   * å½“root.pendingLanesä¸ä¸ºNoLanesæ—¶
+   * ç¬¬ä¸€æ¬¡ä¼šä¸ºpendingLanesçš„æ¯æ¡laneè®¡ç®—è¿‡æœŸæ—¶é—´expirationTime
+   * åé¢ä¼šæ¯”è¾ƒexpirationTimeå’ŒcurrentTime
+   * è‹¥expirationTime<currentTimeï¼Œè¯´æ˜å¯¹åº”çš„laneå·²ç»è¿‡æœŸ
+   * è¿‡æœŸçš„laneä¼šè¢«è®°å½•åˆ°root.expiredLanes
+   */
+  markStarvedLanesAsExpired(root, currentTime);

//...
}
```

å®ç°æ ‡è®°æ‰€æœ‰é¥¥é¥¿èµ›é“ä¸ºè¿‡æœŸçš„æ–¹æ³•`markStarvedLanesAsExpired`

```js
export function markStarvedLanesAsExpired(root, currentTime) {
  //è·å–å½“å‰æ‰€æœ‰æ›´æ–°èµ›é“
  const pendingLanes = root.pendingLanes;
  //è·å–rootä¸Šè®°å½•æ‰€æœ‰èµ›é“è¿‡æœŸæ—¶é—´çš„å±æ€§
  const expirationTimes = root.expirationTimes;

  let lanes = pendingLanes;
  while (lanes > 0) {
    //è·å–æœ€å·¦ä¾§çš„1çš„ç´¢å¼•
    const index = pickArbitraryLaneIndex(lanes);
    const lane = 1 << index;
    const expirationTime = expirationTimes[index];

    //å¦‚æœæ­¤èµ›é“ä¸Šæ²¡æœ‰è¿‡æœŸæ—¶é—´,è¯´æ˜æ²¡æœ‰ä¸ºæ­¤è½¦é“è®¾ç½®è¿‡æœŸæ—¶é—´
    if (expirationTime === NoTimestamp) {
      expirationTimes[index] = computeExpirationTime(
        lane,
        currentTime
      );
    } else if (expirationTime <= currentTime) {
      //å¦‚æœæ­¤è½¦é“çš„è¿‡æœŸæ—¶é—´å·²ç»å°äºç­‰äºå½“å‰æ—¶é—´äº†ï¼ŒæŠŠæ­¤è½¦é“æ·»åŠ åˆ°è¿‡æœŸè½¦é“é‡Œ
      root.expiredLanes |= lane;
      console.log(
        'expirationTime',
        expirationTime,
        'currentTime',
        currentTime,
        root.expiredLanes
      );
    }
    lanes &= ~lane;
  }
}

/**
 * å–æ˜¯å·¦ä¾§çš„1çš„ç´¢å¼•
 */
function pickArbitraryLaneIndex(lanes) {
  //clz32è¿”å›æœ€å·¦ä¾§çš„1çš„å·¦è¾¹0çš„ä¸ªæ•°
  //  000100010
  return 31 - Math.clz32(lanes);
}

/**
 * @description è®¡ç®—è½¦é“çš„è¿‡æœŸæ—¶é—´
 */
function computeExpirationTime(lane, currentTime) {
  switch (lane) {
    case SyncLane:
    case InputContinuousLane:
      return currentTime + 250;
    case DefaultLane:
      return currentTime + 5000;
    case IdleLane:
      return NoTimestamp;
    default:
      return NoTimestamp;
  }
}
```

`markStarvedLanesAsExpired`åšçš„äº‹

 `root`ä¸Šæœ‰ä¸ªå±æ€§`expirationTimes`ç”¨äºè®°å½•31æ¡`lane`çš„è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤å€¼ä¸º-1ï¼‰

-   ç¬¬ä¸€æ¬¡ä¼šä¸º`pendingLanes`çš„æ¯æ¡`lane`è®¡ç®—è¿‡æœŸæ—¶é—´`expirationTime`

-   åé¢ä¼šæ¯”è¾ƒ`expirationTime`å’Œ`currentTime`ï¼Œè‹¥`expirationTime<currentTime`ï¼Œè¯´æ˜å¯¹åº”çš„`lane`å·²ç»è¿‡æœŸ

-  è¿‡æœŸçš„`lane`ä¼šè¢«è®°å½•åˆ°`root.expiredLanes`

å½“æ¯æ¬¡æœ‰æ–°çš„æ›´æ–°ï¼Œæ‰§è¡Œ`ensureRootIsScheduled`æ—¶ä¾¿ä¼šæ£€æŸ¥`pendingLanes`çš„æ¯æ¡`lane`æ˜¯å¦å·²è¿‡æœŸ <!--æ£€æŸ¥çš„å‰ææ˜¯æœ‰æ–°çš„æ›´æ–°è¿›æ¥ï¼Œè‹¥æ˜¯æ²¡æœ‰æ–°çš„æ›´æ–°è¿›æ¥ï¼Œé‚£ä¾¿ä¸ä¼šæœ‰é«˜ä¼˜æ‰“æ–­ä½ä¼˜ï¼Œåªéœ€æŒ‰ç…§åŸæœ¬çš„é¡ºåºæ‰§è¡Œå³å¯-->

------

æ¥ç€æ”¹é€ å¹¶å‘æ¸²æŸ“çš„æ–¹æ³•`performConcurrentWorkOnRoot`ä¸­å…³äºæ˜¯å¦å¼€å¯æ—¶é—´åˆ‡ç‰‡çš„é€»è¾‘

```diff
// src/react-reconciler/src/ReactFiberWorkLoop.js

/**
 * @description æ‰§è¡Œrootä¸Šçš„å¹¶å‘æ›´æ–°å·¥ä½œ
 * @description æ ¹æ®è™šæ‹ŸDOMæ„å»ºfiberæ ‘,è¦åˆ›å»ºçœŸå®çš„DOMèŠ‚ç‚¹
 * @description è¿˜éœ€è¦æŠŠçœŸå®çš„DOMèŠ‚ç‚¹æ’å…¥å®¹å™¨
 * @param root  æ ¹ FiberRootNode
 */
function performConcurrentWorkOnRoot(root, didTimeout) {
  // console.log('performConcurrentWorkOnRoot__didTimeout', didTimeout);
  //å…ˆè·å–å½“å‰æ ¹èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡
  const originalCallbackNode = root.callbackNode;

  //è·å–å½“å‰ä¼˜å…ˆçº§æœ€é«˜çš„è½¦é“ åˆæ¬¡æ¸²æŸ“æ—¶æ˜¯é»˜è®¤äº‹ä»¶è½¦é“ DefaultLane 16
  const lanes = getNextLanes(root, NoLanes); //16
  if (lanes === NoLanes) {
    return null;
  }

-  const shouldTimeSlice = !includesBlockingLane(root, lanes) && !didTimeout;

+  /**
+   * å¦‚æœä¸åŒ…å«é˜»å¡çš„è½¦é“ã€ä¸åŒ…å«è¿‡æœŸçš„è½¦é“ã€å¹¶ä¸”ä»»åŠ¡æ²¡æœ‰è¶…æ—¶ï¼Œ
+   * å°±å¯ä»¥å¹¶è¡Œæ¸²æŸ“,å°±æ˜¯å¯ç”¨æ—¶é—´åˆ†ç‰‡
+   * æ‰€ä»¥è¯´é»˜è®¤æ›´æ–°è½¦é“æ˜¯åŒæ­¥çš„,ä¸èƒ½å¯ç”¨æ—¶é—´åˆ†ç‰‡ï¼ˆæ²¡æœ‰å¼€å¯Concurrent Modeçš„æ¨¡å¼ï¼‰
+   * å½“ä»»åŠ¡è¶…æ—¶ä¹‹åå°±ä¸èƒ½ä½¿ç”¨æ—¶é—´åˆ†ç‰‡ï¼Œç›´æ¥èµ°åŒæ­¥æ¸²æŸ“
+   */
+  //æ˜¯å¦ä¸åŒ…å«é˜»å¡è½¦é“
+  const nonIncludesBlockingLane = !includesBlockingLane(root, lanes);
+  //æ˜¯å¦ä¸åŒ…å«è¿‡æœŸçš„è½¦é“
+  const nonIncludesExpiredLane = !includesExpiredLane(root, lanes);
+  //æ—¶é—´ç‰‡æ²¡æœ‰è¿‡æœŸ
+  const nonTimeout = !didTimeout;
+  //ä¸‰ä¸ªå˜é‡éƒ½æ˜¯çœŸï¼Œæ‰èƒ½è¿›è¡Œæ—¶é—´åˆ†ç‰‡ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œå¹¶å‘æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¸­æ–­æ‰§è¡Œ
+  const shouldTimeSlice = nonIncludesBlockingLane && nonIncludesExpiredLane && nonTimeout;
+  console.log('shouldTimeSlice', shouldTimeSlice);

//...
}
```

æ˜¯å¦å¼€å¯æ—¶é—´åˆ‡ç‰‡`shouldTimeSlice`çš„åˆ¤æ–­å¢åŠ äº†æ˜¯å¦ä¸åŒ…å«è¿‡æœŸçš„è½¦é“çš„åˆ¤æ–­ï¼Œè‹¥æ˜¯å½“å‰æ›´æ–°çš„`lane`è¿‡æœŸäº†ï¼Œ`shouldTimeSlice`ä¾¿ä¸º`false`ï¼Œä¹Ÿå°±æ˜¯åˆ‡æ¢ä¸ºåŒæ­¥æ›´æ–°

```js
//æ˜¯å¦ä¸åŒ…å«è¿‡æœŸçš„è½¦é“
const nonIncludesExpiredLane = !includesExpiredLane(root, lanes);
```

```js
// src/react-reconciler/src/ReactFiberLane.js

/**
 * @description åˆ¤æ–­å½“å‰laneæ˜¯å¦è¿‡æœŸ
 */
export function includesExpiredLane(root, lanes) {
  return (lanes & root.expiredLanes) !== NoLanes;
}
```

------

æ¥ä¸‹æ¥è§£å†³ä½ä¼˜å…ˆçº§æ›´æ–°ä¸¢å¤±çš„é—®é¢˜

å›å¿†ä¸‹==*16ã€Reactä¸­çš„Laneæ¨¡å‹*==ä¸­æ”¹é€ çš„å¤„ç†`fiber`ä¸Šæ›´æ–°é˜Ÿåˆ—çš„æ–¹æ³• `ReactUpdateQueue`ï¼Œä¼šå°†ä½ä¼˜å…ˆçº§çš„æ›´æ–°æŒ‚èµ·åˆ°`baseQueue`ä¸Šå¾…ä¸‹æ¬¡æ‰§è¡Œï¼›

`hook`ä¸Šçš„æ›´æ–°é˜Ÿåˆ—ä¹Ÿæœ‰ä¸€æ ·çš„é€»è¾‘ï¼Œçœ‹ä¸‹é¢çš„å®ç°

```js
function updateReducer(reducer) {
  const hook = updateWorkInProgressHook();
  const queue = hook.queue;
  queue.lastRenderedReducer = reducer;
  const current = currentHook;
  let baseQueue = current.baseQueue;
  const pendingQueue = queue.pending;
  //æŠŠæ–°æ—§æ›´æ–°é“¾è¡¨åˆå¹¶
  if (pendingQueue !== null) {
    if (baseQueue !== null) {
      const baseFirst = baseQueue.next;
      const pendingFirst = pendingQueue.next;
      baseQueue.next = pendingFirst;
      pendingQueue.next = baseFirst;
    }
    current.baseQueue = baseQueue = pendingQueue;
    queue.pending = null;
  }
  if (baseQueue !== null) {
    printQueue(baseQueue);
    const first = baseQueue.next;
    let newState = current.baseState;
    let newBaseState = null;
    let newBaseQueueFirst = null;
    let newBaseQueueLast = null;
    let update = first;
    do {
      const updateLane = update.lane;
      const shouldSkipUpdate = !isSubsetOfLanes(
        renderLanes,
        updateLane
      );
      if (shouldSkipUpdate) {
        const clone = {
          lane: updateLane,
          action: update.action,
          hasEagerState: update.hasEagerState,
          eagerState: update.eagerState,
          next: null
        };
        if (newBaseQueueLast === null) {
          newBaseQueueFirst = newBaseQueueLast = clone;
          newBaseState = newState;
        } else {
          newBaseQueueLast = newBaseQueueLast.next = clone;
        }

        /**
         * â€¼ï¸é‡è¦
         * è¿™é‡Œé‡ç½®äº†å½“å‰fiberçš„lanes
         * é‡ç½®ä¸ºäº†æ‰€æœ‰è¢«è·³è¿‡çš„æ›´æ–°çš„lanes
         * ä¸ºä»€ä¹ˆä¼šè¢«é‡ç½®å‘¢ï¼Ÿ
         * è¿™æ˜¯å› ä¸ºåœ¨beginWorkä¸­ä¼šå°†å½“å‰fiberçš„lanesç›´æ¥é‡ç½®ä¸ºNoLanes
         * è¿™é‡Œå†é‡æ–°èµ‹å€¼
         */
        currentlyRenderingFiber.lanes = mergeLanes(
          currentlyRenderingFiber.lanes,
          updateLane
        );

      } else {
        if (newBaseQueueLast !== null) {
          const clone = {
            lane: NoLane,
            action: update.action,
            hasEagerState: update.hasEagerState,
            eagerState: update.eagerState,
            next: null
          };
          newBaseQueueLast = newBaseQueueLast.next = clone;
        }
        if (update.hasEagerState) {
          newState = update.eagerState;
        } else {
          const action = update.action;
          newState = reducer(newState, action);
        }
      }
      update = update.next;
    } while (update !== null && update !== first);
    if (newBaseQueueLast === null) {
      newBaseState = newState;
    } else {
      newBaseQueueLast.next = newBaseQueueFirst;
    }
    hook.memoizedState = newState;
    hook.baseState = newBaseState;
    hook.baseQueue = newBaseQueueLast;
    queue.lastRenderedState = newState;
  }
  if (baseQueue === null) {
    queue.lanes = NoLanes;
  }
  const dispatch = queue.dispatch;
  return [hook.memoizedState, dispatch];
}
```

é€»è¾‘åŸºæœ¬ä¸Šä¸€æ ·ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œé€šè¿‡è¿™ä¸€æœºåˆ¶ï¼Œä½ä¼˜å…ˆçº§çš„æ›´æ–°ä¾¿ä¸ä¼šè¢«ä¸¢å¤±äº†ï¼Œè€Œæ˜¯æŒ‚åœ¨`baseQueue`ä¸Šäº†

å…¶ä¸­

```js
printQueue(baseQueue);
```

```js
function printQueue(queue) {
  const first = queue.next;
  let desc = '';
  let update = first;
  do {
    desc += '=>' + update.action.id;
    update = update.next;
  } while (update !== null && update !== first);
  desc += '=>null';
  console.log(desc);
}
```

æ˜¯ä¸€æ®µè°ƒè¯•ä»£ç ï¼Œæ˜¯ä¸ºäº†æ‰“å°`baseQueue`ä¸­æ‰€æœ‰è¢«æŒ‚èµ·çš„æ›´æ–°ï¼Œæ–¹ä¾¿ç†è§£æ•´ä¸ªæµç¨‹

------

æ¥ä¸‹æ¥æ”¹é€ `src/react-reconciler/src/ReactFiberWorkLoop.js`ä¸­çš„æäº¤æ›´æ–°çš„æ–¹æ³•`commitRootImpl`ï¼Œå®ç°é«˜ä¼˜ä»»åŠ¡æ›´æ–°æäº¤å®Œæˆåï¼Œç»§ç»­è°ƒåº¦ä½ä¼˜ä»»åŠ¡

```diff
/**
 * @description æäº¤é˜¶æ®µçš„å…·ä½“é€»è¾‘
 * @param root æ ¹èŠ‚ç‚¹
 */
function commitRootImpl(root) {
  //å…ˆè·å–æ–°çš„æ„å»ºå¥½çš„fiberæ ‘çš„æ ¹fiber tag=3
  const { finishedWork } = root;
+  console.log('commit',finishedWork.child.memoizedState.memoizedState);
  workInProgressRoot = null;
  workInProgressRootRenderLanes = NoLanes;
  root.callbackNode = null;
  root.callbackPriority = NoLane;

+  //åˆå¹¶ç»Ÿè®¡å½“å‰æ–°çš„æ ¹ä¸Šå‰©ä¸‹çš„è½¦é“
+  const remainingLanes = mergeLanes(
+    finishedWork.lanes, // æ ¹fiberè‡ªå·±çš„lanes
+    finishedWork.childLanes // æ‰€æœ‰å­fiberçš„lanes
+  );

+  // å°†é™¤äº†æ ¹ä¸Šå‰©ä¸‹çš„è½¦é“ä»¥å¤–çš„æ‰€æœ‰è½¦é“æ ‡è®°ä¸ºå·²å®Œæˆ
+  markRootFinished(root, remainingLanes);

  if (
    (finishedWork.subtreeFlags & Passive) !== NoFlags ||
    (finishedWork.flags & Passive) !== NoFlags
  ) {
    if (!rootDoesHavePassiveEffect) {
      rootDoesHavePassiveEffect = true;
      Scheduler_scheduleCallback(
        NormalSchedulerPriority,
        flushPassiveEffects
      );
    }
  }
  //åˆ¤æ–­å­æ ‘æœ‰æ²¡æœ‰å‰¯ä½œç”¨
  const subtreeHasEffects =
    (finishedWork.subtreeFlags & MutationMask) !== NoFlags;
  const rootHasEffect =
    (finishedWork.flags & MutationMask) !== NoFlags;
  //å¦‚æœè‡ªå·±çš„å‰¯ä½œç”¨æˆ–è€…å­èŠ‚ç‚¹æœ‰å‰¯ä½œç”¨å°±è¿›è¡Œæäº¤DOMæ“ä½œ
  if (subtreeHasEffects || rootHasEffect) {
    //å½“DOMæ‰§è¡Œå˜æ›´ä¹‹å
    commitMutationEffectsOnFiber(finishedWork, root);
    //æ‰§è¡Œlayout Effect
    commitLayoutEffects(finishedWork, root);
    if (rootDoesHavePassiveEffect) {
      rootDoesHavePassiveEffect = false;
      rootWithPendingPassiveEffects = root;
    }
  }
  //ç­‰DOMå˜æ›´åï¼Œå°±å¯ä»¥æŠŠè®©rootçš„currentæŒ‡å‘æ–°çš„fiberæ ‘
  root.current = finishedWork;

+  //åœ¨æäº¤ä¹‹åï¼Œå› ä¸ºæ ¹ä¸Šå¯èƒ½ä¼šæœ‰è·³è¿‡çš„æ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°å†æ¬¡è°ƒåº¦
+  ensureRootIsScheduled(root, now());
}
```

å¢åŠ äº†ä¸‰éƒ¨åˆ†é€»è¾‘ï¼š

- åˆå¹¶ç»Ÿè®¡å½“å‰æ–°çš„æ ¹ä¸Šæ‰€æœ‰è¢«æŒ‚èµ·çš„`lane`ï¼š`remainingLanes`

  ```js
  const remainingLanes = mergeLanes(
    finishedWork.lanes, // æ ¹fiberè‡ªå·±çš„lanes
    finishedWork.childLanes // æ‰€æœ‰å­fiberçš„lanes
  );
  ```

  <!--childLanesæ˜¯æ‰€æœ‰å­fiberä¸Šçš„laneså†’æ³¡åˆ°æ ¹fiberä¸Šçš„ï¼Œè¿™éƒ¨åˆ†çš„é€»è¾‘åé¢ä¼šå®ç°-->

- å°†å·²ç»å®Œæˆçš„`lane`æ ‡è®°ä¸ºå®Œæˆ

  ```js
  markRootFinished(root, remainingLanes);
  ```

  ```js
  // src/react-reconciler/src/ReactFiberLane.js
  
  /**
   * @description å°†é™¤äº†è¢«ä¿ç•™çš„laneä¹‹å¤–çš„æ‰€æœ‰laneæ ‡è®°ä¸ºå·²å®Œæˆ
   * é‡ç½®root.pendingLanesä¸ºè¢«ä¿ç•™çš„è½¦é“remainingLanes
   * å°†root.expirationTimesä¸Šå·²å®Œæˆçš„laneçš„è¿‡æœŸæ—¶é—´é‡ç½®ä¸ºNoTimestamp
   */
  export function markRootFinished(root, remainingLanes) {
    //pendingLanesæ ¹ä¸Šæ‰€æœ‰çš„å°†è¦è¢«æ¸²æŸ“çš„è½¦é“ 1å’Œ2
    //remainingLanes è¢«ä¿ç•™çš„è½¦é“ 2
    //noLongerPendingLanesæŒ‡çš„æ˜¯å·²ç»æ›´æ–°è¿‡çš„lane
    const noLongerPendingLanes = root.pendingLanes & ~remainingLanes;
    root.pendingLanes = remainingLanes;
    const expirationTimes = root.expirationTimes;
    let lanes = noLongerPendingLanes;
    while (lanes > 0) {
      //è·å–æœ€å·¦ä¾§çš„1çš„ç´¢å¼•
      const index = pickArbitraryLaneIndex(lanes);
      const lane = 1 << index;
      //æ¸…é™¤å·²ç»è®¡ç®—è¿‡çš„è½¦é“çš„è¿‡æœŸæ—¶é—´
      expirationTimes[index] = NoTimestamp;
      lanes &= ~lane;
    }
  }
  ```

  è¿™é‡Œå°±æ˜¯å°†å·²ç»å®Œæˆçš„`lane`ä»`root.pendingLanes`ä¸Šæ¶ˆé™¤ï¼ŒåŒæ—¶é‡ç½®`expirationTimes`ä¸­å·²ç»å®Œæˆçš„`lane`çš„è¿‡æœŸæ—¶é—´ä¸º`NoTimestamp`(-1)

- é‡æ–°æ‰§è¡Œè°ƒåº¦æ›´æ–°ï¼Œå®Œæˆä½ä¼˜ä»»åŠ¡çš„æ›´æ–°

  ```js
  ensureRootIsScheduled(root, now());
  ```

  ç”±äºå·²ç»å®Œæˆçš„`lane`å·²ç»ä»`root.pendingLanes`ä¸Šæ¶ˆé™¤ï¼Œé‚£ä¹ˆå†æ¬¡ensureRootIsScheduledæ—¶ï¼Œ`root.pendingLanes`ä¸Šçš„æœ€é«˜ä¼˜`lane`ä¾¿ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå˜æˆæ¯”ä¹‹å‰ä½ä¼˜çš„`lane`ï¼Œä»è€Œå®ç°ç»§ç»­è°ƒåº¦æ‰§è¡Œè¢«æŒ‚èµ·çš„`lane`

------

æ¥ä¸‹æ¥å®ç°å¤„ç†`childLanes`çš„é€»è¾‘

é¦–å…ˆæ˜¯`beginWork`

```diff
// src/react-reconciler/src/ReactFiberBeginWork.js

/**
 * @description ç›®æ ‡æ˜¯æ ¹æ®æ–°è™šæ‹ŸDOMæ„å»ºæ–°çš„fiberå­é“¾è¡¨ .child .sibling
 * @param current è€fiber
 * @param workInProgress æ–°çš„fiber h1
 */
export function beginWork(current, workInProgress, renderLanes) {
+  /**
+   * â€¼ï¸é‡è¦
+   * åœ¨å¤„ç†å½“å‰fiberèŠ‚ç‚¹ä¹‹å‰ï¼Œå°†å…¶fiberçš„lanesé‡ç½®ä¸ºNoLanes
+   * ä¸ºä½•è¦é‡ç½®ï¼Ÿ
+   * è¿™æ˜¯å› ä¸ºä¸€ä¸ªfiberä¸Šçš„æ‰€æœ‰laneå¯èƒ½æ— æ³•ä¸€æ¬¡æ›´æ–°å®Œæˆ
+   * ä¼šä¼˜å…ˆå®ŒæˆrenderLaneså¯¹åº”çš„laneï¼Œä¼˜å…ˆå®Œæˆçš„laneä¾¿éœ€è¦è¢«å»é™¤
+   * å¦‚ä½•å»é™¤ï¼Ÿç›´æ¥é‡ç½®ä¸ºNoLanesï¼Œç„¶åå†é‡æ–°åˆå¹¶è®¡ç®—
+   * fiberä¸Šæ–°çš„lanesä¼šç”±è¢«å‰©ä¸‹çš„æ‰€æœ‰æ›´æ–°å¯¹è±¡updateä¸­çš„laneåˆå¹¶ç”Ÿæˆ
+   *
+   * âš ï¸æ³¨æ„ éœ€è¦åŒºåˆ†renderLanes å’Œfiber.lanes
+   * renderLanesæ˜¯root.pendingLanesä¸­ä¼˜å…ˆçº§æœ€é«˜çš„lane
+   * fiber.lanesæ˜¯ç”±fiberä¸Šæ‰€æœ‰æ›´æ–°å¯¹è±¡updateä¸­çš„laneåˆå¹¶ç”Ÿæˆ
+   */
+  workInProgress.lanes = NoLanes;
  
  //...
 }
```

åœ¨`beginWork`å¼€å§‹ä¹‹å‰å°†å½“å‰`fiber`èŠ‚ç‚¹çš„`lanes`é‡ç½®ä¸º`NoLanes`ï¼Œé‚£ä¹ˆ`fiber`çš„`lanes`æ˜¯ä»€ä¹ˆæ—¶å€™é‡æ–°èµ‹å€¼çš„å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯åœ¨å¤„ç†æ›´æ–°é˜Ÿåˆ—æ—¶ï¼Œçœ‹ä¸‹`setState`ä¸­å¤„ç†æ›´æ–°é˜Ÿåˆ—çš„æ–¹æ³•ä¸­è¿™æ®µé€»è¾‘ğŸ‘‡

```js
currentlyRenderingFiber.lanes = mergeLanes(
  currentlyRenderingFiber.lanes,
  updateLane
);
```

å¤„ç†`fiber`èŠ‚ç‚¹ä¸Šæ›´æ–°é˜Ÿåˆ—çš„æ–¹æ³•ï¼š`processUpdateQueue`ä¸­ä¹Ÿæœ‰åŒæ ·çš„é€»è¾‘

ä¹Ÿå°±æ˜¯è¯´==`fiber`èŠ‚ç‚¹ä¸Šæ–°çš„`lanes`ç”±æ‰€æœ‰å¾…å®Œæˆçš„æ›´æ–°çš„`lane`åˆå¹¶è€Œæˆ==

------

æ¥ç€æ˜¯`completWork`

```diff
//src/react-reconciler/src/ReactFiberCompleteWork.js

/**
 * @description å‘ä¸Šå†’æ³¡å±æ€§
 * @param completedWork å·²å®Œæˆçš„fiber
 */
function bubbleProperties(completedWork) {
+  let newChildLanes = NoLanes;
  let subtreeFlags = NoFlags;
  //éå†å½“å‰fiberçš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼ŒæŠŠæ‰€æœ‰çš„å­èŠ‚çš„å‰¯ä½œç”¨ï¼Œä»¥åŠå­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„å‰¯ä½œç”¨å…¨éƒ¨åˆå¹¶
  let child = completedWork.child;
  while (child !== null) {
+    // å‘ä¸Šå†’æ³¡lanes,æ‰€æœ‰å­fiberçš„lanesæœ€ç»ˆä¼šå†’æ³¡åˆ°HostRootFiberä¸Š
+    newChildLanes = mergeLanes(newChildLanes, mergeLanes(child.lanes, child.childLanes));
    subtreeFlags |= child.subtreeFlags;
    subtreeFlags |= child.flags;
    child = child.sibling;
  }
+  completedWork.childLanes = newChildLanes;
  completedWork.subtreeFlags = subtreeFlags;
}
```

è¿™é‡Œä¾¿æ˜¯å°†å­`fiber`çš„`lanes`å‘ä¸Šå†’æ³¡ï¼Œæœ€ç»ˆä¼šå†’æ³¡åˆ°`HostRootFiber`ä¸Šï¼Œæˆä¸º`HostRootFiber.childLanes`

æœ€ç»ˆåœ¨æäº¤é˜¶æ®µä¸­ç”¨äºè®¡ç®—`remainingLanes`ğŸ‘‡

```js
const remainingLanes = mergeLanes(
  finishedWork.lanes, // æ ¹fiberè‡ªå·±çš„lanes
  finishedWork.childLanes // æ‰€æœ‰å­fiberçš„lanes
);
```

------

å¥½äº†ï¼Œæ‰€æœ‰çš„å®ç°åˆ°è¿™å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹å®ç°æ•ˆæœ

`main.jsx`

```jsx
import * as React from 'react';
import { createRoot } from 'react-dom/client';

let counter = 0;
let timer;
let bCounter = 0;
let cCounter = 0;
function FunctionComponent() {
  const [text, setText] = React.useState('A');
  const divRef = React.useRef();
  const updateB = text => text + 'B';
  updateB.id = 'updateB' + bCounter++;

  const updateC = text => text + 'C';
  updateC.id = 'updateC' + cCounter++;

  React.useEffect(() => {
    timer = setInterval(() => {
      if (counter === 0) {
        console.log('updateB');
        setText(updateB); //16
      }
      divRef.current.click(); //1
      if (counter++ > 5) {
        clearInterval(timer);
      }
    });
  }, []);
  return (
    <div
      ref={divRef}
      onClick={() => {
        console.log('updateC');
        setText(updateC);
      }}
    >
      <span>{text}</span>
    </div>
  );
}
let element = <FunctionComponent />;
const root = createRoot(document.getElementById('root'));
root.render(element);

```

çœ‹ä¸‹ä¼˜å…ˆå“åº”`updateC`æ—¶çš„åœºæ™¯

![image-20230308153758964](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20230308153758964.png)

çœ‹ä¸‹`updateB` `lane`åˆ°æœŸä¹‹åï¼Œç›´æ¥ä¸€æ°”å‘µæˆæ›´æ–°å®Œæˆçš„åœºæ™¯

![image-20230308154709289](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20230308154709289.png)

------

`updateB`ä¹‹æ‰€ä»¥éœ€è¦å¹¶å‘æ›´æ–°é‚£ä¹ˆé•¿æ—¶é—´ï¼Œæ˜¯å› ä¸ºæ·»åŠ äº†è°ƒè¯•ä»£ç 

```js
// src/react-reconciler/src/ReactFiberWorkLoop.js

/**
 * @description å¹¶å‘æ¨¡å¼çš„å·¥ä½œå¾ªç¯æ–¹æ³•
 */
function workLoopConcurrent() {
  /*
    â€¼ï¸é‡è¦é‡è¦é‡è¦
    å¦‚æœæœ‰ä¸‹ä¸€ä¸ªè¦æ„å»ºçš„fiberå¹¶ä¸”æ—¶é—´ç‰‡æ²¡æœ‰è¿‡æœŸå°±ç»§ç»­å¾ªç¯
    è‹¥æ˜¯shouldYieldè¿”å›trueè¡¨ç¤ºå½“å‰æ—¶é—´åˆ‡ç‰‡è¿‡æœŸäº†ï¼Œéœ€è¦é€€å‡ºå¾ªç¯
    é€€å‡ºå¾ªç¯årenderRootConcurrentä¸­ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œè¡¨ç¤ºå½“å‰fiberæ ‘æ˜¯å¦æ„å»ºå®Œæˆ
    shouldYieldæ˜¯schedulerä¸­ç”¨æ¥åˆ¤æ–­æ—¶é—´åˆ‡ç‰‡æ˜¯å¦è¿‡æœŸçš„æ–¹æ³•
   */
  while (workInProgress !== null && !shouldYield()) {
    sleep(2000);
    performUnitOfWork(workInProgress);
  }
}
```

```js
function sleep(duration) {
  const timeStamp = new Date().getTime();
  const endTime = timeStamp + duration;
  while (true) {
    if (new Date().getTime() > endTime) {
      return;
    }
  }
}
```

å…¶ä¸­  `sleep(2000)` å¯ä»¥ä½¿å½“å‰`fiber`èŠ‚ç‚¹çš„å¤„ç†æ—¶é—´åŠ é•¿ï¼Œè¿™æ ·ä¸€æ¬¡æ—¶é—´åˆ‡ç‰‡åªèƒ½å¤„ç†ä¸€ä¸ª`fiber`èŠ‚ç‚¹

### ä¸‰ã€æ€»ç»“

==é¥¥é¥¿é—®é¢˜æ˜¯å› ä¸ºé«˜ä¼˜ä»»åŠ¡ä¸æ–­ä¸­æ–­å–æ¶ˆå¯¼è‡´ä½ä¼˜ä»»åŠ¡ä¸€ç›´å¾—ä¸åˆ°æ‰§è¡Œå¼•èµ·çš„==ï¼›

**React**æ˜¯è¿™ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼š

- ç»™æ¯ä¸ª`lane`==è®¾ç½®è¿‡æœŸæ—¶é—´==ï¼Œ==æ¯æ¬¡æœ‰æ–°çš„æ›´æ–°ä»»åŠ¡è¿›æ¥æ—¶==ï¼Œ==æ£€æŸ¥==æ¯æ¡`lane`çš„==è¿‡æœŸæ—¶é—´==ï¼Œè‹¥==è¿‡æœŸåˆ™è¢«è®°å½•==ï¼Œå¾…ä½==ä¼˜ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶ç›´æ¥é‡‡ç”¨åŒæ­¥æ›´æ–°é€»è¾‘ï¼Œç›´æ¥ä¸€æ°”å‘µæˆå®Œæˆä»»åŠ¡==
- é™¤äº†ç»™`lane`è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œ`scheduler`ä¸­ä¹Ÿä¼šç»™æ¯ä¸ªå¹¶å‘ä»»åŠ¡è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè‹¥è¿‡æœŸäº†åŒæ ·ä¼šåˆ‡æ¢ä¸ºåŒæ­¥æ›´æ–°é€»è¾‘

å¦å¤–ï¼Œéœ€è¦æ˜ç¡®çš„ä¸€ç‚¹ï¼š==é«˜ä¼˜ä»»åŠ¡æ˜¯åœ¨ä½ä¼˜ä»»åŠ¡ä¸¤ä¸ªæ—¶é—´åˆ‡ç‰‡ä¸­é—´å°†å…¶æ‰“æ–­å–æ¶ˆçš„ï¼Œä¸€ä¸ªæ—¶é—´åˆ‡ç‰‡å°±æ˜¯ä¸€ä¸ªå®ä»»åŠ¡==