## HTTP 强缓存与协议缓存

**「HTTP 缓存」**主要包括两类：**强缓存（Strong Cache）与协商缓存（Negotiated Cache）**

合理利用缓存可以显著降低服务器压力、减少带宽消耗、提升页面加载速度

### 一、强缓存与协商缓存简介

- **强缓存（Strong Cache）**

  - 当浏览器发起请求时，**若本地已有有效缓存副本**，并且满足服务器响应头中的强缓存规则，浏览器将**直接使用缓存，不发起网络请求**

  - 关键字段：`Cache-Control`、`Expires`

- **协商缓存（Negotiated Cache）**

  - **当强缓存失效后**，浏览器会向服务器**发送请求并附带缓存标识**（如 `ETag` 或 `Last-Modified`），服务器根据这些标识判断资源是否更新

    - 若资源**未变更**，返回 `304 Not Modified`，浏览器继续使用缓存

    - 若资源**已变更**，返回 `200 OK` 和新的资源，浏览器更新缓存副本

  - 关键字段：`ETag` / `If-None-Match`，`Last-Modified` / `If-Modified-Since`

### 二、缓存处理流程机制

1. **浏览器首次请求资源**
   - 服务器返回资源内容，并设置缓存相关响应头（如 `Cache-Control`, `ETag`）
2. **浏览器再次请求资源，流程如下：**

```
     ┌────────────┐
     │ 浏览器发起请求 │
     └────┬───────┘
          ↓
  ┌──────────────────────────┐
  │ 是否命中强缓存？         │ ← Cache-Control / Expires
  └────┬────────────┬───────┘
       │ 是          │ 否
       ↓             ↓
[直接使用缓存]    [进入协商缓存流程]
                     ↓
   ┌───────────────────────────┐
   │ 浏览器发送请求 + 协商标识 │
   │ If-None-Match / If-Modified-Since │
   └────┬────────────┬────────┘
        │ 命中        │ 未命中
        ↓             ↓
[返回 304 使用缓存] [返回 200 新资源]
```

### 三、关键字段详解与归类

#### 3.1、强缓存字段（响应头）
| 字段名          | 类型   | 说明                                         |
| --------------- | ------ | -------------------------------------------- |
| `Cache-Control` | 响应头 | 控制是否启用缓存、缓存时长等策略（HTTP/1.1） |
| `Expires`       | 响应头 | 缓存过期时间（HTTP/1.0，已被替代）           |

**示例说明：**

- `Cache-Control: max-age=3600`
  - 表示资源在 3600 秒（1 小时）内有效，浏览器可直接使用缓存
- `Expires: Wed, 21 Oct 2025 07:28:00 GMT`
  - 表示资源在该时间点前都可直接使用缓存


#### 3.2、Cache-Control 在请求头和响应头中的作用与优先级

- **请求头中的 Cache-Control**：

  - 客户端在请求头中设置 `Cache-Control` 是为了**向服务器表达其缓存策略的偏好**

    - 某些指令（如 `no-store`）可以直接控制浏览器不使用缓存，而其他指令（如 `no-cache`、`max-age`）则更多是影响缓存校验流程
  
      > **HTML** 页面的  `<meta>` 标签可以指定 `no-store`
      >
      > 例如： <meta http-equiv="Cache-Control" content="no-cache">
  
  - 常见值
| 值         | 含义                                                     |
| ---------- | -------------------------------------------------------- |
| `max-age`  | 指定客户端愿意接受的缓存资源的最大时间（以秒为单位），但不一定能阻止浏览器使用本地缓存 |
| `no-cache` | 要求服务器验证资源的有效性，而不是直接使用缓存，浏览器会去服务器做协商缓存 |
| `no-store` | 不使用任何缓存，既不在本地存储缓存，也不从服务器获取缓存，浏览器不会使用缓存 |

<!--但最终是否使用缓存、如何响应，依然由服务器决定-->

- **响应头中的 Cache-Control**：
  - 服务器在响应头中设置 `Cache-Control` 是为了**指示客户端如何缓存响应**

  - 常见值：

| 值             | 含义                                                                 |
| -------------- | -------------------------------------------------------------------- |
| `max-age`      | 指定资源在多少秒内有效，客户端在此期间可直接使用缓存                |
| `no-cache`     | 强制要求客户端在使用缓存前向服务器验证资源的有效性                  |
| `no-store`     | 不允许缓存任何响应数据，确保每次请求都能获取最新的数据              |
| `public`       | 指示响应可以被任何缓存区（如浏览器、CDN等）缓存                     |
| `private`      | 指示响应仅能被单个用户缓存，不能在共享缓存中存储                    |
| `must-revalidate` | 指示缓存必须在使用前验证其有效性，即使在缓存未过期的情况下      |

**最终生效的依据**：

在实际应用中，最终生效的缓存策略通常以响应头中的 `Cache-Control` 为准，因为服务器的指令优先级更高

服务器通过响应头明确指示客户端如何处理缓存，而客户端的请求头则是表达其期望

某些请求头指令（如 `no-store`）可以直接影响缓存行为，但大多数情况下，缓存行为还要结合本地缓存状态和服务器响应头共同决定

#### 3.3、协商缓存字段

服务器处理协商缓存时，会比对**「请求头」**中的 `If-None-Match` 和 `If-Modified-Since` 字段与服务器当前资源的 `ETag` 和 `Last-Modified` 值：

- 对于 `If-None-Match`：服务器会将其值与当前资源的 `ETag` 进行精确匹配
  - 如果相同，说明资源未发生变更，返回 `304`
  - 否则返回新资源

- 对于 `If-Modified-Since`：服务器会将其时间与当前资源的 `Last-Modified` 时间进行比较
  - 如果资源的修改时间早于或等于该时间，也认为未变更，返回 `304`
  - 否则返回新资源。


| 字段名              | 类型   | 说明                               |
| ------------------- | ------ | ---------------------------------- |
| `ETag`              | 响应头 | 资源版本标识，唯一 ID              |
| `If-None-Match`     | 请求头 | 浏览器携带的 ETag 值，供服务器比对 |
| `Last-Modified`     | 响应头 | 资源上次修改时间                   |
| `If-Modified-Since` | 请求头 | 浏览器携带的时间戳，与服务器比对   |

### 四、字段优先级与策略选择

- **判断顺序**：
   - 浏览器首先检查是否命中强缓存（`Cache-Control` 优先于 `Expires`）
   - 若未命中强缓存，则进入协商缓存流程
   - 协商缓存优先使用 `ETag` / `If-None-Match`，其次为 `Last-Modified` / `If-Modified-Since`
- **字段优先级表**：

| 优先级 | 字段                              | 类型                 |
| ------ | --------------------------------- | -------------------- |
| ★★★★★  | Cache-Control                     | 强缓存控制（最优先） |
| ★★★★☆  | ETag + If-None-Match              | 协商缓存（精确标识） |
| ★★★☆☆  | Last-Modified + If-Modified-Since | 协商缓存（时间标识） |
| ★★☆☆☆  | Expires                           | 早期字段，易失效     |

### 六、典型缓存策略配置示例

| 场景             | 建议配置                                                     |
| ---------------- | ------------------------------------------------------------ |
| 带版本号静态资源 | `Cache-Control: max-age=31536000, immutable`，不设置协商缓存 |
| 无版本号静态资源 | `Cache-Control: no-cache` + `ETag` 或 `Last-Modified`        |
| 动态接口数据     | `Cache-Control: no-store` 或 `no-cache` + `ETag`             |

