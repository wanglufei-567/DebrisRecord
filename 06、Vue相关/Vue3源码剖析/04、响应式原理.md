

## Vue3æºç å‰–æï¼ˆå››ï¼‰â€” Vue3å“åº”å¼åŸç†

### ä¸€ã€å‰è¨€

#### 1.1ã€Vue3ä¸Vue2çš„åŒºåˆ«

##### 1.1.1ã€å“åº”å¼å®ç°ä¸Šçš„ä¸åŒ

- åœ¨Vue2çš„æ—¶å€™ä½¿ç”¨`defineProperty`æ¥è¿›è¡Œæ•°æ®çš„åŠ«æŒ, éœ€è¦å¯¹å±æ€§è¿›è¡Œé‡å†™æ·»åŠ `getter`åŠ`setter` **æ€§èƒ½å·®**
- å½“æ–°å¢å±æ€§å’Œåˆ é™¤å±æ€§æ—¶æ— æ³•ç›‘æ§å˜åŒ–ã€‚éœ€è¦é€šè¿‡`$set`ã€`$delete`å®ç°
- æ•°ç»„ä¸é‡‡ç”¨`defineProperty`æ¥è¿›è¡ŒåŠ«æŒ ï¼ˆæµªè´¹æ€§èƒ½ï¼Œå¯¹æ‰€æœ‰ç´¢å¼•è¿›è¡ŒåŠ«æŒä¼šé€ æˆæ€§èƒ½æµªè´¹ï¼‰éœ€è¦å¯¹æ•°ç»„å•ç‹¬è¿›è¡Œå¤„ç†

Vue3ä¸­ä½¿ç”¨`Proxy`æ¥å®ç°å“åº”å¼æ•°æ®å˜åŒ–ï¼Œä»è€Œè§£å†³äº†ä¸Šè¿°é—®é¢˜

##### 1.1.2ã€CompositionAPIä¸OptionsAPI

- åœ¨Vue2ä¸­é‡‡ç”¨çš„æ˜¯OptionsAPI, ç”¨æˆ·æä¾›çš„`data`,`props`,`methods`,`computed`,`watch`ç­‰å±æ€§ (ç”¨æˆ·ç¼–å†™å¤æ‚ä¸šåŠ¡é€»è¾‘ä¼šå‡ºç°åå¤æ¨ªè·³é—®é¢˜)
- Vue2ä¸­æ‰€æœ‰çš„å±æ€§éƒ½æ˜¯é€šè¿‡`this`è®¿é—®ï¼Œ`this`å­˜åœ¨æŒ‡å‘æ˜ç¡®é—®é¢˜
- Vue2ä¸­å¾ˆå¤šæœªä½¿ç”¨æ–¹æ³•æˆ–å±æ€§ä¾æ—§ä¼šè¢«æ‰“åŒ…ï¼Œå¹¶ä¸”æ‰€æœ‰å…¨å±€APIéƒ½åœ¨Vueå¯¹è±¡ä¸Šå…¬å¼€ã€‚Composition APIå¯¹ `tree-shaking` æ›´åŠ å‹å¥½ï¼Œä»£ç ä¹Ÿæ›´å®¹æ˜“å‹ç¼©ã€‚
- ç»„ä»¶é€»è¾‘å…±äº«é—®é¢˜ï¼Œ Vue2 é‡‡ç”¨`mixins` å®ç°ç»„ä»¶ä¹‹é—´çš„é€»è¾‘å…±äº«ï¼› ä½†æ˜¯ä¼šæœ‰æ•°æ®æ¥æºä¸æ˜ç¡®ï¼Œå‘½åå†²çªç­‰é—®é¢˜ã€‚ Vue3é‡‡ç”¨CompositionAPI æå–å…¬å…±é€»è¾‘éå¸¸æ–¹ä¾¿

ç®€å•çš„ç»„ä»¶ä»ç„¶å¯ä»¥é‡‡ç”¨OptionsAPIè¿›è¡Œç¼–å†™ï¼ŒcompositionAPIåœ¨å¤æ‚çš„é€»è¾‘ä¸­æœ‰ç€æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚ `reactivity`æ¨¡å—ä¸­å°±åŒ…å«äº†å¾ˆå¤šæˆ‘ä»¬ç»å¸¸ä½¿ç”¨åˆ°çš„`API` ä¾‹å¦‚ï¼š`computed`ã€`reactive`ã€`ref`ã€`effect`ç­‰

### äºŒã€reactiveä¸effect

### 2.1ã€reactivityæ¨¡å—åŸºæœ¬ä½¿ç”¨

```html
  <script>
    const { effect, reactive } = VueReactivity;

    const obj = { name: 'zf', age: 13, address: { num: 30 }, flag: true }

    // reactive() ä¼šå¯¹å±æ€§è¿›è¡ŒåŠ«æŒ proxyï¼Œ ç›‘å¬ç”¨æˆ·çš„è·å–æ“ä½œå’Œè®¾ç½®æ“ä½œ
    // reactive() åªèƒ½ä¼ å…¥å¯¹è±¡ï¼Œ å› ä¸ºproxy åªæ”¯æŒå¯¹è±¡æ ¼å¼
    const state = reactive(obj);

    // effect å‡½æ•°é»˜è®¤ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œ åç»­æ•°æ®å˜åŒ–äº†ä¼šé‡æ–°æ‰§è¡Œeffectå‡½æ•°
    effect(() => {
      app.body.innerHTML = state.name + 'ä»Šå¹´' + state.age + 'å²äº†é—¨ç‰Œå·æ˜¯ ' + state.address.num
    })

    setTimeout(() => {
      state.age++
    }, 1000)
  </script>
</body>
```

`reactive`æ–¹æ³•ä¼šå°†å¯¹è±¡å˜æˆproxyå¯¹è±¡ï¼Œ `effect`ä¸­åœ¨ä½¿ç”¨`reactive`å¯¹è±¡æ—¶ä¼šè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œç¨åå±æ€§å˜åŒ–æ—¶ä¼šé‡æ–°æ‰§è¡Œ`effect`å‡½æ•°~

### 2.2ã€reactiveæ–¹æ³•å®ç°

#### 2.2.1ã€Ploxyå’ŒReflectä¸­çš„receiver

`Reflect.get(target, name, receiver)`

å¦‚æœ`name`å±æ€§è®¾ç½®äº†`getter`ã€`setter`æ–¹æ³•ï¼Œåˆ™æ–¹æ³•ä¸­çš„`this`æŒ‡å‘`receiver`

```js
var target = {
  c: 1,
  get a() { return this.c }
}

Reflect.get(target, 'a', { c: 2 }) // 2
```

`Ploxy`ä¸­çš„`get(target, propKey, receiver)`ä¸`set(target, propKey, value, receiver)`

 `receiver` æŒ‡å‘ `proxy` æœ¬èº«æˆ–è€…ç»§æ‰¿å®ƒçš„å¯¹è±¡

ä¸‹é¢æ˜¯`Proxy`å’Œ`Reflect`ç»“åˆä½¿ç”¨çš„ä¾‹å­ğŸ‘‡

```js
var target = {
  get a() {
    return this.b
  }
}

var p = new Proxy(target, {
  get(target, key, receiver) {
     if (key === 'b') { return 3 }
     return Reflect.get(target, key)
  }
})

p.a // undefined, target æœ¬èº«æ²¡æœ‰ b è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥è®¿é—®åˆ°çš„æ˜¯ undefined
```

```js
var p = new Proxy(target, {
  get(target, key, receiver) {
     if (key === 'b') { return 3 }
     return Reflect.get(p, key)
  }
})

p.a // è¿™æ ·ä¼šæ­»å¾ªç¯, getä¸­ä¼šå†æ¬¡è§¦å‘get
```

```js
var p = new Proxy(target, {
  get(target, key, receiver) {
     if (key === 'b') { return 3 }
     return Reflect.get(target, key, receiver)
  }
})

p.a // 3, é€šè¿‡è®¾ç½®targetä¸­get a()ä¸­çš„thisæŒ‡å‘proxyæœ¬èº«ï¼Œä»è€Œèƒ½å¤Ÿèµ°åˆ°proxyä¸­çš„get()ä¸­
```

#### 2.2.2ã€WeakMapä½¿ç”¨

`WeakMap`ç»“æ„ä¸`Map`ç»“æ„ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”¨äºç”Ÿæˆé”®å€¼å¯¹çš„é›†åˆã€‚

```javascript
// WeakMap å¯ä»¥ä½¿ç”¨ set æ–¹æ³•æ·»åŠ æˆå‘˜
const wm1 = new WeakMap();
const key = {foo: 1};
wm1.set(key, 2);
wm1.get(key) // 2

// WeakMap ä¹Ÿå¯ä»¥æ¥å—ä¸€ä¸ªæ•°ç»„ï¼Œ
// ä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°
const k1 = [1, 2, 3];
const k2 = [4, 5, 6];
const wm2 = new WeakMap([[k1, 'foo'], [k2, 'bar']]);
wm2.get(k2) // "bar"
```

`WeakMap`ä¸`Map`çš„åŒºåˆ«æœ‰ä¸¤ç‚¹ã€‚

- `WeakMap`åªæ¥å—å¯¹è±¡ä½œä¸ºé”®åï¼ˆ`null`é™¤å¤–ï¼‰ï¼Œä¸æ¥å—å…¶ä»–ç±»å‹çš„å€¼ä½œä¸ºé”®åã€‚

- `WeakMap`çš„é”®åæ‰€æŒ‡å‘çš„å¯¹è±¡ï¼Œä¸è®¡å…¥åƒåœ¾å›æ”¶æœºåˆ¶ã€‚

`WeakMap`çš„è®¾è®¡ç›®çš„åœ¨äºï¼Œæœ‰æ—¶æˆ‘ä»¬æƒ³åœ¨æŸä¸ªå¯¹è±¡ä¸Šé¢å­˜æ”¾ä¸€äº›æ•°æ®ï¼Œä½†æ˜¯è¿™ä¼šå½¢æˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨

```javascript
const e1 = document.getElementById('foo');
const e2 = document.getElementById('bar');
const arr = [
  [e1, 'foo å…ƒç´ '],
  [e2, 'bar å…ƒç´ '],
];
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`e1`å’Œ`e2`æ˜¯ä¸¤ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬é€šè¿‡`arr`æ•°ç»„å¯¹è¿™ä¸¤ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›æ–‡å­—è¯´æ˜ã€‚è¿™å°±å½¢æˆäº†`arr`å¯¹`e1`å’Œ`e2`çš„å¼•ç”¨ã€‚

ä¸€æ—¦ä¸å†éœ€è¦è¿™ä¸¤ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¿…é¡»æ‰‹åŠ¨åˆ é™¤è¿™ä¸ªå¼•ç”¨ï¼Œå¦åˆ™åƒåœ¾å›æ”¶æœºåˆ¶å°±ä¸ä¼šé‡Šæ”¾`e1`å’Œ`e2`å ç”¨çš„å†…å­˜ã€‚

```javascript
// ä¸éœ€è¦ e1 å’Œ e2 çš„æ—¶å€™
// å¿…é¡»æ‰‹åŠ¨åˆ é™¤å¼•ç”¨
arr [0] = null;
arr [1] = null;
```

ä¸Šé¢è¿™æ ·çš„å†™æ³•æ˜¾ç„¶å¾ˆä¸æ–¹ä¾¿ï¼Œä¸€æ—¦å¿˜äº†å†™ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚

`WeakMap` å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œè¯ç”Ÿçš„ï¼Œå®ƒçš„é”®åæ‰€å¼•ç”¨çš„å¯¹è±¡éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œå³åƒåœ¾å›æ”¶æœºåˆ¶ä¸å°†è¯¥å¼•ç”¨è€ƒè™‘åœ¨å†…ã€‚å› æ­¤ï¼Œåªè¦æ‰€å¼•ç”¨çš„å¯¹è±¡çš„å…¶ä»–å¼•ç”¨éƒ½è¢«æ¸…é™¤ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶å°±ä¼šé‡Šæ”¾è¯¥å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ä¸å†éœ€è¦ï¼ŒWeakMap é‡Œé¢çš„é”®åå¯¹è±¡å’Œæ‰€å¯¹åº”çš„é”®å€¼å¯¹ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œä¸ç”¨æ‰‹åŠ¨åˆ é™¤å¼•ç”¨ã€‚

#### 2.2.3ã€reactiveæ–¹æ³•å…·ä½“å®ç°

> `reactive(target)`çš„æ¥å—å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹ã€‚å¦åˆ™æ²¡æœ‰ä»»ä½•æ•ˆæœ
>
> `reactive(target)`å®ç°çš„æ ¸å¿ƒå°±æ˜¯åˆ©ç”¨`proxy`å¯¹`target`è¿›è¡Œä»£ç†

```typescript
// packages/reactivity/src/reactive.ts
import { isObject } from '@vue/shared';
import { mutableHandlers } from './baseHandlers';

function createReactiveObject(target: object) {
  // åªæ¥å—å¯¹è±¡åšä»£ç†
  if (!isObject(target)) {
    return target;
  }

  // å¯¹targetè¿›è¡Œä»£ç†
  const proxy = new Proxy(target, mutableHandlers);
  return proxy;
}

// å¸¸ç”¨çš„å°±æ˜¯reactiveæ–¹æ³•
export function reactive(target: object) {
  return createReactiveObject(target, false);
}

```

```typescript
// packages/reactivity/src/baseHandlers.ts
export const mutableHandlers: ProxyHandler<object> = {
  get(target, key, receiver) {
    // ç­‰ä¼šè°æ¥å–å€¼å°±åšä¾èµ–æ”¶é›†
    const res = Reflect.get(target, key, receiver);
    return res;
  },
  set(target, key, value, receiver) {
    // ç­‰ä¼šèµ‹å€¼çš„æ—¶å€™å¯ä»¥é‡æ–°è§¦å‘effectæ‰§è¡Œ
    const result = Reflect.set(target, key, value, receiver);
    return result;
  }
};
```

`isObject()`çš„è·¯å¾„åŠå®ç°

```typescript
// packages/shared/src/index.ts
export const isObject = (value) =>{
  return typeof value === 'object' && value !== null
}
```

ä»¥ä¸Šå°±æ˜¯`Reactive(target)`ä¸»è¦æ ¸å¿ƒä»£ç ï¼Œå¾ˆç®€å•çš„ä»£ç†å®ç°

ä¸Šé¢çš„`Reactive(target)`å·²ç»å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ï¼Œä½†æ˜¯è¿˜æœ‰äº›ç‰¹æ®Šæƒ…å†µéœ€è¦è¿›è¡Œå…œåº•é€»è¾‘å¤„ç†

ä¸¤ä¸ªç‰¹æ®Šæƒ…å†µï¼š

- `Reactive(target)`ä¸­çš„`target`å·²ç»è¢«ä»£ç†è¿‡äº†ï¼Œå¦‚æœå†æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡ï¼Œæœªå…æœ‰ç‚¹æµªè´¹å†…å­˜å’Œæ€§èƒ½ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œç¼“å­˜å¤„ç†ï¼Œè‹¥`target`å·²ç»è¢«ä»£ç†è¿‡äº†ï¼Œåˆ™ç›´æ¥è¿”å›ä»£ç†å¯¹è±¡
- `Reactive(target)`ä¸­çš„`target`å·²ç»æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡äº†ï¼Œé‚£å®Œå…¨æ²¡æœ‰å¿…è¦å¯¹ä¸€ä¸ªä»£ç†å¯¹è±¡è¿›è¡Œå†æ¬¡ä»£ç†ï¼Œæ‰€ä»¥éœ€è¦å¢åŠ åˆ¤æ–­`target`æ˜¯å¦æ˜¯ä»£ç†å¯¹è±¡çš„é€»è¾‘

å®Œæ•´ä»£ç å¦‚ä¸‹ğŸ‘‡

```typescript
// packages/reactivity/src/reactive.ts
import { isObject } from '@vue/shared';
import { ReactiveFlags, mutableHandlers } from './baseHandlers';

// ç¼“å­˜åˆ—è¡¨ï¼Œä½¿ç”¨è¦ä»£ç†çš„å¯¹è±¡ä½œkey
const reactiveMap = new WeakMap();

function createReactiveObject(target: object, isReadonly: boolean) {
  // åªæ¥å—å¯¹è±¡åšä»£ç†
  if (!isObject(target)) {
    return target;
  }

  /**
   * åœ¨è¿›è¡Œå¯¹è±¡ä»£ç†å‰å…ˆè¿›è¡Œå–å€¼ï¼Œçœ‹æ˜¯å¦å·²ç»æ˜¯ä»£ç†å¯¹è±¡äº†
   * è‹¥ä¸æ˜¯ä»£ç†å¯¹è±¡åˆ™target[ReactiveFlags.IS_REACTIVE]ä¸ºundefined
   * è‹¥æ˜¯å·²ç»ä»£ç†è¿‡çš„å¯¹è±¡ï¼Œåˆ™ä¼šèµ°åˆ°mutableHandlers.get()ä¸­ï¼Œè¿”å›å€¼ä¸ºtrue
   * å³target[ReactiveFlags.IS_REACTIVE]===trueè¡¨ç¤ºtargetå·²ç»è¢«ä»£ç†è¿‡äº†
   */
  if (target[ReactiveFlags.IS_REACTIVE]) {
    return target;
  }

  // å¦‚æœå·²ç»ä»£ç†è¿‡åˆ™ç›´æ¥è¿”å›ä»£ç†åçš„å¯¹è±¡
  const existingProxy = reactiveMap.get(target);
  if (existingProxy) {
    return existingProxy;
  }

  // å¯¹targetè¿›è¡Œä»£ç†
  const proxy = new Proxy(target, mutableHandlers);
  // ç¼“å­˜å·²ç»ä»£ç†çš„å¯¹è±¡
  reactiveMap.set(target, proxy);

  return proxy;
}

// å¸¸ç”¨çš„å°±æ˜¯reactiveæ–¹æ³•
export function reactive(target: object) {
  return createReactiveObject(target, false);
}
```

```typescript
// packages/reactivity/src/baseHandlers.ts
export const enum ReactiveFlags {
  IS_REACTIVE = '__v_isReactive'
}

export const mutableHandlers: ProxyHandler<object> = {
  get(target, key, receiver) {
    // åœ¨getä¸­å¢åŠ æ ‡è¯†ï¼Œå½“è·å–IS_REACTIVEæ—¶è¿”å›true
    if (key === ReactiveFlags.IS_REACTIVE) {
      console.log('IS_REACTIVE', target)
      return true;
    }
    // ç­‰ä¼šè°æ¥å–å€¼å°±åšä¾èµ–æ”¶é›†
    const res = Reflect.get(target, key, receiver);
    console.log('get', target, res)
    return res;
  },
  set(target, key, value, receiver) {
    // ç­‰ä¼šèµ‹å€¼çš„æ—¶å€™å¯ä»¥é‡æ–°è§¦å‘effectæ‰§è¡Œ
    const result = Reflect.set(target, key, value, receiver);
    return result;
  }
};
```

ä½¿ç”¨æ•ˆæœ

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="./reactivity.global.js"></script>
  <div id="app"></div>
  <script>
    const { effect, reactive } = VueReactivity;

    const obj = { name: 'zf', age: 13, address: { num: 30 }, flag: true }

    const state = reactive(obj);
    console.log(state) // ProxyÂ {name: 'zf', age: 13, address: {â€¦}, flag: true}
    
    const state2 = reactive(obj);
    console.log(state === state2) // true

    const state3 = reactive(state);
    console.log(state === state3) // true
  </script>
</body>

</html>
```

### 2.3ã€effectæ–¹æ³•å®ç°

`effect(fn)`ä¸­çš„`fn`ï¼Œé¦–å…ˆé»˜è®¤æ‰§è¡Œä¸€æ¬¡ï¼Œåç»­è‹¥`fn`ä¸­ä¾èµ–åˆ°çš„`reactiveObject`çš„å±æ€§å‘ç”Ÿå˜åŒ–ï¼Œåˆ™`fn`ä¼šå†æ¬¡æ‰§è¡Œï¼›Vue3ä¸­çš„`effect()`ç›¸å½“äºVue2ä¸­çš„`watcher`ï¼Œéƒ½æ˜¯å±æ€§æ•°æ®å˜åŒ–ä¹‹åæ‰§è¡Œç›¸åº”çš„å›è°ƒï¼›è¯´åˆ°è¿™é‡Œï¼Œå…¶å®å°±åº”è¯¥æƒ³åˆ°**è§‚å¯Ÿè€…æ¨¡å¼**å’Œ**å‘å¸ƒè®¢é˜…æ¨¡å¼**ï¼›åœ¨Vue2ä¸­ä½¿ç”¨åˆ°çš„ä¾¿æ˜¯**è§‚å¯Ÿè€…æ¨¡å¼**ï¼Œ`reactiveObject`çš„å±æ€§çš„`set()`ä¸­è°ƒç”¨`watcher`çš„`update()`å®Œæˆå›è°ƒçš„æ‰§è¡Œï¼›åœ¨Vue3ä¸­ä½¿ç”¨åˆ°çš„äº‹**å‘å¸ƒè®¢é˜…æ¨¡å¼**ï¼Œ`reactiveObject`çš„å±æ€§çš„`set()`ä¸­è°ƒç”¨`ReactiveEffect`ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰çš„`trigger()`æ–¹æ³•ï¼Œ`trigger()`æ–¹æ³•ä¼šå°†`ReactiveEffect`ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰ä¸­çš„ç»´æŠ¤çš„å›è°ƒé˜Ÿåˆ—ä¸­ï¼ˆå…¶å®æ˜¯`ReactiveEffect`å®ä¾‹ï¼Œå®ä¾‹ä¸Šçš„`run()`æ‰æ˜¯`effect(fn)`ä¸­çš„fnï¼‰çš„å›è°ƒæ‹¿å‡ºæ¥ä¸€ä¸€æ‰§è¡Œ

#### 2.3.1ã€effect()å‡½æ•°

```js
// packages/reactivity/src/effect.ts
export let activeEffect = undefined;// å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect

class ReactiveEffect {
    deps = []; // æ”¶é›†effectä¸­ä½¿ç”¨åˆ°çš„å±æ€§
    constructor(public fn) { }
    run() {
        // è®¾ç½®æˆæ­£åœ¨æ¿€æ´»çš„æ˜¯å½“å‰effect
        activeEffect = this;
        return this.fn();
    }
}
export function effect(fn) {
    const _effect = new ReactiveEffect(fn); // åˆ›å»ºå“åº”å¼effect
    _effect.run(); // è®©å“åº”å¼effecté»˜è®¤æ‰§è¡Œ
}
```

å…¶ä¸­`activeEffect`æ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œè®°å½•çš„æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„`effect`ï¼ˆæ˜¯`ReactiveEffect`å®ä¾‹ï¼‰ï¼Œæ‰€ä»¥åœ¨`reactive.ts`ä¸­æ˜¯å¯ä»¥ç›´æ¥æ‹¿åˆ°å¹¶ç›´æ¥ä½¿ç”¨çš„ï¼Œåç»­çš„ä¾èµ–æ”¶é›†å°±æ˜¯ä½¿ç”¨è¿™ä¸ª`activeEffect`å…¨å±€å˜é‡ï¼Œåœ¨`Proxy`çš„`get()`ä¸­å®Œæˆçš„

```js
export let activeEffect = undefined;
```

æ¯ä¸€ä¸ª`effect(fn)`æ–¹æ³•çš„æ‰§è¡Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª`ReactiveEffect`å®ä¾‹ï¼Œä¸ºä»€ä¹ˆè¦å•ç‹¬å®ä¾‹åŒ–ä¸€ä¸ª`ReactiveEffect`æ¥æ‰§è¡Œ`fn`ï¼Œé‚£æ˜¯å› ä¸º`ReactiveEffect`ä¸Šå®ç°äº†`effect`ä¾èµ–çš„å±æ€§ã€æ¿€æ´»çŠ¶æ€ç­‰å¾ˆå¤šå±æ€§åŠ`effect`å¤±æ´»ç­‰æ–¹æ³•ï¼ˆè¿™äº›åé¢ä¼šç”¨åˆ°ï¼‰

```js
export function effect(fn) {
    const _effect = new ReactiveEffect(fn); // åˆ›å»ºå“åº”å¼effect
    _effect.run(); // è®©å“åº”å¼effecté»˜è®¤æ‰§è¡Œ
}
```

#### 2.3.2ã€ä¾èµ–æ”¶é›†`track()`æ–¹æ³•

æ‰€è°“**ä¾èµ–æ”¶é›†**å°±æ˜¯åœ¨`effect(fn)`ä¸­`fn`é»˜è®¤æ‰§è¡Œï¼ˆç¬¬ä¸€æ¬¡æ‰§è¡Œï¼‰æ—¶ï¼Œå¯¹`fn`ä¸­ä¾èµ–åˆ°çš„`reactiveObject`çš„`attr`

è¿›è¡Œæ”¶é›†ï¼Œå®ç°å¦‚ä¸‹ğŸ‘‡

```js
// packages/reactivity/src/effect.ts

// è®°å½•ä¾èµ–å…³ç³»ï¼Œæ•°æ®æ ¼å¼{target: { attr: [effect, effect]}}
const targetMap = new WeakMap();
export function track(target, key) {
  if (activeEffect) {
    let depsMap = targetMap.get(target);
    if (!depsMap) {
      targetMap.set(target, (depsMap = new Map()));
    }
    let deps = depsMap.get(key);
    if (!deps) {
      depsMap.set(key, (deps = new Set()));
    }
    // ä¾èµ–æ”¶é›†çš„å­˜å‚¨æ“ä½œ
    trackEffects(deps);
  }
}

export function trackEffects(deps) {
  /**
   * è‹¥æ˜¯å½“å‰attrå·²ç»è®°å½•äº†æ­¤activeEffect
   * åˆ™ä¸å†æ¬¡æ”¶é›†
   */
  let shouldTrack = !deps.has(activeEffect);
  if (shouldTrack) {
    // attr è®°å½• effect
    deps.add(activeEffect);
    // effect è®°å½• attr æ”¾çš„æ˜¯set
    activeEffect.deps.push(deps);
  }
}
```

```js
// packages/reactivity/src/baseHandlers.ts

import { track } from './effect';
export const mutableHandlers: ProxyHandler<object> = {
  get(target, key, receiver) {
    ...
    // è®©å½“å‰çš„å±æ€§å’Œ æ­£åœ¨æ¿€æ´»çš„effectå…³è”èµ·æ¥
    track(target, key);

    const res = Reflect.get(target, key, receiver);
    ...
    return res;
  }
};
```

æ•´ä¸ªæµç¨‹æ˜¯è¿™æ ·çš„ï¼š`effect(fn)` :arrow_right:`_effect.run()`:arrow_right: `proxy get()`:arrow_right:`track()`

ä¾èµ–æ”¶é›†æ˜¯å‘ç”Ÿåœ¨`proxy get()`ä¸­ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¦å¯¹åŸå¯¹è±¡è¿›è¡Œä»£ç†çš„ä¸€ä¸ªåŸå› ï¼Œåé¢`attr`çš„å˜åŒ–å¼•èµ·çš„å›è°ƒæ‰§è¡Œï¼Œä¹Ÿæ˜¯è¦åœ¨ä»£ç†å¯¹è±¡`reactiveObject`çš„`proxy set()`å®ç°ï¼›

å®é™…ä¸Šä¾èµ–æ”¶é›†æ˜¯åŒå‘çš„ï¼Œ`effect`è¦æ”¶é›†`attr`ï¼Œ`attr`ä¹Ÿè¦æ”¶é›†`effect`ï¼›

- `attr`æ”¶é›†`effect` 

  ä¸Šé¢å®ç°ä¸­çš„`targetMap`æ˜¯ç”¨æ¥å­˜å‚¨æœ‰ä¾èµ–åˆ°`reactiveObject`çš„å±æ€§çš„`effect`

  ```js
  // è®°å½•ä¾èµ–å…³ç³»ï¼Œæ•°æ®æ ¼å¼{target: { attr: [effect, effect]}}
  const targetMap = new WeakMap();
  ```

  `targetMap`çš„æ•°æ®æ ¼å¼æ˜¯`{target: { attr: [effect, effect]}}`ï¼Œå…¶ä¸­`target`æ˜¯`proxy`ä¸­çš„`target`ï¼ˆä¹Ÿå°±æ˜¯`reactiveObject`ï¼‰ï¼Œ`attr`å°±æ˜¯`fn`ä¸­ä¾èµ–åˆ°å±æ€§ï¼Œ`[effect, effect]`æ˜¯ä¸ª`set`ï¼Œæ”¾çš„æ˜¯ä¸åŒçš„`effect`ï¼ˆä¸€ä¸ª`attr`å¯èƒ½è¢«å¥½å‡ ä¸ª`effect`ä¾èµ–ï¼‰

  ```js
  export const mutableHandlers: ProxyHandler<object> = {
    get(target, key, receiver) {
      ...
      // è®©å½“å‰çš„å±æ€§å’Œ æ­£åœ¨æ¿€æ´»çš„effectå…³è”èµ·æ¥
      track(target, key);
      ...
    }
  };
  ```

  ```js
   export function track(target, key) {
     ...
     let depsMap = targetMap.get(target);
      if (!depsMap) {
        targetMap.set(target, (depsMap = new Map()));
      }
      let deps = depsMap.get(key);
      if (!deps) {
        depsMap.set(key, (deps = new Set()));
      }
     ...
     // ä¾èµ–æ”¶é›†çš„å­˜å‚¨æ“ä½œ
    trackEffects(deps);
   }
     
   export function trackEffects(deps) {
     ...
     // attr è®°å½• effect
    deps.add(activeEffect);
     ...
  }
  ```

  `deps.add(activeEffect)`è¿™é‡Œçš„ `deps`å°±æ˜¯å¯¹åº”`key`çš„`set`ï¼Œ`activeEffect`åˆ™æ˜¯å½“å‰æ­£åœ¨æ´»è·ƒçš„`effect`

  è¯•æƒ³ä¸‹ï¼Œæœ‰ä¸¤ä¸ª`effect`ï¼ˆ`e1`ã€`e2`ï¼‰éƒ½ä¾èµ–äº†å±æ€§`a`ï¼Œé‚£ä¹ˆ`e1`çš„å›è°ƒé»˜è®¤æ‰§è¡Œæ—¶ï¼Œ`a`ä¾¿ä¼šæ”¶é›†åˆ°`e1`ï¼Œæ­¤æ—¶çš„`targetMap`ä¾¿æ˜¯è¿™æ ·çš„ï¼š`{target: { a: [e1]}}`ï¼›å½“`e2`çš„å›è°ƒé»˜è®¤æ‰§è¡Œæ—¶ï¼Œ`a`åŒæ ·ä¼šæ”¶é›†`e2`ï¼Œæ­¤æ—¶çš„`targetMap`ä¾¿æ˜¯è¿™æ ·çš„ï¼š`{target: { a: [e1ï¼Œe2]}}`ï¼›è¿™æ ·ä¾¿å®Œæˆäº†`attr`æ”¶é›†`effect` 

- `effect`æ”¶é›†`attr`

  åŒæ ·çš„ï¼Œ`effect`ä¹Ÿæ˜¯è¦æ”¶é›†`attr`çš„ï¼Œç»´æŠ¤åœ¨`effect.deps`ä¸­ï¼Œ `deps`æ˜¯ä¸ªæ•°ç»„ï¼Œå› ä¸ºä¸€ä¸ª`effect`å¯èƒ½ä¼šä¾èµ–åˆ°å¤šä¸ª`attr`

  ```js
   export function trackEffects(deps) {
     ...
    // effect è®°å½• attr æ”¾çš„æ˜¯set
    activeEffect.deps.push(deps);
     ...
  }
  ```

  çœ‹åˆ°è¿™è¡Œä»£ç å¯èƒ½ä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼š `activeEffect.deps`ä¸­æ”¶é›†çš„ä¸åº”è¯¥æ˜¯`attr`çš„`key`å€¼ï¼Œä¸ºä»€ä¹ˆæ”¶é›†çš„æ˜¯`attr`çš„`effect`ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥æš‚æ—¶ç•™ç€ï¼Œå¾…åˆ°åé¢å®ç°`attr`å˜åŒ–å¼•èµ·çš„å“åº”å¼å˜åŒ–æ—¶ï¼Œå†å»ç†è§£ï¼›

  è¯•æƒ³ä¸‹ï¼Œæœ‰ä¸¤ä¸ª`effect`ï¼ˆ`e1`ã€`e2`ï¼‰éƒ½ä¾èµ–äº†å±æ€§`a`ã€`b`ï¼Œé‚£ä¹ˆ`targetMap`åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š`{target: { a: [e1,e2], b:[e1,e2]}}`ï¼Œè€Œ`effect.deps`( `activeEffect.deps`)åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š`[[e1,e2],[e1,e2]]`ï¼Œå…³äº`effect.deps`è¿™é‡Œä¸å¦¨å°±å…ˆè®°ç€æ˜¯è¿™æ ·çš„ï¼Œæ¥ç€å¾€ä¸‹çœ‹

#### 2.3.3ã€è§¦å‘æ›´æ–°`trigger()`æ–¹æ³•

è§¦å‘æ›´æ–°å°±æ˜¯æŒ‡`reactiveObject`çš„`attr`å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ`attr`æ”¶é›†åˆ°`effect`ä¼šç›¸åº”çš„å†æ¬¡æ‰§è¡Œï¼Œå®ç°å¦‚ä¸‹ğŸ‘‡

```typescript
// packages/reactivity/src/effect.ts

export function trigger(target, key, value) {
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    return; // å±æ€§æ²¡æœ‰ä¾èµ–ä»»ä½•çš„effect
  }
  let effects = depsMap.get(key);
  triggerEffects(effects);
}

export function triggerEffects(effects) {
  if (effects) {
    effects.forEach(effect => {
     /**
       * ä¿è¯è¦æ‰§è¡Œçš„effectä¸æ˜¯å½“å‰çš„effect
       * é¿å…effectä¸­ç›´æ¥æ”¹åŠ¨attrå¼•èµ·çš„effectå†æ¬¡æ‰§è¡Œçš„æ­»å¾ªç¯
       * å› ä¸ºattråªè¦å˜åŒ–ä¾¿ä¼šè§¦å‘trigger
       * è¿™é‡Œåšé€»è¾‘åˆ¤æ–­å°±æ˜¯é˜»æ–­æ‰effectä¸­ç›´æ¥æ”¹åŠ¨attrå¼•èµ·çš„trigger
       */
      if (effect !== activeEffect) {
        // æ•°æ®å˜åŒ–äº†ï¼Œæ‰¾åˆ°å¯¹åº”çš„effect é‡æ–°æ‰§è¡Œ
        effect.run();
        }
      }
    });
  }
}
```

```typescript
// packages/reactivity/src/baseHandlers.ts

import { trigger } from './effect';
export const mutableHandlers: ProxyHandler<object> = {
    set(target, key, value, receiver) {
    let oldValue = target[key];
    if (oldValue !== value) {
      // é‡æ–°èµ‹å€¼æ—¶ï¼Œè‹¥æ–°å€¼å’Œè€å€¼ä¸åŒåˆ™è§¦å‘effect
      trigger(target, key, value);
      let result = Reflect.set(target, key, value, receiver);
      return result;
    }
  }
};
```

æ•´ä¸ªæµç¨‹æ˜¯è¿™æ ·çš„ï¼š`reactiveObject`çš„`attr`å‘ç”Ÿå˜åŒ–:arrow_right: `proxy set()`â€‹ :arrow_right: `trigger()`â€‹ :arrow_right: `effect.run()`â€‹ :arrow_right: `effect(fn)`ä¸­çš„`fn`å†æ¬¡æ‰§è¡Œ

ä¸Šé¢å®ç°ä¸­æœ‰æ®µç‰¹æ®Šé€»è¾‘ï¼š

```typescript
/**
 * ä¿è¯è¦æ‰§è¡Œçš„effectä¸æ˜¯å½“å‰çš„effect
 * é¿å…effectä¸­ç›´æ¥æ”¹åŠ¨attrå¼•èµ·çš„effectå†æ¬¡æ‰§è¡Œçš„æ­»å¾ªç¯
 * å› ä¸ºattråªè¦å˜åŒ–ä¾¿ä¼šè§¦å‘trigger
 * è¿™é‡Œåšé€»è¾‘åˆ¤æ–­å°±æ˜¯é˜»æ–­æ‰effectä¸­ç›´æ¥æ”¹åŠ¨attrå¼•èµ·çš„trigger
 */
if (effect !== activeEffect) {
  // æ•°æ®å˜åŒ–äº†ï¼Œæ‰¾åˆ°å¯¹åº”çš„effect é‡æ–°æ‰§è¡Œ
 effect.run();
  }
}
```

æ˜¯ä¸ºäº†è§£å†³è¿™ç§åœºæ™¯ï¼š

```js
// ç¼“å­˜ä»£ç†ç»“æœ require()
const {effect ,reactive} = VueReactivity;
const state = reactive({ age: 30 })
effect(() => { 
   if(age>30) age++;
});
age = 31;
```

ç›´æ¥åœ¨`effect(fn)`ä¸­å¯¹`reactiveObject`çš„`attr`é‡æ–°èµ‹å€¼

è¯•æƒ³ä¸‹ï¼Œè‹¥æ˜¯æ²¡æœ‰ä¸Šé¢é‚£æ®µåˆ¤æ–­é€»è¾‘ï¼Œ`age = 31` :arrow_right: `trigger()` :arrow_right:  `effect.run()` :arrow_right: `fn`å†æ¬¡æ‰§è¡Œ :arrow_right: `age`å˜åŒ–......ä¾¿ä¼šé™·å…¥æ­»å¾ªç¯ï¼›

é‚£è¿™æ®µç‰¹æ®Šé€»è¾‘æ˜¯æ€ä¹ˆé¿å…äº†æ­»å¾ªç¯çš„å‘¢ï¼Ÿæ˜¯å¦è¿˜è®°å¾— `effect.run()`çš„å®ç°

```typescript
run() {
    // è®¾ç½®æˆæ­£åœ¨æ¿€æ´»çš„æ˜¯å½“å‰effect
    activeEffect = this;
    return this.fn();
}
```

æ¯æ¬¡`effect.run()`æ‰§è¡Œæ—¶ï¼Œä¾¿ä¼šå°†å…¨å±€å˜é‡`activeEffect`ç½®ä¸ºå½“å‰çš„`effect`ï¼Œé‚£å½“`attr`å‘ç”Ÿå˜åŒ–å¼•èµ·çš„`trigger()`æ—¶ï¼Œåªè¦å°†å½“å‰çš„`effect`ä»`attr`æ”¶é›†åˆ°çš„`effect`ä¸­è¿‡æ»¤æ‰ä¸æ‰§è¡Œ`effect.run()`ä¾¿å¯ä»¥é¿å…æ­»å¾ªç¯ï¼›

é‚£ä¹ˆä¸Šé¢çš„æ¡ˆä¾‹çš„æµç¨‹å°±å˜æˆäº†è¿™æ ·ï¼š`age = 31` :arrow_right: `trigger()` :arrow_right:  `effect.run()` :arrow_right: `fn`å†æ¬¡æ‰§è¡Œ :arrow_right: `activeEffect = this` :arrow_right: `age++` :arrow_right: `trigger()` :arrow_right: `effect !== activeEffect`ä¸º`false` :arrow_right: ç»“æŸï¼Œ`effect.run`ä¸æ‰§è¡Œ

#### 2.3.4ã€å®ç°æ•ˆæœ

ä»¥ä¸Šå°±æ˜¯Vue3å“åº”å¼å˜åŒ–çš„åŸºæœ¬å®ç°ï¼Œä¸‹é¢ğŸ‘‡çœ‹ä¸‹å®ç°æ•ˆæœ

```html
<!--  -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="./reactivity.global.js"></script>
  <div id="app"></div>
  <script>
    const { effect, reactive } = VueReactivity;

    const obj = { name: 'å¼ ä¸‰', age: 13, address: { num: 30 }, flag: true }
    const state = reactive(obj);

    effect(() => {
      app.innerHTML = state.name + 'ä»Šå¹´' + state.age + 'å²äº†é—¨ç‰Œå·æ˜¯ ' + state.address.num
    })

    setTimeout(() => {
      state.age++
    }, 1000)
  </script>
</body>

</html>
```

è¿è¡Œç»“æœ

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220603181116115-20220603181158295.png" style="zoom:50%;" />

ä¸€ç§’ä¹‹å

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220603181219615.png" alt="image-20220603181219615" style="zoom:50%;" />



### 2.4ã€å“åº”å¼ä¸­çš„ä¸€äº›ç‰¹æ®Šé€»è¾‘

#### 2.4.1ã€åµŒå¥—`effect`çš„å¤„ç†é€»è¾‘

å…ˆçœ‹ä¸‹åµŒå¥—`effect`çš„å…·ä½“åœºæ™¯

```js
  const obj = { name: 'å¼ ä¸‰', age: 13, flag: false }
  const state = reactive(obj);

  effect(() => { // e1
    state.name
    effect(() => { // e2
      state.age
    })
    state.flag
  })
```

```typescript
// packages/reactivity/src/effect.ts
export let activeEffect = undefined;// å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect

class ReactiveEffect {
    ...
    run() {
        // è®¾ç½®æˆæ­£åœ¨æ¿€æ´»çš„æ˜¯å½“å‰effect
        activeEffect = this;
        return this.fn();
    }
  ...
}
```

è¿™é‡Œæœ‰ä¸¤ä¸ª`effect`ï¼š`e1`ã€`e2`ï¼Œ`e2`åµŒå¥—åœ¨`e1`ä¸­ï¼Œåœ¨`e1`åˆæ¬¡æ‰§è¡Œåˆ°`state.name`è¿™ä¸€è¡Œæ—¶ï¼Œå…¨å±€å˜é‡`activeEffect`æŒ‡å‘çš„æ˜¯`e1`ï¼Œä½†æ¥ä¸‹æ¥æ‰§è¡Œ`e2`çš„æ—¶å€™ï¼Œ`activeEffect`æŒ‡å‘çš„å°±å˜æˆäº†`e2`ï¼›

åˆ°è¿™é‡Œå…¶å®ä¸€åˆ‡éƒ½è¿˜æ²¡é—®é¢˜ï¼Œä½†å½“`e2`æ‰§è¡Œå®Œæˆï¼Œå†å»æ‰§è¡Œ`state.flag`æ—¶ï¼Œæ­¤æ—¶çš„`activeEffect`æŒ‡å‘çš„è¿˜æ˜¯`e2`ï¼Œè¿™å°±æœ‰é—®é¢˜äº†ï¼Œæ˜æ˜`flag`æ˜¯`e1`ä¾èµ–çš„å±æ€§ï¼Œæ€ä¹ˆèƒ½å’Œ`e2`ç»‘å®šå‘¢

æ‰€ä»¥è¿™é‡Œåº”è¯¥æœ‰è¿™æ ·ä¸€æ®µé€»è¾‘ï¼Œå½“`e2`æ‰§è¡Œå®Œæˆæ—¶ï¼Œ`activeEffect`æŒ‡å‘åº”è¯¥ç”±`e2`å˜å›`e1`

å› æ­¤éœ€è¦å¯¹`activeEffect`çš„æŒ‡å‘è¿›è¡Œæ”¹é€ ï¼Œæ”¹é€ ä¹‹åçš„é€»è¾‘å¦‚ä¸‹ğŸ‘‡

```typescript
// packages/reactivity/src/effect.ts
export let activeEffect = undefined;// å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect

class ReactiveEffect {
   public parent = undefined;
    ...
run() {
    try {
      // å°†activeEffectè®¾ç½®ä¸ºå½“å‰ReactiveEffectå®ä¾‹çš„çˆ¶effectï¼Œç”¨ä½œè®°å½•å­˜å‚¨
      this.parent = activeEffect;
      // å†å°†å½“å‰ReactiveEffectå®ä¾‹è®¾ç½®ä¸ºactiveEffect
      activeEffect = this;
      return this.fn();
    } finally {
      /**
       * æ‰§è¡Œå®Œæ¯•åè¿˜åŸactiveEffectï¼Œ
       * ä¹Ÿå°±æ˜¯å½“å‰çš„ReactiveEffectå®ä¾‹åªå¯¹å‡ºç°åœ¨è‡ªå·±fnæ–¹æ³•ä¸­çš„å±æ€§è¿›è¡Œä¾èµ–æ”¶é›†æ“ä½œ
       * è‹¥ä¸æ‰§è¡Œè¿™ä¸€æ­¥ï¼Œæ¯ä¸€æ¬¡å“åº”å¼å¯¹è±¡ä¸­æœ‰get()æ“ä½œæ—¶éƒ½ä¼šå°†å±æ€§æ”¶é›†åˆ°activeEffectä¸­
       */
      activeEffect = this.parent;
      this.parent = undefined;
    }
  }
  ...
}
```

#### 2.4.2ã€ä¾èµ–æ›´æ–°ä¸`cleanup`

å…ˆçœ‹ä¸‹è¿™ä¸ªåœºæ™¯

```js
const {effect ,reactive} = VueReactivity;

const state = reactive({ flag: true, name: 'å¼ ä¸‰', age: 30 })
effect(() => {
    document.body.innerHTML = state.flag ? state.name : state.age
});
setTimeout(() => {
    state.flag = false;
    setTimeout(() => {
        console.log('ä¿®æ”¹nameï¼ŒåŸåˆ™ä¸Šä¸æ›´æ–°')
        state.name = 'æå››'
    }, 1000);
}, 1000)
```

å½“`state.flag`ä¸º`true`æ—¶ï¼Œ`effect`ä¾èµ–çš„æ˜¯`name`å±æ€§ï¼Œä½†å½“`state.flag`ä¸º`false`æ—¶ï¼Œ`effect`å°±ä¸å†ä¾èµ–`name`å±æ€§ï¼Œè€Œæ˜¯ä¾èµ–`age`å±æ€§ï¼›å› æ­¤ï¼Œå½“`name`æ”¹å˜æ—¶ï¼Œ`effect`åº”è¯¥ä¸å†æ¬¡æ‰§è¡Œï¼Œä½†ç›®å‰çš„å“åº”å¼å˜åŒ–`trigger`ä¸­å¹¶æ²¡æœ‰å°†`name`å±æ€§è¿›è¡Œä¾èµ–ç§»é™¤çš„é€»è¾‘ï¼Œæ‰€ä»¥å½“`name`æ”¹å˜æ—¶ï¼Œ`effect`ä¼šå†æ¬¡æ‰§è¡Œ

ä¾èµ–æ›´æ–°æ˜¯ç”±`trigger`è§¦å‘çš„ï¼Œä½†æ˜¯å…·ä½“é€»è¾‘å´æ˜¯åœ¨`effect.run()`å¤„ç†çš„

æ”¹é€ é€»è¾‘å¦‚ä¸‹ğŸ‘‡

```typescript
export function trigger(target, key, value) {
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    return; // å±æ€§æ²¡æœ‰ä¾èµ–ä»»ä½•çš„effect
  }
  let effects = depsMap.get(key);
  triggerEffects(effects);
}

export function triggerEffects(effects) {
  if (effects) {
    /**
     * æ³¨æ„ï¼šè¿™é‡Œçš„attræ”¶é›†çš„effectsåœ¨effectçš„depsä¸­ä¹Ÿæœ‰ä¿å­˜
     * æ‰€ä»¥éœ€è¦å°†effectså¤åˆ¶ä¸€ä»½ï¼Œå†è¿›è¡Œæ“ä½œï¼Œ
     * é¿å…effect.run()ä¸­æ¸…ç†effectæ—¶çš„æ­»å¾ªç¯
     */
    effects = new Set(effects);
    effects.forEach(effect => {
      if (effect !== activeEffect) {
        effect.run(); // æ•°æ®å˜åŒ–äº†ï¼Œæ‰¾åˆ°å¯¹åº”çš„effect é‡æ–°æ‰§è¡Œ
      }
    });
  }
}
```

```typescript
class ReactiveEffect {
  ...
  run() {
    try {
      ...
      /**
       * æ¸…ç†å½“å‰ReactiveEffectå®ä¾‹ä¸­çš„deps
       * åœ¨ä¸‹é¢çš„fn()æ‰§è¡Œæ—¶ä¼šå†æ¬¡æ”¶é›†
       * ä¹Ÿå°±æ˜¯å…ˆæ¸…ç†åœ¨æ”¶é›†ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆå¤„ç†
       * æ˜¯å› ä¸ºå½“å‰ReactiveEffectå®ä¾‹ä¾èµ–çš„attrå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–
       * è¿™æ ·åšæ˜¯ä¸ºäº†æ›´æ–°effectä¾èµ–çš„attr
       */
      cleanEffect(this);
      return this.fn();
    } finally {
      activeEffect = this.parent;
      this.parent = undefined;
    }
  }
  
/**
 * æ¸…ç†effectæ”¶é›†çš„attrçš„deps(seté›†åˆ, setå­˜æ”¾çš„æ˜¯effect)
 * setä¸­å­˜æ”¾çš„æ˜¯attræ”¶é›†çš„effect(æ˜¯æ‰€æœ‰çš„effectï¼Œä¸åªæ˜¯å½“å‰çš„effect)
 * è¿™é‡Œåªæ˜¯ä»attræ”¶é›†çš„æ‰€æœ‰effectä¸­åˆ é™¤å½“å‰çš„effect
 * æ‰€ä»¥è¿™é‡Œæœ‰ä¸¤æ­¥é€»è¾‘
 * 1ã€ä»attræ”¶é›†çš„æ‰€æœ‰effectä¸­åˆ é™¤å½“å‰çš„effect
 * 2ã€å°†å½“å‰effectçš„depsæ¸…ç©º
 * æ—¢æ¸…ç†äº†attrçš„ä¾èµ–åˆæ¸…ç†äº†effectçš„ä¾èµ–
 */
function cleanEffect(effect) {
  let deps = effect.deps;
  for (let i = 0; i < deps.length; i++) {
    deps[i].delete(effect);
  }
  effect.deps.length = 0;
}
```

ä¾èµ–æ›´æ–°çš„å®ç°å…¶å®æ˜¯æ¯æ¬¡`trigger`çš„æ‰§è¡Œï¼Œå°±ä¼šå…ˆæ¸…ç†ä¾èµ–ï¼Œä¹‹åå†é‡æ–°è¿›è¡Œæ”¶é›†

æ•´ä¸ªæµç¨‹æ˜¯è¿™æ ·çš„ï¼š`attr`å˜åŒ– :arrow_right: `proxy set()` :arrow_right: `trigger()` :arrow_right: `effect.run()` :arrow_right: `cleanEffect()`æ¸…ç†ä¾èµ–   :arrow_right: `this.fn()` :arrow_right: `proxy get()` :arrow_right: `track()`é‡æ–°æ”¶é›†ä¾èµ–

å…¶ä¸­ `cleanEffect()`æ¸…ç†ä¾èµ–çš„é€»è¾‘å¯èƒ½æœ‰ç‚¹éš¾ç†è§£

```typescript
function cleanEffect(effect) {
  let deps = effect.deps;
  for (let i = 0; i < deps.length; i++) {
    deps[i].delete(effect);
  }
  effect.deps.length = 0;
}
```

åº”è¯¥è¿˜è®°å¾—`effect.deps`ä¸­æ”¶é›†çš„ä¸æ˜¯`atrr`çš„`key`ï¼Œè€Œæ˜¯`attr`ä¾èµ–çš„`effect`(æ˜¯æ‰€æœ‰çš„`effect`ï¼Œä¸åªæ˜¯å½“å‰çš„ä¸€ä¸ª`effect`)ï¼Œæ‰€ä»¥`cleanEffect()`ä¸­åšäº†ä¸¤ä»¶äº‹

- ä»`attr`æ”¶é›†çš„æ‰€æœ‰`effect`ä¸­åˆ é™¤å½“å‰çš„`effect`
- å°†å½“å‰`effect`çš„`deps`æ¸…ç©º(length = 0ä¼šç›´æ¥å°†æ•°ç»„æ¸…ç©º)

#### 2.4.3ã€effectåœæ­¢ä¾èµ–æ”¶é›†

 `effect`ä¸­åœ¨ä½¿ç”¨`reactive`å¯¹è±¡æ—¶ä¼šè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œä¹‹åå±æ€§å˜åŒ–æ—¶ä¼šé‡æ–°æ‰§è¡Œ`effect`å‡½æ•°ï¼Œä½†è‹¥æ˜¯æƒ³è¦åœ¨æŸä¸€æ—¶åˆ»æƒ³è¦å–æ¶ˆè¿™ç§å“åº”å¼å˜åŒ–ï¼Œå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

æ‰€ä»¥åº”è¯¥æœ‰è¿™æ ·ä¸€ä¸ªåŠŸèƒ½ï¼Œæä¾›ä¸€ä¸ªæ§åˆ¶`effect`æ¿€æ´»çŠ¶æ€çš„`api`ç”±è°ƒç”¨æ–¹è‡ªè¡Œå†³å®šä»€ä¹ˆæ—¶å€™è¿›è¡Œå“åº”å¼å˜åŒ–

æ”¹é€ é€»è¾‘å¦‚ä¸‹ğŸ‘‡

```typescript
// packages/reactivity/src/effect.ts

class ReactiveEffect {
  ...
  /**
   * å¤±æ´»æ“ä½œ
   * åœæ­¢æ”¶é›†ä¾èµ–
   */
  stop() {
    if (this.active) {
      this.active = false;
      cleanEffect(this);
    }
  }
}

export function effect(fn, options?) {
  // å°†å¤–éƒ¨ä¼ é€’è¿›æ¥çš„å‡½æ•°è®¾ç½®ä¸ºå“åº”å¼çš„effect
  const _effect = new ReactiveEffect(fn);
  // è®©å“åº”å¼effecté»˜è®¤æ‰§è¡Œä¸€æ¬¡
  _effect.run();
  // æ›´æ”¹runnerä¸­çš„this
  const runner = _effect.run.bind(_effect);
  runner.effect = _effect; // æš´éœ²effectçš„å®ä¾‹
  // effectè¿”å›runnerçš„ç›®çš„æ˜¯è®©ç”¨æˆ·å¯ä»¥è‡ªå·±æ§åˆ¶æ¸²æŸ“é€»è¾‘
  return runner; // ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è°ƒç”¨runneré‡æ–°æ‰§è¡Œ
}
```

ç»™`ReactiveEffect`å®ä¾‹ä¸Šå¢åŠ `stop`æ–¹æ³•ï¼Œ`stop`æ–¹æ³•ä¸­ä¼šå°†`effect`ç½®ä¸ºå¤±æ´»çŠ¶æ€å¹¶è¿›è¡Œä¾èµ–æ¸…ç†ï¼Œä¹‹åå†é€šè¿‡å°†`effect`æš´éœ²å‡ºå»çš„æ–¹å¼ï¼Œè®©ç”¨æˆ·å¯ä»¥è‡ªè¡Œè°ƒç”¨`runner()å’Œ`runner.effect.stop()`è¿›è¡Œ`effect`å¤±æ´»ä¸æ¿€æ´»çŠ¶æ€çš„åˆ‡æ¢

#### 2.4.4ã€è°ƒåº¦æ‰§è¡Œï¼ˆå®ç°æ‰¹é‡æ›´æ–°ï¼‰

å…ˆçœ‹ä¸‹è¿™ä¸ªğŸ‘‡åœºæ™¯ï¼ŒçŒœæµ‹ä¸‹`effect`å…±æ‰§è¡Œå‡ æ¬¡

```html
<!--  -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="./reactivity.global.js"></script>
  <div id="app"></div>
  <script>
    const { effect, reactive } = VueReactivity;

    const obj = { name: 'å¼ ä¸‰', age: 13, address: { num: 30 }, flag: false }
    const state = reactive(obj);

    const runner = effect(() => {
      console.log('runner')
      app.innerHTML = state.name + 'ä»Šå¹´' + state.age + 'å²äº†é—¨ç‰Œå·æ˜¯ ' + state.address.num
    })

    setTimeout(() => {
      state.name = 'æå››'
      state.age++
      state.address.num ++
    }, 5000)
  </script>
</body>

</html>
```

æ‰“å°ç»“æœæ˜¯4æ¬¡ï¼Œé™¤å»ç¬¬ä¸€æ¬¡é»˜è®¤æ‰§è¡Œï¼Œè¿˜æ‰§è¡Œäº†3æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´`reactiveObject`çš„`attr`æ¯å˜åŒ–ä¸€æ¬¡ï¼Œå°±ä¼š`trigger()`ä¸€æ¬¡ï¼Œ`effect(fn)`çš„`fn`å°±ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œ`html`å°±ä¼šé‡æ–°æ¸²æŸ“ä¸€æ¬¡,è¿™æ ·æœªå…å¤ªæµªè´¹æ€§èƒ½äº†ï¼Œæ‰€ä»¥æœŸæœ›æœ‰ä¸€ä¸ªæ‰¹é‡æ›´æ–°çš„é€»è¾‘ï¼Œå¯ä»¥å®ç°å¤šæ¬¡å˜åŒ–åªæ‰§è¡Œä¸€æ¬¡æ¸²æŸ“

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220608232301142.png" alt="image-20220608232301142" style="zoom:50%;" />

æ”¹é€ é€»è¾‘å¦‚ä¸‹ğŸ‘‡

é¦–å…ˆå®ç°`scheduler`ï¼ˆè°ƒåº¦ï¼‰åŠŸèƒ½ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰`trigger()`ä¹‹åçš„æ‰§è¡Œé€»è¾‘ï¼ˆé»˜è®¤æ˜¯æ‰§è¡Œ`effect(fn)`ä¸­çš„`fn`ï¼‰

```typescript
// packages/reactivity/src/effect.ts
class ReactiveEffect {
  ...
  // ä¼ é€’çš„fnã€scheduleræŒ‚åˆ°thisä¸Š
  constructor(public fn, public scheduler?) {}
  ...
}

export function effect(fn, options = {} as any) {
  ...
  /**
   * å°†å¤–éƒ¨ä¼ é€’è¿›æ¥çš„å‡½æ•°è®¾ç½®ä¸ºå“åº”å¼çš„effect
   * optionsä¸ºç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®é¡¹
   */
  const _effect = new ReactiveEffect(fn, options?.scheduler);
  ...                                   
}

export function triggerEffects(effects) {
  if (effects) {
    effects = new Set(effects);
    effects.forEach(effect => {
      if (effect !== activeEffect) {
        if (effect.scheduler) {
          effect.scheduler(); // å¯ä»¥æä¾›ä¸€ä¸ªè°ƒåº¦å‡½æ•°ï¼Œç”¨æˆ·å®ç°è‡ªå·±çš„é€»è¾‘
        } else {
          effect.run(); // æ•°æ®å˜åŒ–äº†ï¼Œæ‰¾åˆ°å¯¹åº”çš„effect é‡æ–°æ‰§è¡Œ
        }
      }
    });
  }
}
```

ä¸Šé¢æ”¹é€ çš„é€»è¾‘å¯ä»¥è®©ç”¨æˆ·åœ¨ä½¿ç”¨`effect(fn, [options])`æ–¹æ³•æ—¶ï¼Œé€šè¿‡é…ç½®é¡¹ä¼ å…¥è‡ªå®šä¹‰çš„`scheduler`ï¼ŒæŒ‡å®š`trigger`è§¦å‘æ—¶æ‰§è¡Œçš„é€»è¾‘ï¼›

ä¸Šé¢çš„é€»è¾‘ä¸­å…³é”®çš„æ˜¯è¿™é‡Œï¼Œç”¨æˆ·è‹¥é…ç½®äº†`scheduler`åˆ™ä¸å†æ‰§è¡Œ`effect.run()`ä¹Ÿå°±æ˜¯`fn`ï¼Œè€Œæ˜¯æ‰§è¡Œ`scheduler`

```typescript
if (effect.scheduler) {
  effect.scheduler(); // å¯ä»¥æä¾›ä¸€ä¸ªè°ƒåº¦å‡½æ•°ï¼Œç”¨æˆ·å®ç°è‡ªå·±çš„é€»è¾‘
} else {
  effect.run(); // æ•°æ®å˜åŒ–äº†ï¼Œæ‰¾åˆ°å¯¹åº”çš„effect é‡æ–°æ‰§è¡Œ
}
```

é‚£æœ‰äº†`scheduler`ï¼Œç”¨æˆ·ä¾¿å¯ä»¥è‡ªå·±è‡ªå·±å†³å®š`trigger`è§¦å‘æ—¶ï¼Œå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œçš„æ—¶æœºã€æ¬¡æ•°ã€åŠæ‰§è¡Œæ–¹å¼ï¼Œä»è€Œå®ç°æ‰¹é‡æ›´æ–°çš„æ•ˆæœ

æ³¨æ„ï¼š`scheduler`å®ç°çš„ä»…ä»…æ˜¯è‡ªå®šä¹‰å‰¯ä½œç”¨å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡`trigger`ä¹‹åï¼Œ`scheduler`éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ï¼ŒVueæœ¬èº«å¹¶æ²¡æœ‰åšå“åº”å¼å˜åŒ–çš„æ‰¹é‡æ›´æ–°é€»è¾‘ï¼Œä½†æ˜¯é€šè¿‡`scheduler`æˆ‘ä»¬æ˜¯èƒ½å¤Ÿå®ç°æ‰¹é‡æ›´æ–°çš„

æ‰¹é‡æ›´æ–°ä½¿ç”¨å¦‚ä¸‹ğŸ‘‡

```js
<script src="./reactivity.global.js"></script>
<div id="app"></div>
<script>
  const { effect, reactive } = VueReactivity;

  const obj = { name: 'å¼ ä¸‰', age: 13, address: { num: 30 }, flag: false }
  const state = reactive(obj);

  let waiting = false;
  const runner = effect(() => {
    console.log('runner')
    app.innerHTML = state.name + 'ä»Šå¹´' + state.age + 'å²äº†é—¨ç‰Œå·æ˜¯ ' + state.address.num
  }, {
    scheduler() { // è°ƒåº¦å‡½æ•°
      console.log('scheduler')
      if (!waiting) {
        waiting = true
        Promise.resolve().then(() => {
          runner();
          waiting = false;
        })
      }
    }
  })

  setTimeout(() => {
    state.name = 'æå››'
    state.age++
    state.address.num++
  }, 1000)
</script>
```

ä¸Šé¢ğŸ‘†æ‰¹é‡æ›´æ–°çš„å…³é”®åœ¨äº`Promise.resolve().then()`çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬åº”å½“æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ï¼ŒVueçš„`tragger`éƒ½æ˜¯åŒæ­¥é€»è¾‘ï¼Œé‚£å½“æˆ‘ä»¬åœ¨ä¸€æ¬¡`scheduler`ä¸­ä½¿ç”¨äº†`promise`ä¹‹åï¼Œäº§ç”Ÿçš„å¼‚æ­¥é€»è¾‘ï¼Œå°±ä¼šåœ¨æ‰€æœ‰çš„åŒæ­¥é€»è¾‘æ‰§è¡Œå®Œä¹‹åæ‰ä¼šæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡`tragger`éƒ½ä¼šè§¦å‘`scheduler`,ä½†`scheduler`ä¸­çš„å¼‚æ­¥é€»è¾‘è¦ç­‰åˆ°æ‰€æœ‰çš„`tragger`éƒ½è§¦å‘ä¹‹åæ‰æ›´æ–°ï¼›é‚£åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å®ç°åŒæ­¥æ›´æ–°æ“ä½œï¼›

å®ç°æ•ˆæœå¦‚ä¸‹ğŸ‘‡

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220609001337257.png" alt="image-20220609001337257" style="zoom:50%;" />

### 2.5ã€`computed`å®ç°

åŒVue2çš„`computed`è®¡ç®—å±æ€§ä¸€æ ·ï¼ŒVue3çš„`computed`è®¡ç®—å±æ€§ä¹Ÿæ˜¯å°†å‡ ä¸ª`reactiveObject`çš„å±æ€§(`attr1`ã€`attr2`...)æ•´åˆæˆä¸€ä¸ªæ–°çš„`reactiveObject`çš„å±æ€§(`attr`)ï¼Œå½“`attr1`ã€`attr2`...æ”¹å˜æ—¶ï¼Œ`attr`ä¹Ÿä¼šç›¸åº”çš„æ”¹å˜

`computed`çš„ä½¿ç”¨å¦‚ä¸‹ğŸ‘‡

```js
const attr = computed(() => {
...
return attr1 + attr2
})
// æˆ–è€…
const attr = computed({
  get(){
    ...
    return attr1 + attr2
  },
  set(val){
   attr1 = val;
  }
})
```

å®ç°å¦‚ä¸‹ğŸ‘‡

```typescript
// packages/reactivity/src/computed.ts

import { isFunction } from '@vue/shared';
import {
  activeEffect,
  ReactiveEffect,
  trackEffects,
  triggerEffects
} from './effect';

export function computed(getterOrOptions) {
  // åˆ¤æ–­ä¼ è¿›æ¥çš„æ˜¯getæ–¹æ³•è¿˜æ˜¯é…ç½®é¡¹
  let isGetter = isFunction(getterOrOptions);

  // èµ‹å€¼getå’Œsetæ–¹æ³•
  let getter;
  let setter;
  const fn = () => console.warn('computed is readonly ');
  if (isGetter) {
    getter = getterOrOptions;
    setter = fn;
  } else {
    getter = getterOrOptions.get;
    setter = getterOrOptions.set || fn;
  }

  // è¿”å›ComputedRefImplå®ä¾‹
  return new ComputedRefImpl(getter, setter);
}

/**
 * ComputedRefImplç±»
 * å†…éƒ¨å°è£…äº†ReactiveEffectçš„å®ä¾‹åŒ–
 * è´Ÿè´£ä¾èµ–æ”¶é›†çš„å·¥ä½œ
 */
class ComputedRefImpl {
  private _value; // ç”¨æ¥å­˜å‚¨è®¡ç®—å±æ€§çš„ç»“æœ
  private _dirty = true; // ç”¨æ¥åˆ¤æ–­æ˜¯å¦ç¼“å­˜ï¼Œå³æ˜¯å¦é‡æ–°è®¡ç®—
  public effect; // è®¡ç®—å±æ€§å¯¹åº”çš„effect
  public deps; // ç”¨äºæ”¶é›†ä¾èµ–å½“å‰è®¡ç®—å±æ€§çš„effect(æ³¨æ„ï¼šå’Œè®¡ç®—å±æ€§å¯¹åº”effectåŒºåˆ†å¼€)
  constructor(getter, public setter) {

    // effect.deps å­˜çš„æ˜¯å±æ€§å¯¹åº”çš„seté›†åˆ
    this.effect = new ReactiveEffect(getter, () => {
      /**
       * effect çš„ schedulerï¼Œ
       * è¿™é‡Œè‡ªå®šä¹‰ å½“å‰è®¡ç®—å±æ€§ä¾èµ–çš„ attr å‘ç”Ÿå˜åŒ–åçš„æ›´æ–°é€»è¾‘
       */
      if (!this._dirty) {
        /**
         * è¿™é‡Œçš„æ›´æ–°é€»è¾‘æ˜¯
         * å½“è®¡ç®—å±æ€§è¢«ä½¿ç”¨åï¼Œ_dirtyå°±ä¼šä¸ºfalseï¼Œä½¿ç”¨çš„ä¾¿æ˜¯ç¼“å­˜å€¼äº†
         * ä¹Ÿåªæœ‰è®¡ç®—å±æ€§è¢«ä½¿ç”¨åï¼Œæ‰éœ€è¦èµ°è¿™æ®µæ›´æ–°é€»è¾‘
         */
        this._dirty = true;
        // é€šçŸ¥ä¾èµ–å½“å‰è®¡ç®—å±æ€§çš„effectæ›´æ–°
        triggerEffects(this.deps);
      }
    });
  }

  get value() {
    /**
     * æœ‰effectä¾èµ–å½“å‰è®¡ç®—å±æ€§çš„è¯ï¼Œå°±å°†å…¶æ”¶é›†åˆ°å½“å‰è®¡ç®—å±æ€§çš„depsä¸­
     * æ³¨æ„ï¼šåªæœ‰å½“effectçš„å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼ŒactiveEffectæ‰æœ‰å€¼ï¼Œ
     * è‹¥æ˜¯å½“å‰è®¡ç®—å±æ€§valueåœ¨è¢«ä½¿ç”¨æ—¶ï¼ŒactiveEffectæœ‰å€¼çš„è¯
     * å°±è¯´æ˜äº†æ­¤activeEffectæ—¶ä¾èµ–å½“å‰è®¡ç®—å±æ€§çš„
     */
    if (activeEffect) {
      trackEffects(this.deps || (this.deps = new Set()));
    }

    /**
     * åªæœ‰å½“_dirtyä¸ºtrueæ—¶
     * å³å½“å‰è®¡ç®—å±æ€§ä¾èµ–çš„ attr å‘ç”Ÿå˜åŒ–å
     * æ‰èµ°è®¡ç®—å±æ€§çš„getteré€»è¾‘å¹¶æ›´æ–°_value
     * å¦åˆ™å°±ä¸æ›´æ–°_valueç›´æ¥è¿”å›ï¼ˆä¹Ÿå°±æ˜¯ç¼“å­˜å€¼ï¼‰
     */
    if (this._dirty) {
      // å°†_dirtyç½®ä¸ºfalseï¼Œè¡¨æ˜æ¥ä¸‹æ¥è®¡ç®—å±æ€§è¿”å›çš„æ˜¯ç¼“å­˜å€¼
      this._dirty = false;
      this._value = this.effect.run();
    }
    return this._value;
  }

  /**
   * ç›´æ¥æ‰§è¡Œç”¨æˆ·é…ç½®çš„set
   * åœ¨setä¸­å¯ä»¥ç›´æ¥ä¿®æ”¹ reactiveObj çš„ attr
   */
  set value(newValues) {
    this.setter(newValues);
  }
}

```

`computed`çš„å®ç°ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒçš„ç‚¹

- `computed`ç¼“å­˜å€¼çš„å®ç°
- `computed`æœ¬èº«å°±æ˜¯ä¸ª`effect`ï¼Œä½†å…¶åˆæ”¶é›†äº†å…¶ä»–ä½¿ç”¨`computed`è‡ªå·±æœ¬èº«çš„`effect`ï¼Œç”¨ä½œå“åº”å¼æ›´æ–°

### 2.6ã€`watch`å®ç°

`watch`çš„æ ¸å¿ƒå°±æ˜¯è§‚æµ‹ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œå½“æ•°æ®å˜åŒ–æ—¶é€šçŸ¥å¹¶æ‰§è¡Œå›è°ƒ ï¼ˆé‚£ä¹Ÿå°±æ˜¯è¯´å®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ª`effect`ï¼‰

```js
watch(state,(oldValue,newValue)=>{ // ç›‘æµ‹ä¸€ä¸ªå“åº”å¼å€¼çš„å˜åŒ–
    console.log(oldValue,newValue)
})
// æˆ–è€…
watch(state => stae[key],(oldValue,newValue)=>{ // ç›‘æµ‹ä¸€ä¸ªå“åº”å¼å€¼çš„å˜åŒ–
    console.log(oldValue,newValue)
})
```

`watch`çš„ä½¿ç”¨æœ‰å‡ ä¸ªå…³é”®ä¸»è¦æ³¨æ„ï¼š

- `watch`å¦‚æœç›‘æ§çš„æ˜¯ä¸€ä¸ªå¯¹è±¡é‚£ä¹ˆï¼Œå¯¹è±¡æ˜¯æ— æ³•æ‹¿åˆ°è€å€¼çš„ï¼Œ`oldValue`å†…çš„æ•°æ®ä¼šæ˜¯æ›´æ–°ä¹‹åçš„ï¼ˆvue2ä¹Ÿæ˜¯ä¸€æ ·) ï¼Œè¿™ä¸ªæ˜¯å› ä¸ºå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹çš„ï¼Œ`oldValue`,`newValue`æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡
- vue3 ä¸­`watch`ç›‘æ§çš„æ˜¯ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™é»˜è®¤ä¼šæ·±åº¦ç›‘æ§ï¼Œå¯¹è±¡å†…çš„æ‰€æœ‰å±æ€§éƒ½ä¼šè¢«ç›‘æ§ï¼Œæ‰€ä»¥å°½é‡ä¸è¦é‡‡ç”¨è¿™ç§ç›´æ¥ç›‘æ§å¯¹è±¡çš„æ–¹å¼ ï¼ˆé»˜è®¤ä¼šé€’å½’è®¿é—®å¯¹è±¡çš„å±æ€§ï¼Œæ‰€ä»¥ä¸å»ºè®®ç”¨ï¼‰
- å¦‚æœç›‘æ§çš„æ˜¯æŸä¸ªå±æ€§çš„è¯ éœ€è¦å†™æˆå‡½æ•°çš„æ ¼å¼

`watch`çš„å®ç°å¦‚ä¸‹

```typescript
// packages/reactivity/src/baseHandler.ts
export function isReactive(value) {
  return value && value[ReactiveFlags.IS_REACTIVE];
}
```

```typescript
import { ReactiveEffect } from './effect';
import { isReactive } from './baseHandler';
import { isFunction, isObject } from '@vue/shared';

/**
 * ç”¨æ¥é€’å½’è®¿é—®å¯¹è±¡å±æ€§
 * setç”¨æ¥å­˜æ”¾å·²ç»è¿­ä»£è¿‡çš„å¯¹è±¡
 */
function traversal(value, set = new Set()) {
  if (!isObject(value)) {
    return value;
  }

  if (set.has(value)) {
    // æ­¤å¯¹è±¡å·²ç»è¢«è¿­ä»£è¿‡äº†
    return value;
  }
  set.add(value);

  for (let key in value) {
    // é€’å½’é€»è¾‘ï¼Œvalue[key] è®¿é—®æ‰€æœ‰å±æ€§
    traversal(value[key], set);
  }

  return value;
}

export function watch(source, cb, { immediate } = {} as any) {
  let get; // ç”¨æ¥å­˜æ”¾è¦ç›‘æ§çš„å¯¹è±¡ï¼Œå‡½æ•°å½¢å¼
  let oldValue; // å­˜æ”¾è€å€¼
  let cleanup; // ç”¨äºæ¸…ç†ä¸Šä¸€æ¬¡watchæ“ä½œçš„

  if (isReactive(source)) {
    /**
     * è‹¥æ˜¯ä¼ è¿›æ¥çš„æ˜¯ä¸ªReactiveObj,
     * åˆ™ç”Ÿæˆä¸€ä¸ªéå†è®¿é—®çš„fn,ä¾›åç»­new ReactiveEffect(fn, scheduler)ä½¿ç”¨
     * åˆ›å»ºä¸€ä¸ªeffectï¼Œè®©è¿™ä¸ªeffectæ”¶é›†sourceä¸­çš„æ‰€æœ‰å±æ€§
     */
    get = () => traversal(source);
  } else if (isFunction(source)) {
    // è‹¥ä¼ è¿›æ¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°åˆ™ç›´æ¥ä½¿ç”¨ã€
    get = source;
  }

  /**
   * onCleanup(fn),æ¥æ”¶ç”¨æˆ·ä¼ å…¥çš„æ–¹æ³•ä½œä¸ºå‚æ•°ï¼Œå¹¶èµ‹å€¼ç»™cleanup
   */
  const onCleanup = fn => {
    cleanup = fn;
  };

  /**
   * scheduleræ–¹æ³•ï¼Œæ•°æ®å˜åŒ–åè°ƒç”¨
   */
  const job = () => {
    /**
     * ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶cleanupæ˜¯undefined
     * å¦‚æœcleanupæœ‰å€¼ï¼Œåˆ™æ˜¯ä¸Šä¸€æ¬¡èµ‹å€¼çš„
     * æ‰€ä»¥è¿™é‡Œçš„cleanupæ˜¯ä¸Šä¸€æ¬¡çš„ï¼Œåˆ©ç”¨äº†çš„é—­åŒ…åŸç†
     */
    cleanup && cleanup();

    // æ•°æ®å˜åŒ–åé‡æ–°è°ƒç”¨effect.runå‡½æ•°ï¼Œä¼šè·å¾—æœ€æ–°çš„å€¼
    let newValue = effect.run();

    // æ‰§è¡Œç”¨æˆ·ä¼ è¿›æ¥çš„å›è°ƒï¼Œå¹¶ä¼ å…¥å‚æ•°
    cb(newValue, oldValue, onCleanup);

    // å›è°ƒæ‰§è¡Œå®Œä¹‹åï¼Œå°†è¿™ä¸€æ¬¡æ‰§è¡Œçš„æ–°å€¼èµ‹å€¼ç»™oldValue
    oldValue = newValue;
  };

  const effect = new ReactiveEffect(get, job);

  if (immediate) {
    // éœ€è¦ç«‹å³æ‰§è¡Œï¼Œåˆ™ç«‹åˆ»æ‰§è¡Œä»»åŠ¡
    job();
  }

  // é»˜è®¤è°ƒç”¨runæ–¹æ³•ä¼šæ‰§è¡Œgetå‡½æ•°ï¼Œæ­¤æ—¶sourceä½œä¸ºäº†ç¬¬ä¸€æ¬¡çš„è€å€¼ï¼ˆgetçš„è¿”å›å€¼æ˜¯sourceï¼‰
  oldValue = effect.run();
}

```

`watch`å®ç°çš„æ ¸å¿ƒåœ¨äºåˆ©ç”¨äº†`effect`çš„å®ç°åŸç†

```typescript
 const effect = new ReactiveEffect(get, job);
```

åˆ›å»ºäº†ä¸€ä¸ª`effect`ï¼Œå®Œæˆå¯¹`watch`ä¸­ä½¿ç”¨åˆ°çš„`attir`ä¾èµ–æ”¶é›†ï¼Œå¹¶å¯¹ç”¨æˆ·ä¼ å…¥çš„å›è°ƒè¿›è¡Œå°è£…ï¼Œå°è£…åçš„æ–¹æ³•ä½œä¸º`scheduler`æ–¹æ³•ï¼Œç”¨äºæ•°æ®å˜åŒ–åè°ƒç”¨

ä¸Šé¢å®ç°ä¸­è¿˜æœ‰ä¸€ä¸ªå…³é”®çš„åœ°æ–¹ï¼Œ`cleanup`çš„å®ç°

å¯ä»¥çœ‹ä¸‹`cleanup`çš„ä½¿ç”¨åœºæ™¯

<!--è¿ç»­è§¦å‘watchæ—¶éœ€è¦æ¸…ç†ä¹‹å‰çš„watchæ“ä½œ-->

```js
const state = reactive({ age: 30 })
let i = 2000;
function getData(timer){
    return new Promise((resolve,reject)=>{
        setTimeout(() => {
            resolve(timer)
        }, timer);
    })
}
watch(()=>state.age,async (newValue,oldValue,onCleanup)=>{
    let clear = false;
    onCleanup(()=>{
        clear = true;
    })
    i-=1000;
    let r =  await getData(i); // ç¬¬ä¸€æ¬¡æ‰§è¡Œ1såæ¸²æŸ“1000ï¼Œ ç¬¬äºŒæ¬¡æ‰§è¡Œ0såæ¸²æŸ“0ï¼Œ æœ€ç»ˆåº”è¯¥æ˜¯0
    if(!clear){document.body.innerHTML = r;}
 
},{flush:'sync'});

state.age = 31;
state.age = 32;
```

ç”¨æˆ·ä¼ å…¥çš„`onCleanup`æ˜¯åœ¨ä¸‹ä¸€æ¬¡`watch`è§¦å‘æ—¶æ‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨`onCleanup`å®Œæˆä¸€äº›å–æ¶ˆä¸Šä¸€æ¬¡è¯·æ±‚ç»“æœç­‰ç±»ä¼¼çš„æ“ä½œ

### 2.7ã€`ref`çš„å®ç°

`ref`æ¥å—ä¸€ä¸ªå‚æ•°å€¼å¹¶è¿”å›ä¸€ä¸ªå“åº”å¼ä¸”å¯æ”¹å˜çš„ `ref` **å¯¹è±¡**ï¼Œ`ref` **å¯¹è±¡**æ‹¥æœ‰ä¸€ä¸ªæŒ‡å‘å†…éƒ¨å€¼çš„å•ä¸€å±æ€§ `value`

```html
// packages/reactivity/dist/09ã€refä½¿ç”¨.html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="../../../node_modules/@vue/reactivity/dist/reactivity.global.js"></script>
  <div id="app"></div>
  <script>
    const { effect, ref } = VueReactivity;

    // åŸºæœ¬ç±»å‹ï¼Œä¸å…·å¤‡å“åº”å¼èƒ½åŠ›, ç”¨refå°†åŸºæœ¬ç±»å‹å˜æˆå¯¹è±¡ç±»å‹ï¼Œå…·å¤‡å“åº”å¼èƒ½åŠ›
    let flag = ref(false);
    let obj = ref({ name: 'å¼ ä¸‰' })

    effect(() => {
      console.log('runner')
      app.innerHTML = flag.value + obj.value.name
    })

    setTimeout(() => {
     // æ”¹valueçš„æ—¶å€™å¯ä»¥è§¦å‘effecté‡æ–°æ‰§è¡Œ
      flag.value = true;
      obj.value.name = 'æå››'
    }, 1000)

  </script>
</body>

</html>
```

`ref` è·Ÿ `reactive` éƒ½æ˜¯å“åº”ç³»ç»Ÿçš„æ ¸å¿ƒæ–¹æ³•ï¼Œä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å…¥å£

å¯ä»¥å°† `ref` çœ‹æˆ `reactive` çš„ä¸€ä¸ªå˜å½¢ç‰ˆæœ¬ï¼Œè¿™æ˜¯ç”±äº `reactive` å†…éƒ¨é‡‡ç”¨ `Proxy` æ¥å®ç°ï¼Œè€Œ `Proxy` åªæ¥å—å¯¹è±¡ä½œä¸ºå…¥å‚ï¼Œè¿™æ‰æœ‰äº† `ref` æ¥è§£å†³åŸºç¡€ç±»å‹çš„æ•°æ®å“åº”ï¼Œå¦‚æœä¼ å…¥ `ref` çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå†…éƒ¨ä¹Ÿä¼šè°ƒç”¨ `reactive` æ–¹æ³•è¿›è¡Œæ·±å±‚å“åº”è½¬æ¢

#### 2.7.1ã€`ref`å®ç°

`ref`çš„å®ç°å¦‚ä¸‹ğŸ‘‡

```typescript
// packages/reactivity/src/ref.ts

import { isObject } from '@vue/shared';
import { activeEffect, trackEffects, triggerEffects } from './effect';
import { reactive } from './reactive';

/**
 * ç”¨äºå°†å¯¹è±¡è½¬æ¢æˆReactiveObj
 */
export function toReactive(value) {
  return isObject(value) ? reactive(value) : value;
}

/**
 * å¯¹ä¼ å…¥è¿›æ¥çš„åŸºç¡€ç±»å‹æ•°æ®ã€å¯¹è±¡è¿›è¡Œä»£ç†åˆ°valueå±æ€§ä¸Š
 * (ç”¨åˆ°çš„å…¶å®æ˜¯definePropertyæ–¹æ³•)
 * (es6 classä¸­çš„getã€setç¼–è¯‘æˆes5çš„è¯å°±æ˜¯defineProperty)
 * å¹¶å¯¹valueå±æ€§è®¾ç½®å“åº”å¼é€»è¾‘
 * getæ—¶æ”¶é›†ä¾èµ– trackEffects
 * setæ—¶è§¦å‘æ›´æ–° triggerEffects
 */
class RefImpl {
  private _value;
  private dep;
  private __v_isRef = true;
  constructor(public rawValue, public _shallow) {
    // æµ…refä¸éœ€è¦å†æ¬¡ä»£ç†
    this._value = _shallow ? rawValue : toReactive(rawValue);
  }

  get value() {
    if (activeEffect) {
      trackEffects(this.dep || (this.dep = new Set())); // æ”¶é›†ä¾èµ–
    }
    return this._value;
  }

  set value(newVal) {
    if (newVal !== this.rawValue) {
      this.rawValue = newVal; // rawValueä¸ºåŸå§‹æ•°æ®ï¼Œä¼šä¿ç•™åœ¨refå¯¹è±¡ä¸Š
      this._value = this._shallow ? newVal : toReactive(newVal);
      triggerEffects(this.dep); // è§¦å‘æ›´æ–°
    }
  }
}

/**
 * å°†åŸå§‹æ•°æ®è¿›è¡Œè£…åŒ…ï¼Œè½¬å˜æˆå“åº”å¼æ•°æ®
 */
function createRef(rawValue, shallow) {
  return new RefImpl(rawValue, shallow);
}

/**
 * å°†åŸå§‹ç±»å‹åŒ…è£…æˆå¯¹è±¡, åŒæ—¶ä¹Ÿå¯ä»¥åŒ…è£…å¯¹è±¡ è¿›è¡Œæ·±å±‚ä»£ç†
 */
export function ref(value) {
  return createRef(value, false);
}

/**
 * åˆ›å»ºæµ…ref ä¸ä¼šè¿›è¡Œæ·±å±‚ä»£ç†
 */
export function shallowRef(value) {
  return createRef(value, true);
}
```

`ref`çš„å®ç°ä¸­æ ¸å¿ƒé€»è¾‘æ˜¯å°†ç”¨æˆ·ä¼ å…¥çš„`rawValue`ï¼ŒæŒ‚åœ¨`ref`å¯¹è±¡(`RefImpl`å®ä¾‹)çš„`value`å±æ€§ä¸Šï¼Œå¹¶åœ¨`value`å±æ€§çš„`get`ã€`set`ä¸Šå®Œæˆå“åº”å¼çš„é€»è¾‘

<!--refçš„ä½œç”¨å°±æ˜¯å°†ä¸æ˜¯å“åº”å¼çš„æ•°æ®å˜æˆå“åº”å¼çš„-->

#### 2.7.2ã€ `toRef` & `toRefs`å®ç°

å…ˆçœ‹ä¸€ä¸ªå“åº”å¼ä¸¢å¤±ç°è±¡

```js
const { effect, reactive } = VueReactivity;
const state = reactive({name: 'å¼ ä¸‰', age: 30 })
let person = {...state}
effect(()=>{
    document.body.innerHTML = person.name +'ä»Šå¹´' + person.age +'å²äº†'
})
setTimeout(()=>{
    person.age = 31;
},1000)
```

å¦‚æœå¯¹`ReacttiveObj`è¿›è¡Œè§£æ„æ“ä½œåˆ™ä¼šä¸¢å¤±å“åº”å¼çš„ç‰¹æ€§ï¼Œè¿™æ˜¯å› ä¸ºå¯¹å¯¹å“åº”å¼å¯¹è±¡è¿›è¡Œè§£æ„ï¼Œç›¸å½“äºæ˜¯è¿›è¡Œäº†æµ…æ‹·è´ï¼Œé‚£åœ¨`effect`ä¸­ä½¿ç”¨æµ…æ‹·è´çš„å¯¹è±¡æ—¶æ˜¯èµ°ä¸åˆ°`ReacttiveObj`çš„`get`ä¸­çš„ï¼Œé‚£ä¹Ÿå°±ä¸ä¼šè¿›è¡Œä¾èµ–æ”¶é›†ï¼ˆå…¶å®ä¸å…‰æ²¡æœ‰æ”¶é›†ï¼Œä¿®æ”¹æ•°æ®ä¹‹åä¹Ÿä¸ä¼šèµ°åˆ°`set`ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šèµ°`trigger`ï¼‰

> <!--è§£æ„æ—¶æµ…æ‹·è´ï¼Œæ‰€ä»¥åµŒå¥—çš„å¯¹è±¡ä¾ç„¶å…·å¤‡å“åº”å¼ç‰¹æ€§-->
>
> ```js
> const { effect, reactive } = VueReactivity;
> 
> const state = reactive({ address: { num: 199 } })
> let person = { ...state }
> 
> effect(() => {
>   document.body.innerHTML = person.address.num
> })
> 
> setTimeout(() => {
>   person.address.num = 888 // ä¼šè§¦å‘æ›´æ–°ï¼Œé‡æ–°æ‰§è¡Œeffect
> }, 1000)
> ```

ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒVueæä¾›`toRef` & `toRefs`è¿™ä¸¤ä¸ªapiï¼Œä¸‹é¢çœ‹ä¸‹å…·ä½“å®ç°ğŸ‘‡

```typescript
// packages/reactivity/src/ref.ts

/**
 * å¯¹ä¼ å…¥è¿›æ¥çš„ReactiveObjè¿›è¡Œä»£ç†,å°†ReactiveObj[key]æŒ‚åˆ°valueå±æ€§ä¸Š
 * è¿™é‡Œä¸éœ€è¦åšå“åº”å¼é€»è¾‘ï¼Œå› ä¸ºReactiveObj[key]æœ¬èº«å°±æœ‰å“åº”å¼ç‰¹æ€§
 * è¿™é‡Œåªæ˜¯å®Œæˆå¯¹ReactiveObj çš„ attrçš„ä½¿ç”¨è€Œå·²
 * ä¼šèµ°åˆ°ReactiveObj Proxyä¸­çš„getå’Œset
 */
class ObjectRefImpl {
  private __v_isRef = true;
  constructor(public object, public key) {}
  get value() {
    return this.object[this.key];
  }
  set value(newValue) {
    this.object[this.key] = newValue;
  }
}

export function toRef(object, key) {
  return new ObjectRefImpl(object, key);
}

/**
 * éå†objectï¼Œæ¯ä¸ªå±æ€§éƒ½ç”Ÿæˆä¸€ä¸ªref
 */
export function toRefs(object) {
  let result = {};
  for (let key in object) {
    result[key] = toRef(object, key);
  }
  return result;
}
```

å®ç°çš„é€»è¾‘å¾ˆç®€å•ï¼Œå“åº”å¼ä¸¢å¤±æ˜¯å› ä¸ºä½¿ç”¨çš„æ˜¯æ–°å˜é‡ï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨`ReactiveObj`ï¼Œé‚£åšä¸€å±‚ä»£ç†ï¼Œé€šè¿‡`ref.value`ç›´æ¥è®¿é—®`ReactiveObj`ä¾¿å¯ä»¥äº†

æœ‰äº† `toRef` & `toRefs`ä¾¿å¯ä»¥éšæ„ä½¿ç”¨ç»“æ„æ“ä½œäº†

#### 2.7.3ã€`proxyRefs`å®ç°

ä»¥ä¸Šä¸‰ä¸ªAPI`ref`ã€ `toRef` ã€ `toRefs`ï¼Œåœ¨ä½¿ç”¨`ref`å¯¹è±¡æ—¶ï¼Œéƒ½éœ€è¦è¿™æ ·ä½¿ç”¨`ref.value`ï¼Œè¿™æ ·æœªå…æœ‰äº›ä¸å¤Ÿç›´è§‚ï¼Œè‹¥æ˜¯èƒ½å¤Ÿç›´æ¥`ref[key]`å²‚ä¸æ˜¯æ›´å¥½ï¼Œçœ‹ä¸‹é¢ğŸ‘‡å®ç°

```typescript
/**
 * åšä¸€å±‚ä»£ç†ï¼Œè‹¥æ˜¯refå¯¹è±¡ï¼Œåˆ™ç›´æ¥ä½¿ç”¨valueå±æ€§
 */
export function proxyRefs(object) {
  return new Proxy(object, {
    get(target, key, receiver) {
      let r = Reflect.get(target, key, receiver);
      return r.__v_isRef ? r.value : r;
    },
    set(target, key, value, receiver) {
      if (target[key].__v_isRef) {
        target[key].value = value;
        return true;
      }
      return Reflect.set(target, key, value, receiver);
    }
  });
}
```

å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯å¸®æˆ‘ä»¬çœæ‰è®¿é—®`value`è¿™ä¸€æ­¥

çœ‹ä½¿ç”¨æ•ˆæœ

```js
const { effect, reactive, ref, toRef, proxyRefs } = VueReactivity;

const state = reactive({ name: 'å¼ ä¸‰', age: 30 })
let nameRef = toRef(state, 'name') // ä½¿ç”¨valueè®¿é—®

let ageRef = proxyRefs({ age: toRef(state, 'age') }) // ä½¿ç”¨keyè®¿é—®


effect(() => {
  console.log('runner')
  document.body.innerHTML = nameRef.value + 'ä»Šå¹´' + ageRef.age + 'å²äº†'
})

setTimeout(() => {
  nameRef.value = 'æå››'
  ageRef.age = 31;
}, 1000)
```

### ä¸‰ã€Vue3å“åº”å¼åŸç†æ€»ç»“

- `reactive`é€‚ç”¨äºå¯¹è±¡çš„å“åº”å¼å¤„ç†ï¼Œéå¯¹è±¡ä¸èƒ½ä½¿ç”¨ï¼Œå› ä¸ºä¸æ˜¯å¯¹è±¡çš„ä¸èƒ½è¢«proxyä»£ç†
- `ref` ã€`toRef` ã€`toRefs` é€‚ç”¨äºéå¯¹è±¡ç±»å‹æ•°æ®çš„å“åº”å¼å¤„ç†ï¼ˆå¯¹è±¡ä¹Ÿå¯ä»¥ï¼‰ï¼Œå–å€¼è¦ä½¿ç”¨`ref.value`çš„å½¢å¼ï¼Œ è‹¥ä¸æƒ³ä½¿ç”¨`ref.value`å¯ä»¥é‡‡ç”¨`proxyRefs`ä»£ç†å–å€¼.
- `computed` ã€ `watch` éƒ½æ˜¯åŸºäº`ReactiveEffect`
  - `computed`ä¸­æ˜¯å…·å¤‡ç¼“å­˜çš„`dirty`, ä¾èµ–çš„å€¼å˜åŒ–äº†ä¼šæ‰§è¡Œ`effect`å¹¶æ›´æ–°`dirty`å±æ€§ï¼ˆ è®¡ç®—å±æ€§ä¼šæ”¶é›†ä¾èµ–ï¼‰
  - `watch` å°±æ˜¯æ•°æ®å˜åŒ–äº†è§¦å‘å†…éƒ¨çš„`scheduler`ï¼Œæä¾›`onCleanup`å¯ä»¥ç”¨æ¥æ¸…ç†ä¸Šæ¬¡`watch`æ“ä½œ

