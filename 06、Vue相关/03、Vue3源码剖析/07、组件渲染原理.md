## Vue3æºç å‰–æï¼ˆä¸ƒï¼‰â€” ç»„ä»¶æ¸²æŸ“åŸç†

### ä¸€ã€å‰è¨€

ç»„ä»¶æ˜¯æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨æœ€å¤šçš„ï¼Œé‚£ä¹ˆç»„ä»¶çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- é€»è¾‘æ‹†åˆ†
- å¤ç”¨
- æ–¹ä¾¿ç»´æŠ¤
- ç»„ä»¶çº§æ›´æ–°

#### 1.1ã€ç»„ä»¶ä½¿ç”¨

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="app"></div>
  <script src="../../../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js"></script>
  <script>
    const { render, Text, h } = VueRuntimeDOM;
    
    const VueComponent = {
      data() {
        return { name: 'å¼ ä¸‰' } // æ•°æ®æº
      },
      render() { // renderå‡½æ•°è¿”å›è™šæ‹ŸèŠ‚ç‚¹ å†³å®šæœ€ç»ˆæ¸²æŸ“çš„ç»“æœ
        return h('button', {}, h('span', this.name))
      }
    }
    console.log('VueComponent', h(VueComponent, {a:1}))
    render(h(VueComponent), app);

  </script>
</body>

</html>
```

**æ•ˆæœ**

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220619172008125.png" alt="image-20220619172008125" style="zoom:50%;" />

### äºŒã€ç»„ä»¶åˆå§‹åŒ–æŒ‚è½½

#### 2.1ã€`createVNode`ä¸­æ·»åŠ ç»„ä»¶ç±»å‹

```typescript
// packages/runtime-core/src/createVNode.ts

/**
 * åˆ›å»ºVirtualNode
 */
export function createVNode(type, props = null, children = null) {
  /**
   * æ ‡è®°åˆ›å»ºçš„æ˜¯ä»€ä¹ˆç±»å‹çš„VNode
   * type: string å…ƒç´ ç±»å‹
   * typeï¼šObject ç»„ä»¶ç±»å‹ (ç»„ä»¶æœ¬èº«æ˜¯ä¸ªå¯¹è±¡ï¼ŒåŒ…å«renderæ–¹æ³•)
   */
  const shapeFlag = isString(type)
    ? ShapeFlags.ELEMENT
    : isObject(type)
    ? ShapeFlags.STATEFUL_COMPONENT
    : 0;
  
  // ...
}
```

ç»„ä»¶ç±»å‹çš„`VNode`é•¿ä¸‹é¢ğŸ‘‡è¿™æ ·ï¼Œä¸å…ƒç´ ç±»å‹å’Œæ–‡æœ¬ç±»å‹ä¸åŒçš„æ˜¯ï¼Œç»„ä»¶ç±»å‹çš„`VNode`çš„`type`ä¸å†æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å…¶å®å°±æ˜¯ç”¨æˆ·ç¼–å†™çš„åŸå§‹ç»„ä»¶

<!--ç”¨æˆ·å†™çš„ç»„ä»¶å°±æ˜¯ä¸ªå¯¹è±¡ï¼Œè¢«æŒ‚è½½åœ¨ç»„ä»¶å®ä¾‹ä¸Šçš„typeå±æ€§ä¸Šï¼Œå¯¹è±¡ä¸­å¿…é¡»åŒ…å«renderæ–¹æ³•ï¼Œæä¾›ç»„ä»¶è¦æ¸²æŸ“çš„subTree-->

```js
{
    "__v_isVNode": true,
    "type": {
      "data": {
        //...
      },
      "render": {
        //...
      }
    },
    "props": {
        "a": 1
    },
    "children": null,
    "el": null,
    "shapeFlag": 4,
}
```

#### 2.2ã€ç»„ä»¶çš„åˆå§‹åŒ–æŒ‚è½½åŠå“åº”å¼å¤„ç†

**`patch`ä¸­æ·»åŠ ç»„ä»¶æŒ‚è½½å’Œæ›´æ–°æ–¹æ³•**

```typescript
 // packages/runtime-core/src/renderer.ts
/**
   * VNodeçš„åˆå§‹åŒ–æŒ‚è½½å’Œdiffæ›´æ–°
   * @param n1 å®¹å™¨ä¸Šä¿å­˜çš„ä¸Šä¸€æ¬¡çš„VNode
   * @param n2 æ–°çš„VNode
   * @param container å®¹å™¨ çœŸå®çš„DOMèŠ‚ç‚¹
   */
  const patch = (
    n1,
    n2,
    container,
    anchor = null,
    parentComponent = null
  ) => {
   // ...

    const { type, shapeFlag } = n2;
    switch (type) {
      // ...
      default:
        // ...
        else if (shapeFlag & ShapeFlags.STATEFUL_COMPONENT) {
          processComponent(n1, n2, container, anchor);
        }
    }
  };

```

**ç»„ä»¶çš„æŒ‚è½½å’Œæ›´æ–°æ–¹æ³•`processComponent`**

```typescript
// packages/runtime-core/src/renderer.ts
/**
   * ç»„ä»¶ç±»å‹çš„VNodeçš„æŒ‚è½½å’Œæ›´æ–°å¤„ç†
   */
  function processComponent(n1, n2, container, anchor) {
    if (n1 == null) {
      // åˆå§‹åŒ–æŒ‚è½½ç»„ä»¶
      mountComponent(n2, container, anchor);
    } else {
      // ç»„ä»¶çš„æ›´æ–°æµç¨‹ æ’æ§½çš„æ›´æ–° å±æ€§æ›´æ–°
      updateComponent(n1, n2);
    }
  }
```

**åˆå§‹åŒ–æŒ‚è½½æ–¹æ³•`mountComponent`**

```typescript
// packages/runtime-core/src/renderer.ts
/**
   * ç»„ä»¶ç±»å‹çš„VNodeçš„æŒ‚è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container çˆ¶å®¹å™¨
   * @param anchor é”šç‚¹ ç”¨äºçœŸå®èŠ‚ç‚¹çš„insertæ“ä½œ
   * ç»„ä»¶çš„æ›´æ–°æµç¨‹ æ’æ§½çš„æ›´æ–° å±æ€§æ›´æ–°
   */
  function mountComponent(vnode, container, anchor) {
    /**
     * ï¼ˆ1ï¼‰ç»„ä»¶æŒ‚è½½å‰ éœ€è¦åˆ›å»ºä¸€ä¸ªç»„ä»¶çš„å®ä¾‹ï¼ˆå¯¹è±¡ï¼‰
     * å¯¹è±¡ä¸­åŒ…å«äº†ç»„ä»¶çš„çŠ¶æ€ã€ç»„ä»¶çš„å±æ€§ã€ç»„ä»¶å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸ
     * å°†åˆ›å»ºçš„ç»„ä»¶å®ä¾‹ä¿å­˜åˆ°vnodeä¸Š
     */
    const instance = (vnode.component =
      createComponentInstance(vnode));

    /**
     * (2) å¤„ç†ç»„ä»¶çš„æ’æ§½å’Œç»„ä»¶çš„å±æ€§
     * ç»™ç»„ä»¶çš„å®ä¾‹ä¸Šçš„å±æ€§è¿›è¡Œèµ‹å€¼
     */
    setupComponent(instance);

    /**
     * (3ï¼‰ç»™ç»„ä»¶ç»‘å®šä¸€ä¸ªeffect
     * ç»„ä»¶æ•°æ®å˜åŒ–åå¯ä»¥é‡æ–°æ¸²æŸ“
     */
    setupRenderEffect(instance, container, anchor);
  }
```

**åˆ›å»ºç»„ä»¶å®ä¾‹çš„æ–¹æ³•`mountComponent`**

ç»„ä»¶å®ä¾‹ä¹Ÿæ˜¯ä¸ªå¯¹è±¡ï¼Œä¸ç»åŒ…å«äº†ç»„ä»¶ç±»å‹çš„`VNode`ï¼Œè¿˜åŒ…å«äº†å…¶ä»–å¾ˆå¤šåé¢ä¼šä½¿ç”¨åˆ°çš„ç»„ä»¶å±æ€§ï¼Œè¿™é‡Œå°±æ˜¯è¿›è¡Œä¸€ä¸ªåˆå§‹åŒ–åˆ›å»ºç»„ä»¶å®ä¾‹

```typescript
// packages/runtime-core/src/component.ts

export function createComponentInstance(vnode) {
  let instance = {
    data: null, // ç»„ä»¶æœ¬èº«çš„æ•°æ®
    vnode, // æ ‡è¯†å®ä¾‹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹
    subTree: null, // ç»„ä»¶å¯¹åº”çš„æ¸²æŸ“çš„è™šæ‹ŸèŠ‚ç‚¹ï¼ˆç»„ä»¶renderç”Ÿæˆçš„vnodeï¼‰
    isMounted: false, // ç»„ä»¶æ˜¯å¦æŒ‚è½½è¿‡
    update: null, // ç»„ä»¶çš„effect.runæ–¹æ³•
    render: null,
    propsOptions: vnode.type.props || {},
    // vnode.props ç»„ä»¶åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹çš„æ—¶å€™æä¾›çš„
    // vnode.type.props è¿™ä¸ªæ˜¯ç”¨æˆ·å†™çš„
    props: {}, // è¿™ä¸ªprops ä»£è¡¨ç”¨æˆ·æ¥æ”¶çš„å±æ€§
    attrs: {}, // è¿™ä¸ªä»£è¡¨çš„æ˜¯ æ²¡æœ‰æ¥å—
    proxy: null // ä»£ç†å¯¹è±¡
  };
  return instance;
}
```

**ç»„ä»¶å®ä¾‹å±æ€§èµ‹å€¼æ–¹æ³•`setupComponent`**

åœ¨è¿™é‡Œå°†ç”¨æˆ·æ‰€ä¹¦å†™çš„åŸå§‹ç»„ä»¶ä¸Šçš„å±æ€§ï¼ˆ`data`ã€`render`ç­‰ï¼‰èµ‹å€¼åˆ°ç»„ä»¶å®ä¾‹ä¸Šï¼Œå¹¶å¯¹`data`è¿›è¡Œä»£ç†ä¸ºåç»­çš„å“åº”å¼æ›´æ–°åšå‡†å¤‡

```typescript
// packages/runtime-core/src/component.ts

/**
 * å¤„ç†ç»„ä»¶çš„æ’æ§½å’Œç»„ä»¶çš„å±æ€§çš„æ–¹æ³•
 * (1) ç»™ç»„ä»¶ä¸Šçš„å±æ€§è¿›è¡Œèµ‹å€¼
 */
export function setupComponent(instance) {
  // typeå°±æ˜¯ç”¨æˆ·å†™çš„åŸå§‹ç»„ä»¶ï¼ˆæ˜¯ä¸ªå¯¹è±¡ï¼‰
  let { type, props, children } = instance.vnode;
  let { data, render } = type;

  if (data) {
    if (!isFunction(data)) {
      return console.warn('The data option must be a function.');
    }
   /**
     * å°†ç»„ä»¶å®ä¾‹çš„dataè¿›è¡Œä»£ç†ï¼Œè½¬æ¢æˆReactiveObj
     * åç»­æ›´æ–°propså¯ä»¥ç›´æ¥é‡æ–°æ¸²æŸ“ç»„ä»¶
     */
    instance.data = reactive(data.call({}));
  }

  // å°†ç”¨æˆ·å†™çš„renderæŒ‚åœ¨ç»„ä»¶å®ä¾‹ä¸Š
  instance.render = render;
}
```

**ç»„ä»¶å“åº”æ—¶å¤„ç†çš„æ–¹æ³•`setupRenderEffect`**

```typescript
// packages/runtime-core/src/renderer.ts

 /**
   * ç»„ä»¶çš„æŒ‚è½½ï¼Œå¹¶å¯¹ç»„ä»¶å®ä¾‹è¿›è¡Œå“åº”å¼å¤„ç†
   * @param instance ç»„ä»¶å®ä¾‹
   * @param container çˆ¶å®¹å™¨
   * @param anchor é”šç‚¹
   */
  function setupRenderEffect(instance, container, anchor) {
    /**
     * ç»„ä»¶å“åº”å¼å˜åŒ–çš„å›è°ƒæ–¹æ³•
     */
    const componentUpdate = () => {
      const { render, data } = instance;
      if (!instance.isMounted) {
        // ç»„ä»¶åˆå§‹åŒ–æŒ‚è½½

        /**
         * è°ƒç”¨ç”¨æˆ·å†™çš„åŸå§‹ç»„ä»¶ä¸­çš„render
         * å¹¶å°†å…¶ç”Ÿæˆçš„VNodeæŒ‚åˆ°ç»„ä»¶å®ä¾‹instance.subTreeä¸Š
         * ç»„ä»¶æœ€ç»ˆè¦æ¸²æŸ“çš„è™šæ‹ŸèŠ‚ç‚¹ å°±æ˜¯subtree
         * 
         * æ³¨æ„ï¼šå“åº”å¼çš„ä¾èµ–æ”¶é›†å‘ç”Ÿåœ¨è¿™é‡Œ
         * ç»„ä»¶å®ä¾‹çš„dataåœ¨setupComponentæ—¶å·²ç»è¢«è½¬æ¢æˆReactiveObj
         */
        const subTree = render.call(instance.data); // è¿™é‡Œçš„thisåé¢è¦æ”¹æˆinstance.proxy

        /**
         * çœŸæ­£çš„åˆå§‹åŒ–æŒ‚è½½
         * å’Œå…ƒç´ ç±»å‹ã€æ–‡æœ¬ç±»å‹ä¸€æ ·
         * ä¼ å…¥VNodeç»™patchæ–¹æ³•è¿›è¡Œæ¸²æŸ“
         * æ³¨æ„ï¼šè¿™é‡Œpatchçš„æ˜¯subTreeä¸æ˜¯instance
         * subTreeçš„VNodeçš„ç±»å‹æœ‰ç”¨æˆ·ç¼–å†™çš„renderå†³å®š
         */
        patch(null, subTree, container, anchor);

        instance.subTree = subTree;
        instance.isMounted = true; // æ ‡è¯†å½“å‰ç»„ä»¶å·²ç»æŒ‚è½½è¿‡äº†
      } else {
        // ç»„ä»¶æ›´æ–°

        // ç”Ÿæˆæ–°çš„VNode
        const subTree = render.call(instance.data); // è¿™é‡Œçš„thisåé¢è¦æ”¹æˆinstance.proxy
        /**
         * æ›´æ–°é€»è¾‘
         * å°†æ–°çš„VNodeå’Œæ—§çš„VNodeä¼ ç»™patchæ–¹æ³•è¿›è¡Œæ›´æ–°
         */
        patch(instance.subTree, subTree, container, anchor);
        // æ›´æ–°subTree
        instance.subTree = subTree;
      }
    };

    const effect = new ReactiveEffect(componentUpdate);

    // å°†effectçš„runæ–¹æ³•ç»‘å®šåˆ°ç»„ä»¶ä¸Šï¼Œæä¾›å¼ºåˆ¶æ›´æ–°æ–¹å¼ï¼Œinstance.update()
    let update = (instance.update = effect.run.bind(effect));

    // è¿›è¡ŒæŒ‚è½½
    update();
  }
```

å¥½äº†ï¼Œç»„ä»¶çš„åˆå§‹åŒ–æŒ‚è½½åŠå“åº”å¼æ›´æ–°çš„å®ç°å°±å®Œæˆäº†ï¼Œè¿™æ®µå®ç°çš„æ ¸å¿ƒåœ¨äº

```typescript
 const effect = new ReactiveEffect(componentUpdate);
```

è¿™é‡Œä½¿ç”¨åˆ°å“åº”å¼æ¨¡å—ä¸­çš„åŠŸèƒ½ï¼Œåœ¨è°ƒç”¨ç”¨æˆ·ç¼–å†™çš„`render`æ–¹æ³•æ—¶å®Œæˆä¾èµ–æ”¶é›†

```typescript
const subTree = render.call(instance.data);
```

ä¹‹åä¾¿æ˜¯å®Œæˆ`VNode`çš„æŒ‚è½½ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œ`patch`çš„æ˜¯`subTree`ï¼Œæ˜¯ç”¨æˆ·ç¼–å†™çš„ç»„ä»¶ä¸­çš„`render`ï¼Œå…¶`VNode`ç±»å‹æœªçŸ¥ï¼Œä¸è¦è¯¯ä»¥ä¸ºè¿™é‡Œæ˜¯`patch`å½“å‰ç»„ä»¶å®ä¾‹`instance`

```typescript
patch(null, subTree, container, anchor);
```

å½“åç»­`render`ä¸­ä½¿ç”¨çš„`ReactiveObj`çš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¾¿ä¼šé‡æ–°è§¦å‘`componentUpdate`ï¼Œä»è€Œèµ°åˆ°`VNode`çš„æ›´æ–°é€»è¾‘

```typescript
patch(instance.subTree, subTree, container, anchor);
```

å…¶å®åˆ°è¿™é‡Œä¾¿èƒ½è®¤è¯†åˆ°Vue3æ ¸å¿ƒæ¨¡å—çš„å…³ç³»äº†

> æ ¸å¿ƒæ¨¡å—å…³ç³»å›¾
>
> ```js
>                     +---------------------+    +----------------------+
>                       |                     |    |                      |
>         +------------>|  @vue/compiler-dom  +--->|  @vue/compiler-core  |
>         |             |                     |    |                      |
>    +----+----+        +---------------------+    +----------------------+
>    |         |
>    |   vue   |
>    |         |
>    +----+----+        +---------------------+    +----------------------+    +-------------------+
>         |             |                     |    |                      |    |                   |
>         +------------>|  @vue/runtime-dom   +--->|  @vue/runtime-core   +--->|  @vue/reactivity  |
>                       |                     |    |                      |    |                   |
>                       +---------------------+    +----------------------+    +-------------------+
> ```
>
>  @vue/runtime-dom  â€”>  @vue/runtime-core  â€”>  @vue/reactivity

### ä¸‰ã€ç»„ä»¶`Props`ã€`Attrs`å®ç°

åœ¨ç»„ä»¶çš„`render`ä¸­ç”¨æˆ·å¯ä»¥è®¿é—®ç»„ä»¶çš„`data`ã€`props` ã€`$attrs`ç­‰å±æ€§ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹ç»„ä»¶çš„`props` ï¼›å¦å¤–å…³äºç»„ä»¶æœªå£°æ˜çš„`props`ä¼šæŒ‚è½½åœ¨ç»„ä»¶çš„`$attrs`ä¸Š

ä¸‹é¢ğŸ‘‡å°±è¦å®ç°è¿™äº›é€»è¾‘

**åœ¨`setupComponent`ä¸­ `initProps`**

```typescript
// packages/runtime-core/src/component.ts
export function setupComponent(instance) {
  let { type, props } = instance.vnode;
  //...
  
  /**
   * å¤„ç†props
   */
  initProps(instance, props);
  
  //...
}
```

```typescript
// packages/runtime-core/src/component.ts
/**
 * å¤„ç†ç»„ä»¶å®ä¾‹çš„props
 * @param instance ç»„ä»¶å®ä¾‹
 * @param rawProps ç»„ä»¶å®é™…ä¸Šæ¥æ”¶åˆ°çš„æ‰€æœ‰props
 * ç”¨æˆ·æ¥æ”¶çš„æ”¾åˆ°instance.propsä¸Š
 * ç”¨æˆ·æœªæ¥æ”¶çš„æ”¾åˆ°instance.attrsä¸Š
 */
function initProps(instance, rawProps) {
  const props = {};
  const attrs = {};

  const options = instance.propsOptions;

  if (rawProps) {
    for (let key in rawProps) {
      const value = rawProps[key]; // æ‹¿åˆ°å¯¹åº”çš„å€¼

      // è¿™é‡Œåº”è¯¥æ ¡éªŒå€¼çš„ç±»å‹ æ˜¯å¦ç¬¦åˆ è¦æ±‚çš„æ ¡éªŒ
      if (key in options) {
        props[key] = value;
      } else {
        attrs[key] = value;
      }
    }
  }
  /**
   * å°†ç»„ä»¶å®ä¾‹çš„propsè¿›è¡Œä»£ç†ï¼Œè½¬æ¢æˆReactiveObj
   * åç»­æ›´æ–°propså¯ä»¥ç›´æ¥é‡æ–°æ¸²æŸ“ç»„ä»¶
   * Vueæºç ä¸­ç”¨çš„æ˜¯shallowReactive
   */
  instance.props = reactive(props);
  instance.attrs = attrs; // é»˜è®¤æ˜¯éå“åº”å¼çš„
}
```

**ä¿®æ”¹ç”¨æˆ·`render`çš„`this`æŒ‡å‘**

```typescript
// packages/runtime-core/src/renderer.ts

  function setupRenderEffect(instance, container, anchor) {
    const componentUpdate = () => {
      const { render } = instance;

      if (!instance.isMounted) {
        // ç»„ä»¶åˆå§‹åŒ–æŒ‚è½½

        /**
         * è°ƒç”¨ç”¨æˆ·å†™çš„åŸå§‹ç»„ä»¶ä¸­çš„render
         * å¹¶å°†å…¶ç”Ÿæˆçš„VNodeæŒ‚åˆ°ç»„ä»¶å®ä¾‹instance.subTreeä¸Š
         * ç»„ä»¶æœ€ç»ˆè¦æ¸²æŸ“çš„è™šæ‹ŸèŠ‚ç‚¹ å°±æ˜¯subtree
         *
         * æ³¨æ„ï¼šå“åº”å¼çš„ä¾èµ–æ”¶é›†å‘ç”Ÿåœ¨è¿™é‡Œ
         * ç»„ä»¶å®ä¾‹çš„dataåœ¨setupComponentæ—¶å·²ç»è¢«è½¬æ¢æˆReactiveObj
         *
         * æ³¨æ„ï¼šè¿™é‡Œrenderä¸­çš„thisæŒ‡å‘çš„æ˜¯ç»„ä»¶å®ä¾‹ä¸Šçš„ä»£ç†å¯¹è±¡ï¼ˆä¸æ˜¯ReactiveObjï¼‰
         * é€šè¿‡è¿™ä¸ªä»£ç†å¯¹è±¡å¯ä»¥è®¿é—®ç»„ä»¶ä¸Šçš„dataã€propsã€$attrsç­‰å±æ€§
         * åŒæ—¶ä¹Ÿå¯¹ç”¨æˆ·çš„ä¸€äº›æ“ä½œç»„ä»¶å±æ€§çš„è¡Œä¸ºè¿›è¡Œæ‹¦æˆª
         */
        const subTree = render.call(instance.proxy);

        // ... 
      } else {
        // ç»„ä»¶æ›´æ–°
        
        // ...

        // ç”Ÿæˆæ–°çš„VNode
        const subTree = render.call(instance.proxy);
        
        // ...
      }
    };

    // ... 
  }
```

**åˆ›å»º`instance.proxy`**

```typescript
// packages/runtime-core/src/component.ts
export function setupComponent(instance) {
  let { type, props } = instance.vnode;
  //...
  
  /**
   * åˆ›å»ºç»„ä»¶ä»£ç†å¯¹è±¡ï¼Œä¾›ç”¨æˆ·ä½¿ç”¨
   * é¿å…ç”¨æˆ·ç›´æ¥æ“ä½œç»„ä»¶å®ä¾‹
   * åŒæ—¶å¯¹ç”¨æˆ·æ“ä½œç»„ä»¶å®ä¾‹çš„è¡Œä¸ºè¿›è¡Œæç¤º
   */
  instance.proxy = new Proxy(instance, instanceProxy);
  
  //...
}
```

```typescript
// packages/runtime-core/src/component.ts

/**
 * ç»„ä»¶å®ä¾‹ä»£ç†é…ç½®
 */
const instanceProxy = {
  get(target, key) {
    const { data, props } = target;
    // ç”¨æˆ·è®¿é—®ç»„ä»¶ä¸Šçš„dataã€propsã€$attrsç­‰å±æ€§
    if (data && hasOwn(data, key)) {
      return data[key];
    } else if (props && hasOwn(props, key)) {
      return props[key];
    }
    let getter = publicProperties[key];
    if (getter) {
      return getter(target);
    }
  },
  set(target, key, value) {
    const { data, props } = target;
    if (data && hasOwn(data, key)) {
      data[key] = value;
    } else if (props && hasOwn(props, key)) {
      // æ‹¦æˆªç”¨æˆ·ä¿®æ”¹ç»„ä»¶å®ä¾‹propsï¼Œè¦éµå¾ªå•å‘æ•°æ®æµåŸåˆ™
      console.warn('props not update');
      return false;
    }
    return true;
  }
};
```

```typescript
// packages/runtime-core/src/component.ts

/**
 * ç»„ä»¶å®ä¾‹ä»£ç†é…ç½®
 */
const instanceProxy = {
  get(target, key) {
    const { data, props } = target;
    // ç”¨æˆ·è®¿é—®ç»„ä»¶ä¸Šçš„dataã€propsã€$attrsç­‰å±æ€§
    if (data && hasOwn(data, key)) {
      return data[key];
    } else if (props && hasOwn(props, key)) {
      return props[key];
    }
    let getter = publicProperties[key];
    if (getter) {
      return getter(target);
    }
  },
  set(target, key, value) {
    const { data, props } = target;
    if (data && hasOwn(data, key)) {
      data[key] = value;
    } else if (props && hasOwn(props, key)) {
      // æ‹¦æˆªç”¨æˆ·ä¿®æ”¹ç»„ä»¶å®ä¾‹propsï¼Œè¦éµå¾ªå•å‘æ•°æ®æµåŸåˆ™
      console.warn('props not update');
      return false;
    }
    return true;
  }
};
```

ä¸Šé¢ğŸ‘†è¿™æ®µå®ç°çš„æ ¸å¿ƒåœ¨äº

-  `initProps(instance, props)`æ—¶ï¼Œæ ¹æ®ç»„ä»¶å®ä¾‹ä¸Šçš„`propsOptions: vnode.type.props || {}`å°†`vnode`ä¸Šçš„`props`åˆ†å¼€å­˜åœ¨`instance.props`å’Œ`instance.attrs`ä¸Š
- æ”¹å˜ç”¨æˆ·`render`çš„`this`æŒ‡å‘ä¸º`instance.proxy`ï¼Œ`instance.proxy`æ˜¯ä¸ªä»£ç†å¯¹è±¡ï¼Œå¤„ç†äº†ç”¨æˆ·å¯¹äºç»„ä»¶ä¸Šçš„`data`ã€`props`ã€`$attrs`ç­‰å±æ€§çš„è®¿é—®æ“ä½œåŠä¿®æ”¹æ“ä½œ

### å››ã€`props`å˜åŒ–å¯¼è‡´ç»„ä»¶æ›´æ–°çš„å®ç°

**ç»„ä»¶çš„æŒ‚è½½å’Œæ›´æ–°æ–¹æ³•`processComponent`**

```typescript
// packages/runtime-core/src/renderer.ts
/**
   * ç»„ä»¶ç±»å‹çš„VNodeçš„æŒ‚è½½å’Œæ›´æ–°å¤„ç†
   */
  function processComponent(n1, n2, container, anchor) {
    if (n1 == null) {
      // åˆå§‹åŒ–æŒ‚è½½ç»„ä»¶
      mountComponent(n2, container, anchor);
    } else {
      // ç»„ä»¶çš„æ›´æ–°æµç¨‹ æ’æ§½çš„æ›´æ–° å±æ€§æ›´æ–°
      updateComponent(n1, n2);
    }
  }
```

**ç»„ä»¶æ›´æ–°çš„å¤„ç†`updateComponent`**

```typescript
// packages/runtime-core/src/renderer.ts
/**
   * ç»„ä»¶çš„æ›´æ–°å¤„ç†æ–¹æ³•
   * @param n1 æ—§çš„VNode
   * @param n2 æ–°çš„VNode
   */
  function updateComponent(n1, n2) {
    // å¤ç”¨ç»„ä»¶å®ä¾‹
    const instance = (n2.component = n1.component);

    if (shouldComponentUpdate(n1, n2)) {
      /**
       * è‹¥åˆ¤æ–­ç»„ä»¶éœ€è¦æ›´æ–°
       * åˆ™å°†æ–°çš„VNodeæŒ‚åœ¨ç»„ä»¶çš„nextä¸Š
       * å¹¶è°ƒç”¨instance.update()è§¦å‘ç»„ä»¶çš„æ›´æ–°
       * instance.update()è§¦å‘çš„effectçš„å›è°ƒ componentUpdate
       * æ³¨æ„ï¼šç»„ä»¶çš„æ›´æ–°æ˜¯åœ¨è¿™é‡Œè§¦å‘çš„ï¼Œä½¿ç”¨çš„æ˜¯reactivityæ¨¡å—çš„åŠŸèƒ½
       */
      instance.next = n2;
      instance.update();
    } else {
      instance.vnode = n2;
    }
  }
```

**åˆ¤æ–­ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°çš„æ–¹æ³•`shouldComponentUpdate`**

```typescript
// packages/runtime-core/src/renderer.ts
  /**
   * åˆ¤æ–­ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°çš„æ–¹æ³•
   * (1) æ ¹æ®propsåˆ¤æ–­
   */
  function shouldComponentUpdate(n1, n2) {
    const prevProps = n1.props;
    const nextProps = n2.props;

    return hasChange(prevProps, nextProps); // å¦‚æœå±æ€§æœ‰å˜åŒ–è¯´æ˜è¦æ›´æ–°
  }
```

**åˆ¤æ–­propsæ˜¯å¦å‘ç”Ÿå˜åŒ–çš„æ–¹æ³•hasChange**

```typescript
// packages/runtime-core/src/renderer.ts
  /**
   * åˆ¤æ–­propsæ˜¯å¦å‘ç”Ÿå˜åŒ–
   */
  function hasChange(prevProps, nextProps) {
    for (let key in nextProps) {
      if (nextProps[key] != prevProps[key]) {
        return true;
      }
    }
    return false;
  }
```

`setupRenderEffect`ä¸­å¤„ç†ç»„ä»¶å±æ€§æ›´æ–°çš„æ–¹æ³•`updateComponentPreRender`

```typescript
// packages/runtime-core/src/renderer.ts

  function setupRenderEffect(instance, container, anchor) {
    const componentUpdate = () => {
      const { render } = instance;
      
      // ...
      
       else {
        // ç»„ä»¶æ›´æ–°

        let next = instance.next; // nextè¡¨ç¤ºæ–°çš„è™šæ‹ŸèŠ‚ç‚¹

        if (next) {
          /**
           * æœ‰nextè¡¨ç¤ºè¦æ›´æ–°å±æ€§
           * æ³¨æ„ï¼šè¿™é‡Œæ›´æ–°å±æ€§ä¸ä¼šè§¦å‘componentUpdateå†æ¬¡æ‰§è¡Œ
           * è¿™æ˜¯å› ä¸ºä»£ç èƒ½æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼Œå½“å‰ç»„ä»¶çš„effectæ˜¯æ¿€æ´»çš„
           * åœ¨reactivityæ¨¡å—åšçš„ä¼˜åŒ–é€»è¾‘ä¸­ï¼Œ
           * effectæ¿€æ´»æ—¶ï¼Œå±æ€§å˜åŒ–å¼•èµ·çš„å†æ¬¡æ¿€æ´»effectä¼šè¢«å±è”½æ‰
           */
          updateComponentPreRender(instance, next);
        }
         
        // ...
      }
    
    // ...
  }
```

```typescript
// packages/runtime-core/src/renderer.ts

  /**
   * æ›´æ–°ç»„ä»¶ä¸Šå±æ€§çš„æ–¹æ³•
   * @param instance ç»„ä»¶å®ä¾‹
   * @param next æ–°çš„VNode
   */
  function updateComponentPreRender(instance, next) {
    instance.next = null;
    instance.vnode = next; // æ›´æ–°è™šæ‹ŸèŠ‚ç‚¹å’Œnextå±æ€§
    updateProps(instance, instance.props, next.props); // ä¹‹å‰çš„props
  }
```

```typescript
// packages/runtime-core/src/renderer.ts

  /**
   * æ›´æ–°ç»„ä»¶propsçš„æ–¹æ³•
   */
  function updateProps(instance, prevProps, nextProps) {
    for (let key in nextProps) {
      /**
       * èµ‹äºˆå€¼çš„æ—¶å€™ ä¼šé‡æ–°è°ƒç”¨updateï¼Œä½†æ˜¯ä¼šè¢«å±è”½æ‰
       * æ³¨æ„ï¼šè¿™é‡Œæ”¹çš„å±æ€§ä¸æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡instance.proxyä¿®æ”¹çš„
       * ä¿®æ”¹çš„æ˜¯ç»„ä»¶ä¸Šå®ä¾‹ä¸Šçš„props
       */
      instance.props[key] = nextProps[key];
    }
    for (let key in prevProps) {
      if (!(key in nextProps)) {
        delete instance.props[key];
      }
    }
  }
```

### äº”ã€ç»„ä»¶æ‰¹é‡æ›´æ–°çš„å®ç°

ä¸Šé¢çš„ğŸ‘†å®ç°ä¸­ï¼Œæ¯ä¸€æ¬¡ç»„ä»¶çš„`data`æˆ–è€…`props`å‘ç”Ÿå˜åŒ–éƒ½ä¼šè§¦å‘`effect`çš„å‰¯ä½œç”¨å›è°ƒï¼ˆæ›´æ–°é€»è¾‘ï¼‰ï¼Œè¿™æ ·å¯¹äºæ€§èƒ½æ˜¯ä¸€ç§æŸè€—ï¼Œæ‰€ä»¥æœŸæœ›æœ‰ä¸€ä¸ªæ‰¹é‡æ›´æ–°çš„é€»è¾‘ï¼Œçœ‹ä¸‹é¢çš„å®ç°

```typescript
// packages/runtime-core/src/renderer.ts

  function setupRenderEffect(instance, container, anchor) {
    
    // ...

    // æ·»åŠ scheduler
    const effect = new ReactiveEffect(componentUpdate, () =>
    queueJob(instance.update));

    let update = (instance.update = effect.run.bind(effect));

    // ...
  }
```

```typescript
// packages/runtime-core/src/scheduler.ts

const queue = []; // ç»„ä»¶æ›´æ–°æ–¹æ³•çš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªç»„ä»¶åªèƒ½å­˜ä¸€ä¸ªæ›´æ–°æ–¹æ³•

let isFlushing = false; // æ ‡è¯†æ˜¯å¦å·²ç»æœ‰æ‰¹é‡æ›´æ–°çš„å¾®ä»»åŠ¡å­˜åœ¨äº†

const resolvePromise = Promise.resolve();
/**
 * æ‰¹é‡å¤„ç†ç»„ä»¶æ›´æ–°çš„é€»è¾‘
 * @param job ç»„ä»¶çš„æ›´æ–°æ–¹æ³•
 * ç±»ä¼¼äºæµè§ˆå™¨çš„äº‹ä»¶ç¯ï¼Œå°†ä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œå»é‡, å¼‚æ­¥è°ƒç”¨ä»»åŠ¡
 */
export function queueJob(job) {
  /**
   * å»é‡å¤„ç†
   * å‡½æ•°ä¹Ÿå¯ä»¥å»é‡
   */
  if (!queue.includes(job)) {
    queue.push(job);
  }

  /**
   * ä¸€æ¬¡åªå¼€å¯ä¸€ä¸ªæ‰¹å¤„ç†å¾®ä»»åŠ¡
   * å½“å‰å¾®ä»»åŠ¡å¼€å§‹æ‰§è¡Œåæ‰å…è®¸ï¼Œå¼€å¯ä¸‹ä¸€ä¸ªæ‰¹å¤„ç†å¾®ä»»åŠ¡
   */
  if (!isFlushing) {
    isFlushing = true;
    resolvePromise.then(() => {
      isFlushing = false;

      // å¤åˆ¶ä»»åŠ¡é˜Ÿåˆ—ï¼Œå°†åŸå§‹ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©º
      let copyQueue = queue.slice(0);
      queue.length = 0;

      // å°†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ç»„ä»¶æ›´æ–°æ–¹æ³•ä¸€ä¸€æ‹¿å‡ºæ¥æ‰§è¡Œ
      for (let i = 0; i < copyQueue.length; i++) {
        let job = copyQueue[i];
        job();
      }
      copyQueue.length = 0;
    });
  }
}

```

ä¸Šé¢ğŸ‘†è¿™æ®µå®ç°çš„æ ¸å¿ƒæ˜¯ï¼Œæ¯æ¬¡ç»„ä»¶æ›´æ–°éƒ½ä¼šè§¦å‘`scheduler`:  `() =>queueJob(instance.updateï¼‰`ï¼Œæ¯æ¬¡`scheduler`è¢«è§¦å‘æ—¶ï¼Œéƒ½ä¼šèµ°åˆ°`queueJob`ï¼›åœ¨`queueJob`ä¸­ï¼Œç»´æŠ¤äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆä¼šè¿›è¡Œå»é‡ï¼‰å­˜æ”¾ç»„ä»¶çš„æ›´æ–°æ–¹æ³•`instance.update`ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ï¼ˆä¸€æ¬¡æ‰¹å¤„ç†åªåˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ï¼‰å½“æ‰€æœ‰çš„`scheduler`éƒ½æ‰§è¡Œå®Œä¹‹åæ‰ä¼šæ‰§è¡Œè¿™ä¸ªå¾®ä»»åŠ¡ï¼ˆæ‰€æœ‰çš„åŒæ­¥é€»è¾‘èµ°å®Œï¼Œæ‰ä¼šèµ°å¼‚æ­¥ï¼‰ï¼Œè¿™ä¸ªå¾®ä»»åŠ¡å°†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„**æ›´æ–°æ–¹æ³•**æ‹¿å‡ºæ¥ä¸€ä¸€æ‰§è¡Œå®Œæˆæ‰¹é‡æ›´æ–°

### å…­ã€å®Œæ•´çš„ç»„ä»¶æ¸²æŸ“å®ç°

```typescript
// packages/runtime-core/src/renderer.ts

export function createRenderer(options) {
 //...
  
 /**
   * æ›´æ–°ç»„ä»¶propsçš„æ–¹æ³•
   */
  function updateProps(instance, prevProps, nextProps) {
    for (let key in nextProps) {
      /**
       * èµ‹äºˆå€¼çš„æ—¶å€™ ä¼šé‡æ–°è°ƒç”¨updateï¼Œä½†æ˜¯ä¼šè¢«å±è”½æ‰
       * æ³¨æ„ï¼šè¿™é‡Œæ”¹çš„å±æ€§ä¸æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡instance.proxyä¿®æ”¹çš„
       * ä¿®æ”¹çš„æ˜¯ç»„ä»¶ä¸Šå®ä¾‹ä¸Šçš„props
       */
      instance.props[key] = nextProps[key];
    }
    for (let key in prevProps) {
      if (!(key in nextProps)) {
        delete instance.props[key];
      }
    }
  }

  /**
   * æ›´æ–°ç»„ä»¶ä¸Šå±æ€§çš„æ–¹æ³•
   * @param instance ç»„ä»¶å®ä¾‹
   * @param next æ–°çš„VNode
   */
  function updateComponentPreRender(instance, next) {
    instance.next = null;
    instance.vnode = next; // æ›´æ–°è™šæ‹ŸèŠ‚ç‚¹å’Œnextå±æ€§
    updateProps(instance, instance.props, next.props); // ä¹‹å‰çš„props
  }

  /**
   * ç»„ä»¶çš„æŒ‚è½½ï¼Œå¹¶å¯¹ç»„ä»¶å®ä¾‹è¿›è¡Œå“åº”å¼å¤„ç†
   * @param instance ç»„ä»¶å®ä¾‹
   * @param container çˆ¶å®¹å™¨
   * @param anchor é”šç‚¹
   */
  function setupRenderEffect(instance, container, anchor) {
    /**
     * ç»„ä»¶å“åº”å¼å˜åŒ–çš„å›è°ƒæ–¹æ³•
     */
    const componentUpdate = () => {
      const { render } = instance;

      if (!instance.isMounted) {
        // ç»„ä»¶åˆå§‹åŒ–æŒ‚è½½

        /**
         * è°ƒç”¨ç”¨æˆ·å†™çš„åŸå§‹ç»„ä»¶ä¸­çš„render
         * å¹¶å°†å…¶ç”Ÿæˆçš„VNodeæŒ‚åˆ°ç»„ä»¶å®ä¾‹instance.subTreeä¸Š
         * ç»„ä»¶æœ€ç»ˆè¦æ¸²æŸ“çš„è™šæ‹ŸèŠ‚ç‚¹ å°±æ˜¯subtree
         *
         * æ³¨æ„ï¼šå“åº”å¼çš„ä¾èµ–æ”¶é›†å‘ç”Ÿåœ¨è¿™é‡Œ
         * ç»„ä»¶å®ä¾‹çš„dataåœ¨setupComponentæ—¶å·²ç»è¢«è½¬æ¢æˆReactiveObj
         *
         * æ³¨æ„ï¼šè¿™é‡Œrenderä¸­çš„thisæŒ‡å‘çš„æ˜¯ç»„ä»¶å®ä¾‹ä¸Šçš„ä»£ç†å¯¹è±¡ï¼ˆä¸æ˜¯ReactiveObjï¼‰
         * é€šè¿‡è¿™ä¸ªä»£ç†å¯¹è±¡å¯ä»¥è®¿é—®ç»„ä»¶ä¸Šçš„dataã€propsã€$attrsç­‰å±æ€§
         * åŒæ—¶ä¹Ÿå¯¹ç”¨æˆ·çš„ä¸€äº›æ“ä½œç»„ä»¶å±æ€§çš„è¡Œä¸ºè¿›è¡Œæ‹¦æˆª
         */
        const subTree = render.call(instance.proxy);

        /**
         * çœŸæ­£çš„åˆå§‹åŒ–æŒ‚è½½
         * å’Œå…ƒç´ ç±»å‹ã€æ–‡æœ¬ç±»å‹ä¸€æ ·
         * ä¼ å…¥VNodeç»™patchæ–¹æ³•è¿›è¡Œæ¸²æŸ“
         * æ³¨æ„ï¼šè¿™é‡Œpatchçš„æ˜¯subTreeä¸æ˜¯instance
         * subTreeçš„VNodeçš„ç±»å‹æœ‰ç”¨æˆ·ç¼–å†™çš„renderå†³å®š
         */
        patch(null, subTree, container, anchor);

        instance.subTree = subTree;
        instance.isMounted = true; // æ ‡è¯†å½“å‰ç»„ä»¶å·²ç»æŒ‚è½½è¿‡äº†
      } else {
        // ç»„ä»¶æ›´æ–°

        let next = instance.next; // nextè¡¨ç¤ºæ–°çš„è™šæ‹ŸèŠ‚ç‚¹

        if (next) {
          /**
           * æœ‰nextè¡¨ç¤ºè¦æ›´æ–°å±æ€§
           * æ³¨æ„ï¼šè¿™é‡Œæ›´æ–°å±æ€§ä¸ä¼šè§¦å‘componentUpdateå†æ¬¡æ‰§è¡Œ
           * è¿™æ˜¯å› ä¸ºä»£ç èƒ½æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼Œå½“å‰ç»„ä»¶çš„effectæ˜¯æ¿€æ´»çš„
           * åœ¨reactivityæ¨¡å—åšçš„ä¼˜åŒ–é€»è¾‘ä¸­ï¼Œ
           * effectæ¿€æ´»æ—¶ï¼Œå±æ€§å˜åŒ–å¼•èµ·çš„å†æ¬¡æ¿€æ´»effectä¼šè¢«å±è”½æ‰
           */
          updateComponentPreRender(instance, next);
        }

        // ç”Ÿæˆæ–°çš„VNode
        const subTree = render.call(instance.proxy);
        /**
         * æ›´æ–°é€»è¾‘
         * å°†æ–°çš„VNodeå’Œæ—§çš„VNodeä¼ ç»™patchæ–¹æ³•è¿›è¡Œæ›´æ–°
         */
        patch(instance.subTree, subTree, container, anchor);
        // æ›´æ–°subTree
        instance.subTree = subTree;
      }
    };

      const effect = new ReactiveEffect(componentUpdate, () =>
      queueJob(instance.update));

    /**
     * å°†effectçš„runæ–¹æ³•ç»‘å®šåˆ°ç»„ä»¶ä¸Šï¼Œ
     * åç»­ç»„ä»¶æ›´æ–°ä¼šç”¨åˆ°
     * ä¹Ÿæ˜¯æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨çš„å¼ºåˆ¶æ›´æ–°ç»„ä»¶çš„æ–¹æ³•
     */
    let update = (instance.update = effect.run.bind(effect));

    // è¿›è¡ŒæŒ‚è½½
    update();
  }

  /**
   * ç»„ä»¶ç±»å‹çš„VNodeçš„æŒ‚è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container çˆ¶å®¹å™¨
   * @param anchor é”šç‚¹ ç”¨äºçœŸå®èŠ‚ç‚¹çš„insertæ“ä½œ
   * ç»„ä»¶çš„æ›´æ–°æµç¨‹ æ’æ§½çš„æ›´æ–° å±æ€§æ›´æ–°
   */
  function mountComponent(vnode, container, anchor) {
    /**
     * ï¼ˆ1ï¼‰ç»„ä»¶æŒ‚è½½å‰ éœ€è¦åˆ›å»ºä¸€ä¸ªç»„ä»¶çš„å®ä¾‹ï¼ˆå¯¹è±¡ï¼‰
     * å¯¹è±¡ä¸­åŒ…å«äº†ç»„ä»¶çš„çŠ¶æ€ã€ç»„ä»¶çš„å±æ€§ã€ç»„ä»¶å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸ
     * å°†åˆ›å»ºçš„ç»„ä»¶å®ä¾‹ä¿å­˜åˆ°vnodeä¸Š
     */
    const instance = (vnode.component =
      createComponentInstance(vnode));

    /**
     * (2) å¤„ç†ç»„ä»¶çš„æ’æ§½å’Œç»„ä»¶çš„å±æ€§
     * ç»™ç»„ä»¶çš„å®ä¾‹ä¸Šçš„å±æ€§è¿›è¡Œèµ‹å€¼
     */
    setupComponent(instance);

    /**
     * (3ï¼‰ç»™ç»„ä»¶ç»‘å®šä¸€ä¸ªeffect
     * ç»„ä»¶æ•°æ®å˜åŒ–åå¯ä»¥é‡æ–°æ¸²æŸ“
     */
    setupRenderEffect(instance, container, anchor);
  }

  /**
   * åˆ¤æ–­propsæ˜¯å¦å‘ç”Ÿå˜åŒ–
   */
  function hasChange(prevProps, nextProps) {
    for (let key in nextProps) {
      if (nextProps[key] != prevProps[key]) {
        return true;
      }
    }
    return false;
  }

  /**
   * åˆ¤æ–­ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°çš„æ–¹æ³•
   * (1) æ ¹æ®propsåˆ¤æ–­
   */
  function shouldComponentUpdate(n1, n2) {
    const prevProps = n1.props;
    const nextProps = n2.props;

    return hasChange(prevProps, nextProps); // å¦‚æœå±æ€§æœ‰å˜åŒ–è¯´æ˜è¦æ›´æ–°
  }

  /**
   * ç»„ä»¶çš„æ›´æ–°å¤„ç†æ–¹æ³•
   * @param n1 æ—§çš„VNode
   * @param n2 æ–°çš„VNode
   */
  function updateComponent(n1, n2) {
    // å¤ç”¨ç»„ä»¶å®ä¾‹
    const instance = (n2.component = n1.component);

    if (shouldComponentUpdate(n1, n2)) {
      /**
       * è‹¥åˆ¤æ–­ç»„ä»¶éœ€è¦æ›´æ–°
       * åˆ™å°†æ–°çš„VNodeæŒ‚åœ¨ç»„ä»¶çš„nextä¸Š
       * å¹¶è°ƒç”¨instance.update()è§¦å‘ç»„ä»¶çš„æ›´æ–°
       * instance.update()è§¦å‘çš„effectçš„å›è°ƒ componentUpdate
       * æ³¨æ„ï¼šç»„ä»¶çš„æ›´æ–°æ˜¯åœ¨è¿™é‡Œè§¦å‘çš„ï¼Œä½¿ç”¨çš„æ˜¯reactivityæ¨¡å—çš„åŠŸèƒ½
       */
      instance.next = n2;
      instance.update();
    } else {
      instance.vnode = n2;
    }
  }

  
 /**
   * ç»„ä»¶ç±»å‹çš„VNodeçš„æŒ‚è½½å’Œæ›´æ–°å¤„ç†
   */
  function processComponent(n1, n2, container, anchor) {
    if (n1 == null) {
      // åˆå§‹åŒ–æŒ‚è½½ç»„ä»¶
      mountComponent(n2, container, anchor);
    } else {
      // ç»„ä»¶çš„æ›´æ–°æµç¨‹ æ’æ§½çš„æ›´æ–° å±æ€§æ›´æ–°
      updateComponent(n1, n2);
    }
  }
  
  
 /**
   * VNodeçš„åˆå§‹åŒ–æŒ‚è½½å’Œdiffæ›´æ–°
   * @param n1 å®¹å™¨ä¸Šä¿å­˜çš„ä¸Šä¸€æ¬¡çš„VNode
   * @param n2 æ–°çš„VNode
   * @param container å®¹å™¨ çœŸå®çš„DOMèŠ‚ç‚¹
   */
  const patch = (
    n1,
    n2,
    container,
    anchor = null,
    parentComponent = null
  ) => {
    // è‹¥n1æœ‰å€¼ä¸”n2ã€n1ä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜æ˜¯è¦å°†n1æ›¿æ¢æˆn2
    if (n1 && !isSameVNode(n1, n2)) {
      // å¸è½½n1å¹¶é‡åˆ¶ä¸ºnullï¼Œåç»­èµ°n2çš„åˆå§‹åŒ–
      unmount(n1, parentComponent);
      n1 = null;
    }

    /**
     * n1 å¦‚æœæ˜¯null è¯´æ˜æ˜¯åˆå§‹åŒ–æŒ‚è½½
     * n1 å¦‚æœæœ‰å€¼ è¯´æ˜æ˜¯æ›´æ–° è¦èµ°diffç®—æ³•
     */
    const { type, shapeFlag } = n2;
    switch (type) {
      case Text:
        processText(n1, n2, container);
        break;
      case Fragment:
        processFragment(n1, n2, container, parentComponent);
        break;
      default:
        if (shapeFlag & ShapeFlags.ELEMENT) {
          // é€šè¿‡ä½è¿ç®—åˆ¤æ–­å½“å‰VNodeæ˜¯å…ƒç´ ç±»å‹
          processElement(n1, n2, container, anchor, parentComponent);
        } else if (shapeFlag & ShapeFlags.STATEFUL_COMPONENT) {
          processComponent(n1, n2, container, anchor);
        }
    }
  };
  
 /**
   * DOMçš„æ¸²æŸ“æ–¹æ³•
   * è´Ÿè´£DOMçš„åˆå§‹åŒ–æŒ‚è½½ã€æ›´æ–°ã€å¸è½½
   * @param vnode è™šæ‹ŸèŠ‚ç‚¹
   * @param container å®¹å™¨ï¼ŒçœŸå®çš„DOMèŠ‚ç‚¹
   */
  function render(vnode, container) {
    debugger;
    if (vnode == null) {
      // å¸è½½
      if (container._vnode) {
        unmount(container._vnode, null);
      }
    } else {
      // åˆå§‹åŒ–æŒ‚è½½å’Œæ›´æ–°
      patch(container._vnode || null, vnode, container);
    }
    // ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™å°±å°†vnodeä¿ç•™åˆ°äº†å®¹å™¨ä¸Šï¼Œç”¨äºåç»­åŒºåˆ†æ˜¯åˆå§‹åŒ–æŒ‚è½½è¿˜æ˜¯æ›´æ–°
    container._vnode = vnode;
  }
}
```

```typescript
// packages/runtime-core/src/component.ts

import { hasOwn, isFunction } from '@vue/shared';
import { reactive } from '@vue/reactivity';

/**
 * åˆ›å»ºç»„ä»¶å®ä¾‹çš„æ–¹æ³•
 * @param vnode ç»„ä»¶VNode, vnode.typeæ˜¯ç”¨æˆ·å†™çš„åŸå§‹ç»„ä»¶ï¼ˆæ˜¯ä¸ªå¯¹è±¡ï¼‰
 */
export function createComponentInstance(vnode) {
  let instance = {
    data: null, // ç»„ä»¶æœ¬èº«çš„æ•°æ®
    vnode, // æ ‡è¯†å®ä¾‹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹
    subTree: null, // ç»„ä»¶å¯¹åº”çš„æ¸²æŸ“çš„è™šæ‹ŸèŠ‚ç‚¹ï¼ˆç»„ä»¶renderç”Ÿæˆçš„vnodeï¼‰
    isMounted: false, // ç»„ä»¶æ˜¯å¦æŒ‚è½½è¿‡
    update: null, // ç»„ä»¶çš„effect.runæ–¹æ³•
    render: null,
    propsOptions: vnode.type.props || {}, // ç”¨æˆ·ç¼–å†™çš„åŸå§‹ç»„ä»¶ä¸­çš„props
    props: {}, // è¿™ä¸ªprops ä»£è¡¨ç”¨æˆ·æ¥æ”¶çš„å±æ€§
    attrs: {}, // ç”¨æˆ·æ²¡æœ‰æ¥æ”¶çš„propsæ”¾åœ¨è¿™é‡Œ
    proxy: null // ä»£ç†å¯¹è±¡
  };
  return instance;
}

/**
 * å¤„ç†ç»„ä»¶å®ä¾‹çš„props
 * @param instance ç»„ä»¶å®ä¾‹
 * @param rawProps ç»„ä»¶å®é™…ä¸Šæ¥æ”¶åˆ°çš„æ‰€æœ‰props
 * ç”¨æˆ·æ¥æ”¶çš„æ”¾åˆ°instance.propsä¸Š
 * ç”¨æˆ·æœªæ¥æ”¶çš„æ”¾åˆ°instance.attrsä¸Š
 */
function initProps(instance, rawProps) {
  const props = {};
  const attrs = {};

  const options = instance.propsOptions;

  if (rawProps) {
    for (let key in rawProps) {
      const value = rawProps[key]; // æ‹¿åˆ°å¯¹åº”çš„å€¼

      // è¿™é‡Œåº”è¯¥æ ¡éªŒå€¼çš„ç±»å‹ æ˜¯å¦ç¬¦åˆ è¦æ±‚çš„æ ¡éªŒ
      if (key in options) {
        props[key] = value;
      } else {
        attrs[key] = value;
      }
    }
  }
  /**
   * å°†ç»„ä»¶å®ä¾‹çš„propsè¿›è¡Œä»£ç†ï¼Œè½¬æ¢æˆReactiveObj
   * åç»­æ›´æ–°propså¯ä»¥ç›´æ¥é‡æ–°æ¸²æŸ“ç»„ä»¶
   * Vueæºç ä¸­ç”¨çš„æ˜¯shallowReactive
   */
  instance.props = reactive(props);
  instance.attrs = attrs; // é»˜è®¤æ˜¯éå“åº”å¼çš„
}

/**
 * å¯ä»¥ä¾›ç”¨æˆ·è®¿é—®çš„å±æ€§
 */
const publicProperties = {
  $attrs: instance => instance.attrs
};

/**
 * ç»„ä»¶å®ä¾‹ä»£ç†é…ç½®
 */
const instanceProxy = {
  get(target, key) {
    const { data, props } = target;
    // ç”¨æˆ·è®¿é—®ç»„ä»¶ä¸Šçš„dataã€propsã€$attrsç­‰å±æ€§
    if (data && hasOwn(data, key)) {
      return data[key];
    } else if (props && hasOwn(props, key)) {
      return props[key];
    }
    let getter = publicProperties[key];
    if (getter) {
      return getter(target);
    }
  },
  set(target, key, value) {
    const { data, props } = target;
    if (data && hasOwn(data, key)) {
      data[key] = value;
    } else if (props && hasOwn(props, key)) {
      // æ‹¦æˆªç”¨æˆ·ä¿®æ”¹ç»„ä»¶å®ä¾‹propsï¼Œè¦éµå¾ªå•å‘æ•°æ®æµåŸåˆ™
      console.warn('props not update');
      return false;
    }
    return true;
  }
};

/**
 * åˆæ¬¡æŒ‚è½½ç»„ä»¶æ—¶ï¼Œå¤„ç†ç»„ä»¶çš„æ’æ§½å’Œç»„ä»¶çš„å±æ€§çš„æ–¹æ³•
 * (1) ç»™ç»„ä»¶ä¸Šçš„å±æ€§è¿›è¡Œèµ‹å€¼
 * (2) å¤„ç†propså±æ€§ï¼Œåˆ†å¼€ä¿å­˜
 */
export function setupComponent(instance) {
  // typeå°±æ˜¯ç”¨æˆ·å†™çš„åŸå§‹ç»„ä»¶ï¼ˆæ˜¯ä¸ªå¯¹è±¡ï¼‰
  let { type, props } = instance.vnode;
  let { data, render } = type;

  /**
   * å¤„ç†props
   */
  initProps(instance, props);

  /**
   * åˆ›å»ºç»„ä»¶ä»£ç†å¯¹è±¡ï¼Œä¾›ç”¨æˆ·ä½¿ç”¨
   * é¿å…ç”¨æˆ·ç›´æ¥æ“ä½œç»„ä»¶å®ä¾‹
   * åŒæ—¶å¯¹ç”¨æˆ·æ“ä½œç»„ä»¶å®ä¾‹çš„è¡Œä¸ºè¿›è¡Œæç¤º
   */
  instance.proxy = new Proxy(instance, instanceProxy);

  if (data) {
    if (!isFunction(data)) {
      return console.warn('The data option must be a function.');
    }
    /**
     * å°†ç»„ä»¶å®ä¾‹çš„dataè¿›è¡Œä»£ç†ï¼Œè½¬æ¢æˆReactiveObj
     * åç»­æ›´æ–°propså¯ä»¥ç›´æ¥é‡æ–°æ¸²æŸ“ç»„ä»¶
     */
    instance.data = reactive(data.call({}));
  }

  // å°†ç”¨æˆ·å†™çš„renderæŒ‚åœ¨ç»„ä»¶å®ä¾‹ä¸Š
  instance.render = render;
}

```

### ä¸ƒã€æ€»ç»“

ç»„ä»¶çš„æ¸²æŸ“æ˜¯ç»“åˆäº†ä¹‹å‰çš„å“åº”å¼åŸç†å’Œï¼ˆå…ƒç´ ã€æ–‡æœ¬...)çš„æ¸²æŸ“åŸç†ï¼›

**åˆå§‹åŒ–æŒ‚è½½**

æ¯ä¸ªç»„ä»¶åœ¨åˆæ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ª`effect`ï¼Œå¹¶ä¸”åœ¨`effect(fn)`ä¸­å®Œæˆäº† `render` :arrow_right: å“åº”å¼ä¾èµ–æ•°æ®æ”¶é›† :arrow_right: ç”Ÿæˆ`VNode` :arrow_right: `patch VNode` è¿™ä¸€ç»„ä»¶æŒ‚è½½æµç¨‹

**æ›´æ–°æ¸²æŸ“**

 ç»„ä»¶æ›´æ–°æ¸²æŸ“æœ‰ä¸¤ç§æ–¹å¼

- ç»„ä»¶è‡ªå·±çš„çŠ¶æ€å˜åŒ–äº†ï¼Œä¼šè§¦å‘è‡ªå·±çš„`effect`é‡æ–°æ‰§è¡Œ

  - ç»„ä»¶çš„`data`å‘ç”Ÿå˜åŒ–å¼•èµ·ç»„ä»¶æ›´æ–°çš„åŸç†æ˜¯ï¼š

    - åŸå§‹ç»„ä»¶ï¼ˆç”¨æˆ·å†™çš„ï¼‰çš„`data`å±æ€§ï¼Œè¢«è½¬æ¢æˆå“åº”å¼æ•°æ®æŒ‚åˆ°ç»„ä»¶å®ä¾‹ä¸Šï¼ˆ`instance.data`ï¼‰å¹¶ä¸”ç»„ä»¶å®ä¾‹ä¸Šè¿˜æœ‰ä¸€ä¸ªä»£ç†ç»„ä»¶å®ä¾‹å¯¹è±¡ï¼ˆ`instance.proxy` ï¼Œå¯¹`instance.data`æœ‰åšä»£ç†ï¼‰ï¼›

    - `render`æ‰§è¡Œæ—¶è®¿é—®`data`å±æ€§ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªä»£ç†å¯¹è±¡è®¿é—®`instance.data`ï¼Œå› ä¸º`instance.data`æ˜¯å“åº”å¼æ•°æ®ï¼Œä¸”`render`æ˜¯åœ¨`effect`ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¼šå‘ç”Ÿå“åº”å¼æ•°æ®çš„ä¾èµ–æ”¶é›†

    - å½“åç»­ç”¨æˆ·é€šè¿‡è¿™ä¸ªä»£ç†å¯¹è±¡å»ä¿®æ”¹`instance.data`å±æ€§æ—¶ï¼Œä¾¿ä¼šè§¦å‘å½“å‰ç»„ä»¶çš„`effect`ï¼Œä»è€Œå®Œæˆå“åº”å¼æ›´æ–°

      <!--ä»ä¿®æ”¹ç»„ä»¶dataå¼•èµ·å“åº”å¼æ›´æ–°åŸç†ä¸­ï¼Œå¯ä»¥å‘ç°ç»„ä»¶çš„æ›´æ–°ä¸ä»…ä»…åªèƒ½é ä¿®æ”¹dataå®Œæˆï¼Œå…¶å®åªè¦æ˜¯å“åº”å¼æ•°æ®å¹¶ä¸”åœ¨renderä¸­ä½¿ç”¨åˆ°äº†ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªå“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–ä¾¿èƒ½è§¦å‘ç»„ä»¶æ›´æ–°ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ©ç”¨å“åº”å¼æ¨¡å—çš„reactiveç”Ÿæˆä¸€ä¸ªç»„ä»¶çš„stateä¾›renderä½¿ç”¨ï¼Œè¿™æ ·ä¾¿å’Œreactçš„å†™æ³•ä¸€æ ·äº†-->

- çˆ¶ç»„ä»¶ä¼ é€’ç»™å­ç»„ä»¶çš„`props`å˜åŒ–äº†ä¹Ÿä¼šæ›´æ–°ï¼Œä¼šè°ƒç”¨`update()`è§¦å‘å­ç»„ä»¶çš„`effect`é‡æ–°æ‰§è¡Œ

  - ç»„ä»¶`props`å‘ç”Ÿå˜åŒ–å¼•èµ·ç»„ä»¶æ›´æ–°çš„åŸç†æ˜¯ï¼š

    - çˆ¶ç»„ä»¶ä¼ é€’ç»™å­ç»„ä»¶çš„`props`ä¸€å®šæ˜¯å“åº”å¼çš„ï¼Œå½“çˆ¶ç»„ä»¶ä¿®æ”¹è¿™ä¸ª`props`æ—¶é¦–å…ˆä¼šè§¦å‘çˆ¶ç»„ä»¶è‡ªå·±çš„`effect`å¼•èµ·çˆ¶ç»„ä»¶çš„`patch`

    - è€Œçˆ¶ç»„ä»¶`patch`ä¼šå¿…ç„¶ä¼šå¼•èµ·å­ç»„ä»¶çš„`patch`(å­ç»„ä»¶æ˜¯çˆ¶ç»„ä»¶çš„`children`)ï¼Œå­ç»„ä»¶`patch`æ—¶ä¾¿ä¼šè§¦å‘è‡ªå·±çš„`effect`ä»è€Œå®Œæˆ å“åº”å¼æ›´æ–°

    - æ‰€ä»¥ç»„ä»¶`props`å˜åŒ–å¼•èµ·çš„ç»„ä»¶æ›´æ–°ï¼Œå…¶å®æ˜¯çˆ¶ç»„ä»¶æ›´æ–°å¯¼è‡´çš„

      <!--å…¶å®å­ç»„ä»¶å¯ä»¥ä¸é€šè¿‡çˆ¶ç»„ä»¶ï¼Œè‡ªå·±å»ä¿®æ”¹propsï¼Œè¿™æ ·ä¹Ÿèƒ½å¼•èµ·ç»„ä»¶æ›´æ–°ï¼Œå› ä¸ºç»„ä»¶çš„propsä¹Ÿåšäº†å“åº”å¼å¤„ç†ï¼ˆpropså¯èƒ½å·²ç»æ˜¯å“åº”å¼äº†ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯ï¼‰ï¼Œä½†æ˜¯è¿™ç§æ“ä½œä¸€èˆ¬æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸ºåœ¨ç»„ä»¶çš„ä½¿ç”¨æˆ‘ä»¬éœ€è¦éµä»å•å‘æ•°æ®æµçš„åŸåˆ™ï¼Œä¿æŒæ•°æ®çš„çº¯æ´æ€§-->

