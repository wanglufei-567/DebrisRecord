## webpackç¬”è®°ï¼ˆäº”ï¼‰â€” webpackä¼˜åŒ–

### ä¸€ã€å¼•è¨€

åœ¨ç°ä»£å‰ç«¯å¼€å‘ä¸­ï¼Œ**Webpack** å·²ç»æˆä¸ºäº†ä¸€ä¸ªä¸å¯æˆ–ç¼ºçš„å‰ç«¯å·¥ç¨‹æ„å»ºå·¥å…·ã€‚ç„¶è€Œï¼Œéšç€é¡¹ç›®**è§„æ¨¡**çš„**æ‰©å¤§**å’Œ**å¤æ‚åº¦**çš„**æé«˜**ï¼Œ**Webpack** çš„æ„å»ºæ—¶é—´å¯èƒ½ä¼šå˜å¾—è¶Šæ¥è¶Šé•¿ï¼Œè¾“å‡ºçš„æ–‡ä»¶ä¹Ÿå¯èƒ½ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å¯¹ **Webpack** è¿›è¡Œæ·±åº¦ä¼˜åŒ–

#### 1.1ã€ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–ï¼Ÿ

åœ¨ **Web** å¼€å‘ä¸­ï¼Œ**æ€§èƒ½**æ˜¯è‡³å…³é‡è¦çš„ï¼Œä¸€ä¸ª**é«˜æ€§èƒ½**çš„åº”ç”¨ä¸ä»…å¯ä»¥æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè¿˜å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜ç”¨æˆ·çš„è½¬åŒ–ç‡ï¼›å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ **Webpack** è¿›è¡Œä¼˜åŒ–ï¼Œä»¥æé«˜åº”ç”¨çš„æ€§èƒ½

#### 1.2ã€ä¼˜åŒ–çš„ç›®æ ‡

ä¼˜åŒ–çš„ä¸»è¦ç›®æ ‡æ˜¯æé«˜åº”ç”¨çš„**==åŠ è½½é€Ÿåº¦==**å’Œ**==è¿è¡Œæ•ˆç‡==**

å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›è¾¾åˆ°ä»¥ä¸‹å‡ ä¸ªç›®æ ‡ï¼š

1. **æé«˜æ„å»ºé€Ÿåº¦**ï¼šé€šè¿‡ä¼˜åŒ– **Webpack** çš„é…ç½®ï¼Œå‡å°‘æ„å»ºçš„æ—¶é—´ï¼Œ==æé«˜å¼€å‘æ•ˆç‡==
2. **å‡å°‘è¾“å‡ºæ–‡ä»¶çš„å¤§å°**ï¼šé€šè¿‡ä¼˜åŒ–ä»£ç å’Œèµ„æºçš„å¤„ç†æ–¹å¼ï¼Œå‡å°‘è¾“å‡ºæ–‡ä»¶çš„å¤§å°ï¼Œ==å‡å°‘ç”¨æˆ·çš„ä¸‹è½½æ—¶é—´==
3. **æé«˜ä»£ç çš„è¿è¡Œæ•ˆç‡**ï¼šé€šè¿‡ä¼˜åŒ–ä»£ç çš„ç»“æ„å’Œè¿è¡Œæ–¹å¼ï¼Œæé«˜ä»£ç çš„è¿è¡Œæ•ˆç‡ï¼Œ==æé«˜åº”ç”¨çš„å“åº”é€Ÿåº¦==

#### 1.3ã€ä¼˜åŒ–çš„ç»“æœ

ç»è¿‡ä¼˜åŒ–åï¼Œæˆ‘ä»¬å¯ä»¥æœŸå¾…ä»¥ä¸‹çš„ç»“æœï¼š

1. **æ›´å¿«çš„æ„å»ºé€Ÿåº¦**ï¼šé€šè¿‡åˆç†çš„é…ç½®å’Œæ’ä»¶çš„ä½¿ç”¨ï¼Œæ˜¾è‘—æé«˜ **Webpack** çš„æ„å»ºé€Ÿåº¦
2. **æ›´å°çš„è¾“å‡ºæ–‡ä»¶**ï¼šé€šè¿‡ä»£ç å‹ç¼©ã€**Tree Shaking** å’Œä»£ç åˆ†å‰²ç­‰æŠ€æœ¯ï¼Œæ˜¾è‘—å‡å°‘è¾“å‡ºæ–‡ä»¶çš„å¤§å°
3. **æ›´é«˜çš„è¿è¡Œæ•ˆç‡**ï¼šé€šè¿‡ä»£ç ä¼˜åŒ–å’Œèµ„æºæ‡’åŠ è½½ç­‰æŠ€æœ¯ï¼Œæé«˜ä»£ç çš„è¿è¡Œæ•ˆç‡

### äºŒã€ç¯å¢ƒå‡†å¤‡

ä¸ºäº†èƒ½æ›´åŠ æ·±åˆ»çš„ç†è§£å„ç§ä¼˜åŒ–ç­–ç•¥ï¼Œéœ€è¦ä¸€ä¸ªå…·ä½“å‰ç«¯å·¥ç¨‹æ¥è¿›è¡Œè¯´æ˜ï¼Œè¿™é‡Œåˆ›å»ºä¸€ä¸ª **React** å·¥ç¨‹æ¥ä¸ºæ¥ä¸‹æ¥çš„ä¼˜åŒ–å·¥ä½œåšå‡†å¤‡

æ–‡ä»¶ç›®å½•å¦‚ä¸‹ğŸ‘‡

```
optimize
â”œâ”€â”€ .babelrc
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ index.tsx
â”œâ”€â”€ tsconfig.json
â””â”€â”€ webpack.config.js
```

`webpack.config.js` å¦‚ä¸‹ğŸ‘‡

```js
const path = require('path')
const HtmlWebpackPlugin = require('html-webpack-plugin')

module.exports = {
    mode: 'development',
    entry: './src/index.tsx',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: 'bundle.js',
    },
    module: {
        rules: [
            {
                test: /\.(ts|tsx)$/,
                exclude: /node_modules/,
                use: {
                    loader: 'babel-loader',
                },
            },
        ],
    },
    plugins: [
        new HtmlWebpackPlugin({
            template: './src/index.html',
        }),
    ],
    resolve: {
        extensions: ['.tsx', '.ts', '.js'], // æ¨¡å—å¼•å…¥æ—¶ä¼šè‡ªåŠ¨æ·»åŠ è¿™äº›åç¼€å»æ‰¾æ–‡ä»¶
    },
    devServer: {
        port: 9000,
    },
}
```

### ä¸‰ã€æ€§èƒ½æŒ‡æ ‡åˆ†æå·¥å…·

ä¸ºäº†ç›´è§‚çš„çœ‹åˆ°æ€§èƒ½çš„å˜åŒ–ï¼Œéœ€è¦å…ˆå®‰è£…ä¸€äº›æ€§èƒ½æŒ‡æ ‡åˆ†æå·¥å…·ï¼š

- [progress-bar-webpack-plugin](https://www.npmjs.com/package/progress-bar-webpack-plugin)ï¼šæŸ¥çœ‹ç¼–è¯‘è¿›åº¦
- [speed-measure-webpack-plugin](https://www.npmjs.com/package/speed-measure-webpack-plugin)ï¼šæŸ¥çœ‹ç¼–è¯‘é€Ÿåº¦
- [webpack-bundle-analyzer](https://www.npmjs.com/package/webpack-bundle-analyzer)ï¼šæ‰“åŒ…æ–‡ä»¶ä½“ç§¯åˆ†æ

#### 3.1ã€ç¼–è¯‘è¿›åº¦

å¤§å‹é¡¹ç›®çš„ç¼–è¯‘æ—¶é—´å¾€å¾€è¦å¾ˆä¹…ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­è‹¥æ˜¯æƒ³çŸ¥é“å½“å‰ç¼–è¯‘è¿›å±•åˆ°å“ªä¸ªé˜¶æ®µäº†ï¼Œå¯ä»¥é€šè¿‡ [progress-bar-webpack-plugin](https://www.npmjs.com/package/speed-measure-webpack-plugin) æ’ä»¶æŸ¥çœ‹ç¼–è¯‘è¿›åº¦

å®‰è£…ï¼š

```shell
npm i -D progress-bar-webpack-plugin
```

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼š

```js
const path = require('path')
const chalk = require('chalk')

const ProgressBarPlugin = require('progress-bar-webpack-plugin')

module.exports = {
  // ...
    plugins: [
        new HtmlWebpackPlugin({
            template: './src/index.html',
        }),
        new ProgressBarPlugin({
            // ç¼–è¯‘è¿›åº¦æ¡
            format: 'build :msg [:bar] ' + chalk.green.bold(':percent') + ' (:elapsed seconds)',
            clear: false,
        }),
    ],
  // ...
}
```

`format` è¡¨ç¤ºåœ¨ç»ˆç«¯ä¸­è¦å±•ç¤ºå†…å®¹çš„æ ¼å¼ï¼Œå…¶ä¸­å‡ ä¸ªå…³é”®ä¿¡æ¯å¦‚ä¸‹:

- `:msg`ï¼šç¼–è¯‘é˜¶æ®µ

  > **Webpack** çš„ç¼–è¯‘æµç¨‹åˆ†ä¸º 4 ä¸ªé˜¶æ®µï¼š**setup**ã€**make**ã€**seal**ã€**emit**
  >
  > - **setup**ï¼š**Initializationï¼ˆåˆå§‹åŒ–ï¼‰**
  >   - è¯»å–å¹¶åˆå¹¶é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ–æ’ä»¶å’Œé…ç½®é¡¹ï¼Œåˆ›å»º **Compiler** å¯¹è±¡
  > - **make**ï¼š**Compilationï¼ˆç¼–è¯‘ï¼‰**
  >   - ä»å…¥å£ç‚¹å‡ºå‘ï¼Œé€’å½’åœ°è§£ææ‰€æœ‰ä¾èµ–æ¨¡å—ï¼Œæ„å»ºæ¨¡å—ä¾èµ–å›¾ **ModuleGraph**
  >   - å…¶ä¸­åŒ…å«ä»¥ä¸‹å­é˜¶æ®µï¼š
  >     - **Building Modulesï¼ˆæ¨¡å—æ„å»ºï¼‰**ï¼šå¯¹æ¯ä¸ªæ¨¡å—ç”¨å¯¹åº”çš„ **loader** å¤„ç†ï¼Œå°†æ¯ä¸ªæ¨¡å—ç¼–è¯‘ä¸ºé€‚åˆåœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„ **JavaScript**
  >     - **Tree Shakingï¼ˆæ‘‡æ ‘ä¼˜åŒ–ï¼‰**ï¼šåœ¨æ¨¡å—æ„å»ºé˜¶æ®µä¸­ï¼Œ**Webpack** ä¼šå¯¹æ¯ä¸ªæ¨¡å—è¿›è¡Œåˆ†æï¼Œåˆ é™¤æœªå¼•ç”¨çš„ä»£ç 
  >     - **Code Splittingï¼ˆä»£ç åˆ†ç¦»ï¼‰**ï¼šåœ¨æ¨¡å—æ„å»ºè¿‡ç¨‹ä¸­ï¼Œ**Webpack** ä¼šæ ¹æ®é…ç½®è¿›è¡Œä»£ç åˆ†ç¦»ï¼Œå°†æ¨¡å—æ‹†åˆ†æˆä¸åŒçš„ **chunks**
  > - **seal**ï¼š**Optimizationï¼ˆä¼˜åŒ–ï¼‰**
  >   - å¯¹ **ModuleGraph** åš **Chunk** æ‹†åˆ†ï¼ŒæŒ‰ç…§ **splitChunks** çš„é€»è¾‘æˆ–è€…å…¶ä»–æ‹†åˆ†é€»è¾‘ï¼Œæ‹†åˆ†åå°±ç”Ÿæˆäº† **ChunkGraph**
  >   - å…¶ä¸­åŒ…å«ä»¥ä¸‹å­é˜¶æ®µï¼š
  >     - **Tree Shakingï¼ˆæ‘‡æ ‘ä¼˜åŒ–ï¼‰**ï¼šåœ¨æ­¤é˜¶æ®µç»§ç»­å¯¹æ¨¡å—å’Œ **chunks** è¿›è¡Œä¼˜åŒ–ï¼Œç§»é™¤å¤šä½™çš„ä»£ç 
  >     - **Code Splittingï¼ˆä»£ç åˆ†ç¦»ï¼‰**ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–å’Œåˆ†ç¦»ä»£ç å—
  > - **emit**ï¼š**Outputï¼ˆè¾“å‡ºï¼‰**
  >   - å°†ä¸åŒ **Chunk** ç”¨ä¸åŒçš„æ¨¡ç‰ˆæ‰“å°æˆæœ€ç»ˆä»£ç ï¼Œå¹¶è¾“å‡ºåˆ°ç›®æ ‡ç›®å½•
  >   - å…¶ä¸­åŒ…å«ä»¥ä¸‹å­é˜¶æ®µï¼š
  >     - **Code Minificationï¼ˆä»£ç å‹ç¼©ï¼‰**ï¼šåœ¨è¾“å‡ºä¹‹å‰ï¼Œ**Webpack** ä½¿ç”¨ **Terser** ç­‰æ’ä»¶å¯¹ **JavaScript** æ–‡ä»¶è¿›è¡Œå‹ç¼©

- `:bar`ï¼šè¿›åº¦æ¡

- `:percent`ï¼šç™¾åˆ†æ¯”

- `:elapsed`ï¼šå·²æ¶ˆè€—çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰

å±•ç¤ºæ•ˆæœï¼š

![image-20240605084824675](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20240605084824675.png)

#### 2.2ã€ç¼–è¯‘é€Ÿåº¦

ä¼˜åŒ– **Webpack** æ„å»ºé€Ÿåº¦ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“æ˜¯å“ªäº› `plugin`ã€å“ªäº› `loader` è€—æ—¶é•¿ï¼Œå¯ä»¥é€šè¿‡ [speed-measure-webpack-plugin](https://www.npmjs.com/package/speed-measure-webpack-plugin) æ’ä»¶è¿›è¡Œæ„å»ºé€Ÿåº¦åˆ†æï¼Œå¯ä»¥çœ‹åˆ°å„ä¸ª `plugin`ã€ `loader`çš„æ„å»ºæ—¶é•¿ï¼Œåç»­å¯é’ˆå¯¹è€—æ—¶é•¿çš„`plugin`ã€ `loader` è¿›è¡Œä¼˜åŒ–

å®‰è£…ï¼š

```shell
npm i -D speed-measure-webpack-plugin
```

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼š

```js
const path = require('path')
const chalk = require('chalk')

const ProgressBarPlugin = require('progress-bar-webpack-plugin')
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')

const smp = new SpeedMeasurePlugin() // ç¼–è¯‘é€Ÿåº¦åˆ†æ

module.exports = smp.wrap({
  // ...
    plugins: [
        new HtmlWebpackPlugin({
            template: './src/index.html',
        }),
        new ProgressBarPlugin({
            // ç¼–è¯‘è¿›åº¦æ¡
            format: 'build :msg [:bar] ' + chalk.green.bold(':percent') + ' (:elapsed seconds)',
            clear: false,
        }),
    ],
  // ...
})
```

å±•ç¤ºæ•ˆæœï¼š

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20240605230404245.png" alt="image-20240605230404245" style="zoom:50%;" />

å…¶ä¸­  `general output time` ä¸»è¦æ˜¯ç”¨æ¥è¡¡é‡ **Webpack** ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–æ•°æ®çš„æ—¶é—´ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œå®ƒåŒ…å«äº†[speed-measure-webpack-plugin](https://www.npmjs.com/package/speed-measure-webpack-plugin)  æ— æ³•ç›´æ¥æµ‹é‡çš„æ‰€æœ‰æ—¶é—´

#### 2.3ã€æ‰“åŒ…æ–‡ä»¶ä½“ç§¯åˆ†æ

ä¼˜åŒ– **Webpack** æ‰“åŒ…ä½“ç§¯ï¼Œä¹Ÿéœ€è¦å…ˆåˆ†ææ‰“åŒ…æ–‡ä»¶ä¸­å„ä¸ª **bundle** æ–‡ä»¶çš„å æ¯”å¤§å°ï¼Œåç»­å†è¿›è¡Œé’ˆå¯¹ä¼˜åŒ–ï¼Œå¯ä»¥ä½¿ç”¨  [webpack-bundle-analyzer](https://www.npmjs.com/package/webpack-bundle-analyzer) æ¥è¿›è¡Œæ–‡ä»¶ä½“ç§¯çš„åˆ†æ

[webpack-bundle-analyzer](https://www.npmjs.com/package/webpack-bundle-analyzer)  æ˜¯ä¸€ä¸ªç”¨äºåˆ†æå’Œå¯è§†åŒ– **Webpack** æ‰“åŒ…ç»“æœçš„å·¥å…·

å®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- å¯è§†åŒ–æŠ¥å‘Šï¼šæ’ä»¶ç”Ÿæˆä¸€ä¸ªå¯è§†åŒ–æŠ¥å‘Šï¼Œä»¥å›¾è¡¨å’Œè¡¨æ ¼çš„å½¢å¼å±•ç¤ºæ„å»ºäº§ç‰©çš„ç»„æˆéƒ¨åˆ†
  - é€šè¿‡ç›´è§‚çš„ç•Œé¢å±•ç¤ºæ¨¡å—çš„å¤§å°ã€å æ¯”å’Œä¾èµ–å…³ç³»ï¼Œå¯ä»¥å¿«é€Ÿäº†è§£æ•´ä¸ªæ„å»ºç»“æœçš„ç»“æ„
- æ¨¡å—å¤§å°åˆ†æï¼šæ’ä»¶å¯ä»¥å¸®åŠ©äº†è§£æ¯ä¸ªæ¨¡å—ï¼ˆåŒ…æ‹¬ **JavaScript**ã€**CSS**ã€å›¾ç‰‡ç­‰ï¼‰çš„å¤§å°
  - å¯ä»¥è¯†åˆ«å‡ºå“ªäº›äº›å ç”¨ç©ºé—´è¾ƒå¤§çš„æ¨¡å—ï¼Œå¹¶é‡‡å–ç›¸åº”çš„ä¼˜åŒ–æªæ–½ï¼Œä¾‹å¦‚å‹ç¼©ã€ä»£ç æ‹†åˆ†ç­‰
- ä¾èµ–å…³ç³»å¯è§†åŒ–ï¼šå±•ç¤ºæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»
  - ä»¥å›¾å½¢æ–¹å¼æ˜¾ç¤ºæ¨¡å—ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œå¸®åŠ©æ›´å¥½åœ°ç†è§£ä»£ç åº“ä¸­ä¸åŒæ¨¡å—ä¹‹é—´çš„å…³è”æ€§

å®‰è£…ï¼š

```shell
npm i -D webpack-bundle-analyzer
```

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼š

```js
const path = require('path')
const chalk = require('chalk')

const ProgressBarPlugin = require('progress-bar-webpack-plugin')
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin

const smp = new SpeedMeasurePlugin() // ç¼–è¯‘é€Ÿåº¦åˆ†æ

module.exports = smp.wrap({
  // ...
    plugins: [
        new HtmlWebpackPlugin({
            template: './src/index.html',
        }),
        new ProgressBarPlugin({
            // ç¼–è¯‘è¿›åº¦æ¡
            format: 'build :msg [:bar] ' + chalk.green.bold(':percent') + ' (:elapsed seconds)',
            clear: false,
        }),
        new BundleAnalyzerPlugin({
            // æ‰“åŒ…ä½“ç§¯åˆ†æ
            analyzerMode: 'static',
        }),
    ],
  // ...
})
```

å±•ç¤ºæ•ˆæœï¼š

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20240605232902024.png" alt="image-20240605232902024" style="zoom:30%;" />

å¯ä»¥ç›´è§‚çš„çœ‹åˆ° `react-dom` è¿™ä¸ªæ¨¡å—åœ¨å½“å‰å·¥ç¨‹ä¸­æ–‡ä»¶ä½“ç§¯æœ€å¤§

æŠ¥å‘Šä¸­æœ‰å‡ ä¸ªå…³é”®æŒ‡æ ‡ï¼š

- `stat size`ï¼šæ–‡ä»¶çš„â€œ**è¾“å…¥**â€å¤§å°ï¼Œå³åœ¨è¿›è¡Œä»»ä½•è½¬æ¢ï¼ˆå¦‚å‹ç¼©ï¼‰ä¹‹å‰çš„å¤§å°
- `parsed size`ï¼šæ–‡ä»¶çš„â€œ**è¾“å‡º**â€å¤§å°ï¼Œå¦‚æœä½¿ç”¨äº†å‹ç¼©æ’ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼åæ˜ çš„æ˜¯ä»£ç çš„å‹ç¼©åçš„å¤§å°
- `gzip size`ï¼šæ–‡ä»¶çš„ **gzip å‹ç¼©**åçš„å¤§å°ï¼Œå¦‚æœé…ç½®äº† **gzip å‹ç¼©**ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å°†åæ˜ çš„æ˜¯ä»£ç åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­å®é™…åŠ è½½çš„å¤§å°

### ä¸‰ã€åŠ å¿«æ„å»ºé€Ÿåº¦

é€šè¿‡ä¼˜åŒ– **Webpack** çš„é…ç½®ï¼Œæ¯”å¦‚ï¼šå‡å°‘æŸ¥æ‰¾èŒƒå›´ã€é¿å…æ— ç”¨æ¨¡å—å’Œé‡å¤æ‰“åŒ…ã€ä½¿ç”¨ç¼“å­˜å’Œå¹¶è¡Œæ¨¡å¼ã€å¼€å¯å¤šè¿›ç¨‹æ‰“åŒ…å’Œå‹ç¼©ï¼Œå¯ä»¥å¤§å¤§å‡å°‘æ„å»ºçš„æ—¶é—´

#### 3.1ã€ é™ä½ loaderã€plugins çš„æ—¶é—´

æ¯ä¸ªçš„ `loader`ï¼Œ`plugin` éƒ½æœ‰å…¶å¯åŠ¨æ—¶é—´ï¼Œæˆ‘ä»¬åº”è¯¥å‡å°‘éå¿…è¦çš„ `loader`ï¼Œ`plugin`ï¼Œæˆ–è€…é€šè¿‡ä½¿ç”¨ `include` å’Œ `exclude` æ¥ç¼©å°  `loader`  çš„æŸ¥æ‰¾èŒƒå›´

##### 3.1.1ã€ä½¿ç”¨ Webpack èµ„æºæ¨¡å—

**Webpack5** å¼•å…¥äº†ä¸€ç§æ–°çš„æ–¹å¼æ¥å¤„ç†**é™æ€èµ„æº**ï¼Œå³[**èµ„æºæ¨¡å—(Asset Modules)**](https://webpack.docschina.org/guides/asset-modules/)ï¼Œå®ƒå…è®¸ä½¿ç”¨èµ„æºæ–‡ä»¶ï¼ˆå­—ä½“ï¼Œå›¾æ ‡ç­‰ï¼‰è€Œæ— éœ€é…ç½®é¢å¤– `loader`

**Webpack5** æä¾›äº†å››ç§èµ„æºæ¨¡å—ç±»å‹ï¼Œæ¯ç§ç±»å‹éƒ½æœ‰ä¸åŒçš„ç”¨é€”å’Œç”Ÿæˆçš„äº§ç‰©å½¢å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½® `type` å±æ€§è®¾ç½®èµ„æºå¯¼å‡ºç±»å‹ï¼šğŸ‘‡

- `asset/resource`
  - **åŠŸèƒ½**: å°†èµ„æºæ–‡ä»¶ä½œä¸º==å•ç‹¬çš„æ–‡ä»¶==è¾“å‡ºåˆ°è¾“å‡ºç›®å½•ï¼Œå¹¶è¿”å›è¯¥æ–‡ä»¶çš„ **URL**
  - **ç”Ÿæˆçš„äº§ç‰©å½¢å¼**: å•ç‹¬çš„æ–‡ä»¶ï¼Œè¾“å‡ºåˆ°æ„å»ºç›®å½•ä¸­
  - **å¦‚ä½•æ·»åŠ åˆ° bundle ä¸­**: ç”Ÿæˆä¸€ä¸ª **URL**ï¼ˆè·¯å¾„ï¼‰ï¼Œè¯¥ **URL** ä¼šè¢«åŒ…å«åœ¨ç”Ÿæˆçš„ **JavaScript** æˆ– **CSS** æ–‡ä»¶ä¸­

- `asset/inline`
  - **åŠŸèƒ½**: å°†èµ„æºæ–‡ä»¶ä½œä¸º **base64** ç¼–ç çš„å­—ç¬¦ä¸²==å†…è”==åˆ° **JavaScript** æ–‡ä»¶ä¸­
  - **ç”Ÿæˆçš„äº§ç‰©å½¢å¼**: å†…è”çš„ **base64** ç¼–ç å­—ç¬¦ä¸²
  - **å¦‚ä½•æ·»åŠ åˆ° bundle ä¸­**: èµ„æºå†…å®¹ä»¥ **base64** ç¼–ç çš„å½¢å¼ç›´æ¥åµŒå…¥åˆ°å¼•ç”¨å®ƒçš„æ¨¡å—ä¸­

- `asset/source`
  - **åŠŸèƒ½**: å°†èµ„æºæ–‡ä»¶çš„æºä»£ç ä½œä¸ºå­—ç¬¦ä¸²å¯¼å‡º
  - **ç”Ÿæˆçš„äº§ç‰©å½¢å¼**: èµ„æºæ–‡ä»¶çš„æºä»£ç å­—ç¬¦ä¸²
  - **å¦‚ä½•æ·»åŠ åˆ° bundle ä¸­**: èµ„æºå†…å®¹ä»¥å­—ç¬¦ä¸²çš„å½¢å¼==ç›´æ¥åµŒå…¥==åˆ°å¼•ç”¨å®ƒçš„æ¨¡å—ä¸­
- `asset`
  - **åŠŸèƒ½**: è‡ªåŠ¨é€‰æ‹©åœ¨ `resource` å’Œ `inline` ä¹‹é—´ï¼Œé»˜è®¤æƒ…å†µä¸‹å°äº 8kb çš„æ–‡ä»¶ä¼šä½œä¸º **base64** å†…è”ï¼Œå¦åˆ™ä½œä¸ºå•ç‹¬çš„æ–‡ä»¶è¾“å‡º
  - **ç”Ÿæˆçš„äº§ç‰©å½¢å¼**: å°æ–‡ä»¶ï¼ˆé»˜è®¤å°äº 8kbï¼‰å†…è”ï¼Œå¤§æ–‡ä»¶è¾“å‡ºä¸ºå•ç‹¬æ–‡ä»¶
  - **å¦‚ä½•æ·»åŠ åˆ° bundle ä¸­**: å°æ–‡ä»¶å†…è”ä¸º **base64**ï¼Œå¤§æ–‡ä»¶è¾“å‡ºä¸º **URL**

é…ç½®ç¤ºä¾‹ï¼š

```js
// webpack.config.js
module.exports = {
  module: {
    rules: [
     {
        test: /\.png$/, // ä¼šæŠŠpngå›¾ç‰‡è‡ªåŠ¨æ‹·è´åˆ°è¾“å‡ºç›®å½•ä¸­ï¼Œå¹¶è¿”å›æ–°è·¯å¾„æˆ–è€…è¯´åç§°
        type: 'asset/resource',
        generator: {
          filename: 'png/[hash][ext]'
        }
      },
      {
        test: /\.ico$/, // ä¼šæŠŠicoæ–‡ä»¶å˜æˆbase64å­—ç¬¦ä¸²å¹¶è¿”å›ç»™è°ƒç”¨è€…
        type: 'asset/inline'
      },
      {
        test: /\.txt$/, // ä¼šæŠŠtxtå†…å®¹ç›´æ¥è¿”å›
        type: 'asset/source'
      },
      {
        test: /\.svg$/,
        type: 'asset/resource'
      },
      {
        test: /\.jpg$/,
        type: 'asset', // è¡¨ç¤ºå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè‡ªé€‰æ‹©æ˜¯resourceè¿˜inline
        parser: {
          dataUrlCondition: {
            maxSize: 8 * 1024 
          }
        },
        generator: {
          filename: 'jpg/[hash][ext]'
        }
      }
    ],
  },
};
```

ä»¥`asset/resource`ä¸¾ä¾‹è¯´æ˜ä½¿ç”¨æ•ˆæœï¼š

<!--åœ¨Reactå·¥ç¨‹ä¸­ä¸å¤ªå®¹æ˜“çœ‹å‡ºèµ„æºæ–‡ä»¶æœ€ç»ˆæ˜¯å¦‚ä½•æ·»åŠ åˆ°bundleä¸­çš„ï¼Œæ‰€ä»¥ä¸‹é¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªç®€å•è¯´æ˜-->

å‡è®¾æœ‰ä¸€ä¸ªç®€å•çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š

```lua
project/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ logo.png
â”œâ”€â”€ dist/
â”‚   â””â”€â”€ (generated files will be here)
â”œâ”€â”€ package.json
â””â”€â”€ webpack.config.js
```

`webpack.config.js` å†…å®¹å¦‚ä¸‹ï¼š

```js
const path = require('path');

module.exports = {
// ...
  module: {
    rules: [
      {
        test: /\.(png|jpg|gif)$/i,
        type: 'asset/resource',
      },
    ],
  },
};
```

å…¥å£æ–‡ä»¶`src/index.js`å†…å®¹å¦‚ä¸‹ï¼š

```js
import logo from './logo.png';
const img = document.createElement('img');
img.src = logo; // è¿™é‡Œçš„ logo åé¢ä¼šå˜æˆ Webpack å¤„ç†åç”Ÿæˆçš„ URL
document.body.appendChild(img);
```

**Webpack** æ„å»ºå®Œæˆåï¼Œä¼šåœ¨ `dist` ç›®å½•ä¸‹ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

- `bundle.js`ï¼šåŒ…å«æ‰€æœ‰ **JavaScript** ä»£ç 
- `logo.png`ï¼šè¢«å•ç‹¬è¾“å‡ºçš„å›¾ç‰‡æ–‡ä»¶ï¼Œå¯èƒ½ä¼šè¢«é‡å‘½åä»¥åŒ…å«å“ˆå¸Œå€¼ï¼Œä¾‹å¦‚ `logo.123456.png`

åœ¨ `bundle.js` æ–‡ä»¶ä¸­ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„ä»£ç ï¼š<!--ç»è¿‡ç®€åŒ–å’Œæ ¼å¼åŒ–-->

```js
// ç”Ÿæˆçš„æ–‡ä»¶ URL è¢«ç›´æ¥åŒ…å«åœ¨ JavaScript ä»£ç ä¸­
var logo = __webpack_require__("./logo.png");
var img = document.createElement('img');
img.src = logo; // logo å˜é‡åŒ…å«ç”Ÿæˆçš„å›¾ç‰‡æ–‡ä»¶çš„ URL
document.body.appendChild(img);
```

 è¿™é‡Œï¼Œ`__webpack_require__("./logo.png")` ä¼šè¿”å›å›¾ç‰‡çš„ URLï¼Œä¾‹å¦‚ `/dist/logo.123456.png`

##### 3.1.2ã€ç¼©å° loader æŸ¥æ‰¾èŒƒå›´

é€šè¿‡ `include` å’Œ `exclude` å¯ä»¥é™åˆ¶ `loader` çš„åº”ç”¨èŒƒå›´ï¼Œé¿å…ä¸å¿…è¦çš„æ–‡ä»¶å¤„ç†ï¼Œä»è€Œæé«˜æ„å»ºé€Ÿåº¦

ä¾‹å¦‚ï¼š

- é¿å…å¯¹ `node_modules` ç›®å½•ä¸­çš„æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œå› ä¸ºè¿™äº›æ–‡ä»¶é€šå¸¸å·²ç»æ˜¯ç¼–è¯‘å¥½çš„ï¼Œä¸éœ€è¦å†æ¬¡å¤„ç†
- é¿å…å¯¹ç‰¹å®šçš„ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œè¿™äº›ç›®å½•æˆ–æ–‡ä»¶å¯èƒ½åŒ…å«å¤§å‹æ–‡ä»¶æˆ–ç¬¬ä¸‰æ–¹åº“ï¼Œä¸éœ€è¦è¿›è¡Œé¢å¤–çš„ç¼–è¯‘

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼š

```js
module.exports = {
  // ...
    module: {
        rules: [
            {
                test: /\.(ts|tsx)$/,
                exclude: /node_modules/,
                use: {
                    loader: 'babel-loader',
                },
            },
        ],
    },
  // ...
}
```

##### 3.1.3ã€ä½¿ç”¨ noParse è·³è¿‡æ¨¡å—è§£æ

`module.noParse` ç”¨äºå‘Šè¯‰ **Webpack** ä¸è¦è§£ææŸäº›æ¨¡å—ï¼Œæ¯”å¦‚é‚£äº›å·²ç»è¢«æ‰“åŒ…å¥½çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå› ä¸ºè¿™äº›æ–‡ä»¶æ²¡æœ‰ä¾èµ–å…³ç³»ä¸éœ€è¦è¿›è¡Œæ¨¡å—ä¾èµ–è§£æï¼Œè¿™æ ·å¯ä»¥æ˜¾è‘—æé«˜æ„å»ºé€Ÿåº¦

`module.noParse` ä¸»è¦ç”¨äºä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

1. **å¤§å‹ç¬¬ä¸‰æ–¹åº“**ï¼šå¦‚ **jQuery**ã€**Lodash** ç­‰ï¼Œè¿™äº›åº“é€šå¸¸å·²ç»è¢«æ‰“åŒ…å’Œå‹ç¼©è¿‡ï¼Œä¸éœ€è¦å†è¢« **Webpack** è§£æ
2. **æ‰“åŒ…å¥½çš„æ–‡ä»¶**ï¼šå¦‚å·²ç»è¢«ç¼–è¯‘å’Œæ‰“åŒ…çš„ **JavaScript** æ–‡ä»¶ï¼Œé€šå¸¸ä¹Ÿä¸éœ€è¦è§£æ

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼š

```js
module.exports = {
  module: {
    noParse: [
      /jquery|lodash/, // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… jQuery å’Œ Lodash
      path.resolve(__dirname, 'node_modules/some-lib/dist/some-lib.min.js'), // ä½¿ç”¨å­—ç¬¦ä¸²æŒ‡å®šå…·ä½“æ–‡ä»¶è·¯å¾„
    ],
  },
};

```

<!-- éœ€è¦æ³¨æ„âš ï¸çš„æ˜¯ï¼Œä½¿ç”¨ noParse è¿›è¡Œå¿½ç•¥çš„æ¨¡å—æ–‡ä»¶ä¸­ä¸èƒ½ä½¿ç”¨ importã€requireã€define ç­‰è¿›è¡Œä¾èµ–å¯¼å…¥ -->

#### 3.2ã€ä¼˜åŒ– resolveã€modules é…ç½®

**Webpack** çš„ [resolve](https://webpack.docschina.org/configuration/resolve/#root) é…ç½®é¡¹ç”¨äºè®¾ç½®æ¨¡å—è§£ææ–¹å¼ï¼Œå¯é€šè¿‡ä¼˜åŒ– `resolve` é…ç½®æ¥è¦†ç›–é»˜è®¤é…ç½®é¡¹ï¼Œå‡å°‘è§£æèŒƒå›´

##### 3.2.1ã€alias

`alias` å¯ä»¥åˆ›å»º `import` æˆ– `require` çš„åˆ«åï¼Œç”¨æ¥ç®€åŒ–æ¨¡å—å¼•å…¥

`webpack.common.js` é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š

```javascript
module.exports = {
    resolve: {
        alias: {
          '@': paths.appSrc, // @ ä»£è¡¨ src è·¯å¾„
        },
    }
}
```

##### 3.2.2ã€extensions

`extensions` è¡¨ç¤ºéœ€è¦è§£æçš„æ–‡ä»¶ç±»å‹åˆ—è¡¨

æ ¹æ®é¡¹ç›®ä¸­çš„æ–‡ä»¶ç±»å‹ï¼Œå®šä¹‰ `extensions`ï¼Œä»¥è¦†ç›– **Webpack** é»˜è®¤çš„ `extensions`ï¼ŒåŠ å¿«è§£æé€Ÿåº¦

ç”±äº **Webpack** çš„è§£æé¡ºåºæ˜¯ä»å·¦åˆ°å³ï¼Œå› æ­¤è¦å°†ä½¿ç”¨é¢‘ç‡é«˜çš„æ–‡ä»¶ç±»å‹æ”¾åœ¨å·¦ä¾§ï¼Œå¦‚ä¸‹å°† `tsx` æ”¾åœ¨æœ€å·¦ä¾§

`webpack.common.js` é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š

```javascript
module.exports = {
    resolve: {
        extensions: ['.tsx', '.js'],
    }
}
```

##### 3.2.3ã€symlinks

å¦‚æœé¡¹ç›®ä¸ä½¿ç”¨ `symlinks`ï¼ˆä¾‹å¦‚ `npm link` æˆ–è€… `yarn link`ï¼‰ï¼Œå¯ä»¥è®¾ç½® `resolve.symlinks: false`ï¼Œå‡å°‘è§£æå·¥ä½œé‡

`webpack.common.js` é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š

```javascript
module.exports = {
    resolve: {
        symlinks: false,
    },
}
```

##### 3.2.4ã€modules

`modules` è¡¨ç¤º **Webpack** è§£ææ¨¡å—æ—¶éœ€è¦è§£æçš„ç›®å½•

æŒ‡å®šç›®å½•å¯ç¼©å° **Webpack** è§£æèŒƒå›´ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦

`webpack.common.js` é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š

```javascript
module.exports = {
    modules: [
      'node_modules',
       paths.appSrc,
    ]
}
```

#### 3.3ã€å¤šè¿›ç¨‹æ‰“åŒ…

**Wepack** çš„ [thread-loader](https://webpack.docschina.org/loaders/thread-loader/#root) å¯ä»¥å°†éƒ¨åˆ† `loader` çš„å·¥ä½œè½¬ç§»åˆ°å­è¿›ç¨‹ä¸­ï¼Œä»è€ŒåŠ å¿«å¤„ç†é€Ÿåº¦ï¼Œé€‚ç”¨äºéœ€è¦å¤§é‡ **CPU** èµ„æºçš„ `loader`ï¼Œä¾‹å¦‚å¤„ç† **Babel**ã€**TypeScript** ç­‰

å®‰è£…ï¼š

```bash
npm install --save-dev thread-loader
```

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼š

```js
module.exports = smp.wrap({
  // ...
    module: {
        rules: [
            {
                test: /\.(ts|tsx)$/,
                exclude: /node_modules/,
                use: [
                    {
                        loader: 'babel-loader',
                    },
                    {
                        loader: 'thread-loader',
                        options: {
                            workers: 2, // å¼€å¯ä¸¤ä¸ª worker çº¿ç¨‹
                        },
                    },
                ],
            },
        ],
    },
  // ...
})

```

<!--éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯åŠ¨å­è¿›ç¨‹åŒæ ·éœ€è¦æ—¶é—´ï¼Œåªæœ‰å½“æŸä¸ª loader çš„è€—æ—¶æˆä¸º Webpack æ„å»ºé€Ÿåº¦çš„ç“¶é¢ˆæ—¶ï¼Œä½¿ç”¨ thread-loader æ‰æ˜¯æ¯”è¾ƒåˆé€‚çš„-->

#### 3.5ã€ç¼“å­˜æœºåˆ¶ ï¼ˆé‡ç‚¹â—ï¼‰

**Webpack** çš„ `cache` æœºåˆ¶é€šè¿‡ç¼“å­˜ç”Ÿæˆçš„ `webpack` æ¨¡å—å’Œ `chunk`ï¼Œæ¥æ”¹å–„æ„å»ºé€Ÿåº¦

**Webpack**  çš„ `cache` æœºåˆ¶åŒ…æ‹¬**==å†…å­˜ç¼“å­˜==**å’Œ**==æ–‡ä»¶ç³»ç»Ÿç¼“å­˜==**ä¸¤ç§ç±»å‹ï¼š

- å†…å­˜ç¼“å­˜æ˜¯åœ¨æ„å»ºè¿‡ç¨‹ä¸­å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ç¼“å­˜
- æ–‡ä»¶ç³»ç»Ÿæ˜¯ç¼“å­˜å¯åœ¨å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä»è€Œå®ç°æŒä¹…ç¼“å­˜

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼šåªéœ€æ·»åŠ  `cache` é…ç½®é¡¹ğŸ‘‡

```js
const path = require('path');

module.exports = {
  // ...
  cache: {
    type: 'filesystem', // ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜
    cacheDirectory: path.resolve(__dirname, 'node_modules/.cache/webpack'), // ç¼“å­˜ç›®å½•
    buildDependencies: {
      config: [__filename], // ä»¥å½“å‰é…ç½®æ–‡ä»¶ä½œä¸ºç¼“å­˜å¤±æ•ˆä¾èµ–
    },
    hashAlgorithm: 'md5', // ä½¿ç”¨ md5 å“ˆå¸Œç®—æ³•
    compression: false, // ä¸å¯ç”¨å‹ç¼©
    store: 'pack', // é»˜è®¤å­˜å‚¨æ–¹å¼
    managedPaths: ['node_modules'], // é»˜è®¤çš„ç®¡ç†è·¯å¾„
    immutablePaths: [], // é»˜è®¤çš„ä¸å¯å˜è·¯å¾„
  },
};

```

 `cache` é€‰é¡¹çš„é…ç½®å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼šğŸ‘‡

- `type`

  - **`memory`**: ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œé»˜è®¤é€‰é¡¹

  - **`filesystem`**: ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œé€‚ç”¨äºéœ€è¦è·¨æ„å»ºä¼šè¯æŒä¹…åŒ–ç¼“å­˜çš„åœºæ™¯

- `cacheDirectory`
  - æŒ‡å®šç¼“å­˜ç›®å½•ï¼Œä»…åœ¨ `filesystem` ç±»å‹ä¸‹æœ‰æ•ˆ
    - é»˜è®¤å€¼æ˜¯ `node_modules/.cache/webpack`

- `cacheLocation`
  - ä¸ `cacheDirectory` ç±»ä¼¼ï¼Œä½†å¯ä»¥æ›´çµæ´»åœ°æŒ‡å®šç¼“å­˜çš„è·¯å¾„ï¼ŒåŒ…æ‹¬æ–‡ä»¶å

- `hashAlgorithm`
  - ç”¨äºç”Ÿæˆç¼“å­˜æ–‡ä»¶åçš„å“ˆå¸Œç®—æ³•
    - é»˜è®¤æ˜¯ `md4`ï¼Œå¯ä»¥æ›´æ”¹ä¸ºä»»ä½•æ”¯æŒçš„å“ˆå¸Œç®—æ³•ï¼ˆå¦‚ `md5`, `sha256`ï¼‰

- `buildDependencies`
  - æŒ‡å®šå½±å“ç¼“å­˜å¤±æ•ˆçš„æ„å»ºä¾èµ–é¡¹ï¼Œé€šå¸¸ç”¨äºé…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ç­‰

- `managedPaths` å’Œ `immutablePaths`è¿™ä¸¤ä¸ªé€‰é¡¹ç”¨äºä¼˜åŒ–ç¼“å­˜ç®¡ç†ï¼š

  - `managedPaths`: æŒ‡å®šå“ªäº›è·¯å¾„ä¸‹çš„æ¨¡å—ä¸ä¼šè¢«ç¼“å­˜
    - é»˜è®¤å€¼æ˜¯ `['node_modules']`ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ç”±åŒ…ç®¡ç†å™¨ç®¡ç†çš„ï¼Œä¸ä¼šé¢‘ç¹å˜åŠ¨

  - `immutablePaths`: è¿™äº›è·¯å¾„ä¸‹çš„å†…å®¹è¢«è®¤ä¸ºæ˜¯ä¸å¯å˜çš„ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—

- `compression`
  - æ˜¯å¦å¯ç”¨ç¼“å­˜å‹ç¼©
    - å‹ç¼©å¯ä»¥å‡å°‘ç¼“å­˜æ–‡ä»¶çš„å¤§å°ï¼Œä½†ä¼šå¢åŠ å‹ç¼©å’Œè§£å‹ç¼©çš„å¼€é”€

- `store`
  - æŒ‡å®šå¦‚ä½•å­˜å‚¨ç¼“å­˜æ•°æ®
    - é»˜è®¤æ˜¯ `pack`ï¼Œå¯ä»¥æ”¹ä¸º `idle`ï¼ˆç©ºé—²æ—¶å­˜å‚¨ï¼‰ï¼Œä»¥å‡å°‘æ„å»ºæ—¶çš„å­˜å‚¨å¼€é”€

é…ç½®ç¼“å­˜ä¹‹åæ•ˆæœå¦‚ä¸‹ğŸ‘‡

![image-20240608223621371](https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20240608223621371.png)

å¯ä»¥å‘ç°é…ç½®ç¼“å­˜ä¹‹åçš„é¦–æ¬¡æ„å»ºæ—¶é—´ä¼šæ¯”ä¹‹å‰å¢åŠ  30% å·¦å³ï¼Œä½†æ˜¯äºŒæ¬¡æ„å»ºæ—¶æ—¶é—´å‡å°‘äº†50% 

<!--è¿™ä¸ªæ•°æ®æ˜¯åŸºäºä¹‹å‰åˆ›å»ºçš„ React å·¥ç¨‹ï¼Œæ¯ä¸ªå·¥ç¨‹çš„æ—¶é—´å‡å°‘ç¨‹åº¦ä¼šä¸ä¸€è‡´ï¼Œä½†æ˜¯ä¼šæ˜æ˜¾æ¯”ä¸é…ç½®ç¼“å­˜è¦å¿«å¾ˆå¤š-->

### å››ã€å‡å°æ–‡ä»¶ä½“ç§¯

#### 4.1ã€ä½¿ç”¨ CDN

> CDNç§°ä¹‹ä¸ºå†…å®¹åˆ†å‘ç½‘ç»œï¼ˆContent Delivery Networkæˆ–Content Distribution Networkï¼Œç¼©å†™ï¼šCDNï¼‰ï¼Œå®ƒæ˜¯æŒ‡é€šè¿‡ç›¸äº’è¿æ¥çš„ç½‘ç»œç³»ç»Ÿï¼Œåˆ©ç”¨æœ€é è¿‘æ¯ä¸ªç”¨æˆ·çš„æœåŠ¡å™¨ï¼Œ æ›´å¿«ã€æ›´å¯é åœ°å°†éŸ³ä¹ã€å›¾ç‰‡ã€è§†é¢‘ã€åº”ç”¨ç¨‹åºåŠå…¶ä»–æ–‡ä»¶å‘é€ç»™ç”¨æˆ·

åœ¨å·¥ç¨‹ä¸­è‹¥æ˜¯æƒ³ä½¿ç”¨ **CDN** æ¥åŠ è½½æŸäº›æ¨¡å—ï¼Œè€Œä¸æ˜¯å°†è¿™äº›æ¨¡å—æ‰“åŒ…åˆ°ä½ çš„ **bundle** ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `externals` é…ç½®æ¥è·³è¿‡è¿™äº›æ¨¡å—çš„è§£æï¼Œå¹¶é€šè¿‡ `HtmlWebpackPlugin` æ’ä»¶å°† **CDN** å¼•å…¥åˆ°æ‰“åŒ…äº§ç‰©ä¸­

`webpack.config.js` ä¸­çš„é…ç½®æ–¹å¼ï¼š

1. ä½¿ç”¨ `externals` é…ç½®

   - `externals` é…ç½®é¡¹å¯ä»¥å‘Šè¯‰ **Webpack** æŸäº›æ¨¡å—ä¸éœ€è¦æ‰“åŒ…ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶ä»å¤–éƒ¨ï¼ˆå¦‚ **CDN**ï¼‰è·å–

     > - `externals`ï¼šç”¨äºæŒ‡å®šå“ªäº›æ¨¡å—ä¸éœ€è¦è¢«æ‰“åŒ…ï¼Œè€Œæ˜¯ä»å¤–éƒ¨ç¯å¢ƒï¼ˆä¾‹å¦‚ **CDN**ï¼‰ä¸­è·å–
     >   - **Webpack** åœ¨æ„å»ºæ—¶ä¼šè·³è¿‡è¿™äº›æ¨¡å—ï¼Œå¹¶åœ¨**è¿è¡Œæ—¶**é€šè¿‡å…¨å±€å˜é‡ä»å¤–éƒ¨ç¯å¢ƒä¸­åŠ è½½å®ƒä»¬
     > - `noParse`ï¼šç”¨äºæŒ‡å®šå“ªäº›æ¨¡å—ä¸éœ€è¦è¿›è¡Œä¾èµ–è§£æ
     >   - **Webpack** åœ¨æ„å»ºæ—¶ä¼šå°†è¿™äº›æ¨¡å—è§†ä¸ºç‹¬ç«‹æ–‡ä»¶ï¼Œä»è€Œè·³è¿‡ä¾èµ–è§£æï¼Œä½†è¿™äº›æ¨¡å—ä»ç„¶ä¼šè¢«æ‰“åŒ…åˆ°æœ€ç»ˆçš„ **bundle** ä¸­

     ```js
     module.exports = {
       // ...
       externals: {
         // é”®æ˜¯æ¨¡å—åï¼Œå€¼æ˜¯å¤–éƒ¨å…¨å±€å˜é‡åï¼Œæ‰“åŒ…äº§ç‰©ä¼šåœ¨è¿è¡Œæ—¶ä»å…¨å±€å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯ windowï¼‰ä¸Šå–å€¼
         // ä¾‹å¦‚ï¼Œimport React from 'react' è¢«ç¼–è¯‘ä¹‹åä¼šé€šè¿‡ window.React è®¿é—® react æ¨¡å—
         'react': 'React',
         'react-dom': 'ReactDOM'
       }
     };
     ```

2. é€šè¿‡ `html-webpack-plugin` æ’ä»¶åœ¨ **HTML** ä¸­å¼•å…¥ **CDN** è„šæœ¬

   1. é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ¨¡æ¿ **HTML** æ–‡ä»¶ï¼ˆä¾‹å¦‚ `template.html`ï¼‰ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ª **script** æ ‡ç­¾æ¥å¼•å…¥ **CDN** ä¸Šçš„åº“ï¼Œä¾‹å¦‚ï¼š

   ```html
   <!DOCTYPE html>
   <html>
   <head>
     <title>My App</title>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
   </head>
   <body>
     <div id="app"></div>
   </body>
   </html>
   ```

   2. ç„¶åï¼Œåœ¨ `webpack.config.js` ä¸­ï¼Œé…ç½® `html-webpack-plugin` æ’ä»¶ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š

   ```javascript
   const HtmlWebpackPlugin = require('html-webpack-plugin');
   const path = require('path');
   
   module.exports = {
     // ...
     plugins: [
       new HtmlWebpackPlugin({
         template: path.resolve(__dirname, 'path/to/your/template.html'), // ä½¿ç”¨æ¨¡æ¿æ–‡ä»¶
       }),
     ],
   };
   ```

   è¿™æ ·é…ç½®åï¼Œ`html-webpack-plugin` æ’ä»¶å°±ä¼šæ ¹æ®æ¨¡æ¿æ–‡ä»¶ç”Ÿæˆ **HTML** æ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨å¼•å…¥ **Webpack** æ‰“åŒ…åçš„ **JS** å’Œ **CSS** æ–‡ä»¶ï¼ŒåŒæ—¶ä¹Ÿä¼šå¼•å…¥åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­æŒ‡å®šçš„ **CDN** åº“

#### 4.2ã€Tree Shakingï¼ˆæ‘‡æ ‘ä¼˜åŒ–ï¼‰

[Tree Shaking](https://webpack.docschina.org/guides/tree-shaking/) æ˜¯ä¸€ç§ç”¨äº**åˆ é™¤æœªä½¿ç”¨ä»£ç ï¼ˆDead Code**ï¼‰çš„æŠ€æœ¯ï¼Œä¸»è¦ç”¨äº **JavaScript** åº”ç”¨ç¨‹åºçš„æ‰“åŒ…å’Œä¼˜åŒ–ï¼Œå…¶ç›®æ ‡æ˜¯å‡å°‘æœ€ç»ˆè¾“å‡ºçš„æ–‡ä»¶ä½“ç§¯ï¼Œä»è€Œæå‡åŠ è½½é€Ÿåº¦å’Œæ‰§è¡Œæ€§èƒ½

**Tree Shaking** åå­—çš„çµæ„Ÿæ¥æºäºæ‘‡æ ‘çš„è¿‡ç¨‹ï¼Œé€šè¿‡æŠ–åŠ¨æ ‘æœ¨ï¼Œæœªé™„ç€çš„å¶å­ä¼šæ‰è½ï¼Œç•™ä¸‹é‚£äº›ç´§ç´§æŠ“ä½çš„å¶å­ï¼ŒåŒæ ·ï¼Œ**Tree Shaking** é€šè¿‡åˆ†æä»£ç ä¾èµ–å…³ç³»ï¼Œåˆ é™¤æœªè¢«ä½¿ç”¨çš„ä»£ç éƒ¨åˆ†

**Dead Code** ä¸€èˆ¬å…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š

- ä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œä¸å¯åˆ°è¾¾
- ä»£ç æ‰§è¡Œçš„ç»“æœä¸ä¼šè¢«ç”¨åˆ°
- ä»£ç åªä¼šå½±å“æ­»å˜é‡ï¼ˆåªå†™ä¸è¯»ï¼‰

åœ¨ **Webpack5** ä¸­ï¼Œ**Tree Shaking** æ˜¯é»˜è®¤åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹å¯ç”¨çš„ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼Œ**Webpack** ä¼šå‡è®¾æ‰€æœ‰æ¨¡å—éƒ½**å¯èƒ½æœ‰å‰¯ä½œç”¨**ï¼Œå› æ­¤ä¸ä¼šè½»æ˜“åœ°ç§»é™¤ä»»ä½•æ¨¡å—

å¯ä»¥é€šè¿‡åœ¨ `package.json` ä¸­é…ç½® `sideEffects` å­—æ®µï¼Œå‘Šè¯‰ **Webpack** å“ªäº›æ–‡ä»¶æˆ–æ¨¡å—æœ‰å‰¯ä½œç”¨çš„

> `package.json` ä¸­çš„ `sideEffects` å­—æ®µæ˜¯ **Webpack** ç”¨æ¥æ ‡è¯†å“ªäº›æ–‡ä»¶æˆ–æ¨¡å—æœ‰å‰¯ä½œç”¨çš„
>
> **å‰¯ä½œç”¨**æ˜¯æŒ‡æ–‡ä»¶åœ¨è¢«å¯¼å…¥æ—¶ï¼Œä¼šäº§ç”Ÿä¸€äº›å…¨å±€çš„å½±å“æˆ–ä¿®æ”¹å…¶ä»–æ¨¡å—æˆ–å…¨å±€çŠ¶æ€çš„è¡Œä¸º
>
> `sideEffects` å­—æ®µæœ‰åŠ©äº **Webpack** æ›´å¥½åœ°è¿›è¡Œ **Tree Shaking**ï¼Œä»è€Œåˆ é™¤æœªä½¿ç”¨çš„ä»£ç 

`sideEffects` çš„é…ç½®æ–¹å¼ï¼š

1. **`sideEffects: false`**

   å½“æ‰€æœ‰æ¨¡å—éƒ½æ²¡æœ‰å‰¯ä½œç”¨æ—¶ï¼Œå¯ä»¥å°† `sideEffects` è®¾ç½®ä¸º `false`ï¼Œè¿™æ„å‘³ç€æ•´ä¸ªå·¥ç¨‹ä¸­çš„æ‰€æœ‰æ¨¡å—éƒ½å¯ä»¥è¿›è¡Œ **Tree Shaking**

   ```json
   {
     "name": "your-project",
     "version": "1.0.0",
     "main": "index.js",
     "sideEffects": false
   }
   ```

2. **`sideEffects: true`**

   ä¸ç¡®å®šå“ªäº›æ¨¡å—æœ‰å‰¯ä½œç”¨æ—¶ï¼Œå¯ä»¥å°† `sideEffects` è®¾ç½®ä¸º `true`ï¼Œè¿™æ„å‘³ç€ **Webpack** ä¸ä¼šè¿›è¡Œä»»ä½•æ¨¡å—çš„ **Tree Shaking**

   ```json
   {
     "name": "your-project",
     "version": "1.0.0",
     "main": "index.js",
     "sideEffects": true
   }
   ```

3. **æŒ‡å®šæœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶**

   å½“å¤§å¤šæ•°æ¨¡å—æ²¡æœ‰å‰¯ä½œç”¨ï¼Œä½†æœ‰ä¸€äº›ç‰¹å®šçš„æ–‡ä»¶æœ‰å‰¯ä½œç”¨æ—¶ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„æ¥åˆ—å‡ºæœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶è·¯å¾„**Webpack** ä¼šå¯¹è¿™äº›åˆ—å‡ºçš„æ–‡ä»¶ä¿ç•™å¤„ç†ï¼Œè€Œå…¶ä»–æ²¡æœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶åˆ™ä¼šè¿›è¡Œ **Tree Shaking**

   ```json
   {
     "name": "your-project",
     "version": "1.0.0",
     "main": "index.js",
     "sideEffects": [
       "./src/someFileWithSideEffects.js",
       "./src/anotherFileWithSideEffects.css"
     ]
   }
   ```

#### 4.3ã€Code Splittingï¼ˆä»£ç åˆ†ç¦»ï¼‰

[SplitChunksPlugin](https://webpack.docschina.org/plugins/split-chunks-plugin) æ˜¯ **Webpack** å†…ç½®çš„æ’ä»¶ï¼Œç”¨äºä¼˜åŒ–å’Œåˆ†å‰²ä»£ç å—ï¼ˆ**chunks**ï¼‰ï¼Œå®ƒçš„ä¸»è¦ç›®çš„æ˜¯å°†å…¬å…±æ¨¡å—æå–åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œä»è€Œå‡å°‘ä»£ç çš„é‡å¤ï¼Œä¼˜åŒ–æµè§ˆå™¨ç¼“å­˜ï¼Œæå‡åŠ è½½æ€§èƒ½

**SplitChunksPlugin çš„ä½œç”¨**ï¼š

1. **å‡å°‘é‡å¤ä»£ç **ï¼šå°†åº”ç”¨ç¨‹åºä¸­å…±äº«çš„ä¾èµ–æå–åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œé¿å…é‡å¤åŠ è½½ç›¸åŒçš„æ¨¡å—
2. **æé«˜ç¼“å­˜æ•ˆç‡**ï¼šåˆ†ç¦»å‡ºçš„å…¬å…±æ¨¡å—å¯ä»¥è¢«æµè§ˆå™¨ç¼“å­˜ï¼Œä»è€Œåœ¨åç»­çš„é¡µé¢åŠ è½½ä¸­ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œå‡å°‘åŠ è½½æ—¶é—´
3. **ä¼˜åŒ–åŠ è½½é¡ºåº**ï¼šæŒ‰éœ€åŠ è½½ä»£ç å—ï¼Œå‡å°‘åˆå§‹åŠ è½½ä½“ç§¯ï¼Œæé«˜é¦–å±æ¸²æŸ“é€Ÿåº¦

**Wepack5** ä¸­`SplitChunksPlugin` æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåªä¼šå½±å“åˆ°**æŒ‰éœ€åŠ è½½**çš„ **chunks**

**SplitChunksPlugin çš„é…ç½®å‚æ•°**ï¼š

```js
module.exports = {
  optimization: {
    splitChunks: {
      chunks: 'async', // ä»…åˆ†å‰²å¼‚æ­¥åŠ è½½çš„ä»£ç å—
      minSize: 20000, // æ¨¡å—çš„æœ€å°å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚
      minRemainingSize: 0, // ç¡®ä¿æ‹†åˆ†åå—çš„æœ€å°å¤§å°
      minChunks: 1, // æ¨¡å—è¢«å¼•ç”¨çš„æœ€å°‘æ¬¡æ•°
      maxAsyncRequests: 30, // æŒ‰éœ€åŠ è½½æ—¶çš„æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°
      maxInitialRequests: 30, // å…¥å£ç‚¹çš„æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°
      enforceSizeThreshold: 50000, // å¼ºåˆ¶æ‰§è¡Œæ‹†åˆ†çš„å¤§å°é˜ˆå€¼
      cacheGroups: {
        defaultVendors: {
          test: /[\\/]node_modules[\\/]/, // åŒ¹é…ç¬¬ä¸‰æ–¹æ¨¡å—
          priority: -10, // ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
          reuseExistingChunk: true, // å…è®¸é‡ç”¨ç°æœ‰çš„ä»£ç å—
        },
        default: {
          minChunks: 2, // è‡³å°‘è¢«ä¸¤ä¸ªæ¨¡å—å¼•ç”¨æ‰ä¼šè¢«åˆ†å‰²
          priority: -20, // ä¼˜å…ˆçº§
          reuseExistingChunk: true, // å…è®¸é‡ç”¨ç°æœ‰çš„ä»£ç å—
        },
      },
    },
  },
};

```

**é…ç½®å‚æ•°è¯´æ˜**ï¼š

1. **chunks**ï¼šå†³å®šå“ªäº› **chunks** ä¼šè¢«é€‰ä¼˜åŒ–
   -  `'async'`ï¼šé»˜è®¤å€¼ï¼Œè¡¨ç¤ºåªå¯¹å¼‚æ­¥åŠ è½½çš„ **chunks** è¿›è¡Œä¼˜åŒ–
     - å¼‚æ­¥åŠ è½½çš„ **chunks** é€šå¸¸æ˜¯é‚£äº›é€šè¿‡åŠ¨æ€å¯¼å…¥`import()`åŠ è½½çš„ä»£ç å—
   -  `'initial'` ï¼šè¡¨ç¤ºåªå¯¹åŒæ­¥åŠ è½½çš„ **chunks** è¿›è¡Œä¼˜åŒ–
     - åŒæ­¥åŠ è½½çš„ **chunks** é€šå¸¸æ˜¯é‚£äº›åœ¨é¡µé¢åŠ è½½æ—¶å°±åŠ è½½çš„ä»£ç å—ï¼Œ
     - ä¾‹å¦‚é€šè¿‡`<script>`æ ‡ç­¾å¼•å…¥çš„ä»£ç å—
   -  `'all'`ï¼šè¡¨ç¤ºå¯¹æ‰€æœ‰çš„ **chunks** è¿›è¡Œä¼˜åŒ–ï¼Œæ— è®ºå®ƒä»¬æ˜¯åŒæ­¥åŠ è½½çš„è¿˜æ˜¯å¼‚æ­¥åŠ è½½çš„
2. **minSize**ï¼šå†³å®šäº†ç”Ÿæˆ **chunk** çš„æœ€å°ä½“ç§¯ï¼ˆä»¥`bytes`ä¸ºå•ä½ï¼‰
   - é»˜è®¤å€¼ä¸º `20000` å­—èŠ‚ï¼Œè¡¨ç¤ºåªæœ‰å½“ **chunk** çš„ä½“ç§¯å¤§äº 20KB æ—¶ï¼Œæ‰ä¼šè¢«æ‹†åˆ†
3. **minRemainingSize**ï¼šå†³å®šäº†ç”Ÿæˆ **chunk** æ‰€éœ€çš„ä¸» **chunk**ï¼ˆ**bundle**ï¼‰çš„æœ€å°ä½“ç§¯
   - é»˜è®¤å€¼ä¸º `0`
4. **minChunks**ï¼šå†³å®šäº†æ‹†åˆ†å‰å¿…é¡»å…±äº«æ¨¡å—çš„æœ€å° **chunks** æ•°
   - é»˜è®¤å€¼ä¸º `1`ï¼Œè¡¨ç¤ºåªæœ‰å½“ä¸€ä¸ªæ¨¡å—è¢«è‡³å°‘ä¸€ä¸ª **chunk** ä½¿ç”¨æ—¶ï¼Œæ‰ä¼šè¢«æ‹†åˆ†

#### 4.4ã€Code Minificationï¼ˆä»£ç å‹ç¼©ï¼‰

[TerserWebpackPlugin](https://webpack.docschina.org/plugins/terser-webpack-plugin/) æ˜¯ **Webpack5**  ä¸­å†…ç½®çš„ä¸€ä¸ªä»£ç å‹ç¼©æ’ä»¶ï¼Œå®ƒä½¿ç”¨ **Terser** æ¥å‹ç¼©å’Œæœ€å°åŒ–å·¥ç¨‹ä¸­çš„**JavaScript** ä»£ç ï¼Œç”Ÿäº§ç¯å¢ƒä¸­é»˜è®¤å¼€å¯

**TerserWebpackPlugin çš„é…ç½®å‚æ•°**ï¼š

```javascript
const TerserPlugin = require('terser-webpack-plugin');
module.exports = {
    optimization: {
        minimizer: [
            new TerserPlugin({
              test: /\\.js(\\?.*)?$/i, // åŒ¹é…æ–‡ä»¶çš„æµ‹è¯•æ¡ä»¶ï¼Œé»˜è®¤å€¼ä¸º/\\.m?js(\\?.*)?$/i
              include: /\\/includes/, // éœ€è¦åŒ…å«çš„æ–‡ä»¶
              exclude: /\\/excludes/, // éœ€è¦æ’é™¤çš„æ–‡ä»¶
              parallel: true, // æ˜¯å¦ä½¿ç”¨å¤šè¿›ç¨‹å¹¶è¡Œè¿è¡Œä»¥æé«˜æ„å»ºé€Ÿåº¦ã€‚é»˜è®¤å€¼ä¸ºtrue
              terserOptions: { // ä¼ é€’ç»™ Terser çš„å‹ç¼©é€‰é¡¹ï¼Œå¯ä»¥é…ç½®æ›´å¤š Terser çš„å‚æ•°
                compress: { // ç”¨äºé…ç½®ä»£ç å‹ç¼©çš„é€‰é¡¹
                  ecma: 5,
                  warnings: false,
                  comparisons: false,
                  inline: 2,
                },
                output: { // ç”¨äºé…ç½®è¾“å‡ºé€‰é¡¹
                  ecma: 5,
                  comments: false,
                  ascii_only: true,
                },
              },
            }),
        ]
    }
}
```

### äº”ã€æé«˜è¿è¡Œæ•ˆç‡

#### 5.1ã€æŒ‰éœ€åŠ è½½

é€šè¿‡ **Webpack** æä¾›çš„ [import() è¯­æ³•](https://webpack.docschina.org/api/module-methods/#import-1) åŠŸèƒ½è¿›è¡Œä»£ç åˆ†ç¦»ï¼Œé€šè¿‡æŒ‰éœ€åŠ è½½ï¼Œå¯ä»¥å¤§å¤§æå‡ç½‘é¡µåŠ è½½é€Ÿåº¦

ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```javascript
export default function App () {
    return (
        <div>
            hello react 111
            <Hello />
            <button onClick={() => import('lodash')}>åŠ è½½lodash</button>
        </div>
    )
}
```





