## k8s常用命令

### 一、Pod相关

- **获取 Pod 运行状态信息**

  ```bash
  kubectl get pod
  # or
  kubectl get pod <pod-name>
  ```

- **查看某个 Pod 的详细状态信息**

  ```shell
   kubectl describe pod <pod-name> 
  ```

- **查看某个 Pod 的配置信息**

  ```bash
  kubectl get pod <pod-name> -o yaml
  # -o yaml 以 YAML 格式输出 Pod 的配置信息
  # -o json 以 JSON 格式输出 Pod 的配置信息
  ```

- **删除 Pod**

  ```bash
  kubectl delete pod <pod-name> -n <namespace>
  ```

  - `<pod-name>`：要删除的 **Pod** 的名称

  - `-n <namespace>`：**Pod** 所在的命名空间，如果没有指定，默认是在 `default` 命名空间下操作

  > 如果 **Pod** 是由 `Deployment` 或其他控制器（如 `ReplicaSet`、`StatefulSet` 等）管理的，那么删除 **Pod** 后，控制器**会自动重新创建一个新的 Pod** 来保持期望的副本数量
  >
  > 如果 **Pod** 是独立创建的（没有控制器管理）**删除后它不会自动重建**

### 二、容器相关

- **进入某个 Pod 中的某个容器**

  ```bash
  kubectl exec -it <container-name> /bin/sh -c web
  ```

  - `kubectl exec`：这是 `kubectl` 的一个子命令，用于在 **Pod** 中执行命令

  - `-it`：这是两个参数的组合
    - `-i`表示**交互式**，意味着命令将与终端交互
    - `-t`表示**tty**，它会为命令分配一个伪终端，可以像在本地一样使用终端
    
  - `<container-name>`：这是要在其中执行命令的 **Pod** 名称

  - `/bin/sh`：要在 **Pod** 中运行的命令
    - 在这个例子中，表示正在启动一个 **shell**
    
  - `-c web`：这是传递给`/bin/sh`的参数，表示想要运行的容器的名称是 `web`

    <!--可以运行 kubectl describe pod <pod-name> 查看当前 pod 有哪些容器-->

- **退出容器**

  - 输入`exit`命令
  - 按下`Ctrl+D`

- **替换容器中的镜像**

  ```bash
  kubectl set image deployment/<deployment-name> <container-name>=<new-image>
  
  # eg.
  # kubectl set image deployment/guandata-web-deployment web=registry.cn-hangzhou.aliyuncs.com/guandata/guandata-web:xxx
  ```

  - `kubectl set image`：这是 `kubectl` 的一个子命令，用于更新资源的镜像

  - `deployment/<deployment-name>`：这是你想要更新镜像的部署的名称

    - `deployment/`前缀表示这是一个部署资源

      > 在 **Kubernetes** 中，**Deployment** 是一种资源对象，它描述了应用程序的运行方式（如使用哪个 **Docker** 镜像，端口号是多少等），以及如何更新和扩展应用程序
      >
      > **Deployment** 会管理 **Pod** 的生命周期，包括创建 **Pod**，更新 **Pod** 的镜像，扩展 **Pod** 的数量，以及在 **Pod** 出现故障时重新创建 **Pod**
      >
      > 如果想查看当前有哪些 **Deployment**，可以使用以下的`kubectl`命令
      >
      > ```bash
      > kubectl get deployments
      > ```

  - `<container-name>=<new-image>`：要设置的新镜像

    - `<container-name>`是容器的名称
    - `<new-image>`是新镜像的地址和标签

- 重启 **Pod** 某个容器中的 **Nginx**

  ```bash
  kubectl exec -it <pod-name> -c <container-name> -- nginx -s reload
  ```

  - `<pod-name>` 想要重启 **Nginx**  的 **Pod** 的名称

  - `<container-name>` 是运行 **Nginx** 的容器的名称

  - `nginx -s reload` 是在容器中执行的命令，用于重启 **Nginx**
### 三、配置文件相关

#### 3.1、直接编辑资源配置

使用 `kubectl edit` 命令来编辑资源的配置（包括 **Pod**、**Deployment** 等）

`kubectl edit` 会打开一个文本编辑器，允许直接修改资源的 **YAML** 文件

**示例**：

```bash
kubectl edit pod <pod-name> -n <namespace>
```

- `<pod-name>` 是要修改的 **Pod** 名称
- `<namespace>` 是 **Pod** 所在的命名空间

`kubectl edit` 会下载当前资源的配置并在默认编辑器中打开（通常是 `vim` 或 `nano`）修改完成后保存并退出，**Kubernetes** 会直接应用更改

<!--直接编辑 Pod 通常只用于调试或临时修改，因为 Pod 是不可变的，一旦修改或删除，Kubernetes 控制器（如 Deployment 或 StatefulSet）可能会重新创建该 Pod-->

#### 3.2、**修改并应用配置文件**

如果有 **YAML** 配置文件，可以在本地修改文件后，使用 `kubectl apply` 或 `kubectl replace` 命令应用更改

**步骤：**

1. **导出当前配置**（如果你还没有 **YAML** 文件）：

   ```bash
   kubectl get pod <pod-name> -n <namespace> -o yaml > pod-config.yaml
   ```

2. **在本地编辑 YAML 文件**： 打开 `pod-config.yaml` 文件并进行需要的修改

   ```bash
   vim /path/to/your/pod-config.yaml
   ```

3. **应用更改**

   - 如果编辑的是 **Pod** 控制器（如 **Deployment**、**StatefulSet**）的 **YAML** 文件：

     ```bash
     kubectl apply -f pod-config.yaml
     ```

   - 如果编辑的是单个 **Pod** 的 **YAML** 文件（一般不建议这样做）：

     ```bash
     kubectl replace -f pod-config.yaml
     ```

<!-- 适合临时调整或不需要长期持久性变更的情况 -->

#### 3.3、更新控制器资源

如果 **Pod** 是由控制器（如 **Deployment**）管理的，修改控制器的 **YAML** 文件是更推荐的方法，因为控制器会管理 **Pod** 的状态，并确保一致性

**步骤：**

1. **导出并编辑 Deployment 等控制器的 YAML 文件**

   ```bash
   kubectl get deployment <deployment-name> -n <namespace> -o yaml > deployment-config.yaml
   ```

2. **修改 YAML 文件中的配置**

   ```bash
   vim /path/to/your/deployment-config.yaml
   ```

3. **应用修改后的配置**

   ```bash
   kubectl apply -f deployment-config.yaml
   ```

<!--适合需要对所有相关资源做出一致性和持久性变更的情况-->

<!--如果有一个 Pod 是由 Deployment 管理的，而只修改了这个 Pod 的配置，不去修改 Deployment 的配置，Deployment 可能会重新创建 Pod 以符合它的期望状态，这就意味着修改可能会被覆盖。所以在这种情况下，修改 Deployment 这样控制器的配置才是正确的做法-->

#### 3.4、应用配置文件的命令

```bash
kubectl apply -f xxx.yaml
```

- `kubectl apply`：这是 `kubectl` 的一个子命令，用于应用配置文件，这个命令会根据配置文件中的定义创建或更新资源

- `-f xxx.yaml`：这是你想要应用的配置文件

  - `-f`表示文件
  - `xxx.yaml`是文件的路径

  <!--如果配置文件中的Pod定义与当前运行的Pod有所不同，Kubernetes会尝试更新Pod以匹配配置文件，这可能会导致Pod重启，但这取决于具体的更改内容和Kubernetes的更新策略-->
