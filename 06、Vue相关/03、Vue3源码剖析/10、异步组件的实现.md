## Vue3æºç å‰–æï¼ˆåï¼‰â€” å¼‚æ­¥ç»„ä»¶çš„å®ç°

### ä¸€ã€å¼‚æ­¥ç»„ä»¶çš„ä½¿ç”¨

> `defineAsyncComponent`å‡½æ•°æ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œä»–çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ…è£…ç»„ä»¶ã€‚æ­¤åŒ…è£…ç»„ä»¶ä¼šæ ¹æ®çŠ¶æ€æ¥å†³å®šæ¸²æŸ“çš„å†…å®¹ï¼ŒåŠ è½½æˆåŠŸåæ¸²æŸ“ç»„ä»¶ï¼Œåœ¨æœªæ¸²æŸ“æˆåŠŸæ—¶æ¸²æŸ“ä¸€ä¸ªå ä½ç¬¦èŠ‚ç‚¹

#### 1.1ã€`defineAsyncComponent`è¯­æ³•

```js
import { defineAsyncComponent } from 'vue'

const AsyncComp = defineAsyncComponent({
  // å·¥å‚å‡½æ•°
  loader: () => import('./Foo.vue'),
  // åŠ è½½å¼‚æ­¥ç»„ä»¶æ—¶è¦ä½¿ç”¨çš„ç»„ä»¶
  loadingComponent: LoadingComponent,
  // åŠ è½½å¤±è´¥æ—¶è¦ä½¿ç”¨çš„ç»„ä»¶
  errorComponent: ErrorComponent,
  // åœ¨æ˜¾ç¤º loadingComponent ä¹‹å‰çš„å»¶è¿Ÿ | é»˜è®¤å€¼ï¼š200ï¼ˆå•ä½ msï¼‰
  delay: 200,
  // å¦‚æœæä¾›äº† timeout ï¼Œå¹¶ä¸”åŠ è½½ç»„ä»¶çš„æ—¶é—´è¶…è¿‡äº†è®¾å®šå€¼ï¼Œå°†æ˜¾ç¤ºé”™è¯¯ç»„ä»¶
  // é»˜è®¤å€¼ï¼šInfinityï¼ˆå³æ°¸ä¸è¶…æ—¶ï¼Œå•ä½ msï¼‰
  timeout: 3000,
  // å®šä¹‰ç»„ä»¶æ˜¯å¦å¯æŒ‚èµ· | é»˜è®¤å€¼ï¼štrue
  suspensible: false,
  /**
   *
   * @param {*} error é”™è¯¯ä¿¡æ¯å¯¹è±¡
   * @param {*} retry ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæŒ‡ç¤ºå½“ promise åŠ è½½å™¨ reject æ—¶ï¼ŒåŠ è½½å™¨æ˜¯å¦åº”è¯¥é‡è¯•
   * @param {*} fail  ä¸€ä¸ªå‡½æ•°ï¼ŒæŒ‡ç¤ºåŠ è½½ç¨‹åºç»“æŸé€€å‡º
   * @param {*} attempts å…è®¸çš„æœ€å¤§é‡è¯•æ¬¡æ•°
   */
  onError(error, retry, fail, attempts) {
    if (error.message.match(/fetch/) && attempts <= 3) {
      // è¯·æ±‚å‘ç”Ÿé”™è¯¯æ—¶é‡è¯•ï¼Œæœ€å¤šå¯å°è¯• 3 æ¬¡
      retry()
    } else {
      // æ³¨æ„ï¼Œretry/fail å°±åƒ promise çš„ resolve/reject ä¸€æ ·ï¼š
      // å¿…é¡»è°ƒç”¨å…¶ä¸­ä¸€ä¸ªæ‰èƒ½ç»§ç»­é”™è¯¯å¤„ç†ã€‚
      fail()
    }
  }
})
```

#### 1.2ã€`defineAsyncComponent`ä½¿ç”¨

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="app"></div>
  <script src="../../../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js"></script>
  <script>
   const { render, h, defineAsyncComponent } = VueRuntimeDOM;
    
    let asyncComponent = defineAsyncComponent({
      loader: async () => {
        await new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve()
          }, 5000);
        })
        return import('./test.js').then((data) => {
          console.log('first', data)
          return data.default
        })
      },
      timeout: 5000,
      loadingComponent: {
        render: () => {
          return h('div', 'loadingä¸­ï½ï½ï½')
        }
      },
      onError(err, retry, fail) {
        // retry();
        fail()
      },
      errorComponent: {
        render: () => {
          return h('div', 'å‡ºé”™æ‹‰ï½ï½ï½')
        }
      }
    })

    render(h(asyncComponent), app)
  </script>
</body>

</html>
```

#### 1.3ã€å¼‚æ­¥ç»„ä»¶ä½¿ç”¨æ•ˆæœ

**åŠ è½½ä¸­**

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220625225652557.png" alt="image-20220625225652557" style="zoom:50%;" />

**åŠ è½½æˆåŠŸå**

<img src="https://raw.githubusercontent.com/wanglufei561/picture_repo/master/assets/image-20220625225752130.png" alt="image-20220625225752130" style="zoom:50%;" />

### äºŒã€å¼‚æ­¥ç»„ä»¶çš„å…·ä½“å®ç°

```typescript
// packages/runtime-core/src/apiAsyncComponent.ts

import { ref } from '@vue/reactivity';
import { Fragment } from './createVNode';
import { h } from './h';

/**
 * åˆ›å»ºå¼‚æ­¥ç»„ä»¶çš„æ–¹æ³•
 * defineAsyncComponentæ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªç»„ä»¶
 * æ­¤ç»„ä»¶ä¼šæ ¹æ®çŠ¶æ€æ¥å†³å®šæ¸²æŸ“çš„å†…å®¹ï¼Œ
 * åŠ è½½æˆåŠŸåæ¸²æŸ“ç»„ä»¶ï¼Œ
 * åœ¨æœªæ¸²æŸ“æˆåŠŸæ—¶æ¸²æŸ“ä¸€ä¸ªå ä½ç¬¦èŠ‚ç‚¹ï¼Œ
 * å¦å¤–è¿˜æœ‰é”™è¯¯æç¤ºç»„ä»¶å’Œloadingç»„ä»¶
 */
export function defineAsyncComponent(loaderOptions) {
  /**
   * è‹¥æ˜¯å…¥å‚æ˜¯ä¸€ä¸ªå‡½æ•°
   * åˆ™é»˜è®¤ä¸ºloaderOptions.loader
   */
  if (typeof loaderOptions == 'function') {
    loaderOptions = {
      loader: loaderOptions
    };
  }

  // è¦åŠ è½½çš„ç»„ä»¶ï¼Œé»˜è®¤å€¼ä¸ºnull
  let Component = null;

  return {
    setup() {
      const {
        loader, // å·¥å‚å‡½æ•°ï¼Œè¿”å›å€¼æ˜¯promiseï¼ˆå¼‚æ­¥åŠ è½½ç»„ä»¶çš„æ–¹æ³•ï¼‰
        timeout, // è¶…æ—¶æ—¶é—´ï¼Œè‹¥è¶…æ—¶åˆ™æ¸²æŸ“é”™è¯¯æç¤ºç»„ä»¶ï¼Œä¸è®¾ç½®åˆ™æ°¸ä¸è¶…æ—¶
        errorComponent, // é”™è¯¯æç¤ºç»„ä»¶
        delay, // åœ¨æ˜¾ç¤º loadingComponent ä¹‹å‰çš„å»¶è¿Ÿ
        loadingComponent, // åŠ è½½å¼‚æ­¥ç»„ä»¶æ—¶ä½¿ç”¨çš„ç»„ä»¶
        onError // åŠ è½½å¤±è´¥çš„å›è°ƒï¼Œå‚æ•° errï¼šé”™è¯¯ä¿¡æ¯ï¼›retryï¼šé‡æ–°åŠ è½½æ–¹æ³•ï¼›failï¼šç»“æŸåŠ è½½
      } = loaderOptions;

      const loaded = ref(false); // è¡¨ç¤ºæ˜¯å¦åŠ è½½æˆåŠŸï¼Œé»˜è®¤å€¼false
      const error = ref(false); // è¡¨ç¤ºæ˜¯å¦åŠ è½½å¤±è´¥ï¼Œé»˜è®¤å€¼false
      const loading = ref(false); // è¡¨ç¤ºæ˜¯å¦æ­£åœ¨åŠ è½½ä¸­ï¼Œé»˜è®¤å€¼false

      /**
       * è¶…æ—¶å¤„ç†
       * è¶…æ—¶ç›´æ¥å°†çŠ¶æ€ç½®ä¸ºåŠ è½½å¤±è´¥
       */
      if (timeout != null) {
        setTimeout(() => {
          error.value = true;
        }, timeout);
      }

      /**
       * å»¶è¿Ÿå¤„ç†
       * æœ‰å»¶è¿Ÿå€¼åˆ™å»¶è¿Ÿæ—¶é—´ä¹‹åå†æ˜¾ç¤ºloading
       * æ²¡æœ‰å»¶è¿Ÿå€¼åˆ™ç›´æ¥æ˜¾ç¤ºloading
       */
      if (delay) {
        setTimeout(() => {
          loading.value = true;
        }, delay);
      } else {
        loading.value = true;
      }

      /**
       * é€šè¿‡promiseé“¾æ¥å®ç°å……å®åŠ è½½
       */
      function load() {
        return loader().catch(err => {
          /**
           * åŠ è½½å¤±è´¥æ—¶
           * è‹¥æ˜¯æœ‰å¤±è´¥å›è°ƒ
           * åˆ™è¿”å›ä¸€ä¸ªPromise
           * è¿™ä¸ªpromiseçš„çŠ¶æ€å˜åŒ–ä¹‹å
           * åç»­çš„é“¾å¼æ“ä½œæ‰ä¼šè¿›è¡Œ
           */
          if (onError) {
            return new Promise((resolve, reject) => {
              // é‡è¯•æ–¹æ³•
              const retry = () => resolve(load());
              const fail = () => reject();
              onError(err, retry, fail);
            });
          } else {
            throw err;
          }
        });
      }

      load()
        .then(v => {
          loaded.value = true;
          Component = v;
        })
        .catch(err => {
          error.value = true;
        })
        .finally(() => {
          loading.value = false;
        });

      /**
       * setupä¸­è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯´æ˜å°±æ˜¯render
       * renderè¿”å›å€¼æ˜¯VNode
       */
      return () => {
        if (loaded.value) {
          /**
           * åªè¦loaded.value === true å°±è¯´æ˜å¼‚æ­¥ç»„ä»¶åŠ è½½æˆåŠŸ
           * ç›´æ¥æ¸²æŸ“å¼‚æ­¥ç»„ä»¶
           * ä¸èµ°ä¸‹é¢çš„é€»è¾‘äº†
           */
          return h(Component);
        } else if (error.value && errorComponent) {
          return h(errorComponent);
        } else if (loading.value && loadingComponent) {
          return h(loadingComponent);
        } else {
          // é»˜è®¤æ¸²æŸ“ä¸€ä¸ªFragment
          return h(Fragment, []);
        }
      };
    }
  };
}
```

**å¯¼å‡º`defineAsyncComponent`**

```typescript
// packages/runtime-core/src/index.ts
// ...

export { defineAsyncComponent } from './defineAsyncComponent';
```

ä¸Šé¢çš„ğŸ‘†å®ç°å…¶å®å¹¶ä¸éš¾ï¼Œå¼‚æ­¥ç»„ä»¶å…¶å®å°±æ˜¯ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œå°±æ˜¯å°†ç»„ä»¶åŒ…è£…ä¸€ä¸‹ï¼Œå¢åŠ äº›å¼‚æ­¥é€»è¾‘ï¼›ä¸Šé¢å®ç°ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„éƒ¨åˆ†æ˜¯

ç»´æŠ¤äº†ä¸‰ä¸ªå¼‚æ­¥ç»„ä»¶åŠ è½½çš„çŠ¶æ€ï¼Œè¿™ä¸‰ä¸ªçŠ¶æ€éƒ½æ˜¯å“åº”å¼çš„ï¼Œåªè¦çŠ¶æ€å˜åŒ–ï¼Œä¾¿ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼Œè¿™ä¸ªä¹Ÿæ˜¯`defineAsyncComponent`æ”¯æŒåŠ è½½ä¸­å±•ç¤ºç»„ä»¶ã€é”™è¯¯æç¤ºç»„ä»¶ã€é»˜è®¤å±•ç¤ºç»„ä»¶çš„åŸå› 

```js
const loaded = ref(false); // è¡¨ç¤ºæ˜¯å¦åŠ è½½æˆåŠŸï¼Œé»˜è®¤å€¼false
const error = ref(false); // è¡¨ç¤ºæ˜¯å¦åŠ è½½å¤±è´¥ï¼Œé»˜è®¤å€¼false
const loading = ref(false); // è¡¨ç¤ºæ˜¯å¦æ­£åœ¨åŠ è½½ä¸­ï¼Œé»˜è®¤å€¼false
```

`loader`æœ¬èº«å°±æ˜¯ä¼šè¿”å›ä¸€ä¸ª`promise`ï¼Œè¿™é‡Œå¯¹`promise`çŠ¶æ€çš„å˜æ¢è¿›è¡Œäº†å¤„ç†ï¼Œç”¨æ¥è¡¨å¾ç»„ä»¶çš„åŠ è½½çŠ¶æ€

```js
function load() {
  return loader().catch(err => {
    if (onError) {
      return new Promise((resolve, reject) => {
        // é‡è¯•æ–¹æ³•
        const retry = () => resolve(load());
        const fail = () => reject();
        onError(err, retry, fail);
      });
    } else {
      throw err;
    }
  });
}

load()
  .then(v => {
    loaded.value = true;
    Component = v;
  })
  .catch(err => {
    error.value = true;
  })
  .finally(() => {
    loading.value = false;
  });
```

