## CodeMirror6 ä¸­çš„æ ¸å¿ƒæ¦‚å¿µ

### ä¸€ã€Facet

**Facets** æ˜¯ **CodeMirror** çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œç”¨æ¥å¤„ç† **extension** ä¹‹é—´çš„ã€Œé…ç½®å…±äº«ã€å’Œã€Œè¡Œä¸ºæ§åˆ¶ã€ï¼›é€šè¿‡ **Facets**ï¼Œ**CodeMirror** èƒ½å¤Ÿä»¥ã€Œæ¨¡å—åŒ–ã€å’Œã€Œå£°æ˜å¼ã€çš„æ–¹å¼ç®¡ç†å¤æ‚çš„ç¼–è¾‘å™¨é…ç½®ï¼Œä½¿å…¶æ›´çµæ´»ã€æ›´æ˜“æ‰©å±•

- **Facets** çš„æ ¸å¿ƒç²¾é«“æ˜¯è§£å†³**å¤æ‚ç³»ç»Ÿä¸­æ‰©å±•ä¹‹é—´çš„ã€Œé…ç½®ç®¡ç†ã€å’Œã€Œè¡Œä¸ºåè°ƒã€é—®é¢˜**

- **CodeMirror** è¿™æ ·çš„ã€Œå¯æ‰©å±•ç³»ç»Ÿã€ä¸­ï¼Œä¸åŒçš„æ¨¡å—å’Œ **extension** éœ€è¦ã€Œå®šä¹‰é…ç½®ã€ã€ã€Œå…±äº«çŠ¶æ€ã€ã€ã€ŒåŠ¨æ€è°ƒæ•´è¡Œä¸ºã€ï¼Œ**Facets** çš„å‡ºç°æ˜¯ä¸ºäº†æä¾›ä¸€ç§**ç»Ÿä¸€çš„æœºåˆ¶**ï¼Œè®©è¿™äº›æ¨¡å—èƒ½å¤Ÿä»¥**è§£è€¦çš„æ–¹å¼åä½œ**

  <!-- ç®€å•ç†è§£ Facet å°±æ˜¯ä¸€ä¸ªæ”¶é›†æ•°æ®çš„å®¹å™¨-->

**ä¸ºä»€ä¹ˆéœ€è¦ Facetsï¼Ÿ**

1. **æ¨¡å—åŒ–çš„éœ€æ±‚**ï¼šæ¯ä¸ªæ‰©å±•æˆ–æ’ä»¶éƒ½å¯èƒ½å®šä¹‰è‡ªå·±çš„åŠŸèƒ½ï¼Œå®ƒä»¬éœ€è¦ä¸€ç§æ–¹å¼ä¸ç¼–è¾‘å™¨æ ¸å¿ƒå’Œå…¶ä»–æ‰©å±•**å…±äº«ä¿¡æ¯**
   - ä¾‹ï¼šä¸€ä¸ªæ’ä»¶æä¾›ä¸»é¢˜æ ·å¼ï¼Œå¦ä¸€ä¸ªæ’ä»¶éœ€è¦çŸ¥é“å½“å‰ä¸»é¢˜
2. **é¿å…ç¡¬ç¼–ç å’Œè€¦åˆ**ï¼šå¦‚æœç›´æ¥é€šè¿‡å…¨å±€å˜é‡æˆ–å›ºå®šçš„ **API** ç®¡ç†è¿™äº›é…ç½®ï¼Œä¼šå¯¼è‡´æ¨¡å—é—´çš„å¼ºè€¦åˆï¼Œéš¾ä»¥ç»´æŠ¤å’Œæ‰©å±•
3. **åŠ¨æ€æ€§**ï¼šæ‰©å±•å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶è¢«æ·»åŠ ã€ç§»é™¤ï¼Œé…ç½®éœ€è¦åŠ¨æ€æ›´æ–°ï¼Œè€Œä¸æ˜¯å†™æ­»åœ¨ä»£ç ä¸­
4. **ç»Ÿä¸€çš„æ•°æ®æµ**ï¼š**Facets** æä¾›äº†ä¸€ç§å£°æ˜å¼çš„æ–¹å¼ï¼Œç¡®ä¿å¤šä¸ªæ¥æºçš„é…ç½®èƒ½ä»¥æ¸…æ™°ã€ä¸€è‡´çš„è§„åˆ™åˆå¹¶å’Œä½¿ç”¨

**Facets çš„æ ¸å¿ƒä½œç”¨**

- **Facets** æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**â€œåŠ¨æ€çš„é…ç½®æ€»çº¿â€**ï¼Œå®ƒæŠŠæ¥è‡ªä¸åŒæ¨¡å—çš„é…ç½®æ±‡æ€»æˆä¸€ä¸ª**å¯ç”¨çš„ç»Ÿä¸€è§†å›¾**ï¼Œå¹¶æ ¹æ®æ‰©å±•çš„å˜åŒ–åŠ¨æ€æ›´æ–°

- æ¢å¥è¯è¯´ï¼š**Facets** æ˜¯ç¼–è¾‘å™¨çš„â€œç¥ç»ç³»ç»Ÿâ€ï¼Œå¸®åŠ©æ‰©å±•æ¨¡å—åƒâ€œå™¨å®˜â€ä¸€æ ·ç‹¬ç«‹å·¥ä½œï¼Œä½†åˆèƒ½ååŒå‘æŒ¥ä½œç”¨

- å¦‚æœæ²¡æœ‰ **Facets**ï¼Œç¼–è¾‘å™¨å°†å¾ˆéš¾åœ¨æ¨¡å—åŒ–å’ŒåŠ¨æ€æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡

**Facets** çš„æ ¸å¿ƒä»·å€¼åœ¨äºå®ƒè§£å†³äº†æ‰©å±•ä¹‹é—´**ä¿¡æ¯æµåŠ¨çš„å¤æ‚æ€§**ï¼Œä»¥æ¨¡å—åŒ–ã€åŠ¨æ€åŒ–ã€å£°æ˜å¼çš„æ–¹å¼ï¼Œè®©æ•´ä¸ªç³»ç»Ÿæ›´çµæ´»ã€æ›´æ˜“æ‰©å±•

ç¤ºä¾‹ï¼šé€šè¿‡ `Facet` æ¥æ§åˆ¶è¡Œé«˜ğŸ‘‡

```tsx
import { Facet } from "@codemirror/state";

// åˆ›å»ºä¸€ä¸ªæ§åˆ¶è¡Œé«˜çš„ Facet
const lineHeightFacet = Facet.define({
  // åˆå¹¶å¤šä¸ªæ‰©å±•çš„è¡Œé«˜å€¼ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå€¼ï¼ˆæˆ–è€…æ ¹æ®éœ€æ±‚å¯ä»¥åšåˆå¹¶ï¼‰
  combine(values) {
    return values.length > 0 ? values[0] : 20; // é»˜è®¤è¡Œé«˜ä¸º 20px
  }
});
```

- **`combine(values)`**:

  - ä¸€ä¸ªåˆå¹¶å‡½æ•°ï¼Œç”¨æ¥å¤„ç† **Facet** ä¸­å­˜å‚¨çš„å¤šä¸ªå€¼
    - `values` æ˜¯æ‰€æœ‰è®¾ç½®æ­¤ **Facet** å€¼çš„æ‰©å±•ä¸­çš„å€¼çš„æ•°ç»„
    - åˆå¹¶å‡½æ•°å°†è¿™äº›å€¼åˆå¹¶ä¸ºä¸€ä¸ªæœ€ç»ˆçš„å€¼ï¼Œè¿™ä¸ªå€¼å°†è¢«ç¼–è¾‘å™¨ä½¿ç”¨
  - é»˜è®¤è¡Œä¸ºï¼šå¦‚æœæ²¡æœ‰æä¾› `combine` å‡½æ•°ï¼Œ**CodeMirror** ä¼šä½¿ç”¨é»˜è®¤çš„è¡Œä¸º
    - å¯¹äºå¤§å¤šæ•° **Facet**ï¼Œå®ƒä¼šè¿”å›å€¼æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå€¼

  **ç¤ºä¾‹**ï¼šå¯ä»¥åœ¨å¤šä¸ªæ‰©å±•ä¸­è®¾ç½®åŒä¸€ä¸ª **Facet**ï¼Œ`combine` å‡½æ•°ä¼šå†³å®šå¦‚ä½•åˆå¹¶è¿™äº›å€¼

  - ä¾‹å¦‚ï¼Œå¤šä¸ªæ‰©å±•å¯èƒ½ä¼šè®¾ç½®ä¸åŒçš„ä¸»é¢˜é¢œè‰²ï¼Œ`combine` å‡½æ•°å¯ä»¥è¿”å›ä¸€ä¸ªæœ€ç»ˆçš„é¢œè‰²å€¼

<!--Facet æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥æ¥å—å¤šä¸ªæ‰©å±•æä¾›çš„å€¼ï¼Œè¿™äº›å€¼ä¼šè¢«èšåˆåœ¨ä¸€èµ·-->

```tsx
import { EditorState, EditorView } from "@codemirror/view";

// åˆ›å»ºä¸€ä¸ªæ‰©å±•æ¥å°†è¡Œé«˜åº”ç”¨åˆ°æ ·å¼
const lineHeightExtension = (lineHeight) => {
  return EditorView.theme({
    "&": {
      lineHeight: `${lineHeight}px`, // ä½¿ç”¨ `Facet` çš„å€¼æ¥è®¾ç½®è¡Œé«˜
    },
  });
};

// åˆ›å»ºä¸€ä¸ªç¼–è¾‘å™¨çŠ¶æ€å¹¶ä½¿ç”¨è¿™ä¸ª Facet
const state = EditorState.create({
  extensions: [
    lineHeightFacet.of(24), // ç›´æ¥æä¾›ä¸€ä¸ªé™æ€å€¼ï¼Œè¡Œé«˜ä¸º 24px
    lineHeightFacet.compute(["doc"], state => state.doc.lines), // å½“æ–‡æ¡£å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒåŠ¨æ€è®¡ç®—ä¸€ä¸ªå€¼
    lineHeightExtension(state.facet(lineHeightFacet)), // å°† Facet ä¸­çš„è¡Œé«˜åº”ç”¨åˆ°è§†å›¾ä¸­
  ],
});


// åˆ›å»ºç¼–è¾‘å™¨è§†å›¾å¹¶åº”ç”¨æ‰©å±•
const view = new EditorView({
  state,
  parent: document.querySelector("#editor"),
});
```

### äºŒã€StateField

**StateField** æ˜¯ **CodeMirror** ä¸­ç”¨äºå­˜å‚¨ **EditorState** ä¹‹å¤–çš„ä¿¡æ¯ï¼Œè®¸å¤š **Extension**ï¼ˆä¾‹å¦‚æ’¤é”€å†å²ã€ä»£ç æŠ˜å ç­‰ï¼‰éœ€è¦åœ¨çŠ¶æ€ä¸­ä¿å­˜æŸäº›æ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®é€šå¸¸**ä¸ç¼–è¾‘å™¨çš„æ–‡æ¡£å†…å®¹æ— å…³**ï¼Œä½†åˆ**ä¸ç¼–è¾‘å™¨çš„è¡Œä¸ºæˆ–çŠ¶æ€å¯†åˆ‡ç›¸å…³**ï¼Œ**StateField** å°±æ˜¯ç”¨æ¥å­˜å‚¨è¿™ç§ä¿¡æ¯çš„

**StateField çš„ä½œç”¨ï¼š**

1. **å­˜å‚¨ä¸å¯å˜çš„æ•°æ®**ï¼š**StateField** ç”¨äºå­˜å‚¨ç¼–è¾‘å™¨çŠ¶æ€ä¸­çš„é¢å¤–æ•°æ®
   - è¿™äº›æ•°æ®å¿…é¡»æ˜¯ä¸å¯å˜çš„ï¼Œå³ä¸€æ—¦åˆ›å»ºï¼Œå®ƒä»¬çš„å€¼ä¸èƒ½ç›´æ¥æ”¹å˜
   - æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶ï¼Œéƒ½ä¼šé€šè¿‡ç±»ä¼¼ `reducer` çš„æ–¹å¼æ¥è®¡ç®—æ–°çš„å­—æ®µå€¼
2. **ä¸ç¼–è¾‘å™¨çŠ¶æ€åŒæ­¥**ï¼šæ¯å½“ç¼–è¾‘å™¨çŠ¶æ€ï¼ˆ**EditorState**ï¼‰æ›´æ–°æ—¶ï¼Œ**StateField** ä¼šä¸å…¶ä»–çŠ¶æ€å­—æ®µä¿æŒåŒæ­¥
   - æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªæ›´æ–°å‡½æ•°ï¼Œå®ƒæ¥æ”¶å½“å‰çš„å­—æ®µå€¼å’Œäº‹åŠ¡ï¼ˆ`transaction`ï¼‰å¹¶è¿”å›æ–°çš„å­—æ®µå€¼
3. **æ”¯æŒæ‰©å±•å­˜å‚¨æ•°æ®**ï¼šä¸åŒçš„æ‰©å±•éœ€è¦åœ¨ç¼–è¾‘å™¨çš„çŠ¶æ€ä¸­å­˜å‚¨é¢å¤–çš„æ•°æ®
   - ä¾‹å¦‚ï¼Œæ’¤é”€å†å²ï¼ˆ**undo history**ï¼‰éœ€è¦å­˜å‚¨æ’¤é”€çš„å˜åŒ–ï¼Œä»£ç æŠ˜å éœ€è¦è®°å½•å“ªäº›åŒºåŸŸè¢«æŠ˜å ç­‰
   - **StateField** æä¾›äº†ä¸€ç§ç®¡ç†å’Œæ›´æ–°è¿™äº›æ•°æ®çš„æœºåˆ¶

**è¯­æ³•ï¼š**

åˆ›å»ºä¸€ä¸ª **StateField** æ—¶ï¼Œé€šå¸¸éœ€è¦æä¾›ä»¥ä¸‹é…ç½®é¡¹ï¼š

- **`create`**: å®šä¹‰è¯¥å­—æ®µçš„åˆå§‹å€¼
- **`update`**: å®šä¹‰å¦‚ä½•åœ¨çŠ¶æ€æ›´æ–°æ—¶æ ¹æ®äº‹åŠ¡ï¼ˆ`transaction`ï¼‰æ›´æ–°è¯¥å­—æ®µçš„å€¼
  - `transaction ` ä¸ŠåŒ…å«ä»¥ä¸‹å±æ€§
    - `docChanged`ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ–‡æ¡£æ˜¯å¦è¢«æ­¤äº‹åŠ¡æ›´æ”¹
    - `newDoc`ï¼šäº‹åŠ¡åçš„æ–‡æ¡£æ–°çŠ¶æ€
    - `changes`ï¼šæè¿°å¯¹æ–‡æ¡£æ‰€åšæ›´æ”¹çš„å¯¹è±¡
    - `annotations`ï¼šå…³äºäº‹åŠ¡çš„é™„åŠ å…ƒæ•°æ®æˆ–ä¿¡æ¯
    - `effects`ï¼šäº‹åŠ¡ä¸­é™„åŠ çš„å‰¯ä½œç”¨
    - `selection`ï¼šäº‹åŠ¡åçš„æ–°é€‰æ‹©çŠ¶æ€


ç¤ºä¾‹ï¼šğŸ‘‡

```javascript
import { StateField } from "@codemirror/state";

// å®šä¹‰ä¸€ä¸ªæ–°çš„ StateField
const counterField = StateField.define({
  // è®¾ç½®å­—æ®µçš„åˆå§‹å€¼
  create() {
    return 0; // åˆå§‹å€¼ä¸º 0
  },

  // æ›´æ–°å­—æ®µçš„å€¼
  update(value, transaction) {
    // æ¯å½“æ–‡æ¡£å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬åœ¨æ­¤ç®€å•åœ°å°†å­—æ®µå€¼åŠ 1
    if (transaction.docChanged) {
      return value + 1;
    }
    return value;
  },
});
```

**ä½¿ç”¨ StateFieldï¼š**ğŸ‘‡

åˆ›å»ºå¥½ **StateField** åï¼Œå¯ä»¥å°†å®ƒæ·»åŠ åˆ° **EditorState** çš„ **extensions** ä¸­ï¼Œé€šè¿‡ `EditorState.field` æ–¹æ³•ï¼Œå¯ä»¥è®¿é—®å½“å‰å­—æ®µçš„å€¼

```javascript
import { EditorState, EditorView } from "@codemirror/basic-setup";
import { counterField } from "./counterField"; // å‡è®¾ä¸Šé¢å®šä¹‰äº† counterField

// åˆ›å»º EditorState
const state = EditorState.create({
  doc: "Hello, world!",
  extensions: [counterField] // æ·»åŠ è‡ªå®šä¹‰çš„ StateField
});

// åˆ›å»º EditorView
const view = new EditorView({
  state,
  parent: document.querySelector("#editor")
});

// è·å–å¹¶è®¿é—® StateField çš„å€¼
console.log(view.state.field(counterField)); // è¾“å‡ºå½“å‰å­—æ®µå€¼
```

**æ›´æ–°å’Œè®¿é—® StateFieldï¼š**ğŸ‘‡

å½“çŠ¶æ€æ›´æ–°æ—¶ï¼Œ**StateField** ä¼šæ ¹æ®äº‹åŠ¡æ›´æ–°å…¶å€¼

```javascript
// è·å–å½“å‰å­—æ®µçš„å€¼
const currentCount = view.state.field(counterField);
console.log("å½“å‰è®¡æ•°: ", currentCount);
```

### ä¸‰ã€StateEffect

åœ¨ **CodeMirror** ä¸­ï¼Œ**StateEffect** æ˜¯ä¸€ä¸ªç”¨äºè¡¨ç¤ºä¸äº‹åŠ¡ï¼ˆ`transaction`ï¼‰ç›¸å…³çš„ã€Œå‰¯ä½œç”¨ã€çš„æœºåˆ¶ï¼Œé€šå¸¸ä¸ç¼–è¾‘å™¨çŠ¶æ€ç›¸å…³çš„ä¿®æ”¹ç»“åˆä½¿ç”¨ï¼Œ**StateEffect** å…è®¸å¯¹ç¼–è¾‘å™¨çš„çŠ¶æ€è¿›è¡Œã€Œç»†ç²’åº¦ã€çš„æ§åˆ¶å’Œä¿®æ”¹

#### 3.1ã€StateEffect ä¸ StateField ç»“åˆä½¿ç”¨

**StateEffect çš„ä½œç”¨ï¼š**

- **StateEffect** ä¸»è¦ç”¨äºåœ¨ç¼–è¾‘å™¨çš„çŠ¶æ€ä¸­äº§ç”Ÿã€Œå‰¯ä½œç”¨ã€ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ **StateField** ä¸­å­˜å‚¨çš„è‡ªå®šä¹‰å­—æ®µè¿›è¡Œæ›´æ–°
- åœ¨ **CodeMirror** çš„äº‹åŠ¡ï¼ˆ`transaction`ï¼‰ä¸­ï¼Œ**StateEffect** å¯ä»¥ä½œä¸ºã€Œå‰¯ä½œç”¨ã€å­˜åœ¨ï¼Œå®ƒä»¬å¯ä»¥å¸®åŠ©è¡¨è¾¾çŠ¶æ€å˜åŒ–ï¼Œè€Œè¿™äº›å˜åŒ–å¹¶ä¸æ˜¯ç›´æ¥ç”±æ–‡æ¡£å†…å®¹æˆ–é€‰æ‹©ä½ç½®å¼•èµ·çš„
-  **StateEffect** å¯ä»¥åœ¨äº‹åŠ¡ï¼ˆ`transaction`ï¼‰ä¸­ä¼ é€’é¢å¤–çš„ã€ŒæŒ‡ä»¤ã€æˆ–ã€Œæ•°æ®ã€ï¼Œè¿›è€Œå½±å“ç¼–è¾‘å™¨çš„çŠ¶æ€

**`StateEffect` çš„ä½¿ç”¨æµç¨‹ï¼š**

1. **åˆ›å»º StateEffect**: ä½¿ç”¨ `StateEffect.define` å®šä¹‰ä¸€ä¸ª **StateEffect**ï¼Œè¿™ä¸ª **StateEffect** é€šå¸¸ä¼šæºå¸¦ä¸€äº›å€¼
2. **åœ¨äº‹åŠ¡ä¸­é™„åŠ  StateEffect**: åœ¨éœ€è¦çš„åœ°æ–¹ï¼ˆä¾‹å¦‚ç¼–è¾‘å™¨æ“ä½œä¸­ï¼‰ï¼Œå°† **StateEffect** é€šè¿‡ **effects** å±æ€§é™„åŠ åˆ°äº‹åŠ¡ï¼ˆ`transaction`ï¼‰ä¸­
3. **åœ¨ StateField æ›´æ–°ä¸­å¤„ç† StateEffect**: åœ¨ **StateField** çš„ `update` å‡½æ•°ä¸­ï¼Œæ£€æŸ¥äº‹åŠ¡ä¸­æ˜¯å¦åŒ…å«ç‰¹å®šçš„ **StateEffect**ï¼Œå¹¶æ®æ­¤æ›´æ–°çŠ¶æ€å­—æ®µçš„å€¼

**åˆ›å»º StateEffectï¼š**ğŸ‘‡

```javascript
import { StateEffect } from "@codemirror/state";

// å®šä¹‰ä¸€ä¸ªæ–°çš„ StateEffectï¼Œç”¨äºå¢åŠ è®¡æ•°å™¨å€¼
const incrementCounterEffect = StateEffect.define<{num: number, pos:number}>({
  map: (value, mapping) => {
    // ä½¿ç”¨ mapping.mapPos æ¥è°ƒæ•´æ•ˆæœçš„ä½ç½®
    return { ...value, pos: mapping.mapPos(value.pos) };
  }
});

```

è¯­æ³•ï¼š `StateEffect.define(spec?)`

- `spec`
  - `map`?:  `fn(value, mapping)`
    - `value`: `StateEffect` æ‰€ä¿å­˜çš„æ›´æ–°å€¼
    - `mapping`ï¼šä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºå¤„ç†æ–‡æ¡£æ›´æ”¹æ—¶çš„ä½ç½®æ˜ å°„
      - å½“æ–‡æ¡£å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œæ–‡æœ¬çš„æ’å…¥æˆ–åˆ é™¤ä¼šå¯¼è‡´æ–‡æœ¬ä½ç½®çš„åç§»ï¼Œ`mapping` æä¾›äº†ä¸€ç§æœºåˆ¶æ¥æ›´æ–°æ•ˆæœçš„ä½ç½®ï¼Œä½¿å…¶åœ¨æ–‡æ¡£æ›´æ”¹åä»ç„¶æŒ‡å‘æ­£ç¡®çš„ä½ç½®
      - `mapping.mapPos(pos)`: å°†ç»™å®šçš„æ–‡æ¡£ä½ç½® `pos` æ˜ å°„åˆ°**æ›´æ”¹åçš„æ–‡æ¡£ä¸­å¯¹åº”çš„ä½ç½®**ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œç”¨äºè°ƒæ•´æ•ˆæœçš„ä½ç½®

------

**å°† StateEffect é™„åŠ åˆ°äº‹åŠ¡ä¸­ï¼š**ğŸ‘‡

å½“æƒ³è¦åœ¨æŸæ¬¡ç¼–è¾‘å™¨æ“ä½œä¸­è§¦å‘ **StateEffect** æ—¶ï¼Œéœ€è¦é€šè¿‡äº‹åŠ¡æ¥é™„åŠ è¯¥æ•ˆæœï¼Œé€šå¸¸ä¼šåœ¨æŸä¸ªäº‹ä»¶ä¸­è§¦å‘æ•ˆæœï¼Œå¹¶æ›´æ–°çŠ¶æ€

```javascript
import { EditorState, StateField } from '@codemirror/state'
import { EditorView } from '@codemirror/view'

// å®šä¹‰ä¸€ä¸ª StateField æ¥è·Ÿè¸ªè®¡æ•°å™¨å€¼
const counterField = StateField.define({
  create() {
    return 0; // åˆå§‹å€¼ä¸º 0
  },

  update(value, transaction) {
    // å¦‚æœäº‹åŠ¡ä¸­åŒ…å« incrementCounterEffectï¼Œæˆ‘ä»¬å°±å¢åŠ è®¡æ•°å™¨å€¼
    for (let effect of transaction.effects) {
      if (effect.is(incrementCounterEffect)) {
        return value + effect.num; // æ¯æ¬¡é‡åˆ°è¿™ä¸ª effectï¼Œè®¡æ•°å™¨å¢åŠ  1
      }
    }
    return value;
  },

  name: "counterField"
});

// åˆ›å»ºç¼–è¾‘å™¨çŠ¶æ€
const state = EditorState.create({
  doc: "Hello, world!",
  extensions: [counterField] // åŠ å…¥ counterField
});

// åˆ›å»ºç¼–è¾‘å™¨è§†å›¾
const view = new EditorView({
  state,
  parent: document.querySelector("#editor")
});

// åˆ›å»ºä¸€ä¸ªè§¦å‘ StateEffect çš„äº‹åŠ¡
const transaction = view.state.update({
  effects: [incrementCounterEffect.of({ num: 1 })] // é™„åŠ  effect
});

// åº”ç”¨äº‹åŠ¡ï¼Œæ›´æ–°è§†å›¾
view.dispatch(transaction);

// è·å–æ›´æ–°åçš„ StateField å€¼
console.log(view.state.field(counterField)); // è¾“å‡ºè®¡æ•°å™¨å€¼
```

**æ€»ç»“ï¼š**

- **`StateEffect` çš„ä½œç”¨**: ç”¨äºè¡¨ç¤ºé™„åŠ æ•ˆæœï¼Œå®ƒä»¬é€šå¸¸ä¸ä¼šç›´æ¥å½±å“æ–‡æ¡£æˆ–é€‰æ‹©ï¼Œä½†ä¼šå½±å“ä¸è¿™äº›äº‹åŠ¡ç›¸å…³çš„ã€Œè‡ªå®šä¹‰çŠ¶æ€å­—æ®µã€ï¼ˆ`StateField`ï¼‰
- **å¦‚ä½•ä¸ `StateField` é…åˆä½¿ç”¨**: é€šè¿‡å°† **StateEffect** é™„åŠ åˆ°äº‹åŠ¡ä¸­ï¼Œ**StateField** å¯ä»¥é€šè¿‡ `transaction.effects` æ¥å“åº”è¿™äº›æ•ˆæœï¼Œä»è€Œæ›´æ–°è‡ªå®šä¹‰çŠ¶æ€å­—æ®µçš„å€¼
- ç›¸å…³è¯­æ³•:
  - `StateEffect.define<Value>()` ç”¨æ¥å®šä¹‰ä¸€ä¸ªæ–°çš„ã€Œå‰¯ä½œç”¨ã€
  - `StateEffect.of(value)` ç”¨æ¥åˆ›å»ºä¸€ä¸ªç‰¹å®šçš„æ•ˆæœå®ä¾‹ï¼Œå°†å€¼é™„åŠ åˆ°æ•ˆæœä¸­
  - åœ¨ `StateField.update` å‡½æ•°ä¸­ï¼Œä½¿ç”¨ `effect.is()` æ–¹æ³•æ¥æ£€æŸ¥äº‹åŠ¡ä¸­æ˜¯å¦åŒ…å«è¯¥æ•ˆæœï¼Œå¹¶æ ¹æ®éœ€è¦æ›´æ–°çŠ¶æ€

#### 3.2ã€é€šè¿‡ StateEffect é…ç½® Extension

é€šè¿‡ **StateEffect** è¿˜å¯ä»¥å¯¹ç¼–è¾‘å™¨çš„ **Extension** è¿›è¡Œå˜æ›´ä¿®æ”¹

å¸¸ç”¨æ–¹æ³•ï¼šğŸ‘‡

- `StateEffect.reconfigure`

  - **ä½œç”¨**ï¼š`reconfigure` ç”¨äºé‡æ–°é…ç½®ç¼–è¾‘å™¨çš„ **æ ¹æ‰©å±•ï¼ˆroot extensionsï¼‰**ï¼Œå®ƒä¼šæ›¿æ¢å½“å‰çš„é¡¶å±‚é…ç½®
    - ä½¿ç”¨æ­¤æ–¹æ³•æ—¶ï¼Œç¼–è¾‘å™¨çš„ç°æœ‰æ‰©å±•ä¼šè¢«å®Œå…¨æ›¿æ¢ï¼Œè€Œä¸æ˜¯è¿½åŠ æˆ–ä¿®æ”¹ç°æœ‰æ‰©å±•çš„é…ç½®

  - **ç”¨æ³•**ï¼š

    - å½“éœ€è¦æ›´æ–°æˆ–æ›´æ”¹ç¼–è¾‘å™¨çš„ **æ ¹æ‰©å±•** æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `reconfigure`
    - è¿™ä¼šé‡æ–°é…ç½® **æ ¹æ‰©å±•**ï¼Œé€‚ç”¨äºéœ€è¦å®Œå…¨æ›´æ¢æˆ–è°ƒæ•´æ ¹æ‰©å±•çš„åœºæ™¯

    ```js
    const reconfigured = StateEffect.reconfigure(newExtensions);
    ```

    è¿™é‡Œçš„ `newExtensions` æ˜¯ä¸€ä¸ªæ–°çš„æ‰©å±•åˆ—è¡¨ï¼Œä¼šæ›¿æ¢æ‰åŸæœ‰çš„æ ¹æ‰©å±•ï¼Œå¦å¤–ä»»ä½•é€šè¿‡ `appendConfig` æ·»åŠ çš„æ‰©å±•å°†ä¼šè¢«ä¸¢å¼ƒ

- `StateEffect.appendConfig`

  - **ä½œç”¨**ï¼š`appendConfig` ç”¨äºå°†æ–°çš„æ‰©å±• **è¿½åŠ åˆ°ç¼–è¾‘å™¨çš„æ ¹æ‰©å±•ï¼ˆroot extensionsï¼‰**ï¼Œå³åœ¨å½“å‰çš„é…ç½®åŸºç¡€ä¸Šå¢åŠ æ–°çš„ **Extension**ï¼Œè€Œä¸å½±å“å·²å­˜åœ¨çš„ **Extension**

    - ä¸ `reconfigure` çš„æ›¿æ¢è¡Œä¸ºä¸åŒï¼Œ`appendConfig` æ˜¯ä¸€ç§å¢é‡å¼æ“ä½œï¼Œå¯ä»¥åœ¨ä¸ä¸¢å¤±åŸæœ‰æ‰©å±•çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€æ·»åŠ æ–°çš„åŠŸèƒ½æˆ–è¡Œä¸º

  - **ç”¨æ³•**ï¼š

    - å¯ä»¥ä½¿ç”¨ `appendConfig` åœ¨ä¸å¹²æ‰°ç°æœ‰é…ç½®çš„æƒ…å†µä¸‹ï¼Œå‘ç¼–è¾‘å™¨çš„é…ç½®ä¸­è¿½åŠ æ–°çš„æ‰©å±•
    - é€šå¸¸é€‚ç”¨äºåŠ¨æ€åœ°æ‰©å±•ç¼–è¾‘å™¨çš„åŠŸèƒ½ï¼Œè€Œä¸å½±å“å·²æœ‰çš„è®¾ç½®

    ```js
    const additionalExtensions = [newExtension1, newExtension2];
    const updatedEffect = StateEffect.appendConfig(additionalExtensions);
    ```

    è¿™é‡Œçš„ `additionalExtensions` æ˜¯ä¸€ç»„å°†è¢«è¿½åŠ åˆ°ç¼–è¾‘å™¨é…ç½®ä¸­çš„æ‰©å±•