## pnpmç›¸å…³

### ä¸€ã€ä»€ä¹ˆæ˜¯ pnpm

> **pnpm** æ˜¯ä¸€ç§é«˜æ•ˆã€å¿«é€Ÿã€èŠ‚çœç£ç›˜ç©ºé—´çš„ **JavaScript** åŒ…ç®¡ç†å·¥å…·
>
> **pnpm** çš„æ ¸å¿ƒç†å¿µæ˜¯â€œé“¾æ¥å’Œå…±äº«â€ï¼Œå®ƒé€šè¿‡ã€Œç¬¦å·é“¾æ¥ã€ï¼ˆsymlinkï¼‰å’Œã€Œå»é‡æœºåˆ¶ã€æ¥é«˜æ•ˆç®¡ç†ä¾èµ–å…³ç³»

#### 1.1ã€ pnpm ä¼˜åŠ¿

1. **æ›´å°çš„å†…å­˜å ç”¨**
   - **pnpm** ä½¿ç”¨ä¸€ä¸ªã€Œå…¨å±€çš„ã€å­˜å‚¨ç›®å½•ï¼ˆç±»ä¼¼äºç¼“å­˜ï¼‰ï¼Œå¹¶é€šè¿‡ç¡¬é“¾æ¥æˆ–ç¬¦å·é“¾æ¥å°†åŒ…å¼•ç”¨åˆ°é¡¹ç›®ä¸­
   - é¿å…äº†ä¼ ç»ŸåŒ…ç®¡ç†å™¨é‡å¤ä¸‹è½½å’Œå­˜å‚¨ç›¸åŒç‰ˆæœ¬çš„ä¾èµ–ï¼Œä»è€Œå¤§å¹…å‡å°‘ç£ç›˜å ç”¨
2. **æ›´å¿«çš„å®‰è£…é€Ÿåº¦**
   - **pnpm** çš„å®‰è£…é€Ÿåº¦éå¸¸å¿«ï¼Œå› ä¸ºå®ƒé¿å…äº†é‡å¤çš„æ–‡ä»¶å†™å…¥ï¼ŒåŒæ—¶ä½¿ç”¨é«˜æ•ˆçš„å¹¶å‘æœºåˆ¶æ¥å¤„ç†ä¾èµ–å®‰è£…
3. **ä¸¥æ ¼çš„ä¾èµ–éš”ç¦»**
   - **pnpm** ä½¿ç”¨å”¯ä¸€çš„ `node_modules` ç»“æ„ï¼Œå°†æ¯ä¸ªåŒ…çš„ä¾èµ–ä¸¥æ ¼é™åˆ¶åœ¨å…¶ä½œç”¨åŸŸå†…ã€‚è¿™ç§æœºåˆ¶èƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢åŒ…çš„å¹½çµä¾èµ–é—®é¢˜
4. **Monorepo æ”¯æŒ**
   **pnpm** æä¾›äº†å†…ç½®çš„ `workspaces` æ”¯æŒï¼Œéå¸¸é€‚åˆç®¡ç† **Monorepo** é¡¹ç›®

#### 1.2ã€pnpm menorepo é¡¹ç›®æ¦‚è§ˆ

**å·¥ç¨‹é¡¹ç›®ç»“æ„ï¼šğŸ‘‡**

```di
packages
    pkg1
        package.json
    pkg2
        package.json
package.json
pnpm-workspace.yaml
```

- `packages` ä¸ºå·¥ä½œåŒºç›®å½•ï¼Œé‡Œé¢å¯åˆ›å»ºå¤šä¸ªé¡¹ç›®ï¼Œé¡¹ç›®é‡Œé¢éœ€åŒ…å«`package.json`æ–‡ä»¶ï¼Œ`package.json`é‡Œçš„`name`ä¸ºé¡¹ç›®åéœ€è¦å¿…å¡«

- `pnpm-workspace.yaml`å¯ä»¥è‡ªå®šä¹‰å·¥ä½œåŒºç›®å½•ï¼Œé»˜è®¤ä¸º `packages` ä¸‹çš„æ‰€æœ‰å­ç›®å½•

  ```yaml
  // pnpm-workspace.yaml
  packages:
      // packagesç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•
      - 'packages/*'
      
      // componentsç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•
      - 'components/*'
      
      // æ’é™¤testç›®å½•ä¸‹çš„åŒ…
      - '!**/test/**'
  ```

### äºŒã€å¸¸ç”¨å‘½ä»¤

- åˆå§‹åŒ–é¡¹ç›®

  ```shell
  pnpm init
  ```

- ä¸ºæ‰€æœ‰ `packages` å®‰è£…ä¾èµ–

  ```shell
  pnpm install
  ```

- å®‰è£…å…¨å±€çš„å…¬å…±ä¾èµ–åŒ…

  - `pnpm` æä¾›äº† `-w`, `--workspace-root` å‚æ•°ï¼Œå¯ä»¥å°†ä¾èµ–åŒ…å®‰è£…åˆ°å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ï¼Œä½œä¸ºæ‰€æœ‰ `package` çš„å…¬å…±ä¾èµ–

  ```shell
  pnpm add react -w
  pnpm add react -w -D // å®‰è£…å…¬å…±å¼€å‘ä¾èµ–
  ```

- ç»™æŸä¸ª`package`å•ç‹¬å®‰è£…æŒ‡å®šä¾èµ–

  ```shell
  pnpm add react --filter pkg1(é¡¹ç›®å)  --filter pkg2(é¡¹ç›®å)
  
  #`--filter` å‚æ•°è·Ÿç€çš„æ˜¯`package`ä¸‹çš„ `package.json` çš„ `name` å­—æ®µï¼Œå¹¶ä¸æ˜¯ç›®å½•å
  ```

  æˆ–è€…å…ˆè¿›å…¥åˆ°å¯¹åº”é¡¹ç›®ä¸‹æ‰§è¡Œä»¥ä¸‹ä»£ç 

  ```bash
  # å…ˆcdåˆ°å­åŒ…çš„ç›®å½•ä¸‹å†è¿›è¡Œinstall
  
  cd packages/pkg1 
  
  pnpm add react
  ```


- `package`ä¹‹é—´ç›¸äº’å®‰è£…ä¾èµ–

  å°†`package`ä¸‹çš„`pkg1`åŒ…å®‰è£…åˆ°`pkg2`ä¸­

  ```shell
  pnpm add pkg1 --filter pkg2
  ```


- å–æ¶ˆæŸä¸ªä¾èµ–çš„å®‰è£…

  ```shell
  pnpm remove axios
  pnpm remove axios --filter  @monorepo/http // å•ä¸ªpackage
  ```

- æŸ¥çœ‹ä¾èµ–æ ‘

  ```shell
  pnpm list [package]// æŸ¥çœ‹å…¨å±€å…¬å…±ä¾èµ–
  pnpm list [package] -r // æŸ¥çœ‹æ¯ä¸ªpackageçš„ä¾èµ–
  pnpm list [package] -r --filter pkg1 // æŸ¥çœ‹pkg1çš„ä¾èµ–
  ```

- æŸ¥çœ‹æŸä¸ªåŒ…çš„ä¾èµ–æ ‘

  ```shell
  pnpm why react -r // æ˜¾ç¤ºä¾èµ–äºæŒ‡å®š packageçš„æ‰€æœ‰ package
  
  #`--recursive` `-r` å‚æ•°è¡¨ç¤ºæ‰§è¡Œè¯¥å‘½ä»¤äºå­ç›®å½•æ‰€æœ‰`package` ä¸­ï¼Œæˆ–è€…å¦‚æœæ‰§è¡Œåœ¨ä¸€ä¸ªå·¥ä½œç©ºé—´æ—¶ï¼Œåœ¨å·¥ä½œç©ºé—´çš„æ‰€æœ‰`package`æ‰§è¡Œ
  ```

- æ‰§è¡Œå­åŒ…ä¸­çš„å‘½ä»¤

  
  - é€šè¿‡ `-F` æˆ– `--filter` è¿è¡Œå­åŒ…å‘½ä»¤
  
    ```bash
    # å‡è®¾æœ‰ä¸€ä¸ªåä¸º `my-package` çš„å­åŒ…ï¼Œå¯ä»¥ä»æ ¹ç›®å½•è¿è¡Œè¯¥å­åŒ…çš„å‘½ä»¤
    # ä¾‹å¦‚ï¼Œå¦‚æœå­åŒ…çš„ `package.json` ä¸­æœ‰ä¸€ä¸ª `build` è„šæœ¬ï¼Œå¯ä»¥æ‰§è¡Œï¼š
    pnpm -F my-package run build
    ```
  
  - æ‰§è¡Œå¤šä¸ªå­åŒ…çš„å‘½ä»¤
  
    ```bash
    # å¦‚æœæƒ³åœ¨å¤šä¸ªå­åŒ…ä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨é€—å·åˆ†éš”å­åŒ…å
    pnpm -F my-package,another-package run build
    ```
  
  - è¿è¡Œæ‰€æœ‰å­åŒ…çš„å‘½ä»¤
  
    ```bash
    # å¦‚æœæƒ³åœ¨æ‰€æœ‰å­åŒ…ä¸­æ‰§è¡Œç›¸åŒçš„å‘½ä»¤ï¼Œä½¿ç”¨ `-r` æˆ– `--recursive` å‚æ•°
    pnpm -r run build
    ```
  
    æˆ–è€…åœ¨æ ¹ç›®å½•çš„ `package.json` ä¸­å®šä¹‰ä¸€ä¸ªå‘½ä»¤
  
    ```json
    {
      "scripts": {
        "build:all": "pnpm -r run build"
      }
    }
    ```
  
    ç„¶ååœ¨æ ¹ç›®å½•ä¸‹è¿è¡Œå‘½ä»¤
  
    ```bash
    pnpm run build:all
    ```
  
- åœ¨é¡¹ç›®çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤

  ```shell
  pnpm exec <command>
  
  # `<command>` æ˜¯è¦åœ¨é¡¹ç›®ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ä»»ä½•å‘½ä»¤
  
  # ä¾‹å¦‚ pnpm exec npm test
  # é€šè¿‡è¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¾èµ–é¡¹ä¸­æ‰§è¡Œç‰¹å®šçš„å‘½ä»¤ï¼Œè€Œæ— éœ€åœ¨å…¨å±€èŒƒå›´å®‰è£…è¿™äº›å‘½ä»¤æˆ–å°†å®ƒä»¬ä½œä¸ºé¡¹ç›®çš„å¼€å‘ä¾èµ–é¡¹å®‰è£…
  # ç±»ä¼¼äº npxï¼Œä½†ä¸“é—¨ç”¨äº pnpm ç®¡ç†çš„é¡¹ç›®
  ```

  